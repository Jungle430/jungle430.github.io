<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹ - Jungle&#39;s Blog</title><meta name="description" content="Welcome to Jungle&#39;s blog."><meta property="og:title" content="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹" />
<meta property="og:description" content="Operating System $Nanjing\ University\rightarrow Yanyan\ Jiang\newline$ Overview å¤ä¹  å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥ å¹¶å‘ç¼–ç¨‹çš„åº”ç”¨åœºæ™¯ï¼šé«˜æ€§èƒ½è®¡ç®—ã€æ•°æ®ä¸­å¿ƒã€ç½‘é¡µ/ç§»åŠ¨åº”ç”¨ æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜ Q: å¹¶å‘ç¼–ç¨‹é‚£" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-17T13:48:22+08:00" />
<meta property="article:modified_time" content="2023-03-17T13:48:22+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹"/>
<meta name="twitter:description" content="Operating System $Nanjing\ University\rightarrow Yanyan\ Jiang\newline$ Overview å¤ä¹  å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥ å¹¶å‘ç¼–ç¨‹çš„åº”ç”¨åœºæ™¯ï¼šé«˜æ€§èƒ½è®¡ç®—ã€æ•°æ®ä¸­å¿ƒã€ç½‘é¡µ/ç§»åŠ¨åº”ç”¨ æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜ Q: å¹¶å‘ç¼–ç¨‹é‚£"/>
<meta name="application-name" content="Jungle&#39;s blog">
<meta name="apple-mobile-web-app-title" content="Jungle&#39;s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" /><link rel="prev" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter7/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/Jungle430.github.io\/posts\/operating-system\/operating-system-chapter8\/"
        },"genre": "posts","keywords": "Operating System","wordcount":  5907 ,
        "url": "https:\/\/Jungle430.github.io\/posts\/operating-system\/operating-system-chapter8\/","datePublished": "2023-03-17T13:48:22+08:00","dateModified": "2023-03-17T13:48:22+08:00","publisher": {
            "@type": "Organization",
            "name": "Jungle"},"author": {
                "@type": "Person",
                "name": "Jungle"
            },"description": ""
    }
    </script></head><body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Jungle&#39;s Blog">Jungle&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/">ğŸ“š æ–‡ç«  </a><a class="menu-item" href="/tags/">ğŸ·ï¸ æ ‡ç­¾ </a><a class="menu-item" href="/categories/">ğŸ—ƒï¸ åˆ†ç±» </a><a class="menu-item" href="/about/">ğŸ‘´ å…³äº </a><a class="menu-item" href="https://github.com/Jungle430" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Jungle&#39;s Blog">Jungle&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">ğŸ“šæ–‡ç« </a><a class="menu-item" href="/tags/" title="">ğŸ·ï¸æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">ğŸ—ƒï¸åˆ†ç±»</a><a class="menu-item" href="/about/" title="">ğŸ‘´å…³äº</a><a class="menu-item" href="https://github.com/Jungle430" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><div class="menu-item"><a href="javascript:void(0);" class="theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="single-card" ><h2 class="single-title animated flipInX">Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://github.com/Jungle430" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jungle</a></span>&nbsp;<span class="post-category">å‡ºç‰ˆäº  <a href="/categories/operating-system/"><i class="far fa-folder fa-fw"></i>Operating System</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-03-17">2023-03-17</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 5907 å­—</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 12 åˆ†é’Ÿ</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>ç›®å½•</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#åº”å¯¹-bug-çš„æ–¹æ³•">åº”å¯¹ Bug çš„æ–¹æ³•</a>
      <ul>
        <li><a href="#åŸºæœ¬æ€è·¯å¦å®šä½ è‡ªå·±">åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±</a></li>
        <li><a href="#bug-å¤šçš„æ ¹æœ¬åŸå› ç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·">Bug å¤šçš„æ ¹æœ¬åŸå› ï¼šç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·</a></li>
        <li><a href="#æ›´å®åœ¨çš„æ–¹æ³•é˜²å¾¡æ€§ç¼–ç¨‹">æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹</a></li>
        <li><a href="#é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘">é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘</a></li>
      </ul>
    </li>
    <li><a href="#å¹¶å‘-bugæ­»é”-deadlock">å¹¶å‘ Bugï¼šæ­»é” (Deadlock)</a>
      <ul>
        <li><a href="#æ­»é”-deadlock">æ­»é” (Deadlock)</a></li>
        <li><a href="#aa-deadlock">AA-Deadlock</a></li>
        <li><a href="#abba-deadlock">ABBA-Deadlock</a></li>
        <li><a href="#é¿å…æ­»é”">é¿å…æ­»é”</a></li>
        <li><a href="#é¿å…æ­»é”-contd">é¿å…æ­»é” (cont&rsquo;d)</a></li>
        <li><a href="#lock-ordering-åº”ç”¨-linux-kernel-rmapc">Lock Ordering: åº”ç”¨ (Linux Kernel: rmap.c)</a></li>
        <li><a href="#ä½†æ˜¯ä½ åˆ-naive-äº†">ä½†æ˜¯â€¦â€¦ä½ åˆ Naive äº†â€¦â€¦</a></li>
      </ul>
    </li>
    <li><a href="#å¹¶å‘-bugæ•°æ®ç«äº‰-data-race-longrightarrow-ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—">å¹¶å‘ Bugï¼šæ•°æ®ç«äº‰ (Data Race) $\Longrightarrow$ ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—ï¼Ÿ</a>
      <ul>
        <li><a href="#æ•°æ®ç«äº‰">æ•°æ®ç«äº‰</a></li>
        <li><a href="#æ•°æ®ç«äº‰-contd">æ•°æ®ç«äº‰ (cont&rsquo;d)</a></li>
        <li><a href="#æ•°æ®ç«äº‰ä¾‹å­">æ•°æ®ç«äº‰ï¼šä¾‹å­</a></li>
      </ul>
    </li>
    <li><a href="#æ›´å¤šç±»å‹çš„å¹¶å‘-bug">æ›´å¤šç±»å‹çš„å¹¶å‘ Bug</a>
      <ul>
        <li><a href="#ç¨‹åºå‘˜èŠ±å¼çŠ¯é”™">ç¨‹åºå‘˜ï¼šèŠ±å¼çŠ¯é”™</a></li>
        <li><a href="#åŸå­æ€§è¿å-av">åŸå­æ€§è¿å (AV)</a></li>
        <li><a href="#åŸå­æ€§è¿å-contd">åŸå­æ€§è¿å (cont&rsquo;d)</a></li>
        <li><a href="#é¡ºåºè¿å-ov">é¡ºåºè¿å (OV)</a></li>
      </ul>
    </li>
    <li><a href="#åº”å¯¹å¹¶å‘-bug-çš„æ–¹æ³•">åº”å¯¹å¹¶å‘ Bug çš„æ–¹æ³•</a>
      <ul>
        <li><a href="#å®Œå…¨ä¸€æ ·çš„åŸºæœ¬æ€è·¯å¦å®šä½ è‡ªå·±">å®Œå…¨ä¸€æ ·çš„åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±</a></li>
        <li><a href="#lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥">Lockdep: è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥</a></li>
        <li><a href="#threadsanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥">ThreadSanitizer: è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥</a></li>
        <li><a href="#æ›´å¤šçš„æ£€æŸ¥åŠ¨æ€ç¨‹åºåˆ†æ">æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ</a></li>
        <li><a href="#åŠ¨æ€åˆ†æå·¥å…·sanitizers">åŠ¨æ€åˆ†æå·¥å…·ï¼šSanitizers</a></li>
      </ul>
    </li>
    <li><a href="#è¿™ä¸å°±æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹å—">è¿™ä¸å°±æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹å—ï¼Ÿ</a>
      <ul>
        <li><a href="#æˆ‘ä»¬ä¹Ÿå¯ä»¥buffer-overrun-æ£€æŸ¥">æˆ‘ä»¬ä¹Ÿå¯ä»¥ï¼Buffer Overrun æ£€æŸ¥</a></li>
        <li><a href="#canary-çš„ä¾‹å­ä¿æŠ¤æ ˆç©ºé—´-m2l2">Canary çš„ä¾‹å­ï¼šä¿æŠ¤æ ˆç©ºé—´ (M2/L2)</a></li>
        <li><a href="#çƒ«çƒ«çƒ«å±¯å±¯å±¯å’Œè‘ºè‘ºè‘º">çƒ«çƒ«çƒ«ã€å±¯å±¯å±¯å’Œè‘ºè‘ºè‘º</a></li>
        <li><a href="#é˜²å¾¡æ€§ç¼–ç¨‹ä½é…ç‰ˆ-lockdep">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Lockdep</a></li>
        <li><a href="#é˜²å¾¡æ€§ç¼–ç¨‹ä½é…ç‰ˆ-sanitizer-l1">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Sanitizer (L1)</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥</li>
<li>å¹¶å‘ç¼–ç¨‹çš„åº”ç”¨åœºæ™¯ï¼šé«˜æ€§èƒ½è®¡ç®—ã€æ•°æ®ä¸­å¿ƒã€ç½‘é¡µ/ç§»åŠ¨åº”ç”¨</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¹¶å‘ç¼–ç¨‹é‚£ä¹ˆéš¾ï¼Œæˆ‘å†™å‡º bug æ€ä¹ˆåŠï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>åº”å¯¹ bug (å’Œå¹¶å‘ bug) çš„æ–¹æ³•</li>
<li>æ­»é”å’Œæ•°æ®ç«äº‰</li>
</ul>
<h2 id="åº”å¯¹-bug-çš„æ–¹æ³•">åº”å¯¹ Bug çš„æ–¹æ³•</h2>
<h3 id="åŸºæœ¬æ€è·¯å¦å®šä½ è‡ªå·±">åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±</h3>
<blockquote>
<p>è™½ç„¶ä¸å¤ªæ„¿æ„æ‰¿è®¤ï¼Œä½†å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„ã€‚</p>
</blockquote>
<p>ç„¶åå‘¢ï¼Ÿ</p>
<ul>
<li>åšå¥½æµ‹è¯•</li>
<li>æ£€æŸ¥å“ªé‡Œé”™äº†</li>
<li>å†æ£€æŸ¥å“ªé‡Œé”™äº†</li>
<li>å†å†æ£€æŸ¥å“ªé‡Œé”™äº†
<ul>
<li>(æŠŠä»»ä½•ä½ è®¤ä¸º â€œä¸å¯¹â€ çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€é)</li>
</ul>
</li>
</ul>
<h3 id="bug-å¤šçš„æ ¹æœ¬åŸå› ç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·">Bug å¤šçš„æ ¹æœ¬åŸå› ï¼šç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·</h3>
<blockquote>
<p>è½¯ä»¶æ˜¯éœ€æ±‚ (è§„çº¦) åœ¨è®¡ç®—æœºæ•°å­—ä¸–ç•Œçš„<b>æŠ•å½±</b>ï¼ˆå…³äºå˜é‡çš„æ›´å¤šå†…å®¹ä¸¢å¤±äº†ï¼Œåªæ˜ å°„äº†ä¸€éƒ¨åˆ†ï¼‰</p>
</blockquote>
<p>åªç®¡ â€œç¿»è¯‘â€ ä»£ç ï¼Œä¸ç®¡å’Œå®é™…éœ€æ±‚ (è§„çº¦) æ˜¯å¦åŒ¹é…</p>
<ul>
<li>å¯ä»¥åŠ å…¥assertæ¥è¿›è¡Œè¯æ˜</li>
</ul>
<hr>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/alipay.c" target="_blank" rel="noopener noreffer">alipay.c</a>çš„ä¾‹å­
<ul>
<li>å˜é‡ <code>balance</code> ä»£è¡¨ â€œä½™é¢â€</li>
<li>æ€ä¹ˆçœ‹ withdraw ä»¥å 0 â†’ 18446744073709551516 éƒ½ä¸å¯¹</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">balance</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Alipay_withdraw</span><span class="p">(</span><span class="kt">int</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// unexpected delays
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">balance</span> <span class="o">-=</span> <span class="n">amt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Talipay</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Alipay_withdraw</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Talipay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Talipay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;balance = %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>ä¸‰åå¹´åçš„ç¼–ç¨‹è¯­è¨€å’Œç¼–ç¨‹æ–¹æ³•ï¼Ÿ</p>
<ul>
<li>Annotation verifier (<a href="https://dafny-lang.github.io/dafny/" target="_blank" rel="noopener noreffer">Dafny</a>)</li>
<li>Specification mining (<a href="http://plse.cs.washington.edu/daikon/" target="_blank" rel="noopener noreffer">Daikon</a>)</li>
<li><a href="https://dl.acm.org/doi/10.1145/113446.113468" target="_blank" rel="noopener noreffer">Refinement types</a></li>
<li><a href="https://link.springer.com/article/10.1007/s10009-012-0249-7" target="_blank" rel="noopener noreffer">Program sketching</a>â€¦â€¦</li>
</ul>
<h3 id="æ›´å®åœ¨çš„æ–¹æ³•é˜²å¾¡æ€§ç¼–ç¨‹">æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹</h3>
<blockquote>
<p>æŠŠç¨‹åºéœ€è¦æ»¡è¶³çš„æ¡ä»¶ç”¨ <code>assert</code> è¡¨è¾¾å‡ºæ¥ $\Longrightarrow$ <b>å’Œä¸Šé¢çš„é˜²å¾¡æ€§ç¼–ç¨‹ç›¸å¯¹åº”</b></p>
</blockquote>
<p>ä¾‹å­ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>ã€äºŒå‰æ ‘çš„æ—‹è½¬</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define A 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define B 2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BARRIER __sync_synchronize()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_int</span> <span class="n">nested</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_long</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d threads in the critical section @ count=%ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="k">volatile</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">turn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>                <span class="n">BARRIER</span><span class="p">;</span> <span class="c1">// &lt;- this is critcal for x86
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">y</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>         <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">turn</span> <span class="o">!=</span> <span class="n">B</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TB</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>                <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>         <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">turn</span> <span class="o">!=</span> <span class="n">A</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter8-1.jpg" title="/img/Operating System/chapter8-1.jpg" data-thumbnail="/img/Operating System/chapter8-1.jpg" data-sub-html="<h2>äºŒå‰æ ‘çš„æ—‹è½¬ï¼Œç»´æŠ¤çš„ä¸€äº›æ–¹æ³•assert(y-&gt;parent == x&#39;-&gt;parent &amp;&amp; y-&gt;left == x &amp;&amp; y-&gt;right == c);</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-1.jpg"
            data-srcset="/img/Operating%20System/chapter8-1.jpg, /img/Operating%20System/chapter8-1.jpg 1.5x, /img/Operating%20System/chapter8-1.jpg 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-1.jpg" />
    </a><figcaption class="image-caption">äºŒå‰æ ‘çš„æ—‹è½¬ï¼Œç»´æŠ¤çš„ä¸€äº›æ–¹æ³•<code>assert(y-&gt;parent == x'-&gt;parent &amp;&amp; y-&gt;left == x &amp;&amp; y-&gt;right == c);</code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-2.png" title="/img/Operating System/chapter8-2.png" data-thumbnail="/img/Operating System/chapter8-2.png" data-sub-html="<h2>assertå°±æ˜¯æœ€æœ‰æ•ˆçš„é˜²å¾¡æ‰‹æ®µ,ç›¸å½“äºassert(i == 1);</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-2.png"
            data-srcset="/img/Operating%20System/chapter8-2.png, /img/Operating%20System/chapter8-2.png 1.5x, /img/Operating%20System/chapter8-2.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-2.png" />
    </a><figcaption class="image-caption"><code>assert</code>å°±æ˜¯æœ€æœ‰æ•ˆçš„é˜²å¾¡æ‰‹æ®µ,ç›¸å½“äº<code>assert(i == 1);</code></figcaption>
    </figure>
<ul>
<li>
<p>æŠŠassertå†™å‡ºæ¥ï¼Œä½ ä¹Ÿå°±çŸ¥é“æ€ä¹ˆå†™ä»£ç äº†</p>
</li>
<li>
<p><font color="red"><b>ï¼ï¼ï¼é¢è¯•çš„æ—¶å€™èƒ½å†™å‡ºå¹²å‡€åˆ©è½çš„assertä»£ç æ˜¯ä¸€ä¸ªé‡è¦çš„åŠ åˆ†é¡¹ï¼Œå¯¹å¢å¼ºä»£ç çš„é€»è¾‘æ€§å’Œå¯è¯»æ€§ä»¥åŠdebugéƒ½æœ‰å¾ˆå¤§å¸®åŠ© $\Longrightarrow$Â æ²¡æœ‰äººèƒ½å¤Ÿå†™å‡ºå®Œç¾çš„ä»£ç ï¼Œä»£ç éƒ¨åˆ†å’Œassertæ˜¯äº’ç›¸å°è¯çš„ï¼Œä½¿å¾—ä»£ç çš„å¯é æ€§ä¸Šå‡äº†ä¸€ä¸ªæ•°é‡çº§</b></font></p>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-3.gif" title="/img/Operating System/chapter8-3.gif" data-thumbnail="/img/Operating System/chapter8-3.gif" data-sub-html="<h2>å³ä½¿æ˜¯Linus Torvaldså£°ç§°è‡ªå·±çš„ä»£ç æ²¡æœ‰bugæœ€åä¹Ÿè¢«æ‰“è„¸</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-3.gif"
            data-srcset="/img/Operating%20System/chapter8-3.gif, /img/Operating%20System/chapter8-3.gif 1.5x, /img/Operating%20System/chapter8-3.gif 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-3.gif" />
    </a><figcaption class="image-caption">å³ä½¿æ˜¯<a href="https://en.wikipedia.org/wiki/Linus_Torvalds" target="_blank" rel="noopener noreffer">Linus Torvalds</a>å£°ç§°è‡ªå·±çš„ä»£ç æ²¡æœ‰bugæœ€åä¹Ÿè¢«æ‰“è„¸</figcaption>
    </figure>
<ul>
<li>assertä¸ä¸€å®šéœ€è¦ç»å¯¹çš„æ­£ç¡®ï¼Œæ¯”å¦‚åœ¨ä¸Šé¢çš„æ”¯ä»˜å®ï¼Œå¦‚æœæµ‹è¯•è¿‡ç¨‹ä¸­é‡‘é¢è¾ƒå°ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨<code>assert(balance &lt;= 100000);</code>è¿™æ ·çš„ä»£ç </li>
<li>è¿˜å¯ä»¥æœ‰è¿™æ ·çš„assert</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">assert</span><span class="p">(</span><span class="n">ptr</span> <span class="n">in</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">assert</span><span class="p">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿™äº›assertçœ‹èµ·æ¥å’Œæˆ‘ä»¬çš„ç°å®ä¸–ç•Œçš„é€»è¾‘å¹¶æ²¡æœ‰å…³ç³»ï¼Œä½†æ˜¯å®ƒé˜²æ­¢äº†$Memory\ Error\newline$</li>
</ul>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘">é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘</h3>
<ul>
<li>ä½ çŸ¥é“å¾ˆå¤šå˜é‡çš„<font color="red">å«ä¹‰</font></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define CHECK_INT(x, cond) \
</span></span></span><span class="line"><span class="cl"><span class="cp">  ({ panic_on(!((x) cond), &#34;int check fail: &#34; #x &#34; &#34; #cond); })
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHECK_HEAP(ptr) \
</span></span></span><span class="line"><span class="cl"><span class="cp">  ({ panic_on(!IN_RANGE((ptr), heap)); })
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>å˜é‡æœ‰ â€œtyped annotationâ€</p>
<ul>
<li>
<p><code>CHECK_INT(waitlist-&gt;count, &gt;= 0);</code></p>
</li>
<li>
<p><code>CHECK_INT(pid, &lt; MAX_PROCS);</code></p>
</li>
<li>
<p><code>CHECK_HEAP(ctx-&gt;rip); CHECK_HEAP(ctx-&gt;cr3);</code></p>
</li>
</ul>
</li>
<li>
<p>å˜é‡å«ä¹‰æ”¹å˜ â†’ å‘ç”Ÿå¥‡æ€ªé—®é¢˜ (overflow, memory error, &hellip;)</p>
<ul>
<li><font color="red"><b>ä¸è¦å°çœ‹è¿™äº›æ£€æŸ¥</b></font>ï¼Œå®ƒä»¬åœ¨åº•å±‚ç¼–ç¨‹ (M2, L1, &hellip;) æ—¶éå¸¸å¸¸è§ã€‚å°¤å…¶æ˜¯Cè¯­è¨€â€œè£¸å¥”â€å†™OSå†…æ ¸ï¼Œæ—¢æ²¡æœ‰è¯­è¨€å±‚é¢çš„ä¿æŠ¤ï¼Œä¹Ÿæ²¡æœ‰OSå†…æ ¸çš„ä¿æŠ¤ï¼ˆå› ä¸ºä½ å†™çš„å°±æ˜¯è¿™ç©æ„ï¼‰ï¼Œæ‰€ä»¥è¿™äº›æ£€æŸ¥å°¤å…¶é‡è¦ï¼</li>
<li>è¿™äº›æ£€æŸ¥é€æ¸å°±ä»Cè¯­è¨€æ¼”å˜æˆäº†é›†æˆåº¦å’Œå®‰å…¨æ€§æ›´é«˜çš„ä¸€äº›C++æ ‡å‡†åº“è¿˜æœ‰Rustçš„ç¼–è¯‘å™¨ï¼ˆæ£€æŸ¥å¾ˆä¸¥æ ¼ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½ç›´æ¥å«è·Œï¼‰</li>
<li>åœ¨è™šæ‹Ÿæœºç¥ç§˜é‡å¯/å¡ä½/&hellip;å‰å‘å‡ºè­¦æŠ¥</li>
</ul>
</li>
</ul>
<h2 id="å¹¶å‘-bugæ­»é”-deadlock">å¹¶å‘ Bugï¼šæ­»é” (Deadlock)</h2>
<h3 id="æ­»é”-deadlock">æ­»é” (Deadlock)</h3>
<blockquote>
<p>A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action.</p>
</blockquote>
<ul>
<li>å‡ºç°çº¿ç¨‹ â€œäº’ç›¸ç­‰å¾…â€ çš„æƒ…å†µ</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-4.jpg" title="/img/Operating System/chapter8-4.jpg" data-thumbnail="/img/Operating System/chapter8-4.jpg" data-sub-html="<h2> äº’ç›¸åœ¨ç­‰å¾…ï¼ˆä½ ç­‰æˆ‘ï¼Œæˆ‘ç­‰ä½ ï¼Œæˆ‘ç­‰æˆ‘è‡ªå·±ï¼‰</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-4.jpg"
            data-srcset="/img/Operating%20System/chapter8-4.jpg, /img/Operating%20System/chapter8-4.jpg 1.5x, /img/Operating%20System/chapter8-4.jpg 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-4.jpg" />
    </a><figcaption class="image-caption"><code> äº’ç›¸åœ¨ç­‰å¾…ï¼ˆä½ ç­‰æˆ‘ï¼Œæˆ‘ç­‰ä½ ï¼Œæˆ‘ç­‰æˆ‘è‡ªå·±ï¼‰</code></figcaption>
    </figure>
<h3 id="aa-deadlock">AA-Deadlock</h3>
<ul>
<li>
<p>å‡è®¾ä½ çš„ spinlock ä¸å°å¿ƒå‘ç”Ÿäº†ä¸­æ–­</p>
<ul>
<li>
<p>åœ¨ä¸è¯¥æ‰“å¼€ä¸­æ–­çš„æ—¶å€™å¼€äº†ä¸­æ–­</p>
</li>
<li>
<p>åœ¨ä¸è¯¥åˆ‡æ¢çš„æ—¶å€™æ‰§è¡Œäº† <code>yield()</code></p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">os_run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xxx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xxx</span><span class="p">);</span> <span class="c1">// ---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>                          <span class="c1">//    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="c1">//    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">on_interrupt</span><span class="p">()</span> <span class="p">{</span>      <span class="c1">//    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>   <span class="c1">// &lt;--+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>lockå…³é—­ä¸­æ–­ï¼Œè€Œunlockæ‰“å¼€ä¸­æ–­ã€‚<b>ä¸Šé¢çš„ç¨‹åºä¸Šäº†ä¸¤æŠŠé”ï¼Œå´åœ¨åªå¼€ä¸€æŠŠé”çš„æƒ…å†µä¸‹æ‰“å¼€äº†ä¸­æ–­ã€‚$\Longrightarrow$ ä¸­æ–­éœ€è¦ç­‰ç¬¬ä¸€æŠŠé”é‡Šæ”¾ï¼Œç¬¬ä¸€ä¸ªunlockæ‰§è¡Œéœ€è¦ç­‰ä¸­æ–­è¿”å›æ‰èƒ½æ‰§è¡Œå®Œæ¯•</b>ã€‚</li>
</ul>
<div class="mermaid" id="id-1"></div>
<h3 id="abba-deadlock">ABBA-Deadlock</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé”çš„é¡ºåºå¾ˆé‡è¦â€¦â€¦</p>
<ul>
<li>
<p>swapæœ¬èº«çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜</p>
<ul>
<li><code>swap(1, 2)</code>; <code>swap(2, 3)</code>, <code>swap(3, 1)</code> â†’ æ­»é” $\Longrightarrow$ å¦‚æœä¸‰ä¸ªå¹¶å‘æ‰§è¡Œå¹¶åŒæ—¶ğŸ”’ä½äº†1ï¼Œ2ï¼Œ3ï¼Œé‚£å°±å’Œå“²å­¦å®¶é—®é¢˜é‡Œé¢æ‰€æœ‰äººéƒ½æ‹¿èµ·å·¦æ‰‹çš„å‰å­ä¸€æ ·å˜æˆäº†æ­»é”</li>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/philosopher.c" target="_blank" rel="noopener noreffer">philosopher.c</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sem_t</span> <span class="n">locks</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tphilosopher</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">lhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">id</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;T%d Got %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;T%d Got %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">SEM_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tphilosopher</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é¿å…æ­»é”">é¿å…æ­»é”</h3>
<ul>
<li>
<p>æ­»é”äº§ç”Ÿçš„å››ä¸ª<b>å¿…è¦æ¡ä»¶</b> (<a href="https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr." target="_blank" rel="noopener noreffer">Edward G. Coffman</a>, 1971):</p>
<ul>
<li>
<p>äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼ˆä¾‹å¦‚ğŸ”’ï¼‰</p>
</li>
<li>
<p>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æºï¼ˆæ¯”å¦‚å¤±è´¥ç‰ˆçš„å“²å­¦å®¶åƒé¥­ï¼Œå³æ‰‹æ‹¿å‰å­è¢«é˜»å¡çš„æ—¶å€™ä¸ä¼šæŠŠå·¦æ‰‹æ‹¿åˆ°çš„å‰å­é‡Šæ”¾æ‰ï¼‰</p>
</li>
<li>
<p>ä¸å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤ºï¼ˆğŸ”’æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œè·å¾—ä¹‹åä»»ä½•äººéƒ½æ‹¿ä¸èµ°ï¼‰</p>
</li>
<li>
<p>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆ<b>å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æº</b>å…³ç³»ï¼ˆå‚è€ƒAA-Deadlocké‡Œé¢çš„mermaidå›¾åƒä»¥åŠåå­—è·¯å£çš„å›¾åƒï¼‰</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢<b>æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æº</b>ã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€ â€”â€”Bullshit $\Longrightarrow$ <font color="orange">ç»å…¸æ•™ç§‘ä¹¦åºŸè¯ï¼Œè¿™å››ä¸ªæ¡ä»¶æƒ³è¦ç ´é™¤éå¸¸å›°éš¾</font></p>
</blockquote>
<h3 id="é¿å…æ­»é”-contd">é¿å…æ­»é” (cont&rsquo;d)</h3>
<ul>
<li>
<p>AA-Deadlock</p>
<ul>
<li>
<p>AA å‹çš„æ­»é”å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤</p>
</li>
<li>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/spinlock-xv6.c" target="_blank" rel="noopener noreffer">spinlock-xv6.c</a> ä¸­çš„å„ç§é˜²å¾¡æ€§ç¼–ç¨‹</p>
<ul>
<li><code>if (holding(lk)) panic();</code> $\Longrightarrow$ å¦‚æœè¿™æŠŠğŸ”’åœ¨ä¸ŠğŸ”’çš„æ—¶å€™ï¼Œçº¿ç¨‹å·²ç»å¾—åˆ°äº†ğŸ”’ï¼Œç›´æ¥å°±panic()ï¼Œç„¶åcrushã€‚é˜²æ­¢å‡ºç°æ­»ğŸ”’ä¹‹åè‡ªå·±åˆ°å¤„æ‰¾ï¼Œè¿™ç§ç¼–ç¨‹æ¨¡å¼èƒ½å¤Ÿè¿…é€Ÿå¸®ä½ å®šä½è‡ªå·±çš„ç¼ºé™·å’Œbugã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Mutual exclusion spin locks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;types.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;param.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;memlayout.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;spinlock.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;riscv.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;proc.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;defs.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">initlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Acquire the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Loops (spins) until the lock is acquired.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">push_off</span><span class="p">();</span> <span class="c1">// disable interrupts to avoid deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;acquire&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// On RISC-V, sync_lock_test_and_set turns into an atomic swap:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   a5 = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   s1 = &amp;lk-&gt;locked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   amoswap.w.aq a5, a5, (s1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span><span class="p">(</span><span class="n">__sync_lock_test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Tell the C compiler and the processor to not move loads or stores
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// past this point, to ensure that the critical section&#39;s memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// references happen strictly after the lock is acquired.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// On RISC-V, this emits a fence instruction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__sync_synchronize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Record info about lock acquisition for holding() and debugging.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">mycpu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Release the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">release</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">holding</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;release&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Tell the C compiler and the CPU to not move loads or stores
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// past this point, to ensure that all the stores in the critical
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// section are visible to other CPUs before the lock is released,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and that loads in the critical section occur strictly before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// the lock is released.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// On RISC-V, this emits a fence instruction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__sync_synchronize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Release the lock, equivalent to lk-&gt;locked = 0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This code doesn&#39;t use a C assignment, since the C standard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// implies that an assignment might be implemented with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// multiple store instructions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// On RISC-V, sync_lock_release turns into an atomic swap:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   s1 = &amp;lk-&gt;locked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   amoswap.w zero, zero, (s1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__sync_lock_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pop_off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Check whether this cpu is holding the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Interrupts must be off.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">holding</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">&amp;&amp;</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">mycpu</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// push_off/pop_off are like intr_off()/intr_on() except that they are matched:
</span></span></span><span class="line"><span class="cl"><span class="c1">// it takes two pop_off()s to undo two push_off()s.  Also, if interrupts
</span></span></span><span class="line"><span class="cl"><span class="c1">// are initially off, then push_off, pop_off leaves them off.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">push_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">intr_get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">intr_off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">intena</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">pop_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">mycpu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">intr_get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;pop_off - interruptible&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;pop_off&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">intena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">intr_on</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ABBA-Deadlock</p>
<ul>
<li>
<p>ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</p>
</li>
<li>
<p>ä¸¥æ ¼<b>æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é”</b> (lock ordering; æ¶ˆé™¤ â€œå¾ªç¯ç­‰å¾…â€)</p>
<ul>
<li>
<p><b>æ¯”å¦‚è¯´æœ‰X,A,B,Cå››æŠŠğŸ”’ï¼Œæ— è®ºå¦‚ä½•éƒ½è¦ç»™è¿™å››æŠŠğŸ”’æ’ä¸€ä¸‹é¡ºåº</b></p>
<div class="mermaid" id="id-2"></div>
</li>
</ul>
</li>
<li>
<p><b>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å¾—å…¶ä¸­çš„ä»»ä½•å‡ æŠŠğŸ”’ï¼Œéƒ½å¿…é¡»è¦æŒ‰ç…§æ’å¥½çš„é¡ºåºæ¥</b></p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//------&gt; âˆš ï¼œï¼ˆï¼¾ï¼ï¼¾ï¼‰ï¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//-----&gt; Ã— 
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>é‡äº‹ä¸å†³å¯è§†åŒ–ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/lock-ordering.py" target="_blank" rel="noopener noreffer">lock-ordering.py</a></p>
</li>
<li>
<p>è¿›è€Œè¯æ˜$@thread-T_1:A \rightarrow B \rightarrow C;@thread-T_2:B \rightarrow C$æ˜¯å®‰å…¨çš„</p>
<ul>
<li>â€œåœ¨ä»»æ„æ—¶åˆ»æ€»æ˜¯æœ‰è·å¾— â€œæœ€é åâ€ é”çš„å¯ä»¥ç»§ç»­æ‰§è¡Œâ€
<ul>
<li><b>å³ä½¿æœ‰è®¸å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæ€»ä¼šæœ‰ä¸€ä¸ªè·‘çš„æœ€å¿«çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯ğŸ”’çš„ä½ç½®æœ€é å³/ç¼–å·æœ€å¤§ï¼Œåªæœ‰ğŸ”’æœ€å¤§çš„çº¿ç¨‹æ‰èƒ½è·å¾—ä¸‹ä¸€æŠŠğŸ”’ $\Longrightarrow$ <font color="red">å³ä½¿åé¢çš„çº¿ç¨‹éƒ½å¡æ­»äº†ï¼Œæœ€å‰é¢çš„çº¿ç¨‹ä»ç„¶â€œç•…é€šæ— é˜»â€œã€‚</font><font color="orange">æœ€å¤§çš„çº¿ç¨‹èµ°è¿›ä¸´ç•ŒåŒºä»¥åï¼Œå®ƒå°±ä¼šæŠŠæ‰€æœ‰çš„ğŸ”’éƒ½ç»™é‡Šæ”¾æ‰ã€‚</font></b></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LockOrdering</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locks</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tryacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">lk</span><span class="p">],</span> <span class="n">seen</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">lk</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">seen</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">lk</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¯è§†åŒ–<a href="https://github.com/Jungle430/check-for-NJU-OS/blob/main/lock-ordering.html" target="_blank" rel="noopener noreffer">lock-ordering.html</a></li>
</ul>
<hr>
<ul>
<li>æ€»ç»“ï¼šä¸¤æ¡æŠ€æœ¯
<ol>
<li>é˜²å¾¡ç¼–ç¨‹ $\Longrightarrow$ AA-Deadlock</li>
<li>lock-order $\Longrightarrow$ ABBA-Deadlock</li>
</ol>
</li>
</ul>
<h3 id="lock-ordering-åº”ç”¨-linux-kernel-rmapc">Lock Ordering: åº”ç”¨ (Linux Kernel: rmap.c)</h3>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-5.png" title="/img/Operating System/chapter8-5.png" data-thumbnail="/img/Operating System/chapter8-5.png" data-sub-html="<h2>Linux Kernelï¼šrmap.cä¸­çš„Lock Ordering</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-5.png"
            data-srcset="/img/Operating%20System/chapter8-5.png, /img/Operating%20System/chapter8-5.png 1.5x, /img/Operating%20System/chapter8-5.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-5.png" />
    </a><figcaption class="image-caption">Linux Kernelï¼šrmap.cä¸­çš„<code>Lock Ordering</code></figcaption>
    </figure>
<h3 id="ä½†æ˜¯ä½ åˆ-naive-äº†">ä½†æ˜¯â€¦â€¦ä½ åˆ Naive äº†â€¦â€¦</h3>
<blockquote>
<p>Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. <b><em>Practice will tell you that this approach doesn&rsquo;t scale</em>:</b> when I create a new lock, I don&rsquo;t understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p><b>The best locks are encapsulated</b>: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don&rsquo;t even need to know you are using a lock.</p>
<p>â€”â€” <em><a href="https://www.kernel.org/doc/html/latest/kernel-hacking/locking.html" target="_blank" rel="noopener noreffer">Unreliable Guide to Locking</a></em> by Rusty Russell</p>
</blockquote>
<ul>
<li>æˆ‘ä»¬ç¨åå›åˆ°è¿™ä¸ªé—®é¢˜ï¼Œç»§ç»­çœ‹æ›´å¤šçš„ bugs</li>
</ul>
<h2 id="å¹¶å‘-bugæ•°æ®ç«äº‰-data-race-longrightarrow-ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—">å¹¶å‘ Bugï¼šæ•°æ®ç«äº‰ (Data Race) $\Longrightarrow$ ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—ï¼Ÿ</h2>
<h3 id="æ•°æ®ç«äº‰">æ•°æ®ç«äº‰</h3>
<blockquote>
<p><font color="red"><b>ä¸åŒçš„çº¿ç¨‹</b></font>åŒæ—¶è®¿é—®<font color="red"><b>åŒä¸€æ®µå†…å­˜</b></font>ï¼Œä¸”<font color="red"><b>è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™</b></font>ã€‚</p>
</blockquote>
<div class="mermaid" id="id-3"></div>
<ul>
<li>ä¸¤ä¸ªå†…å­˜è®¿é—®åœ¨ â€œèµ›è·‘â€ï¼Œ<b>â€œè·‘èµ¢â€ çš„æ“ä½œå…ˆæ‰§è¡Œ</b> $\Longrightarrow$ ç¨‹åºæœ€ç»ˆçš„ç»“æœä¸è°è·‘èµ¢æœ‰å…³ $\Longrightarrow$ è®¡ç»„ä¸­å’Œçš„â€œè¯»åå†™â€ä¸â€œå†™åè¯»â€æœ‰å…³çš„æµæ°´çº¿æ’åºé—®é¢˜
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>: å†…å­˜è®¿é—®éƒ½åœ¨èµ›è·‘
<ul>
<li><a href="https://www.felixcloutier.com/x86/mfence" target="_blank" rel="noopener noreffer">MFENCE</a>ï¼š<del>å¦‚ä½•ç•™ä¸‹æœ€å°‘çš„ fenceï¼Œä¾ç„¶ä¿è¯ç®—æ³•æ­£ç¡®ï¼Ÿ</del></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="æ•°æ®ç«äº‰-contd">æ•°æ®ç«äº‰ (cont&rsquo;d)</h3>
<ul>
<li>
<p>Peterson ç®—æ³•å‘Šè¯‰å¤§å®¶ï¼š</p>
<ul>
<li>
<p><font color="red">ä½ ä»¬å†™ä¸å¯¹æ— é”çš„å¹¶å‘ç¨‹åº</font></p>
</li>
<li>
<p>æ‰€ä»¥äº‹æƒ…åè€Œç®€å•äº†</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç”¨äº’æ–¥é”ä¿æŠ¤å¥½å…±äº«æ•°æ®</p>
<p>æ¶ˆç­ä¸€åˆ‡æ•°æ®ç«äº‰</p>
</blockquote>
<div class="mermaid" id="id-4"></div>
<h3 id="æ•°æ®ç«äº‰ä¾‹å­">æ•°æ®ç«äº‰ï¼šä¾‹å­</h3>
<ul>
<li>ä»¥ä¸‹ä»£ç æ¦‚æ‹¬äº†ä½ ä»¬é‡åˆ°æ•°æ®ç«äº‰çš„å¤§éƒ¨åˆ†æƒ…å†µ
<ul>
<li>ä¸è¦ç¬‘ï¼Œä½ ä»¬çš„ bug å‡ ä¹éƒ½æ˜¯è¿™ä¸¤ç§æƒ…å†µçš„å˜ç§</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Case #1: ä¸Šé”™äº†é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">thread1</span><span class="p">()</span> <span class="p">{</span> <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">thread2</span><span class="p">()</span> <span class="p">{</span> <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Case #2: å¿˜è®°ä¸Šé”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">thread1</span><span class="p">()</span> <span class="p">{</span> <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">thread2</span><span class="p">()</span> <span class="p">{</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ›´å¤šç±»å‹çš„å¹¶å‘-bug">æ›´å¤šç±»å‹çš„å¹¶å‘ Bug</h2>
<h3 id="ç¨‹åºå‘˜èŠ±å¼çŠ¯é”™">ç¨‹åºå‘˜ï¼šèŠ±å¼çŠ¯é”™</h3>
<ul>
<li>
<p>å›é¡¾æˆ‘ä»¬å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·</p>
<ul>
<li>
<p>äº’æ–¥é” (lock/unlock) - åŸå­æ€§</p>
</li>
<li>
<p>æ¡ä»¶å˜é‡ (wait/signal) - åŒæ­¥</p>
</li>
</ul>
</li>
<li>
<p>å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)</p>
</li>
<li>
<p>å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)</p>
</li>
<li>
<p>Empirical study: åœ¨ 105 ä¸ªå¹¶å‘ bug ä¸­ (non-deadlock/deadlock)</p>
<ul>
<li>
<p>MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</p>
</li>
<li>
<p><font color="red">97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯ AV æˆ– OV</font></p>
</li>
</ul>
</li>
</ul>
<h3 id="åŸå­æ€§è¿å-av">åŸå­æ€§è¿å (AV)</h3>
<ul>
<li>â€œABAâ€
<ul>
<li>æˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-6.png" title="/img/Operating System/chapter8-6.png" data-thumbnail="/img/Operating System/chapter8-6.png" data-sub-html="<h2>ABA</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-6.png"
            data-srcset="/img/Operating%20System/chapter8-6.png, /img/Operating%20System/chapter8-6.png 1.5x, /img/Operating%20System/chapter8-6.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-6.png" />
    </a><figcaption class="image-caption"><code>ABA</code></figcaption>
    </figure>
<h3 id="åŸå­æ€§è¿å-contd">åŸå­æ€§è¿å (cont&rsquo;d)</h3>
<ul>
<li>æœ‰æ—¶å€™ä¸Šé”ä¹Ÿä¸è§£å†³é—®é¢˜
<ul>
<li>â€œTOCTTOUâ€ - time of check to time of use</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-7.png" title="/img/Operating System/chapter8-7.png" data-thumbnail="/img/Operating System/chapter8-7.png" data-sub-html="<h2>TOCTTOU</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-7.png"
            data-srcset="/img/Operating%20System/chapter8-7.png, /img/Operating%20System/chapter8-7.png 1.5x, /img/Operating%20System/chapter8-7.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-7.png" />
    </a><figcaption class="image-caption"><code>TOCTTOU</code></figcaption>
    </figure>
<ul>
<li><a href="https://www.usenix.org/legacy/events/fast05/tech/full_papers/wei/wei.pdf" target="_blank" rel="noopener noreffer">TOCTTOU vulnerabilities in UNIX-style file systems: An anatomical study</a>(FAST'05)</li>
</ul>
<h3 id="é¡ºåºè¿å-ov">é¡ºåºè¿å (OV)</h3>
<ul>
<li>â€œBAâ€
<ul>
<li>æ€ä¹ˆå°±æ²¡æŒ‰æˆ‘é¢„æƒ³çš„é¡ºåºæ¥å‘¢ï¼Ÿ
<ul>
<li>ä¾‹å­ï¼šconcurrent use after free</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-8.png" title="/img/Operating System/chapter8-8.png" data-thumbnail="/img/Operating System/chapter8-8.png" data-sub-html="<h2>BA</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-8.png"
            data-srcset="/img/Operating%20System/chapter8-8.png, /img/Operating%20System/chapter8-8.png 1.5x, /img/Operating%20System/chapter8-8.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-8.png" />
    </a><figcaption class="image-caption"><code>BA</code></figcaption>
    </figure>
<h2 id="åº”å¯¹å¹¶å‘-bug-çš„æ–¹æ³•">åº”å¯¹å¹¶å‘ Bug çš„æ–¹æ³•</h2>
<h3 id="å®Œå…¨ä¸€æ ·çš„åŸºæœ¬æ€è·¯å¦å®šä½ è‡ªå·±">å®Œå…¨ä¸€æ ·çš„åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±</h3>
<blockquote>
<p>è¿˜æ˜¯å¾—<font color="red">å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„</font></p>
</blockquote>
<ul>
<li>
<p>ç„¶åå‘¢ï¼Ÿ</p>
<ul>
<li>
<p>åšå¥½æµ‹è¯•</p>
</li>
<li>
<p>æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li>
<p>å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li>
<p>å†å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
<ul>
<li>(æŠŠä»»ä½•ä½ è®¤ä¸º â€œä¸å¯¹â€ çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€é)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¾‹å¦‚ï¼šç”¨ lock ordering å½»åº•é¿å…æ­»é”ï¼Ÿ</p>
<ul>
<li>ä½ æƒ³å¤šäº†ï¼šå¹¶å‘é‚£ä¹ˆå¤æ‚ï¼Œç¨‹åºå‘˜å“ªèƒ½å……åˆ†æµ‹è¯•å•Š</li>
</ul>
</li>
</ul>
<h3 id="lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥">Lockdep: è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥</h3>
<p>Lockdep è§„çº¦ (Specification)</p>
<ul>
<li>ä¸ºæ¯ä¸€ä¸ªé”ç¡®å®šå”¯ä¸€çš„ â€œallocation siteâ€
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/lock-site.c" target="_blank" rel="noopener noreffer">lock-site.c</a></li>
<li>assert: åŒä¸€ä¸ª allocation site çš„é”å­˜åœ¨å…¨å±€å”¯ä¸€çš„ä¸Šé”é¡ºåº</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">lock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">locked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">site</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">lock_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define STRINGIFY(s) #s
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TOSTRING(s)  STRINGIFY(s)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOCK_INIT() \
</span></span></span><span class="line"><span class="cl"><span class="cp">  ( (lock_t) { .locked = 0, .site = __FILE__ &#34;:&#34; TOSTRING(__LINE__), } )
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">lock_t</span> <span class="n">lk1</span> <span class="o">=</span> <span class="n">LOCK_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">lock_t</span> <span class="n">lk2</span> <span class="o">=</span> <span class="n">LOCK_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;LOCK   %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">site</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;UNLOCK %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">site</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">some_object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">object_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">some_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="n">LOCK_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">some_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">some_object</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">object_init</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter8-9.png" title="/img/Operating System/chapter8-9.png" data-thumbnail="/img/Operating System/chapter8-9.png" data-sub-html="<h2>ChatGPT</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-9.png"
            data-srcset="/img/Operating%20System/chapter8-9.png, /img/Operating%20System/chapter8-9.png 1.5x, /img/Operating%20System/chapter8-9.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-9.png" />
    </a><figcaption class="image-caption"><code>ChatGPT</code></figcaption>
    </figure>
<ul>
<li>æ£€æŸ¥æ–¹æ³•ï¼šprintf
<ul>
<li>è®°å½•æ‰€æœ‰è§‚å¯Ÿåˆ°çš„ä¸Šé”é¡ºåºï¼Œä¾‹å¦‚</li>
</ul>
</li>
</ul>
<p>$$
[x,y,z] \Longrightarrow x \rightarrow y,x\rightarrow z,y\rightarrow z
$$</p>
<ul>
<li>
<p>æ£€æŸ¥æ˜¯å¦å­˜åœ¨$x â‡ y âˆ§ y â‡ x$</p>
</li>
<li>
<p><font color="red">ç»´æŠ¤ä¸€ä¸ªå›¾ï¼Œå›¾é‡Œé¢ä¸èƒ½æœ‰ç¯ï¼ˆæœ‰ç¯å°±è¿åäº†Lock-Orderï¼‰</font></p>
</li>
<li>
<p><a href="https://jyywiki.cn/OS/OS_Lockdep" target="_blank" rel="noopener noreffer">Lockdep çš„å®ç°</a></p>
<ul>
<li>Since Linux Kernel 2.6.17, also in <a href="https://gitee.com/openharmony" target="_blank" rel="noopener noreffer">OpenHarmony</a>!</li>
</ul>
</li>
</ul>
<h3 id="threadsanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥">ThreadSanitizer: è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥</h3>
<ul>
<li>
<p>ä¸ºæ‰€æœ‰äº‹ä»¶å»ºç«‹ happens-before å…³ç³»å›¾ $\Longrightarrow$ å›¾è®º</p>
<ul>
<li>
<p>Program-order + release-acquire</p>
</li>
<li>
<p>å¯¹äºå‘ç”Ÿåœ¨ä¸åŒçº¿ç¨‹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™çš„$x,y$æ£€æŸ¥</p>
</li>
</ul>
</li>
</ul>
<p>$$
x â‰º y âˆ¨ y â‰º x
$$</p>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/359545.359563" target="_blank" rel="noopener noreffer">Time, clocks, and the ordering of events in a distributed system</a></li>
</ul>
<h3 id="æ›´å¤šçš„æ£€æŸ¥åŠ¨æ€ç¨‹åºåˆ†æ">æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ</h3>
<ul>
<li>
<p>åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è®°å½•</p>
<ul>
<li>
<p>Lockdep: lock/unlock</p>
</li>
<li>
<p>ThreadSanitizer: å†…å­˜è®¿é—® + lock/unlock</p>
</li>
</ul>
</li>
<li>
<p>è§£æè®°å½•æ£€æŸ¥é—®é¢˜</p>
<ul>
<li>Lockdep: $x â‡ y âˆ§ y â‡ x$</li>
<li>ThreadSanitizer: $x \nprec y âˆ§ y \nprec x$</li>
</ul>
</li>
<li>
<p>ä»˜å‡ºçš„ä»£ä»·å’Œæƒè¡¡</p>
<ul>
<li>
<p>ç¨‹åºæ‰§è¡Œå˜æ…¢</p>
</li>
<li>
<p>ä½†æ›´å®¹æ˜“æ‰¾åˆ° bug (å› æ­¤åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¸¸ç”¨)</p>
</li>
</ul>
</li>
</ul>
<h3 id="åŠ¨æ€åˆ†æå·¥å…·sanitizers">åŠ¨æ€åˆ†æå·¥å…·ï¼šSanitizers</h3>
<ul>
<li>
<p>æ²¡ç”¨è¿‡ lint/sanitizersï¼Ÿ</p>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/AddressSanitizer.html" target="_blank" rel="noopener noreffer">AddressSanitizer</a> (asan); <a href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany" target="_blank" rel="noopener noreffer">(paper)</a>: éæ³•å†…å­˜è®¿é—®</p>
<ul>
<li>Buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, &hellip;</li>
<li>Demo: <a href="https://jyywiki.cn/pages/OS/2022/demos/uaf.c" target="_blank" rel="noopener noreffer">uaf.c</a>; <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html" target="_blank" rel="noopener noreffer">kasan</a></li>
</ul>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" target="_blank" rel="noopener noreffer">ThreadSanitizer</a> (tsan): æ•°æ®ç«äº‰</p>
<ul>
<li>Demo: <a href="https://jyywiki.cn/pages/OS/2022/demos/fish.c" target="_blank" rel="noopener noreffer">fish.c</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/sum.c" target="_blank" rel="noopener noreffer">sum.c</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>; <a href="https://github.com/google/ktsan" target="_blank" rel="noopener noreffer">ktsan</a></li>
</ul>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/MemorySanitizer.html" target="_blank" rel="noopener noreffer">MemorySanitizer</a> (msan): æœªåˆå§‹åŒ–çš„è¯»å–</p>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" target="_blank" rel="noopener noreffer">UBSanitizer</a> (ubsan): undefined behavior</p>
<ul>
<li>Misaligned pointer, signed integer overflow, &hellip;</li>
<li>Kernel ä¼šå¸¦ç€ <code>-fwrapv</code> ç¼–è¯‘</li>
</ul>
</li>
<li>
<p>ç¤ºä¾‹ï¼štest.c</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -g test.c -fsanitize<span class="o">=</span>address -o <span class="nb">test</span> <span class="o">&amp;&amp;</span> ./test
</span></span><span class="line"><span class="cl"><span class="o">=================================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">37384</span><span class="o">==</span>ERROR: AddressSanitizer: heap-use-after-free on address 0x602000000010 at pc 0x55c0a903b213 bp 0x7ffe5d50fcd0 sp 0x7ffe5d50fcc8
</span></span><span class="line"><span class="cl">WRITE of size <span class="m">4</span> at 0x602000000010 thread T0
</span></span><span class="line"><span class="cl">    <span class="c1">#0 0x55c0a903b212 in main /home/kali/chapter7/test.c:7</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#1 0x7f8416046189 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#2 0x7f8416046244 in __libc_start_main_impl ../csu/libc-start.c:381</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#3 0x55c0a903b0b0 in _start (/home/kali/chapter7/test+0x10b0)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0x602000000010 is located <span class="m">0</span> bytes inside of 4-byte region <span class="o">[</span>0x602000000010,0x602000000014<span class="o">)</span>
</span></span><span class="line"><span class="cl">freed by thread T0 here:
</span></span><span class="line"><span class="cl">    <span class="c1">#0 0x7f84162b76a8 in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:52</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#1 0x55c0a903b1db in main /home/kali/chapter7/test.c:6</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#2 0x7f8416046189 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">previously allocated by thread T0 here:
</span></span><span class="line"><span class="cl">    <span class="c1">#0 0x7f84162b89cf in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:69</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#1 0x55c0a903b18a in main /home/kali/chapter7/test.c:4</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#2 0x7f8416046189 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SUMMARY: AddressSanitizer: heap-use-after-free /home/kali/chapter7/test.c:7 in main
</span></span><span class="line"><span class="cl">Shadow bytes around the buggy address:
</span></span><span class="line"><span class="cl">  0x0c047fff7fb0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7fc0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7fd0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7fe0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7ff0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">00</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt;0x0c047fff8000: fa fa<span class="o">[</span>fd<span class="o">]</span>fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">Shadow byte legend <span class="o">(</span>one shadow byte represents <span class="m">8</span> application bytes<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  Addressable:           <span class="m">00</span>
</span></span><span class="line"><span class="cl">  Partially addressable: <span class="m">01</span> <span class="m">02</span> <span class="m">03</span> <span class="m">04</span> <span class="m">05</span> <span class="m">06</span> <span class="m">07</span> 
</span></span><span class="line"><span class="cl">  Heap left redzone:       fa
</span></span><span class="line"><span class="cl">  Freed heap region:       fd
</span></span><span class="line"><span class="cl">  Stack left redzone:      f1
</span></span><span class="line"><span class="cl">  Stack mid redzone:       f2
</span></span><span class="line"><span class="cl">  Stack right redzone:     f3
</span></span><span class="line"><span class="cl">  Stack after <span class="k">return</span>:      f5
</span></span><span class="line"><span class="cl">  Stack use after scope:   f8
</span></span><span class="line"><span class="cl">  Global redzone:          f9
</span></span><span class="line"><span class="cl">  Global init order:       f6
</span></span><span class="line"><span class="cl">  Poisoned by user:        f7
</span></span><span class="line"><span class="cl">  Container overflow:      <span class="nb">fc</span>
</span></span><span class="line"><span class="cl">  Array cookie:            ac
</span></span><span class="line"><span class="cl">  Intra object redzone:    bb
</span></span><span class="line"><span class="cl">  ASan internal:           fe
</span></span><span class="line"><span class="cl">  Left alloca redzone:     ca
</span></span><span class="line"><span class="cl">  Right alloca redzone:    <span class="nv">cb</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">37384</span><span class="o">==</span>ABORTING
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter8-10.png" title="/img/Operating System/chapter8-10.png" data-thumbnail="/img/Operating System/chapter8-10.png" data-sub-html="<h2>æ£€æŸ¥sum.cçš„thread</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter8-10.png"
            data-srcset="/img/Operating%20System/chapter8-10.png, /img/Operating%20System/chapter8-10.png 1.5x, /img/Operating%20System/chapter8-10.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter8-10.png" />
    </a><figcaption class="image-caption"><code>æ£€æŸ¥sum.cçš„thread</code></figcaption>
    </figure>
<h2 id="è¿™ä¸å°±æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹å—">è¿™ä¸å°±æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹å—ï¼Ÿ</h2>
<ul>
<li>åªä¸è¿‡ä¸éœ€è¦æˆ‘äº²è‡ªåŠ¨æ‰‹æŠŠä»£ç æ”¹å¾—ä¹±ä¸ƒå…«ç³Ÿäº†â€¦â€¦</li>
</ul>
<h3 id="æˆ‘ä»¬ä¹Ÿå¯ä»¥buffer-overrun-æ£€æŸ¥">æˆ‘ä»¬ä¹Ÿå¯ä»¥ï¼Buffer Overrun æ£€æŸ¥</h3>
<ul>
<li>
<p>Canary (é‡‘ä¸é›€) å¯¹ä¸€æ°§åŒ–ç¢³éå¸¸æ•æ„Ÿ</p>
<ul>
<li>ç”¨ç”Ÿå‘½é¢„è­¦çŸ¿äº•ä¸‹çš„ç“¦æ–¯æ³„éœ² (since 1911)</li>
</ul>
</li>
<li>
<p>è®¡ç®—æœºç³»ç»Ÿä¸­çš„ canary</p>
<ul>
<li>â€œç‰ºç‰²â€ ä¸€äº›å†…å­˜å•å…ƒï¼Œæ¥é¢„è­¦ memory error çš„å‘ç”Ÿ
<ul>
<li>(ç¨‹åºè¿è¡Œæ—¶æ²¡æœ‰åŠ¨ç‰©å—åˆ°å®è´¨çš„ä¼¤å®³)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="canary-çš„ä¾‹å­ä¿æŠ¤æ ˆç©ºé—´-m2l2">Canary çš„ä¾‹å­ï¼šä¿æŠ¤æ ˆç©ºé—´ (M2/L2)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define MAGIC 0x55555555
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BOTTOM (STK_SZ / sizeof(u32) - 1)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">struct</span> <span class="n">stack</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">STK_SZ</span><span class="p">];</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">canary_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">stack</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CANARY_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">canary_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">stack</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CANARY_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">&#34;underflow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">&#34;overflow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="çƒ«çƒ«çƒ«å±¯å±¯å±¯å’Œè‘ºè‘ºè‘º">çƒ«çƒ«çƒ«ã€å±¯å±¯å±¯å’Œè‘ºè‘ºè‘º</h3>
<ul>
<li>
<p>msvc ä¸­ debug mode çš„ guard/fence/canary</p>
<ul>
<li>
<p>æœªåˆå§‹åŒ–æ ˆ: <code>0xcccccccc</code></p>
</li>
<li>
<p>æœªåˆå§‹åŒ–å †: <code>0xcdcdcdcd</code></p>
</li>
<li>
<p>å¯¹è±¡å¤´å°¾: <code>0xfdfdfdfd</code></p>
</li>
<li>
<p>å·²å›æ”¶å†…å­˜: <code>0xdddddddd</code></p>
</li>
</ul>
</li>
<li>
<p><code>(b'**\xcc**' * 80).decode('gb2312')</code></p>
</li>
</ul>
<blockquote>
<p>æ‰‹æŒä¸¤æŠŠé”Ÿæ–¤æ‹·ï¼Œå£ä¸­ç–¾å‘¼çƒ«çƒ«çƒ«</p>
<p>è„šè¸åƒæœµå±¯å±¯å±¯ï¼Œç¬‘çœ‹ä¸‡ç‰©é”˜é”˜é”˜</p>
<p>(å®ƒä»¬ä¸€ç›´åœ¨æ— å½¢ä¸­ä¿æŠ¤ä½ )</p>
</blockquote>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹ä½é…ç‰ˆ-lockdep">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Lockdep</h3>
<ul>
<li>ä¸å¿…å¤§è´¹å‘¨ç« è®°å½•ä»€ä¹ˆä¸Šé”é¡ºåº
<ul>
<li>ç»Ÿè®¡å½“å‰çš„ spin count
<ul>
<li>å¦‚æœè¶…è¿‡æŸä¸ªæ˜æ˜¾ä¸æ­£å¸¸çš„æ•°å€¼ (1,000,000,000) å°±æŠ¥å‘Š</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">spin_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">spin_cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">SPIN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Too many spin @ %s:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é…åˆè°ƒè¯•å™¨å’Œçº¿ç¨‹ backtrace ä¸€ç§’è¯Šæ–­æ­»é”</li>
</ul>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹ä½é…ç‰ˆ-sanitizer-l1">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Sanitizer (L1)</h3>
<ul>
<li>å†…å­˜åˆ†é…è¦æ±‚<code>malloc and free</code>ï¼šå·²åˆ†é…å†…å­˜$S=[l_0,r_0) \cup [l_1,r_1) \cup &hellip;$
<ul>
<li>$kalloc(S)$è¿”å›çš„$[l,r)$ å¿…é¡»æ»¡è¶³$[l,r) \cup S = \empty$
<ul>
<li>thread-local allocation + å¹¶å‘çš„ free è¿˜è›®å®¹æ˜“å¼„é”™çš„</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// allocation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">&#34;double-allocation&#34;</span><span class="p">);</span><span class="c1">//åˆ†é…çš„æ—¶å€™çœ‹åˆ°äº†mallocé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span> <span class="c1">//åˆ·ä¸Šmallocé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">alloc_size</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;double-free&#34;</span><span class="p">);</span><span class="c1">//åˆ†é…çš„æ—¶å€™çœ‹åˆ°äº†freeé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//åˆ·ä¸Šfreeé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•æ‹¯æ•‘äººç±»ä¸æ“…é•¿çš„å¹¶å‘ç¼–ç¨‹ï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>å¸¸è§çš„å¹¶å‘ bug
<ul>
<li>æ­»é”ã€æ•°æ®ç«äº‰ã€åŸå­æ€§/é¡ºåºè¿å</li>
</ul>
</li>
<li>ä¸è¦ç›²ç›®ç›¸ä¿¡è‡ªå·±ï¼šæ£€æŸ¥ã€æ£€æŸ¥ã€æ£€æŸ¥
<ul>
<li>é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ£€æŸ¥</li>
<li>åŠ¨æ€åˆ†æï¼šæ‰“å° + æ£€æŸ¥</li>
</ul>
</li>
</ul>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/operating-system/">Operating System</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>æ›´æ–°äº 2023-03-17</span>
            </div><div class="post-info-mod"></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹" data-hashtags="Operating System"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-hashtag="Operating System"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Linkedin" data-sharer="linkedin" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° WhatsApp" data-sharer="whatsapp" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Myspace" data-sharer="myspace" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Blogger" data-sharer="blogger" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer="baidu" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Evernote" data-sharer="evernote" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/" data-title="Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹"><i class="fab fa-evernote fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/posts/operating-system/operating-system-chapter7/" class="prev" rel="prev" title="Operating System Chapter7 çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a></div></div>
</div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/khusika/FeelIt" target="_blank" rel="noopener noreffer" title="FeelIt 1.0.1"><i class="fas fa-hand-holding-heart fa-fw"></i> FeelIt</a>
        </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/Jungle430">Jungle</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=0.0.1', { scope: '/' })
        .then(() => {
            console.info('Jungle\u0027s Blog\u00A0Service Worker Registered');
        }, err => console.error('Jungle\u0027s Blog\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('Jungle\u0027s Blog\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script src="/lib/mermaid/mermaid.min.js"></script><script>window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":100},"comment":{},"data":{"id-1":"graph LR\nA(\"ä¸­æ–­éœ€è¦ç¬¬ä¸€æŠŠğŸ”’\")\nB(\"ä¸Šé¢çš„å‡½æ•°é‡Šæ”¾ğŸ”’\")\nA--ç­‰å¾…ä¸Šé¢çš„å‡½æ•°æ‰§è¡Œåˆ°è¯¥æŒ‡ä»¤--\u003eB\nB--ç­‰å¾…ä¸­æ–­è¿”å›æ‰èƒ½ç»§ç»­æ‰§è¡ŒæŒ‡ä»¤--\u003eA","id-2":"\t  graph LR\n\t  X(X)\n\t  A(A)\n\t  B(B)\n\t  C(C)\n    X--\u003eA--\u003eB--\u003eC\n    ","id-3":"graph TB\nA(Thread1)\nB(Thread2)\nC(Lock)\nD(Unlock)\nE(Memory)\nF(\"åŒæ—¶è®¿é—®ä¸€æ®µå†…å­˜ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™\")\nA--\u003eC--\u003eD--\u003eE\nB----\u003eE\nE====F","id-4":"graph TB\nA(Thread1)\nB(Thread2)\nC(Lock)\nD(Unlock)\nE(Memory)\nF(Lock)\nA---\u003eC--\u003eE--\u003eD\nB------\u003eF\nD--\u003eF\nF--\u003eE"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50}};</script><script src="/js/theme.min.js"></script></body></html>
