<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Operating System Chapter12 进程的地址空间 - Jungle&#39;s Blog</title><meta name="description" content="Welcome to Jungle&#39;s blog."><meta property="og:title" content="Operating System Chapter12 进程的地址空间" />
<meta property="og:description" content="Operating System $Nanjing\ University\rightarrow Yanyan\ Jiang\newline$ Overview 复习 操作系统：加载第一个 init 程序，随后变为 “异常处理程序” init: fork, execve, exit 和其他系统调用创造整个操作系统世界 本次课回答的问题 Q: 进程的地址" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-05T13:35:01+08:00" />
<meta property="article:modified_time" content="2023-05-05T13:35:01+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Operating System Chapter12 进程的地址空间"/>
<meta name="twitter:description" content="Operating System $Nanjing\ University\rightarrow Yanyan\ Jiang\newline$ Overview 复习 操作系统：加载第一个 init 程序，随后变为 “异常处理程序” init: fork, execve, exit 和其他系统调用创造整个操作系统世界 本次课回答的问题 Q: 进程的地址"/>
<meta name="application-name" content="Jungle&#39;s blog">
<meta name="apple-mobile-web-app-title" content="Jungle&#39;s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" /><link rel="prev" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter11/" /><link rel="next" href="https://Jungle430.github.io/posts/go/module_and_test/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Operating System Chapter12 进程的地址空间",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/Jungle430.github.io\/posts\/operating-system\/operating-system-chapter12\/"
        },"genre": "posts","keywords": "Operating System","wordcount":  7174 ,
        "url": "https:\/\/Jungle430.github.io\/posts\/operating-system\/operating-system-chapter12\/","datePublished": "2023-05-05T13:35:01+08:00","dateModified": "2023-05-05T13:35:01+08:00","publisher": {
            "@type": "Organization",
            "name": "Jungle"},"author": {
                "@type": "Person",
                "name": "Jungle"
            },"description": ""
    }
    </script></head><body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Jungle&#39;s Blog">Jungle&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/">📚 文章 </a><a class="menu-item" href="/tags/">🏷️ 标签 </a><a class="menu-item" href="/categories/">🗃️ 分类 </a><a class="menu-item" href="/about/">👴 关于 </a><a class="menu-item" href="https://github.com/Jungle430" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Jungle&#39;s Blog">Jungle&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">📚文章</a><a class="menu-item" href="/tags/" title="">🏷️标签</a><a class="menu-item" href="/categories/" title="">🗃️分类</a><a class="menu-item" href="/about/" title="">👴关于</a><a class="menu-item" href="https://github.com/Jungle430" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><div class="menu-item"><a href="javascript:void(0);" class="theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="single-card" ><h2 class="single-title animated flipInX">Operating System Chapter12 进程的地址空间</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://github.com/Jungle430" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jungle</a></span>&nbsp;<span class="post-category">出版于  <a href="/categories/operating-system/"><i class="far fa-folder fa-fw"></i>Operating System</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-05-05">2023-05-05</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7174 字</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 15 分钟</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>目录</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#进程的地址空间">进程的地址空间</a>
      <ul>
        <li><a href="#进程的地址空间-1">进程的地址空间</a></li>
        <li><a href="#查看进程的地址空间">查看进程的地址空间</a></li>
        <li><a href="#操作系统提供查看进程地址空间的机制">操作系统提供查看进程地址空间的机制</a></li>
        <li><a href="#更完整的地址空间映象">更完整的地址空间映象</a></li>
        <li><a href="#rtfm-5-proc-我们发现的宝藏">RTFM (5 proc): 我们发现的宝藏</a></li>
        <li><a href="#小知识-系统调用的实现">(小知识) 系统调用的实现</a></li>
        <li><a href="#小知识-系统调用的实现-contd">(小知识) 系统调用的实现 (cont&rsquo;d)</a></li>
      </ul>
    </li>
    <li><a href="#进程的地址空间管理">进程的地址空间管理</a>
      <ul>
        <li><a href="#execve-之后">Execve 之后……</a></li>
        <li><a href="#进程的地址空间-contd">进程的地址空间 (cont&rsquo;d)</a></li>
        <li><a href="#把文件映射到进程地址空间">把文件映射到进程地址空间？</a></li>
        <li><a href="#使用-memory-mapping">使用 Memory Mapping</a></li>
        <li><a href="#memory-mapped-file-一致性">Memory-Mapped File: 一致性</a></li>
      </ul>
    </li>
    <li><a href="#地址空间的隔离">地址空间的隔离</a>
      <ul>
        <li><a href="#地址空间实现进程隔离">地址空间：实现进程隔离</a></li>
        <li><a href="#电子游戏的上一个黄金时代">电子游戏的上一个黄金时代</a></li>
        <li><a href="#前互联网时代的神器-1-金山游侠">前互联网时代的神器 (1): 金山游侠</a></li>
        <li><a href="#前互联网时代的神器-2-按键精灵">前互联网时代的神器 (2): 按键精灵</a></li>
        <li><a href="#前互联网时代的神器-3-变速齿轮">前互联网时代的神器 (3): 变速齿轮</a></li>
        <li><a href="#更强大的游戏外挂">更强大的游戏外挂？</a></li>
        <li><a href="#代码注入-hooking">代码注入 (Hooking)</a></li>
        <li><a href="#游戏外挂攻与防">游戏外挂：攻与防</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a>
      <ul>
        <li><a href="#总结-1">总结</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="overview">Overview</h2>
<ul>
<li>
<p>复习</p>
<ul>
<li>
<p>操作系统：加载第一个 <code>init</code> 程序，随后变为 “异常处理程序”</p>
</li>
<li>
<p><code>init</code>: fork, execve, exit 和其他系统调用创造整个操作系统世界</p>
</li>
</ul>
</li>
<li>
<p>本次课回答的问题</p>
<ul>
<li><strong>Q</strong>: 进程的地址空间是如何创建、如何更改的？</li>
</ul>
</li>
<li>
<p>本次课主要内容</p>
<ul>
<li>进程的地址空间和管理 (<code>mmap</code>)</li>
</ul>
</li>
</ul>
<h2 id="进程的地址空间">进程的地址空间</h2>
<h3 id="进程的地址空间-1">进程的地址空间</h3>
<ul>
<li>
<p><code>char *p</code> 可以和 <code>intptr_t</code> 互相转换</p>
<ul>
<li>可以指向 “任何地方”</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x12345678l</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// p = (void *)(0x12345678l);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="c1">//=&gt;fa1e0ff3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>反汇编</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0000000000001149 &lt;main&gt;:
</span></span><span class="line"><span class="cl">    1149:       f3 0f 1e fa             endbr64 
</span></span><span class="line"><span class="cl">    114d:       55                      push   %rbp
</span></span><span class="line"><span class="cl">    114e:       48 89 e5                mov    %rsp,%rbp
</span></span><span class="line"><span class="cl">    1151:       48 83 ec 10             sub    $0x10,%rsp
</span></span><span class="line"><span class="cl">    1155:       48 8d 05 ed ff ff ff    lea    -0x13(%rip),%rax        # 1149 &lt;main&gt;
</span></span><span class="line"><span class="cl">    115c:       48 89 45 f8             mov    %rax,-0x8(%rbp)
</span></span><span class="line"><span class="cl">    1160:       48 8b 45 f8             mov    -0x8(%rbp),%rax
</span></span><span class="line"><span class="cl">    1164:       8b 00                   mov    (%rax),%eax
</span></span><span class="line"><span class="cl">    1166:       89 c6                   mov    %eax,%esi
</span></span><span class="line"><span class="cl">    1168:       48 8d 05 95 0e 00 00    lea    0xe95(%rip),%rax        # 2004 &lt;_IO_stdin_used+0x4&gt;
</span></span><span class="line"><span class="cl">    116f:       48 89 c7                mov    %rax,%rdi
</span></span><span class="line"><span class="cl">    1172:       b8 00 00 00 00          mov    $0x0,%eax
</span></span><span class="line"><span class="cl">    1177:       e8 d4 fe ff ff          call   1050 &lt;printf@plt&gt;
</span></span><span class="line"><span class="cl">    117c:       b8 00 00 00 00          mov    $0x0,%eax
</span></span><span class="line"><span class="cl">    1181:       c9                      leave  
</span></span><span class="line"><span class="cl">    1182:       c3  
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>正好对应<code>endbr64</code>（注意小端口输出顺序）</p>
</li>
<li>
<p>合法的地址 (可读或可写)</p>
<ul>
<li>
<p>代码 (<code>main</code>, <code>%rip</code> 会从此处取出待执行的指令)，只读</p>
</li>
<li>
<p>数据 (<code>static int x</code>)，读写</p>
</li>
<li>
<p>堆栈 (<code>int y</code>)，读写</p>
</li>
<li>
<p>运行时分配的内存 (???)，读写</p>
</li>
<li>
<p>动态链接库 (???)</p>
</li>
</ul>
</li>
<li>
<p>非法的地址</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// p = (void *)main;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x12345678l</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="c1">//=&gt;zsh: segmentation fault
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>NULL</code>，导致 segmentation fault</li>
</ul>
</li>
<li>
<p>它们停留在概念中，但实际呢？</p>
</li>
</ul>
<h3 id="查看进程的地址空间">查看进程的地址空间</h3>
<ul>
<li>
<p>pmap (1) - report memory of a process</p>
<ul>
<li>
<p>Claim: pmap 是通过访问 procfs (<code>/proc/</code>) 实现的</p>
</li>
<li>
<p>如何验证这一点？</p>
</li>
</ul>
</li>
<li>
<p>查看进程的地址空间</p>
<ul>
<li>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/minimal.S" target="_blank" rel="noopener noreffer">minimal.S</a> (静态链接)</p>
</li>
<li>
<p>最小的 Hello World (静态/动态链接)</p>
<ul>
<li>
<p>进程的地址空间：若干连续的 “段”</p>
</li>
<li>
<p>“段” 的内存可以访问</p>
</li>
<li>
<p>不在段内/违反权限的内存访问 触发 <code>SIGSEGV</code></p>
<ul>
<li><code>gdb</code> 可以 “越权访问”，但不能访问 “不存在” 的地址</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#include &lt;sys/syscall.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.globl _start
</span></span><span class="line"><span class="cl">_start:
</span></span><span class="line"><span class="cl">  movq $SYS_write, %rax   // write(
</span></span><span class="line"><span class="cl">  movq $1,         %rdi   //   fd=1,
</span></span><span class="line"><span class="cl">  movq $st,        %rsi   //   buf=st,
</span></span><span class="line"><span class="cl">  movq $(ed - st), %rdx   //   count=ed-st
</span></span><span class="line"><span class="cl">  syscall                 // );
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  movq $SYS_exit,  %rax   // exit(
</span></span><span class="line"><span class="cl">  movq $1,         %rdi   //   status=1
</span></span><span class="line"><span class="cl">  syscall                 // );
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">st:
</span></span><span class="line"><span class="cl">  .ascii &#34;\033[01;31mHello, OS World\033[0m\n&#34;
</span></span><span class="line"><span class="cl">ed:
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">┌──<span class="o">(</span>jungle㉿LAPTOP-A7S3TAA4<span class="o">)</span>-<span class="o">[</span>/mnt/d/work <span class="k">for</span> vscode/chapter12<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ strace ./minimal
</span></span><span class="line"><span class="cl">execve<span class="o">(</span><span class="s2">&#34;./minimal&#34;</span>, <span class="o">[</span><span class="s2">&#34;./minimal&#34;</span><span class="o">]</span>, 0x7fffdfe108e0 /* <span class="m">41</span> vars */<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;\33[01;31mHello, OS World\33[0m\n&#34;</span>, 28Hello, OS World
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">28</span>
</span></span><span class="line"><span class="cl">exit<span class="o">(</span>1<span class="o">)</span>                                 <span class="o">=</span> ?
</span></span><span class="line"><span class="cl">+++ exited with <span class="m">1</span> +++
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter12-1.png" title="/img/Operating System/chapter12-1.png" data-thumbnail="/img/Operating System/chapter12-1.png" data-sub-html="<h2>查看进程号</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-1.png"
            data-srcset="/img/Operating%20System/chapter12-1.png, /img/Operating%20System/chapter12-1.png 1.5x, /img/Operating%20System/chapter12-1.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-1.png" />
    </a><figcaption class="image-caption"><code>查看进程号</code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-2.png" title="/img/Operating System/chapter12-2.png" data-thumbnail="/img/Operating System/chapter12-2.png" data-sub-html="<h2>使用pmap查看一个进程所有的地址空间</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-2.png"
            data-srcset="/img/Operating%20System/chapter12-2.png, /img/Operating%20System/chapter12-2.png 1.5x, /img/Operating%20System/chapter12-2.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-2.png" />
    </a><figcaption class="image-caption"><code>使用pmap查看一个进程所有的地址空间</code></figcaption>
    </figure>
<ul>
<li>可以看到由许多“段”组成的</li>
<li>仔细看可以发现第一段的段地址和<code>starti</code>首地址的联系</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-3.png" title="/img/Operating System/chapter12-3.png" data-thumbnail="/img/Operating System/chapter12-3.png" data-sub-html="<h2>layout src</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-3.png"
            data-srcset="/img/Operating%20System/chapter12-3.png, /img/Operating%20System/chapter12-3.png 1.5x, /img/Operating%20System/chapter12-3.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-3.png" />
    </a><figcaption class="image-caption"><code>layout src</code></figcaption>
    </figure>
<ul>
<li><code>pmap</code>干了啥？</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">┌──<span class="o">(</span>jungle㉿LAPTOP-A7S3TAA4<span class="o">)</span>-<span class="o">[</span>/mnt/d/work <span class="k">for</span> vscode/chapter12<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ strace pmap <span class="m">1431</span>
</span></span><span class="line"><span class="cl">execve<span class="o">(</span><span class="s2">&#34;/usr/bin/pmap&#34;</span>, <span class="o">[</span><span class="s2">&#34;pmap&#34;</span>, <span class="s2">&#34;1431&#34;</span><span class="o">]</span>, 0x7ffe115f8938 /* <span class="m">41</span> vars */<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55d0cc7da000
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>0x3001 /* ARCH_??? */, 0x7ffc6ce9b2d0<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca614a000
</span></span><span class="line"><span class="cl">access<span class="o">(</span><span class="s2">&#34;/etc/ld.so.preload&#34;</span>, R_OK<span class="o">)</span>      <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/etc/ld.so.cache&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>46367, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 46367, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca613e000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libprocps.so.8&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>80080, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 225320, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca6106000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca610a000, 40960, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x4000<span class="o">)</span> <span class="o">=</span> 0x7f4ca610a000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca6114000, 16384, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xe000<span class="o">)</span> <span class="o">=</span> 0x7f4ca6114000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca6118000, 12288, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x11000<span class="o">)</span> <span class="o">=</span> 0x7f4ca6118000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca611b000, 139304, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca611b000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\237\2\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class="o">)</span> <span class="o">=</span> <span class="m">784</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\4\0\0\0 \0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&#34;</span>..., 48, 848<span class="o">)</span> <span class="o">=</span> <span class="m">48</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0i8\235HZ\227\223\333\350s\360\352,\223\340.&#34;</span>..., 68, 896<span class="o">)</span> <span class="o">=</span> <span class="m">68</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>2216304, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class="o">)</span> <span class="o">=</span> <span class="m">784</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 2260560, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5ede000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5f06000, 1658880, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x28000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5f06000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca609b000, 360448, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1bd000<span class="o">)</span> <span class="o">=</span> 0x7f4ca609b000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca60f3000, 24576, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x214000<span class="o">)</span> <span class="o">=</span> 0x7f4ca60f3000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca60f9000, 52816, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca60f9000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libsystemd.so.0&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>807936, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 812384, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5e17000
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5e2a000, 700416, PROT_NONE<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5e2a000, 520192, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x13000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5e2a000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5ea9000, 176128, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x92000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5ea9000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5ed5000, 32768, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xbd000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5ed5000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5edd000, 1376, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5edd000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/liblzma.so.5&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>170456, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 172296, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5dec000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5def000, 110592, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x3000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5def000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5e0a000, 45056, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1e000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5e0a000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5e15000, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x28000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5e15000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libzstd.so.1&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>841808, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 843832, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5d1d000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5d27000, 729088, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xa000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5d27000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5dd9000, 69632, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xbc000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5dd9000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5dea000, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xcc000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5dea000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/liblz4.so.1&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>125152, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5d1b000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 127072, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cfb000
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5cfd000, 114688, PROT_NONE<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5cfd000, 102400, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x2000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cfd000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5d16000, 8192, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1b000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5d16000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5d19000, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1d000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5d19000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libcap.so.2&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>39024, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 41016, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cf0000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5cf3000, 16384, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x3000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cf3000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5cf7000, 8192, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x7000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cf7000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5cf9000, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x8000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cf9000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libgcrypt.so.20&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>1296312, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 1299576, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5bb2000
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5bc1000, 1200128, PROT_NONE<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5bc1000, 942080, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xf000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5bc1000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5ca7000, 253952, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xf5000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5ca7000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5ce6000, 36864, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x133000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5ce6000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5cef000, 1144, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5cef000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libgpg-error.so.0&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>149760, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 151992, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5b8c000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5b90000, 90112, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x4000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5b90000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5ba6000, 40960, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1a000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5ba6000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7f4ca5bb0000, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x23000<span class="o">)</span> <span class="o">=</span> 0x7f4ca5bb0000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5b8a000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 12288, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5b87000
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>ARCH_SET_FS, 0x7f4ca5b877c0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">set_tid_address<span class="o">(</span>0x7f4ca5b87a90<span class="o">)</span>         <span class="o">=</span> <span class="m">1646</span>
</span></span><span class="line"><span class="cl">set_robust_list<span class="o">(</span>0x7f4ca5b87aa0, 24<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rseq<span class="o">(</span>0x7f4ca5b88160, 0x20, 0, 0x53053053<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca60f3000, 16384, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5bb0000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5ce6000, 12288, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5cf9000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5d19000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5dea000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5e15000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca5ed5000, 28672, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca6118000, 8192, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x55d0cbbd6000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7f4ca6184000, 8192, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">prlimit64<span class="o">(</span>0, RLIMIT_STACK, NULL, <span class="o">{</span><span class="nv">rlim_cur</span><span class="o">=</span>8192*1024, <span class="nv">rlim_max</span><span class="o">=</span>RLIM64_INFINITY<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">munmap<span class="o">(</span>0x7f4ca613e000, 46367<span class="o">)</span>           <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">getrandom<span class="o">(</span><span class="s2">&#34;\xc0\x5f\x86\x25\xbb\x1a\x8a\xe5&#34;</span>, 8, GRND_NONBLOCK<span class="o">)</span> <span class="o">=</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55d0cc7da000
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>0x55d0cc7fb000<span class="o">)</span>                     <span class="o">=</span> 0x55d0cc7fb000
</span></span><span class="line"><span class="cl">prctl<span class="o">(</span>PR_CAPBSET_READ, CAP_MAC_OVERRIDE<span class="o">)</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">prctl<span class="o">(</span>PR_CAPBSET_READ, 0x30 /* CAP_??? */<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
</span></span><span class="line"><span class="cl">prctl<span class="o">(</span>PR_CAPBSET_READ, CAP_CHECKPOINT_RESTORE<span class="o">)</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">prctl<span class="o">(</span>PR_CAPBSET_READ, 0x2c /* CAP_??? */<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
</span></span><span class="line"><span class="cl">prctl<span class="o">(</span>PR_CAPBSET_READ, 0x2a /* CAP_??? */<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
</span></span><span class="line"><span class="cl">prctl<span class="o">(</span>PR_CAPBSET_READ, 0x29 /* CAP_??? */<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/self/auxv&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0400, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;!\0\0\0\0\0\0\0\0\200\364l\374\177\0\0003\0\0\0\0\0\0\0\360\6\0\0\0\0\0\0&#34;</span>..., 1024<span class="o">)</span> <span class="o">=</span> <span class="m">336</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/sys/kernel/osrelease&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0444, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;5.15.90.1-microsoft-standard-WSL&#34;</span>..., 1024<span class="o">)</span> <span class="o">=</span> <span class="m">34</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/sys/devices/system/cpu/online&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;0-15\n&#34;</span>, 1024<span class="o">)</span>                 <span class="o">=</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/self/auxv&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0400, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;!\0\0\0\0\0\0\0\0\200\364l\374\177\0\0003\0\0\0\0\0\0\0\360\6\0\0\0\0\0\0&#34;</span>..., 1024<span class="o">)</span> <span class="o">=</span> <span class="m">336</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/locale-archive&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>6213280, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 6213280, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca559a000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale/locale.alias&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>2996, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;# Locale name alias data base.\n#&#34;</span>..., 4096<span class="o">)</span> <span class="o">=</span> <span class="m">2996</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, 4096<span class="o">)</span>                       <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_IDENTIFICATION&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_IDENTIFICATION&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>258, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 258, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca6183000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>27002, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 27002, PROT_READ, MAP_SHARED, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca6143000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">futex<span class="o">(</span>0x7f4ca60f8a6c, FUTEX_WAKE_PRIVATE, 2147483647<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_MEASUREMENT&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_MEASUREMENT&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>23, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 23, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca6142000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_TELEPHONE&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_TELEPHONE&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>47, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 47, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca6141000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_ADDRESS&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_ADDRESS&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>127, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 127, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca6140000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_NAME&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_NAME&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>62, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 62, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca613f000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_PAPER&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_PAPER&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>34, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 34, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca613e000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_MESSAGES&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_MESSAGES&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFDIR<span class="p">|</span>0755, <span class="nv">st_size</span><span class="o">=</span>4096, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_MESSAGES/SYS_LC_MESSAGES&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>48, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 48, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5599000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_MONETARY&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_MONETARY&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>270, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 270, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5598000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_COLLATE&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_COLLATE&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>1406, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 1406, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5597000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_TIME&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_TIME&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>3360, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 3360, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5596000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_NUMERIC&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_NUMERIC&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>50, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 50, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca5595000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.UTF-8/LC_CTYPE&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/lib/locale/C.utf8/LC_CTYPE&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>353616, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 353616, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca553e000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale/C.UTF-8/LC_MESSAGES/procps-ng.mo&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale/C.utf8/LC_MESSAGES/procps-ng.mo&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale/C/LC_MESSAGES/procps-ng.mo&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale-langpack/C.UTF-8/LC_MESSAGES/procps-ng.mo&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale-langpack/C.utf8/LC_MESSAGES/procps-ng.mo&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/usr/share/locale-langpack/C/LC_MESSAGES/procps-ng.mo&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/self/maps&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">dup3<span class="o">(</span>3, 0, 0<span class="o">)</span>                           <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">shmget<span class="o">(</span>IPC_PRIVATE, 42, IPC_CREAT<span class="p">|</span>0666<span class="o">)</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">shmat<span class="o">(</span>1, NULL, SHM_RDONLY<span class="o">)</span>              <span class="o">=</span> 0x7f4ca553d000
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>0, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0444, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>0, <span class="s2">&#34;55d0cbbce000-55d0cbbd0000 r--p 0&#34;</span>..., 1024<span class="o">)</span> <span class="o">=</span> <span class="m">1024</span>
</span></span><span class="line"><span class="cl">shmdt<span class="o">(</span>0x7f4ca553d000<span class="o">)</span>                   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">shmctl<span class="o">(</span>1, IPC_RMID, NULL<span class="o">)</span>               <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/self/task&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFDIR<span class="p">|</span>0555, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 135168, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca551d000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 135168, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f4ca54fc000
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/1431&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFDIR<span class="p">|</span>0555, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/1431/stat&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;1431 (minimal) t 1398 1431 339 3&#34;</span>..., 1024<span class="o">)</span> <span class="o">=</span> <span class="m">272</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/1431/cmdline&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;/mnt/d/work for vscode/chapter12&#34;</span>..., 2047<span class="o">)</span> <span class="o">=</span> <span class="m">41</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>1, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFCHR<span class="p">|</span>0620, <span class="nv">st_rdev</span><span class="o">=</span>makedev<span class="o">(</span>0x88, 0x4<span class="o">)</span>, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;1431:   /mnt/d/work for vscode/c&#34;</span>..., 491431:   /mnt/d/work <span class="k">for</span> vscode/chapter12/minimal
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">49</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/proc/1431/maps&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0444, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;00400000-00401000 r--p 00000000 &#34;</span>..., 1024<span class="o">)</span> <span class="o">=</span> <span class="m">469</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;0000000000400000      4K r---- m&#34;</span>..., <span class="m">390000000000400000</span>      4K r---- minimal
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">39</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;0000000000401000      4K r-x-- m&#34;</span>..., <span class="m">390000000000401000</span>      4K r-x-- minimal
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">39</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;00007ffff7ff9000     16K r----  &#34;</span>..., 4200007ffff7ff9000     16K r----   <span class="o">[</span> anon <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">42</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;00007ffff7ffd000      8K r-x--  &#34;</span>..., 4200007ffff7ffd000      8K r-x--   <span class="o">[</span> anon <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">42</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;00007ffffffdd000    136K rw---  &#34;</span>..., 4300007ffffffdd000    136K rw---   <span class="o">[</span> stack <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">43</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, 1024<span class="o">)</span>                       <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34; total              168K\n&#34;</span>, <span class="m">25</span> total              168K
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="o">=</span> <span class="m">25</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>1<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">close<span class="o">(</span>2<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">lseek<span class="o">(</span>0, -412, SEEK_CUR<span class="o">)</span>                <span class="o">=</span> <span class="m">612</span>
</span></span><span class="line"><span class="cl">exit_group<span class="o">(</span>0<span class="o">)</span>                           <span class="o">=</span> ?
</span></span><span class="line"><span class="cl">+++ exited with <span class="m">0</span> +++
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>关键信息<code>openat(AT_FDCWD, &quot;/proc/1431/maps&quot;, O_RDONLY) = 3</code></p>
</li>
<li>
<p>???</p>
</li>
<li>
<p><code>cat</code>一下看看里面是啥</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">┌──<span class="o">(</span>jungle㉿LAPTOP-A7S3TAA4<span class="o">)</span>-<span class="o">[</span>/mnt/d/work <span class="k">for</span> vscode/chapter12<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ cat /proc/1431/maps 
</span></span><span class="line"><span class="cl">00400000-00401000 r--p <span class="m">00000000</span> 00:4a <span class="m">3377699720805767</span>                   /mnt/d/work <span class="k">for</span> vscode/chapter12/minimal
</span></span><span class="line"><span class="cl">00401000-00402000 r-xp <span class="m">00001000</span> 00:4a <span class="m">3377699720805767</span>                   /mnt/d/work <span class="k">for</span> vscode/chapter12/minimal
</span></span><span class="line"><span class="cl">7ffff7ff9000-7ffff7ffd000 r--p <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>vvar<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffff7ffd000-7ffff7fff000 r-xp <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>vdso<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffffffdd000-7ffffffff000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>stack<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用<code>man 5 proc</code>多阅读</li>
</ul>
<h3 id="操作系统提供查看进程地址空间的机制">操作系统提供查看进程地址空间的机制</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -static deom.c -o deom
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>查看<code>maps</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /proc/2017/maps
</span></span><span class="line"><span class="cl">00400000-00401000 r--p <span class="m">00000000</span> 00:4a <span class="m">1688849860573486</span>                   /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">00401000-00498000 r-xp <span class="m">00001000</span> 00:4a <span class="m">1688849860573486</span>                   /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">00498000-004c1000 r--p <span class="m">00098000</span> 00:4a <span class="m">1688849860573486</span>                   /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">004c1000-004c8000 rw-p 000c0000 00:4a <span class="m">1688849860573486</span>                   /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">004c8000-004cd000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>                                  <span class="o">[</span>heap<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffff7ff9000-7ffff7ffd000 r--p <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>vvar<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffff7ffd000-7ffff7fff000 r-xp <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>vdso<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffffffdd000-7ffffffff000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>stack<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>readelf</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ readelf deom -l
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Elf file <span class="nb">type</span> is EXEC <span class="o">(</span>Executable file<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entry point 0x401620
</span></span><span class="line"><span class="cl">There are <span class="m">10</span> program headers, starting at offset <span class="m">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Program Headers:
</span></span><span class="line"><span class="cl">  Type           Offset             VirtAddr           PhysAddr
</span></span><span class="line"><span class="cl">                 FileSiz            MemSiz              Flags  Align
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000
</span></span><span class="line"><span class="cl">                 0x0000000000000528 0x0000000000000528  R      0x1000
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000001000 0x0000000000401000 0x0000000000401000
</span></span><span class="line"><span class="cl">                 0x00000000000964bd 0x00000000000964bd  R E    0x1000
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000098000 0x0000000000498000 0x0000000000498000
</span></span><span class="line"><span class="cl">                 0x0000000000028476 0x0000000000028476  R      0x1000
</span></span><span class="line"><span class="cl">  LOAD           0x00000000000c07b0 0x00000000004c17b0 0x00000000004c17b0
</span></span><span class="line"><span class="cl">                 0x0000000000005ae0 0x000000000000b490  RW     0x1000
</span></span><span class="line"><span class="cl">  NOTE           0x0000000000000270 0x0000000000400270 0x0000000000400270
</span></span><span class="line"><span class="cl">                 0x0000000000000030 0x0000000000000030  R      0x8
</span></span><span class="line"><span class="cl">  NOTE           0x00000000000002a0 0x00000000004002a0 0x00000000004002a0
</span></span><span class="line"><span class="cl">                 0x0000000000000044 0x0000000000000044  R      0x4
</span></span><span class="line"><span class="cl">  TLS            0x00000000000c07b0 0x00000000004c17b0 0x00000000004c17b0
</span></span><span class="line"><span class="cl">                 0x0000000000000020 0x0000000000000068  R      0x8
</span></span><span class="line"><span class="cl">  GNU_PROPERTY   0x0000000000000270 0x0000000000400270 0x0000000000400270
</span></span><span class="line"><span class="cl">                 0x0000000000000030 0x0000000000000030  R      0x8
</span></span><span class="line"><span class="cl">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">                 0x0000000000000000 0x0000000000000000  RW     0x10
</span></span><span class="line"><span class="cl">  GNU_RELRO      0x00000000000c07b0 0x00000000004c17b0 0x00000000004c17b0
</span></span><span class="line"><span class="cl">                 0x0000000000003850 0x0000000000003850  R      0x1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Section to Segment mapping:
</span></span><span class="line"><span class="cl">  Segment Sections...
</span></span><span class="line"><span class="cl">   <span class="m">00</span>     .note.gnu.property .note.gnu.build-id .note.ABI-tag .rela.plt 
</span></span><span class="line"><span class="cl">   <span class="m">01</span>     .init .plt .text __libc_freeres_fn .fini 
</span></span><span class="line"><span class="cl">   <span class="m">02</span>     .rodata .stapsdt.base .eh_frame .gcc_except_table 
</span></span><span class="line"><span class="cl">   <span class="m">03</span>     .tdata .init_array .fini_array .data.rel.ro .got .got.plt .data __libc_subfreeres __libc_IO_vtables __libc_atexit .bss __libc_freeres_ptrs 
</span></span><span class="line"><span class="cl">   <span class="m">04</span>     .note.gnu.property 
</span></span><span class="line"><span class="cl">   <span class="m">05</span>     .note.gnu.build-id .note.ABI-tag 
</span></span><span class="line"><span class="cl">   <span class="m">06</span>     .tdata .tbss 
</span></span><span class="line"><span class="cl">   <span class="m">07</span>     .note.gnu.property 
</span></span><span class="line"><span class="cl">   <span class="m">08</span>     
</span></span><span class="line"><span class="cl">   <span class="m">09</span>     .tdata .init_array .fini_array .data.rel.ro .got 
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>动态链接</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /proc/2319/maps 
</span></span><span class="line"><span class="cl">555555554000-555555555000 r--p <span class="m">00000000</span> 00:4a <span class="m">1970324837284142</span>           /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">555555555000-555555556000 r-xp <span class="m">00001000</span> 00:4a <span class="m">1970324837284142</span>           /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">555555556000-555555557000 r--p <span class="m">00002000</span> 00:4a <span class="m">1970324837284142</span>           /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">555555557000-555555559000 rw-p <span class="m">00002000</span> 00:4a <span class="m">1970324837284142</span>           /mnt/d/work <span class="k">for</span> vscode/chapter12/deom
</span></span><span class="line"><span class="cl">7ffff7fbd000-7ffff7fc1000 r--p <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>vvar<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffff7fc1000-7ffff7fc3000 r-xp <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>vdso<span class="o">]</span>
</span></span><span class="line"><span class="cl">7ffff7fc3000-7ffff7fc5000 r--p <span class="m">00000000</span> 08:20 <span class="m">6303</span>                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">7ffff7fc5000-7ffff7fef000 r-xp <span class="m">00002000</span> 08:20 <span class="m">6303</span>                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">7ffff7fef000-7ffff7ffa000 r--p 0002c000 08:20 <span class="m">6303</span>                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">7ffff7ffb000-7ffff7fff000 rw-p <span class="m">00037000</span> 08:20 <span class="m">6303</span>                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">7ffffffdd000-7ffffffff000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>                          <span class="o">[</span>stack<span class="o">]</span>                                                                                
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>多了链接库的数据</li>
</ul>
<p>RTFM: <code>/proc/[pid]/maps</code> (man 5 proc)</p>
<ul>
<li>
<p>进程地址空间中的每一段</p>
<ul>
<li>地址 (范围) 和权限 (rwxsp)</li>
<li>对应的文件: offset, dev, inode, pathname
<ul>
<li>TFM 里有更详细的解释</li>
</ul>
</li>
</ul>
</li>
<li>
<p>和 readelf (-l) 里的信息互相验证</p>
<ul>
<li>课后习题：定义一些代码/数据，观察变化</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">address           perms offset   dev   inode      pathname
</span></span><span class="line"><span class="cl">00400000-00401000 r--p  <span class="m">00000000</span> fd:00 <span class="m">525733</span>     a.out
</span></span><span class="line"><span class="cl">00401000-00495000 r-xp  <span class="m">00001000</span> fd:00 <span class="m">525733</span>     a.out
</span></span><span class="line"><span class="cl">00495000-004bc000 r--p  <span class="m">00095000</span> fd:00 <span class="m">525733</span>     a.out
</span></span><span class="line"><span class="cl">004bd000-004c3000 rw-p  000bc000 fd:00 <span class="m">525733</span>     a.out
</span></span><span class="line"><span class="cl">004c3000-004c4000 rw-p  <span class="m">00000000</span> 00:00 <span class="m">0</span>          <span class="o">[</span>heap<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="更完整的地址空间映象">更完整的地址空间映象</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="m">0000555555554000</span> r--p     a.out
</span></span><span class="line"><span class="cl"><span class="m">0000555555555000</span> r-xp     a.out
</span></span><span class="line"><span class="cl"><span class="m">0000555555556000</span> r--p     a.out
</span></span><span class="line"><span class="cl"><span class="m">0000555555557000</span> r--p     a.out
</span></span><span class="line"><span class="cl"><span class="m">0000555555558000</span> rw-p     a.out
</span></span><span class="line"><span class="cl">00007ffff7dc1000 r--p     libc-2.31.so
</span></span><span class="line"><span class="cl">00007ffff7de3000 r-xp     libc-2.31.so
</span></span><span class="line"><span class="cl">00007ffff7f5b000 r--p     libc-2.31.so
</span></span><span class="line"><span class="cl">00007ffff7fa9000 r--p     libc-2.31.so
</span></span><span class="line"><span class="cl">00007ffff7fad000 rw-p     libc-2.31.so
</span></span><span class="line"><span class="cl">00007ffff7faf000 rw-p     <span class="o">(</span>这是什么？<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ffff7fcb000 r--p     <span class="o">[</span>vvar<span class="o">]</span> <span class="o">(</span>这又是什么？<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ffff7fce000 r-xp     <span class="o">[</span>vdso<span class="o">]</span> <span class="o">(</span>这叒是什么？<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ffff7fcf000 r--p     <span class="o">(</span>省略相似的 ld-2.31.so<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ffffffde000 rw-p     <span class="o">[</span>stack<span class="o">]</span>
</span></span><span class="line"><span class="cl">ffffffffff600000 --xp     <span class="o">[</span>vsyscall<span class="o">]</span> <span class="o">(</span>这叕是什么？<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>是不是 bss? 给我们的代码加一个大数组试试！</li>
</ul>
<h3 id="rtfm-5-proc-我们发现的宝藏">RTFM (5 proc): 我们发现的宝藏</h3>
<blockquote>
<p>vdso (7): Virtual system calls: 只读的系统调用也许可以不陷入内核执行。</p>
</blockquote>
<ul>
<li><b>无需陷入内核的系统调用</b>
<ul>
<li>例子: time (2)
<ul>
<li>直接调试 <a href="https://jyywiki.cn/pages/OS/2022/demos/vdso.c" target="_blank" rel="noopener noreffer">vdso.c</a></li>
<li>时间：内核维护秒级的时间 (所有进程映射同一个页面)</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="nf">gettime</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">timeval</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// trapless system call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mf">1000000.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Time stamp: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span> <span class="c1">// trapless system call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">double</span> <span class="n">st</span> <span class="o">=</span> <span class="n">gettime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">gettime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Time: %.6lfs</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>例子: gettimeofday (2)
<ul>
<li><a href="https://elixir.bootlin.com/linux/latest/source/lib/vdso/gettimeofday.c#L49" target="_blank" rel="noopener noreffer">RTFSC</a> (非常聪明的实现)</li>
</ul>
</li>
<li>更多的例子：RTFM
<ul>
<li>计算机系统里没有魔法！我们理解了进程地址空间的<font color="red">全部</font>！</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-4.png" title="/img/Operating System/chapter12-4.png" data-thumbnail="/img/Operating System/chapter12-4.png" data-sub-html="<h2>time address</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-4.png"
            data-srcset="/img/Operating%20System/chapter12-4.png, /img/Operating%20System/chapter12-4.png 1.5x, /img/Operating%20System/chapter12-4.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-4.png" />
    </a><figcaption class="image-caption"><code>time address</code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-5.png" title="/img/Operating System/chapter12-5.png" data-thumbnail="/img/Operating System/chapter12-5.png" data-sub-html="<h2>vdso</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-5.png"
            data-srcset="/img/Operating%20System/chapter12-5.png, /img/Operating%20System/chapter12-5.png 1.5x, /img/Operating%20System/chapter12-5.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-5.png" />
    </a><figcaption class="image-caption"><code>vdso</code></figcaption>
    </figure>
<ul>
<li>$time\ address \in vdso$，而<code>vdso</code>没有在<code>libc</code>这个位置上面</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-6.jpg" title="/img/Operating System/chapter12-6.jpg" data-thumbnail="/img/Operating System/chapter12-6.jpg" data-sub-html="<h2>实现方式</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-6.jpg"
            data-srcset="/img/Operating%20System/chapter12-6.jpg, /img/Operating%20System/chapter12-6.jpg 1.5x, /img/Operating%20System/chapter12-6.jpg 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-6.jpg" />
    </a><figcaption class="image-caption"><code>实现方式</code></figcaption>
    </figure>
<ul>
<li>源码</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_TIME_NS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">int</span> <span class="nf">do_hres_timens</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">vdso_data</span> <span class="o">*</span><span class="n">vdns</span><span class="p">,</span> <span class="n">clockid_t</span> <span class="n">clk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="k">struct</span> <span class="n">__kernel_timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">vdso_data</span> <span class="o">*</span><span class="n">vd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">timens_offset</span> <span class="o">*</span><span class="n">offs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdns</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">[</span><span class="n">clk</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">vdso_timestamp</span> <span class="o">*</span><span class="n">vdso_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s64</span> <span class="n">sec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vd</span> <span class="o">=</span> <span class="n">vdns</span> <span class="o">-</span> <span class="p">(</span><span class="n">clk</span> <span class="o">==</span> <span class="n">CLOCK_MONOTONIC_RAW</span> <span class="o">?</span> <span class="nl">CS_RAW</span> <span class="p">:</span> <span class="n">CS_HRES_COARSE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">vd</span> <span class="o">=</span> <span class="n">__arch_get_timens_vdso_data</span><span class="p">(</span><span class="n">vd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="n">CLOCK_MONOTONIC_RAW</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">vd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vd</span><span class="p">[</span><span class="n">CS_HRES_COARSE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">vd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vd</span><span class="p">[</span><span class="n">CS_RAW</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">vdso_ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">basetime</span><span class="p">[</span><span class="n">clk</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">seq</span> <span class="o">=</span> <span class="n">vdso_read_begin</span><span class="p">(</span><span class="n">vd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">vdso_clocksource_ok</span><span class="p">(</span><span class="n">vd</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cycles</span> <span class="o">=</span> <span class="n">__arch_get_hw_counter</span><span class="p">(</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">clock_mode</span><span class="p">,</span> <span class="n">vd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">vdso_cycles_ok</span><span class="p">(</span><span class="n">cycles</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">ns</span> <span class="o">=</span> <span class="n">vdso_ts</span><span class="o">-&gt;</span><span class="n">nsec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">last</span> <span class="o">=</span> <span class="n">vd</span><span class="o">-&gt;</span><span class="n">cycle_last</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">ns</span> <span class="o">+=</span> <span class="n">vdso_calc_delta</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">vd</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">vd</span><span class="o">-&gt;</span><span class="n">mult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ns</span> <span class="o">=</span> <span class="n">vdso_shift_ns</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">vd</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">sec</span> <span class="o">=</span> <span class="n">vdso_ts</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vdso_read_retry</span><span class="p">(</span><span class="n">vd</span><span class="p">,</span> <span class="n">seq</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Add the namespace offset */</span>
</span></span><span class="line"><span class="cl">	<span class="n">sec</span> <span class="o">+=</span> <span class="n">offs</span><span class="o">-&gt;</span><span class="n">sec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">+=</span> <span class="n">offs</span><span class="o">-&gt;</span><span class="n">nsec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * Do this outside the loop: a race inside the loop could result
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * in __iter_div_u64_rem() being extremely slow.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="n">__iter_div_u64_rem</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSEC_PER_SEC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">static</span> <span class="n">__always_inline</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="k">struct</span> <span class="n">vdso_data</span> <span class="o">*</span><span class="nf">__arch_get_timens_vdso_data</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">vdso_data</span> <span class="o">*</span><span class="n">vd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">int</span> <span class="nf">do_hres_timens</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">vdso_data</span> <span class="o">*</span><span class="n">vdns</span><span class="p">,</span> <span class="n">clockid_t</span> <span class="n">clk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="k">struct</span> <span class="n">__kernel_timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="小知识-系统调用的实现">(小知识) 系统调用的实现</h3>
<blockquote>
<p>“执行系统调用时，进程陷入内核态执行”——不，不是的。</p>
</blockquote>
<ul>
<li>
<p>系统调用就是一组接口的约定，谁说一定要 <code>int</code> 指令？</p>
<ul>
<li>光一条指令就要保存 ss, rsp, cs, rip, rflags (40 字节) 到内存</li>
</ul>
</li>
<li>
<p>SYSCALL — Fast System Call</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">RCX    &lt;- RIP; (* 下条指令执行的地址 *)
</span></span><span class="line"><span class="cl">RIP    &lt;- IA32_LSTAR;
</span></span><span class="line"><span class="cl">R11    &lt;- RFLAGS;
</span></span><span class="line"><span class="cl">RFLAGS &lt;- RFLAGS &amp; ~(IA32_FMASK);
</span></span><span class="line"><span class="cl">CPL    &lt;- 0; (* 进入 Ring 0 执行 *)
</span></span><span class="line"><span class="cl">CS.Selector &lt;- IA32_STAR[47:32] &amp; 0xFFFC
</span></span><span class="line"><span class="cl">SS.Selector &lt;- IA32_STAR[47:32] + 8;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="小知识-系统调用的实现-contd">(小知识) 系统调用的实现 (cont&rsquo;d)</h3>
<ul>
<li>
<p>能不能让其他系统调用也 <code>trap</code> 进入内核？</p>
<ul>
<li>疯狂的事情也许真的是能实现的 (这算是魔法吗？)
<ul>
<li><a href="https://www.usenix.org/conference/osdi10/flexsc-flexible-system-call-scheduling-exception-less-system-calls" target="_blank" rel="noopener noreffer">FlexSC: Flexible system call scheduling with exception-less system calls</a> (OSDI'10).</li>
</ul>
</li>
</ul>
</li>
<li>
<p>使用共享内存和内核通信！</p>
<ul>
<li>
<p>内核线程在 spinning 等待系统调用的到来</p>
</li>
<li>
<p>收到系统调用请求后立即开始执行</p>
</li>
<li>
<p>进程 spin 等待系统调用完成</p>
</li>
<li>
<p>如果系统调用很多，可以打包处理</p>
</li>
</ul>
</li>
</ul>
<h2 id="进程的地址空间管理">进程的地址空间管理</h2>
<h3 id="execve-之后">Execve 之后……</h3>
<ul>
<li>
<p>进程只有少量内存映射</p>
<ul>
<li>
<p>静态链接：代码、数据、堆栈、堆区</p>
</li>
<li>
<p>动态链接：代码、数据、堆栈、堆区、INTERP (ld.so)</p>
</li>
</ul>
</li>
<li>
<p>地址空间里剩下的部分是怎么创建的？</p>
<ul>
<li>
<p>libc.so 都没有啊……</p>
</li>
<li>
<p>创建了以后，我们还能修改它吗？</p>
<ul>
<li>肯定是能的：动态链接库可以动态加载 (M4)
<ul>
<li><b>当然是通过系统调用了</b></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-7.png" title="/img/Operating System/chapter12-7.png" data-thumbnail="/img/Operating System/chapter12-7.png" data-sub-html="<h2> </h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-7.png"
            data-srcset="/img/Operating%20System/chapter12-7.png, /img/Operating%20System/chapter12-7.png 1.5x, /img/Operating%20System/chapter12-7.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-7.png" />
    </a><figcaption class="image-caption"><code> </code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-8.png" title="/img/Operating System/chapter12-8.png" data-thumbnail="/img/Operating System/chapter12-8.png" data-sub-html="<h2> </h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-8.png"
            data-srcset="/img/Operating%20System/chapter12-8.png, /img/Operating%20System/chapter12-8.png 1.5x, /img/Operating%20System/chapter12-8.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-8.png" />
    </a><figcaption class="image-caption"><code> </code></figcaption>
    </figure>
<ul>
<li>没有进入<code>main</code>的时候，看不到<code>libc</code></li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-9.png" title="/img/Operating System/chapter12-9.png" data-thumbnail="/img/Operating System/chapter12-9.png" data-sub-html="<h2> </h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-9.png"
            data-srcset="/img/Operating%20System/chapter12-9.png, /img/Operating%20System/chapter12-9.png 1.5x, /img/Operating%20System/chapter12-9.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-9.png" />
    </a><figcaption class="image-caption"><code> </code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter12-10.png" title="/img/Operating System/chapter12-10.png" data-thumbnail="/img/Operating System/chapter12-10.png" data-sub-html="<h2> </h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter12-10.png"
            data-srcset="/img/Operating%20System/chapter12-10.png, /img/Operating%20System/chapter12-10.png 1.5x, /img/Operating%20System/chapter12-10.png 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter12-10.png" />
    </a><figcaption class="image-caption"><code> </code></figcaption>
    </figure>
<ul>
<li>执行到<code>main</code>的时候，<code>libc</code>被加载进来了</li>
</ul>
<h3 id="进程的地址空间-contd">进程的地址空间 (cont&rsquo;d)</h3>
<ul>
<li>
<p>进程的地址空间 = 内存里若干连续的 “段”</p>
<ul>
<li>每一段是可访问 (读/写/执行) 的内存
<ul>
<li><b>可能映射到某个文件和/或在进程间共享</b></li>
</ul>
</li>
</ul>
</li>
<li>
<p>管理进程地址空间的系统调用</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">mmap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">munmap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 修改映射权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">mprotect</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>RTFM
<ul>
<li>说人话：<b><font color="red">状态上增加/删除/修改一段可访问的内存</font></b></li>
<li>也就是上面的示例，内存改变全靠<code>mmap</code></li>
</ul>
</li>
</ul>
<h3 id="把文件映射到进程地址空间">把文件映射到进程地址空间？</h3>
<ul>
<li>
<p>它们的确好像没有什么区别</p>
<ul>
<li>
<p>文件 = 字节序列</p>
</li>
<li>
<p>内存 = 字节序列</p>
</li>
<li>
<p>操作系统允许映射好像挺合理的……</p>
<ul>
<li>带来了很大的方便
<ul>
<li><b><code>ELF loader </code>用<code>mmap</code>非常容易实现</b>
<ul>
<li><b>解析出要加载哪部分到内存，直接<code>mmap</code>就完了</b></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ readelf -l deom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Elf file <span class="nb">type</span> is DYN <span class="o">(</span>Position-Independent Executable file<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entry point 0x1040
</span></span><span class="line"><span class="cl">There are <span class="m">13</span> program headers, starting at offset <span class="m">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Program Headers:
</span></span><span class="line"><span class="cl">  Type           Offset             VirtAddr           PhysAddr
</span></span><span class="line"><span class="cl">                 FileSiz            MemSiz              Flags  Align
</span></span><span class="line"><span class="cl">  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040
</span></span><span class="line"><span class="cl">                 0x00000000000002d8 0x00000000000002d8  R      0x8
</span></span><span class="line"><span class="cl">  INTERP         0x0000000000000318 0x0000000000000318 0x0000000000000318
</span></span><span class="line"><span class="cl">                 0x000000000000001c 0x000000000000001c  R      0x1
</span></span><span class="line"><span class="cl">      <span class="o">[</span>Requesting program interpreter: /lib64/ld-linux-x86-64.so.2<span class="o">]</span>
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">                 0x00000000000005f0 0x00000000000005f0  R      0x1000
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000001000 0x0000000000001000 0x0000000000001000
</span></span><span class="line"><span class="cl">                 0x0000000000000145 0x0000000000000145  R E    0x1000
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000002000 0x0000000000002000 0x0000000000002000
</span></span><span class="line"><span class="cl">                 0x00000000000000c4 0x00000000000000c4  R      0x1000
</span></span><span class="line"><span class="cl">  LOAD           0x0000000000002df0 0x0000000000003df0 0x0000000000003df0
</span></span><span class="line"><span class="cl">                 0x0000000000000220 0x0000000000000228  RW     0x1000
</span></span><span class="line"><span class="cl">  DYNAMIC        0x0000000000002e00 0x0000000000003e00 0x0000000000003e00
</span></span><span class="line"><span class="cl">                 0x00000000000001c0 0x00000000000001c0  RW     0x8
</span></span><span class="line"><span class="cl">  NOTE           0x0000000000000338 0x0000000000000338 0x0000000000000338
</span></span><span class="line"><span class="cl">                 0x0000000000000030 0x0000000000000030  R      0x8
</span></span><span class="line"><span class="cl">  NOTE           0x0000000000000368 0x0000000000000368 0x0000000000000368
</span></span><span class="line"><span class="cl">                 0x0000000000000044 0x0000000000000044  R      0x4
</span></span><span class="line"><span class="cl">  GNU_PROPERTY   0x0000000000000338 0x0000000000000338 0x0000000000000338
</span></span><span class="line"><span class="cl">                 0x0000000000000030 0x0000000000000030  R      0x8
</span></span><span class="line"><span class="cl">  GNU_EH_FRAME   0x0000000000002004 0x0000000000002004 0x0000000000002004
</span></span><span class="line"><span class="cl">                 0x000000000000002c 0x000000000000002c  R      0x4
</span></span><span class="line"><span class="cl">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">                 0x0000000000000000 0x0000000000000000  RW     0x10
</span></span><span class="line"><span class="cl">  GNU_RELRO      0x0000000000002df0 0x0000000000003df0 0x0000000000003df0
</span></span><span class="line"><span class="cl">                 0x0000000000000210 0x0000000000000210  R      0x1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Section to Segment mapping:
</span></span><span class="line"><span class="cl">  Segment Sections...
</span></span><span class="line"><span class="cl">   <span class="m">00</span>     
</span></span><span class="line"><span class="cl">   <span class="m">01</span>     .interp 
</span></span><span class="line"><span class="cl">   <span class="m">02</span>     .interp .note.gnu.property .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn 
</span></span><span class="line"><span class="cl">   <span class="m">03</span>     .init .plt .plt.got .text .fini 
</span></span><span class="line"><span class="cl">   <span class="m">04</span>     .rodata .eh_frame_hdr .eh_frame 
</span></span><span class="line"><span class="cl">   <span class="m">05</span>     .init_array .fini_array .dynamic .got .data .bss 
</span></span><span class="line"><span class="cl">   <span class="m">06</span>     .dynamic 
</span></span><span class="line"><span class="cl">   <span class="m">07</span>     .note.gnu.property 
</span></span><span class="line"><span class="cl">   <span class="m">08</span>     .note.gnu.build-id .note.ABI-tag 
</span></span><span class="line"><span class="cl">   <span class="m">09</span>     .note.gnu.property 
</span></span><span class="line"><span class="cl">   <span class="m">10</span>     .eh_frame_hdr 
</span></span><span class="line"><span class="cl">   <span class="m">11</span>     
</span></span><span class="line"><span class="cl">   <span class="m">12</span>     .init_array .fini_array .dynamic .got 
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>readelf</code>告诉系统该进程载入的时候要把什么东西加载到哪里，<code>OS</code>通过<code>mmap</code>进行加载</li>
</ul>
<h3 id="使用-memory-mapping">使用 Memory Mapping</h3>
<p>Example 1:</p>
<ul>
<li>用 mmap 申请大量内存空间(<a href="https://jyywiki.cn/pages/OS/2022/demos/mmap-alloc.c" target="_blank" rel="noopener noreffer">mmap-alloc.c</a>)
<ul>
<li>瞬间完成</li>
<li>不妨<code>strace/gdb</code>看一下</li>
<li><code>libc</code> 的 <code>malloc/free</code> 在初始空间用完后使用 <code>sbrk/mmap</code> 申请空间</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define GiB * (1024LL * 1024 * 1024)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">volatile</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span> <span class="n">GiB</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;mmap: %lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">intptr_t</span><span class="p">)</span><span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;cannot map&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span> <span class="n">GiB</span><span class="p">)</span> <span class="o">=</span> <span class="mi">114</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span> <span class="n">GiB</span><span class="p">)</span> <span class="o">=</span> <span class="mi">514</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Read get: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span> <span class="n">GiB</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Read get: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span> <span class="n">GiB</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">time</span> ./mmap-alloc
</span></span><span class="line"><span class="cl">mmap: 7f091f6c8000
</span></span><span class="line"><span class="cl">Read get: <span class="m">114</span>
</span></span><span class="line"><span class="cl">Read get: <span class="m">514</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0.01s
</span></span><span class="line"><span class="cl">user    0.00s
</span></span><span class="line"><span class="cl">sys     0.00s
</span></span><span class="line"><span class="cl">cpu     47%
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">strace -T ./mmap-alloc
</span></span><span class="line"><span class="cl">execve<span class="o">(</span><span class="s2">&#34;./mmap-alloc&#34;</span>, <span class="o">[</span><span class="s2">&#34;./mmap-alloc&#34;</span><span class="o">]</span>, 0x7ffdbcd061d8 /* <span class="m">41</span> vars */<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> &lt;0.005476&gt;
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>0x3001 /* ARCH_??? */, 0x7fff0b4c4fc0<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span> &lt;0.000046&gt;
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x1fcd000 &lt;0.000034&gt;
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>0x1fcddc0<span class="o">)</span>                          <span class="o">=</span> 0x1fcddc0 &lt;0.000031&gt;
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>ARCH_SET_FS, 0x1fcd3c0<span class="o">)</span>      <span class="o">=</span> <span class="m">0</span> &lt;0.000027&gt;
</span></span><span class="line"><span class="cl">set_tid_address<span class="o">(</span>0x1fcd690<span class="o">)</span>              <span class="o">=</span> <span class="m">4689</span> &lt;0.000037&gt;
</span></span><span class="line"><span class="cl">set_robust_list<span class="o">(</span>0x1fcd6a0, 24<span class="o">)</span>          <span class="o">=</span> <span class="m">0</span> &lt;0.000027&gt;
</span></span><span class="line"><span class="cl">rseq<span class="o">(</span>0x1fcdd60, 0x20, 0, 0x53053053<span class="o">)</span>    <span class="o">=</span> <span class="m">0</span> &lt;0.000024&gt;
</span></span><span class="line"><span class="cl">uname<span class="o">({</span><span class="nv">sysname</span><span class="o">=</span><span class="s2">&#34;Linux&#34;</span>, <span class="nv">nodename</span><span class="o">=</span><span class="s2">&#34;LAPTOP-A7S3TAA4&#34;</span>, ...<span class="o">})</span> <span class="o">=</span> <span class="m">0</span> &lt;0.000026&gt;
</span></span><span class="line"><span class="cl">prlimit64<span class="o">(</span>0, RLIMIT_STACK, NULL, <span class="o">{</span><span class="nv">rlim_cur</span><span class="o">=</span>8192*1024, <span class="nv">rlim_max</span><span class="o">=</span>RLIM64_INFINITY<span class="o">})</span> <span class="o">=</span> <span class="m">0</span> &lt;0.000038&gt;
</span></span><span class="line"><span class="cl">readlink<span class="o">(</span><span class="s2">&#34;/proc/self/exe&#34;</span>, <span class="s2">&#34;/mnt/d/work for vscode/chapter12&#34;</span>..., 4096<span class="o">)</span> <span class="o">=</span> <span class="m">43</span> &lt;0.000143&gt;
</span></span><span class="line"><span class="cl">getrandom<span class="o">(</span><span class="s2">&#34;\x2d\xdd\xc2\x27\x6a\x77\x7d\x7f&#34;</span>, 8, GRND_NONBLOCK<span class="o">)</span> <span class="o">=</span> <span class="m">8</span> &lt;0.000028&gt;
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>0x1feedc0<span class="o">)</span>                          <span class="o">=</span> 0x1feedc0 &lt;0.000043&gt;
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>0x1fef000<span class="o">)</span>                          <span class="o">=</span> 0x1fef000 &lt;0.000047&gt;
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x4c1000, 16384, PROT_READ<span class="o">)</span>    <span class="o">=</span> <span class="m">0</span> &lt;0.000043&gt;
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 3221225472, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7f1dcee47000 &lt;0.000041&gt;
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>1, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFCHR<span class="p">|</span>0620, <span class="nv">st_rdev</span><span class="o">=</span>makedev<span class="o">(</span>0x88, 0x4<span class="o">)</span>, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> &lt;0.000048&gt;
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;mmap: 7f1dcee47000\n&#34;</span>, 19mmap: 7f1dcee47000
</span></span><span class="line"><span class="cl"><span class="o">)</span>    <span class="o">=</span> <span class="m">19</span> &lt;0.000067&gt;
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;Read get: 114\n&#34;</span>, 14Read get: <span class="m">114</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>         <span class="o">=</span> <span class="m">14</span> &lt;0.000050&gt;
</span></span><span class="line"><span class="cl">write<span class="o">(</span>1, <span class="s2">&#34;Read get: 514\n&#34;</span>, 14Read get: <span class="m">514</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>         <span class="o">=</span> <span class="m">14</span> &lt;0.000046&gt;
</span></span><span class="line"><span class="cl">exit_group<span class="o">(</span>0<span class="o">)</span>                           <span class="o">=</span> ?
</span></span><span class="line"><span class="cl">+++ exited with <span class="m">0</span> +++
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>mmap</code>只花了0.000041s！</li>
</ul>
<p>Example 2:</p>
<ul>
<li>用 mmap 映射整个磁盘(<a href="https://jyywiki.cn/pages/OS/2022/demos/mmap-disk.py" target="_blank" rel="noopener noreffer">mmap-disk.py</a>)
<ul>
<li>瞬间完成</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">mmap</span><span class="o">,</span> <span class="nn">hexdump</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/sda&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mm</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hexdump</span><span class="o">.</span><span class="n">hexdump</span><span class="p">(</span><span class="n">mm</span><span class="p">[:</span><span class="mi">512</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="memory-mapped-file-一致性">Memory-Mapped File: 一致性</h3>
<ul>
<li>但我们好像带来了一些问题……
<ul>
<li>如果把页面映射到文件
<ul>
<li>修改什么时候生效？
<ul>
<li>立即生效：那会造成巨大量的磁盘 I/O</li>
<li>unmap (进程终止) 时生效：好像又太迟了……</li>
</ul>
</li>
<li>若干个映射到同一个文件的进程？
<ul>
<li>共享一份内存？</li>
<li>各自有本地的副本？</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>请查阅手册，看看操作系统是如何规定这些操作的行为的</p>
<ul>
<li>
<p>例如阅读 <code>msync (2)</code></p>
</li>
<li>
<p>这才是操作系统真正的复杂性</p>
</li>
</ul>
</li>
</ul>
<h2 id="地址空间的隔离">地址空间的隔离</h2>
<h3 id="地址空间实现进程隔离">地址空间：实现进程隔离</h3>
<ul>
<li>
<p>每个 <code>*ptr</code> 都只能访问本进程 (状态机) 的内存</p>
<ul>
<li>
<p>除非 mmap 显示指定、映射共享文件或共享内存多线程</p>
</li>
<li>
<p>实现了操作系统最重要的功能：进程之间的隔离</p>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>任何一个程序都不能因为 <code>bug</code> 或恶意行为侵犯其他程序执行</p>
<ul>
<li>
<p>“连方法都没有”</p>
</li>
<li>
<p>吗……？</p>
</li>
</ul>
</li>
</ul>
<h3 id="电子游戏的上一个黄金时代">电子游戏的上一个黄金时代</h3>
<ul>
<li>电子竞技的先行者：“即时战略游戏” (Real-Time Strategy)
<ul>
<li><a href="https://www.bilibili.com/video/BV1Yq4y1G7bQ" target="_blank" rel="noopener noreffer">Command and Conquer</a> (Westwood), Starcraft (<del>Microsoft</del>), &hellip;
<ul>
<li>如果我们想 “侵犯” 游戏的执行……呢？</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="前互联网时代的神器-1-金山游侠">前互联网时代的神器 (1): 金山游侠</h3>
<ul>
<li>
<p><font color="red">在进程的内存中找到代表 “金钱”、“生命” 的重要属性并且改掉</font></p>
</li>
<li>
<p>只要有访问其他进程内存和在程序上 “悬浮显示” 的 API 即可</p>
<ul>
<li>
<p>想象成是另一个进程内存的 “调试器”</p>
</li>
<li>
<p>在 Linux 中可以轻松拥有：<a href="https://jyywiki.cn/pages/OS/2022/demos/dosbox-hack.c" target="_blank" rel="noopener noreffer">dosbox-hack.c</a></p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LENGTH(arr)  (sizeof(arr) / sizeof(arr[0]))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">found</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">reset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">scan</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">uintptr_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">kb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">perm</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="s">&#34;pmap -x $(pidof dosbox) | tail -n +3&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#34;%lx&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">intptr_t</span><span class="p">)</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#34;%ld%*ld%*ld%s%*[^</span><span class="se">\n</span><span class="s">]s&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kb</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">perm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">uintptr_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">kb</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">uint16_t</span> <span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">LENGTH</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="n">found</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="n">found</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">s</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;There are %d match(es).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">overwrite</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">found</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">s</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d value(s) written.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="s">&#34;pidof dosbox&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;/proc/%d/mem&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(DOSBox %d) &#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="sc">&#39;q&#39;</span><span class="o">:</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span> <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span> <span class="n">scan</span><span class="p">(</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span> <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span> <span class="n">overwrite</span><span class="p">(</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span> <span class="n">reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Search results reset.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="前互联网时代的神器-2-按键精灵">前互联网时代的神器 (2): 按键精灵</h3>
<ul>
<li>
<p><font color="red">大量重复固定的任务 (例如 2 秒 17 枪)</font></p>
</li>
<li>
<p>这个简单，就是给进程发送键盘/鼠标事件</p>
<ul>
<li>
<p>做个驱动；或者</p>
</li>
<li>
<p>利用操作系统/窗口管理器提供的 API</p>
</li>
<li>
<p><a href="https://github.com/jordansissel/xdotool" target="_blank" rel="noopener noreffer">xdotool</a> (我们用这玩意测试 vscode 的插件)</p>
</li>
<li>
<p><a href="https://www.kernel.org/doc/html/latest/input/input.html" target="_blank" rel="noopener noreffer">evdev</a> (我们用这玩意显示按键；仅课堂展示有效)</p>
</li>
</ul>
</li>
</ul>
<h3 id="前互联网时代的神器-3-变速齿轮">前互联网时代的神器 (3): 变速齿轮</h3>
<ul>
<li>
<p><font color="red">调整游戏的逻辑更新速度</font></p>
<ul>
<li>比如<a href="https://baike.baidu.com/item/%e5%8f%b0%e6%b9%be%e5%a4%a9%e5%a0%82%e9%b8%9f%e8%b5%84%e8%ae%af%e6%9c%89%e9%99%90%e5%85%ac%e5%8f%b8/8443017" target="_blank" rel="noopener noreffer">某神秘公司</a>慢到难以忍受的跑图和战斗</li>
</ul>
</li>
<li>
<p>本质是 “欺骗” 进程的时钟</p>
<ul>
<li>
<p>源头：闹钟、睡眠、<code>gettimeofday</code></p>
</li>
<li>
<p>拦截它们需要稍稍更复杂的技术</p>
</li>
</ul>
</li>
</ul>
<h3 id="更强大的游戏外挂">更强大的游戏外挂？</h3>
<ul>
<li>
<p>游戏也是程序，也是状态机</p>
<ul>
<li>
<p>通过 API 调用 (和系统调用) 最终取得状态、修改状态</p>
</li>
<li>
<p>想象成是一个 “为这个游戏专门设计的 gdb”</p>
</li>
</ul>
</li>
</ul>
<h3 id="代码注入-hooking">代码注入 (Hooking)</h3>
<ul>
<li>
<p>我们可以改内存，也可以改代码！</p>
</li>
<li>
<p>The Light Side</p>
<ul>
<li>
<p>“软件热补丁” <a href="https://jyywiki.cn/pages/OS/2022/demos/dsu.c" target="_blank" rel="noopener noreffer">dsu.c</a> (mprotect)</p>
</li>
<li>
<p><a href="https://dl.acm.org/doi/10.1145/1519065.1519085" target="_blank" rel="noopener noreffer">Ksplice: Automatic rebootless Kernel updates</a> (EuroSys'09)</p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>     <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;In old function %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo_new</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;In new function %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 48 b8 ff ff ff ff ff ff ff ff    movabs $0xffffffffffffffff,%rax
</span></span></span><span class="line"><span class="cl"><span class="c1">// ff e0                            jmpq   *%rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">DSU</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cp">#define ROUNDDOWN(ptr) ((void *)(((uintptr_t)ptr) &amp; ~0xfff))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">size_t</span>    <span class="n">pg_size</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">pg_boundary</span> <span class="o">=</span> <span class="n">ROUNDDOWN</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>         <span class="n">flags</span> <span class="o">=</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Dynamically updating... &#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mprotect</span><span class="p">(</span><span class="n">pg_boundary</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pg_size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">memcpy</span><span class="p">(</span><span class="n">old</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\x48\xb8</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">memcpy</span><span class="p">(</span><span class="n">old</span> <span class="o">+</span>  <span class="mi">2</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">memcpy</span><span class="p">(</span><span class="n">old</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\xff\xe0</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mprotect</span><span class="p">(</span><span class="n">pg_boundary</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pg_size</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PROT_WRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Done&#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">foo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">DSU</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">foo_new</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">foo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./dsu
</span></span><span class="line"><span class="cl">In old <span class="k">function</span> foo
</span></span><span class="line"><span class="cl">Dynamically updating... DoneIn new <span class="k">function</span> foo_new
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>原理同变速齿轮，修改代码，让代码跳转到自己写的部分去</p>
</li>
<li>
<p>详细版本<a href="https://zhuanlan.zhihu.com/p/425845057" target="_blank" rel="noopener noreffer">《软件动态更新技术》</a></p>
</li>
<li>
<p>The Dark Side</p>
<ul>
<li>
<p>对于外挂，代码可以<code>静态/动态/vtable/DLL...</code>注入</p>
</li>
<li>
<p><code>render(objects)</code> → <code>render_hacked(objects)</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="游戏外挂攻与防">游戏外挂：攻与防</h3>
<ul>
<li>
<p>控制/数据流完整性</p>
<ul>
<li>
<p>保护进程的完整性</p>
<ul>
<li>独立的进程/驱动做完整性验证</li>
</ul>
</li>
<li>
<p>保护隐私数据不被其他进程读写</p>
<ul>
<li>拦截向本进程的 <code>ReadProcessMemory</code> 和 <code>WriteProcessMemory</code>，发现后立即拒绝执行</li>
</ul>
</li>
<li>
<p>例子</p>
<ul>
<li><a href="https://irdeto.com/denuvo/anti-cheat/" target="_blank" rel="noopener noreffer">Denuvo Anti-Cheat</a>, <a href="https://dev.epicgames.com/docs/services/en-US/GameServices/AntiCheat/UsingAntiCheat/index.html" target="_blank" rel="noopener noreffer">Epic Anti-Cheat Interface</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>其他解决方法</p>
<ul>
<li>
<p><code>AI</code> 监控/社会工程学：如果你强得不正常，当然要盯上你</p>
</li>
<li>
<p>云/沙盒 (<code>Enclave</code>) 渲染：“计算不再信任操作系统”</p>
</li>
</ul>
</li>
</ul>
<h2 id="总结">总结</h2>
<h3 id="总结-1">总结</h3>
<ul>
<li>本次课回答的问题
<ul>
<li><strong>Q</strong>: 进程的地址空间是如何创建、如何更改的？</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>Take-away messages</p>
<ul>
<li>
<p>进程的地址空间</p>
<ul>
<li>能文件关联的、带有访问权限的连续内存段
<ul>
<li>a.out, ld.so, libc.so, heap, stack, vdso</li>
</ul>
</li>
</ul>
</li>
<li>
<p>进程地址空间的管理 API</p>
<ul>
<li>mmap</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><b>声明：本文章引用资料与图像均已做标注，如有侵权本人会马上删除</b></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/operating-system/">Operating System</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>更新于 2023-05-05</span>
            </div><div class="post-info-mod"></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间" data-hashtags="Operating System"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-hashtag="Operating System"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Linkedin" data-sharer="linkedin" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter12/" data-title="Operating System Chapter12 进程的地址空间"><i class="fab fa-evernote fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/posts/operating-system/operating-system-chapter11/" class="prev" rel="prev" title="Operating System Chapter11 操作系统上的进程"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
            <a href="/posts/go/module_and_test/" class="next" rel="next" title="Go Module与测试">Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/khusika/FeelIt" target="_blank" rel="noopener noreffer" title="FeelIt 1.0.1"><i class="fas fa-hand-holding-heart fa-fw"></i> FeelIt</a>
        </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/Jungle430">Jungle</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=0.0.1', { scope: '/' })
        .then(() => {
            console.info('Jungle\u0027s Blog\u00A0Service Worker Registered');
        }, err => console.error('Jungle\u0027s Blog\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('Jungle\u0027s Blog\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js"></script></body></html>
