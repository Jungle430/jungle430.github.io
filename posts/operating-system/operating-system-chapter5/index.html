<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ - Jungle&#39;s Blog</title><meta name="description" content="Welcome to Jungle&#39;s blog."><meta property="og:title" content="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥" />
<meta property="og:description" content="Operating System $Nanjing\ University\rightarrow Yanyan\ Jiang\newline$ Update Update in 2023-03-08 17:30 ç»§ç»­çœ‹ï¼Œå¹¶å‘çœŸâ„¢ï¸ğŸ‘¨ Overview å¤ä¹  çŠ¶æ€æœºã€çŠ¶æ€æœºã€çŠ¶æ€æœº æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜ Q: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°çº¿ç¨‹äº’æ–¥ï¼Ÿ æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹ è‡ªæ—‹é”çš„" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-08T17:23:11+08:00" />
<meta property="article:modified_time" content="2023-03-08T17:23:11+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥"/>
<meta name="twitter:description" content="Operating System $Nanjing\ University\rightarrow Yanyan\ Jiang\newline$ Update Update in 2023-03-08 17:30 ç»§ç»­çœ‹ï¼Œå¹¶å‘çœŸâ„¢ï¸ğŸ‘¨ Overview å¤ä¹  çŠ¶æ€æœºã€çŠ¶æ€æœºã€çŠ¶æ€æœº æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜ Q: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°çº¿ç¨‹äº’æ–¥ï¼Ÿ æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹ è‡ªæ—‹é”çš„"/>
<meta name="application-name" content="Jungle&#39;s blog">
<meta name="apple-mobile-web-app-title" content="Jungle&#39;s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" /><link rel="prev" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter4/" /><link rel="next" href="https://Jungle430.github.io/posts/operating-system/operating-system-chapter6/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/Jungle430.github.io\/posts\/operating-system\/operating-system-chapter5\/"
        },"genre": "posts","keywords": "Operating System","wordcount":  7068 ,
        "url": "https:\/\/Jungle430.github.io\/posts\/operating-system\/operating-system-chapter5\/","datePublished": "2023-03-08T17:23:11+08:00","dateModified": "2023-03-08T17:23:11+08:00","publisher": {
            "@type": "Organization",
            "name": "Jungle"},"author": {
                "@type": "Person",
                "name": "Jungle"
            },"description": ""
    }
    </script></head><body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Jungle&#39;s Blog">Jungle&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/">ğŸ“š æ–‡ç«  </a><a class="menu-item" href="/tags/">ğŸ·ï¸ æ ‡ç­¾ </a><a class="menu-item" href="/categories/">ğŸ—ƒï¸ åˆ†ç±» </a><a class="menu-item" href="/about/">ğŸ‘´ å…³äº </a><a class="menu-item" href="https://github.com/Jungle430" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Jungle&#39;s Blog">Jungle&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">ğŸ“šæ–‡ç« </a><a class="menu-item" href="/tags/" title="">ğŸ·ï¸æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">ğŸ—ƒï¸åˆ†ç±»</a><a class="menu-item" href="/about/" title="">ğŸ‘´å…³äº</a><a class="menu-item" href="https://github.com/Jungle430" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><div class="menu-item"><a href="javascript:void(0);" class="theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="single-card" ><h2 class="single-title animated flipInX">Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://github.com/Jungle430" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jungle</a></span>&nbsp;<span class="post-category">å‡ºç‰ˆäº  <a href="/categories/operating-system/"><i class="far fa-folder fa-fw"></i>Operating System</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-03-08">2023-03-08</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 7068 å­—</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 15 åˆ†é’Ÿ</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>ç›®å½•</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥">å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥</a>
      <ul>
        <li><a href="#å›é¡¾å¹¶å‘ç¼–ç¨‹">å›é¡¾ï¼šå¹¶å‘ç¼–ç¨‹</a></li>
        <li><a href="#å›é¡¾äº’æ–¥ç®—æ³•">å›é¡¾ï¼šäº’æ–¥ç®—æ³•</a></li>
        <li><a href="#åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥">åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥</a></li>
      </ul>
    </li>
    <li><a href="#è‡ªæ—‹é”-spin-lock">è‡ªæ—‹é” (Spin Lock)</a>
      <ul>
        <li><a href="#è§£å†³é—®é¢˜çš„ä¸¤ç§æ–¹æ³•">è§£å†³é—®é¢˜çš„ä¸¤ç§æ–¹æ³•</a></li>
        <li><a href="#x86-åŸå­æ“ä½œlock-æŒ‡ä»¤å‰ç¼€">x86 åŸå­æ“ä½œï¼š<code>LOCK</code> æŒ‡ä»¤å‰ç¼€</a></li>
        <li><a href="#ç”¨-xchg-å®ç°äº’æ–¥ä¹Ÿå°±æ˜¯è‡ªæ—‹é”çš„æœ¬è´¨å®ç°è¿‡ç¨‹">ç”¨ <code>xchg</code> å®ç°äº’æ–¥ï¼ˆä¹Ÿå°±æ˜¯è‡ªæ—‹é”çš„æœ¬è´¨å®ç°è¿‡ç¨‹ï¼‰</a></li>
        <li><a href="#å®ç°äº’æ–¥è‡ªæ—‹é”">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</a></li>
        <li><a href="#å®ç°äº’æ–¥è‡ªæ—‹é”-contd">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é” (cont&rsquo;d)</a></li>
        <li><a href="#åŸå­æŒ‡ä»¤çš„è¯ç”Ÿbus-lock-80486">åŸå­æŒ‡ä»¤çš„è¯ç”Ÿï¼šBus Lock (80486)</a>
          <ul>
            <li><a href="#è´Ÿæ‹…">è´Ÿæ‹…</a></li>
          </ul>
        </li>
        <li><a href="#lock-æŒ‡ä»¤çš„ç°ä»£å®ç°">Lock æŒ‡ä»¤çš„ç°ä»£å®ç°</a></li>
        <li><a href="#risc-v-å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡">RISC-V: å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡</a></li>
        <li><a href="#load-reservedstore-conditional-lrsc">Load-Reserved/Store-Conditional (LR/SC)</a>
          <ul>
            <li><a href="#compare-and-swap-çš„-lrsc-å®ç°">Compare-and-Swap çš„ LR/SC å®ç°</a></li>
            <li><a href="#lrsc-çš„ç¡¬ä»¶å®ç°">LR/SC çš„ç¡¬ä»¶å®ç°</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#äº’æ–¥é”-mutex-lock">äº’æ–¥é” (Mutex Lock)</a>
      <ul>
        <li><a href="#è‡ªæ—‹é”çš„ç¼ºé™·">è‡ªæ—‹é”çš„ç¼ºé™·</a></li>
        <li><a href="#scalability-æ€§èƒ½çš„æ–°ç»´åº¦">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</a></li>
        <li><a href="#è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</a>
          <ul>
            <li><a href="#ä½¿ç”¨åœºæ™¯æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„-çŸ­ä¸´ç•ŒåŒº">ä½¿ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)</a></li>
          </ul>
        </li>
        <li><a href="#å®ç°çº¿ç¨‹--é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</a></li>
        <li><a href="#å®ç°çº¿ç¨‹--é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥-contd">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (cont&rsquo;d)</a></li>
      </ul>
    </li>
    <li><a href="#futex--spin--mutex">Futex = Spin + Mutex</a>
      <ul>
        <li><a href="#å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ">å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</a></li>
        <li><a href="#futex-fast-userspace-mutexes">Futex: Fast Userspace muTexes</a></li>
        <li><a href="#futex-fast-userspace-mutexes-contd">Futex: Fast Userspace muTexes (cont&rsquo;d)</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-08 17:30</p>
<p>ç»§ç»­çœ‹ï¼Œå¹¶å‘çœŸâ„¢ï¸ğŸ‘¨</p>
</div>
        </div>
    </div>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>çŠ¶æ€æœºã€çŠ¶æ€æœºã€çŠ¶æ€æœº</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°çº¿ç¨‹äº’æ–¥ï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>è‡ªæ—‹é”çš„å®ç°</li>
<li>äº’æ–¥é”çš„å®ç°</li>
</ul>
<h2 id="å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥">å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥</h2>
<h3 id="å›é¡¾å¹¶å‘ç¼–ç¨‹">å›é¡¾ï¼šå¹¶å‘ç¼–ç¨‹</h3>
<p>ç†è§£å¹¶å‘çš„å·¥å…·</p>
<ul>
<li>çº¿ç¨‹ = äºº (å¤§è„‘èƒ½å®Œæˆå±€éƒ¨å­˜å‚¨å’Œè®¡ç®—)</li>
<li>å…±äº«å†…å­˜ = ç‰©ç†ä¸–ç•Œ (ç‰©ç†ä¸–ç•Œå¤©ç”Ÿå¹¶è¡Œ)</li>
<li>ä¸€åˆ‡éƒ½æ˜¯çŠ¶æ€æœº</li>
</ul>
<h3 id="å›é¡¾äº’æ–¥ç®—æ³•">å›é¡¾ï¼šäº’æ–¥ç®—æ³•</h3>
<p>äº’æ–¥ (mutual exclusion)ï¼Œâ€œäº’ç›¸æ’æ–¥â€</p>
<ul>
<li>å®ç° <code>lock_t</code> æ•°æ®ç»“æ„å’Œ <code>lock/unlock</code> API:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">lock_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>ä¸€æŠŠ â€œæ’ä»–æ€§â€ çš„é”â€”â€”å¯¹äºé”å¯¹è±¡ <code>lk</code></p>
<ul>
<li>å¦‚æœæŸä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹çš„ <code>lock</code> ä¸èƒ½è¿”å›</li>
</ul>
<h3 id="åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥">åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥</h3>
<p>å¤±è´¥çš„å°è¯•</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/mutex-bad.py" target="_blank" rel="noopener noreffer">mutex-bad.py</a></li>
</ul>
<hr>
<p>(éƒ¨åˆ†) æˆåŠŸçš„å°è¯•</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a></li>
</ul>
<hr>
<p>å®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾ï¼šä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜</p>
<ul>
<li>load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œåªèƒ½ â€œçœ‹ä¸€çœ¼å°±æŠŠçœ¼ç›é—­ä¸Šâ€
<ul>
<li>çœ‹åˆ°çš„ä¸œè¥¿é©¬ä¸Šå°±è¿‡æ—¶äº†</li>
</ul>
</li>
<li>store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œåªèƒ½ â€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€
<ul>
<li>ä¹Ÿä¸çŸ¥é“æŠŠä»€ä¹ˆæ”¹æˆäº†ä»€ä¹ˆ</li>
</ul>
</li>
<li>è¿™æ˜¯<del>ç®€å•ã€ç²—æš´ (ç¨³å®š)ã€æœ‰æ•ˆ</del>çš„ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾</li>
</ul>
<h2 id="è‡ªæ—‹é”-spin-lock">è‡ªæ—‹é” (Spin Lock)</h2>
<h3 id="è§£å†³é—®é¢˜çš„ä¸¤ç§æ–¹æ³•">è§£å†³é—®é¢˜çš„ä¸¤ç§æ–¹æ³•</h3>
<blockquote>
<p>æå‡ºç®—æ³•ã€è§£å†³é—®é¢˜ (Dekker/Peterson/&hellip;&rsquo;s Protocols)</p>
</blockquote>
<p>æˆ–è€…â€¦â€¦</p>
<blockquote>
<p>æ”¹å˜å‡è®¾ (è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘$\Longrightarrow$ x86æ¶æ„çš„é£æ ¼ï¼Œè½¯ä»¶æŒ‡ä»¤åšä¸å¥½ç›´æ¥å†™ä¸€ä¸ªæŒ‡ä»¤é›†è®©ç¡¬ä»¶è¿™ä¹ˆåšhhh)</p>
</blockquote>
<hr>
<p>å‡è®¾ç¡¬ä»¶èƒ½ä¸ºæˆ‘ä»¬æä¾›ä¸€æ¡ â€œç¬é—´å®Œæˆâ€ çš„è¯» + å†™æŒ‡ä»¤</p>
<ul>
<li>è¯·æ‰€æœ‰äººé—­ä¸Šçœ¼ç›ï¼Œçœ‹ä¸€çœ¼ (load)ï¼Œç„¶åè´´ä¸Šæ ‡ç­¾ (store)
<ul>
<li>å¦‚æœå¤šäººåŒæ—¶è¯·æ±‚ï¼Œç¡¬ä»¶é€‰å‡ºä¸€ä¸ª â€œèƒœè€…â€</li>
<li>â€œè´¥è€…â€ è¦ç­‰ â€œèƒœè€…â€ å®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œ</li>
</ul>
</li>
</ul>
<h3 id="x86-åŸå­æ“ä½œlock-æŒ‡ä»¤å‰ç¼€">x86 åŸå­æ“ä½œï¼š<code>LOCK</code> æŒ‡ä»¤å‰ç¼€</h3>
<p>ä¾‹å­ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/sum-atomic.c" target="_blank" rel="noopener noreffer"><code>sum-atomic.c</code></a></p>
<ul>
<li><code>sum = 200000000</code></li>
</ul>
<hr>
<p>Atomic exchange (load + store)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">xchg</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&#34;lock xchg %0, %1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="s">&#34;+m&#34;</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">),</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">(</span><span class="n">newval</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><b>é‡ç‚¹å°±æ˜¯asmå†…è”æ±‡ç¼–é‚£å¥ï¼Œè¿™é‡Œæ˜¯â€œä¸€æ°”å‘µæˆâ€çš„</b></p>
</li>
<li>
<p>æ›´å¤šçš„åŸå­æŒ‡ä»¤ï¼š<a href="https://en.cppreference.com/w/cpp/header/stdatomic.h" target="_blank" rel="noopener noreffer">stdatomic.h</a> (C11)</p>
</li>
</ul>
<h3 id="ç”¨-xchg-å®ç°äº’æ–¥ä¹Ÿå°±æ˜¯è‡ªæ—‹é”çš„æœ¬è´¨å®ç°è¿‡ç¨‹">ç”¨ <code>xchg</code> å®ç°äº’æ–¥ï¼ˆä¹Ÿå°±æ˜¯è‡ªæ—‹é”çš„æœ¬è´¨å®ç°è¿‡ç¨‹ï¼‰</h3>
<ul>
<li>xchgåœ¨ä¹‹å‰çš„<a href="https://jungle430.github.io/posts/operating-system/support2" target="_blank" rel="noopener noreffer">æ–‡ç« </a>ä¸­æœ‰æåˆ°è¿‡</li>
</ul>
<p>å¦‚ä½•åè°ƒå®¿èˆè‹¥å¹²ä½åŒå­¦ä¸Šå•æ‰€é—®é¢˜ï¼Ÿ</p>
<ul>
<li>åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­ (å…±äº«å˜é‡)
<ul>
<li>åˆå§‹æ—¶ï¼Œæ¡Œä¸Šæ˜¯ ğŸ”‘</li>
</ul>
</li>
</ul>
<hr>
<p>å®ç°äº’æ–¥çš„åè®®</p>
<ul>
<li>æƒ³ä¸Šå•æ‰€çš„åŒå­¦ (ä¸€æ¡ xchg æŒ‡ä»¤)
<ul>
<li>å¤©é»‘è¯·é—­çœ¼</li>
<li>çœ‹ä¸€çœ¼æ¡Œå­ä¸Šæœ‰ä»€ä¹ˆ (ğŸ”‘ æˆ– ğŸ”)</li>
<li>æŠŠ ğŸ” æ”¾åˆ°æ¡Œä¸Š (è¦†ç›–ä¹‹å‰æœ‰çš„ä»»ä½•ä¸œè¥¿)</li>
<li>å¤©äº®è¯·ççœ¼ï¼›çœ‹åˆ° ğŸ”‘ æ‰å¯ä»¥è¿›å•æ‰€å“¦</li>
</ul>
</li>
<li>å‡ºå•æ‰€çš„åŒå­¦
<ul>
<li>æŠŠ ğŸ”‘ æ”¾åˆ°æ¡Œä¸Š</li>
</ul>
</li>
</ul>
<h3 id="å®ç°äº’æ–¥è‡ªæ—‹é”">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">table</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">got</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">,</span> <span class="n">NOPE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">NOPE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">YES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">,</span> <span class="n">YES</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">()</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">{</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é‡è¦çš„è¿˜æ˜¯xchgè¿™ä¸ªä¸œè¥¿ï¼Œä¿è¯é‚£ä¸€æ­¥æ˜¯åŸå­æ€§çš„ï¼Œå°±æ²¡æœ‰å…¶ä»–äº‹æƒ…äº†</li>
</ul>
<h3 id="å®ç°äº’æ–¥è‡ªæ—‹é”-contd">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é” (cont&rsquo;d)</h3>
<p>å¹¶å‘ç¼–ç¨‹ï¼šåƒä¸‡å°å¿ƒ</p>
<ul>
<li>åšè¯¦å°½çš„æµ‹è¯• (åœ¨æ­¤çœç•¥ï¼Œä½ ä»¬åš Labs å°±çŸ¥é“äº†)</li>
<li>å°½å¯èƒ½åœ°è¯æ˜ (<a href="https://jyywiki.cn/pages/OS/2022/demos/model-checker.py" target="_blank" rel="noopener noreffer">model-checker.py</a> å’Œ <a href="https://jyywiki.cn/pages/OS/2022/demos/spinlock.py" target="_blank" rel="noopener noreffer">spinlock.py</a>)</li>
</ul>
<hr>
<p>åŸå­æŒ‡ä»¤çš„æ¨¡å‹</p>
<ul>
<li>ä¿è¯ä¹‹å‰çš„ store éƒ½å†™å…¥å†…å­˜</li>
<li>ä¿è¯ load/store ä¸ä¸åŸå­æŒ‡ä»¤ä¹±åº</li>
</ul>
<h3 id="åŸå­æŒ‡ä»¤çš„è¯ç”Ÿbus-lock-80486">åŸå­æŒ‡ä»¤çš„è¯ç”Ÿï¼šBus Lock (80486)</h3>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-09 10:00</p>
<p>æ—©èµ·å¼€å®ŒSBå¤§ä¼šï¼Œâœ‹æ¥ç€çœ‹</p>
<p>å’–å•¡æœºé‡Œé¢çš„å’–å•¡çœŸæç¥ï¼Œä¼°è®¡ä¸‹åˆæ¯›æ¦‚å¾—ç‹ ç‹ ç¡ä¸€æŠŠ</p>
</div>
        </div>
    </div>
<ul>
<li>486 (20-50MHz) å°±æ”¯æŒ <code>dual-socket</code> äº†</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter5-1.jpg" title="/img/Operating System/chapter5-1.jpg" data-thumbnail="/img/Operating System/chapter5-1.jpg" data-sub-html="<h2>80486</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter5-1.jpg"
            data-srcset="/img/Operating%20System/chapter5-1.jpg, /img/Operating%20System/chapter5-1.jpg 1.5x, /img/Operating%20System/chapter5-1.jpg 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter5-1.jpg" />
    </a><figcaption class="image-caption">80486</figcaption>
    </figure>
<div class="mermaid" id="id-1"></div>
<ul>
<li>
<p>å¦‚æœCPU1éœ€è¦æ‰§è¡Œ<code>add x, 1</code>ï¼Œé‚£ä¹ˆéœ€è¦åˆ†æˆ3æ­¥</p>
<ul>
<li>ä»memoryé‡Œé¢load</li>
<li>å†æŠŠè¿™ä¸ªå€¼add 1ä¹‹åå…ˆæ”¾å…¥ä¸€ä¸ªå†…éƒ¨çš„å¯„å­˜å™¨é‡Œ</li>
<li>å†storeæŠŠmçš„å€¼å†™å›å†…å­˜é‡Œ</li>
</ul>
</li>
<li>
<p>ä¸ºä»€ä¹ˆ486æ—¶ä»£ä¼šè¯ç”Ÿ<b>LOCK</b>è¿™æ ·çš„æŒ‡ä»¤å‘¢ï¼Ÿ</p>
<ul>
<li>å› ä¸ºæ¶‰åŠäº†ä¸¤ä¸ªCPUé¢å¯¹åŒä¸€ä¸ªmemoryçš„çŠ¶å†µï¼Œæ‰€ä»¥éœ€è¦å¯¹memoryè¿›è¡Œlockçš„æ“ä½œ</li>
</ul>
</li>
<li>
<p>è®¾è®¡æ–¹æ³•</p>
<ul>
<li>x86çš„æŒ‡ä»¤é›†æœ‰æŒ‡ä»¤çš„å‰ç¼€ï¼ˆæ¯”å¦‚<code>rep</code>ï¼‰ï¼Œæˆ‘ä»¬è®©<code>lock</code>ä¹Ÿå˜æˆä¸€ä¸ª<b>æŒ‡ä»¤å‰ç¼€</b></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lock + |æŒ‡ä»¤|
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><u>å½“CPUå¼€å§‹è¯»æŒ‡ä»¤çš„æ—¶å€™ï¼Œå®ƒä¼šå…ˆè¯»åˆ°lockæŒ‡ä»¤ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸Šé”ï¼ˆä¹Ÿå³æ˜¯å¯¹åº”çš„CPUæ‹¿åˆ°äº†æ€»çº¿çš„é”ï¼‰</u></li>
<li><u>ç­‰åˆ°CPUæ‹¿åˆ°æ€»çº¿çš„é”ä¹‹åï¼Œå®ƒä¼šå†æ‰§è¡Œåé¢çš„éƒ¨åˆ†</u></li>
<li><u>æŠŠæœ‰å…³æŒ‡ä»¤æ‰§è¡Œå®Œæˆä¹‹åå†æŠŠé”é‡Šæ”¾æ‰</u></li>
</ul>
<h4 id="è´Ÿæ‹…">è´Ÿæ‹…</h4>
<ul>
<li><b>ä»Šå¤©çš„CPUä¸memoryä¹‹é—´éƒ½æœ‰å„è‡ªçš„cacheï¼Œè€Œä¸”cacheå·²ç»å’ŒCPUé›†æˆåœ¨ä¸€ä¸ªå…ƒä»¶ä¸Šé¢äº†ï¼Œè€Œä¸”æ˜¯å¤šçº§cache</b></li>
<li><b>486æ—¶ä»£ä»…ä»…åªæœ‰å¤–é¢çš„ä¸€å—cacheï¼ˆè€Œä¸”è¿™å—cacheåœ¨ä¸»æ¿ä¸Šï¼‰ï¼Œæ‰€ä»¥è¯´åªè¦CPUæ‹¿åˆ°äº†æ€»çº¿ğŸ”’çš„æ§åˆ¶æƒï¼Œå°±æŠŠè‡ªå·±å’Œå¤–é¢çš„ä¸€åˆ‡éš”ç¦»å¼€äº†</b></li>
</ul>
<div class="mermaid" id="id-2"></div>
<ul>
<li>
<p><b>å¤šçº§cacheä¼šä½¿å¾—lockå˜å¾—å¾ˆéº»çƒ¦</b></p>
</li>
<li>
<p>ä¾‹å­ï¼šä¸€ä¸ªæ•°æ®åœ¨ä¸¤ä¸ªCPUçš„cacheé‡Œé¢éƒ½æœ‰å‰¯æœ¬</p>
</li>
</ul>
<div class="mermaid" id="id-3"></div>
<ul>
<li><b>è¿™ä¸ªæ—¶å€™å¦‚æœCPU1è¦lockè®¿é—®mçš„è¯ï¼Œå°±è¦å°†cache21é‡Œé¢çš„må‰¯æœ¬â€œè¸¢æ‰â€</b> $\Longrightarrow$ ä¹Ÿå°±æ˜¯ä»Šå¤©interä¸€ä¸ªå¾ˆå¤§çš„å†å²åŒ…è¢±ï¼šç¼“å­˜çš„ä¸€è‡´æ€§ $\Longrightarrow$ è§£å†³æ–¹æ¡ˆï¼šå°†æ‰€æœ‰çš„cacheç”¨æ€»çº¿è¿æ¥èµ·æ¥</li>
</ul>
<div class="mermaid" id="id-4"></div>
<ul>
<li>ä¸€æ—¦å…¶ä¸­æœ‰ä¸€ä¸ªæ•°æ®éœ€è¦è¢«lockï¼Œé‚£ä¹ˆæ€»çº¿éœ€è¦éå†ä¸€éæ‰€æœ‰CPUçš„cacheï¼Œå¦‚æœå‘ç°äº†è¯¥æ•°æ®çš„å‰¯æœ¬ï¼Œå°±è¦å°†è¯¥æ•°æ®ä»å…¶ä»–CPUçš„cacheé‡Œé¢â€œè¸¢æ‰â€ï¼Œ<b>è¿™æ˜¯å¾ˆæµªè´¹æ—¶é—´çš„</b></li>
</ul>
<h3 id="lock-æŒ‡ä»¤çš„ç°ä»£å®ç°">Lock æŒ‡ä»¤çš„ç°ä»£å®ç°</h3>
<p>åœ¨ L1 cache å±‚ä¿æŒä¸€è‡´æ€§ (ring/mesh bus)</p>
<ul>
<li>ç›¸å½“äºæ¯ä¸ª cache line æœ‰åˆ†åˆ«çš„é”</li>
<li>store(x) è¿›å…¥ L1 ç¼“å­˜å³ä¿è¯å¯¹å…¶ä»–å¤„ç†å™¨å¯è§
<ul>
<li>ä½†è¦å°å¿ƒ store buffer å’Œä¹±åºæ‰§è¡Œ</li>
</ul>
</li>
</ul>
<hr>
<p>L1 cache line æ ¹æ®çŠ¶æ€è¿›è¡Œåè°ƒ</p>
<ul>
<li>M (Modified), è„å€¼</li>
<li>E (Exclusive), ç‹¬å è®¿é—®</li>
<li>S (Shared), åªè¯»å…±äº«</li>
<li>I (Invalid), ä¸æ‹¥æœ‰ cache line</li>
</ul>
<h3 id="risc-v-å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡">RISC-V: å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡</h3>
<p>è€ƒè™‘å¸¸è§çš„åŸå­æ“ä½œï¼š</p>
<ul>
<li>atomic test-and-set
<ul>
<li><code>reg = load(x); if (reg == XX) { store(x, YY); }</code></li>
</ul>
</li>
<li>lock xchg
<ul>
<li><code>reg = load(x); store(x, XX);</code></li>
</ul>
</li>
<li>lock add
<ul>
<li><code>t = load(x); t++; store(x, t);</code></li>
</ul>
</li>
</ul>
<hr>
<p><b>å®ƒä»¬çš„æœ¬è´¨éƒ½æ˜¯</b></p>
<ol>
<li>load</li>
<li>exec (å¤„ç†å™¨æœ¬åœ°å¯„å­˜å™¨çš„è¿ç®—)</li>
<li>store</li>
</ol>
<h3 id="load-reservedstore-conditional-lrsc">Load-Reserved/Store-Conditional (LR/SC)</h3>
<ul>
<li>LR: åœ¨å†…å­˜ä¸Šæ ‡è®° reserved (ç›¯ä¸Šä½ äº†)ï¼Œä¸­æ–­ã€å…¶ä»–å¤„ç†å™¨å†™å…¥éƒ½ä¼šå¯¼è‡´æ ‡è®°æ¶ˆé™¤
<ul>
<li><b>æˆ‘å…ˆè¯»ï¼Œè¯»å®Œä¹‹ååœ¨è¿™ä¸ªç‰©å“ä¸Šé¢åšä¸€ä¸ªæ ‡è®°</b></li>
<li><b>æ ‡è®°ä¸€ç›´åœ¨ç‰©å“ä¸Šï¼ŒåŒæ—¶åœ¨åšæœ¬åœ°çš„è®¡ç®—</b></li>
<li><b>æœ¬åœ°è®¡ç®—ç®—å®Œäº†ï¼Œè¯¥å†™äº†</b></li>
<li><b>å†™çš„æ—¶å€™è¦å…ˆæ£€æµ‹æ ‡è®°ï¼Œåªæœ‰æ ‡è®°è¿˜åœ¨çš„æ—¶å€™æ‰å¯ä»¥å†™ï¼Œå¦åˆ™è¿”å›failï¼Œåªèƒ½å†æ¬¡å°è¯•é‡æ–°ä¸Šé”å†™å…¥</b></li>
</ul>
</li>
<li><u>æœ¬åœ°å†…å­˜çš„è®¡ç®—ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯<b>å…±äº«å†…å­˜çš„è®¡ç®—</b></u></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lr.w rd, (rs1)
</span></span><span class="line"><span class="cl">  rd = M[rs1]
</span></span><span class="line"><span class="cl">  reserve M[rs1]
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<ul>
<li>SC: å¦‚æœ â€œç›¯ä¸Šâ€ æœªè¢«è§£é™¤ï¼Œåˆ™å†™å…¥</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sc.w rd, rs2, (rs1)
</span></span><span class="line"><span class="cl">  if still reserved:
</span></span><span class="line"><span class="cl">    M[rs1] = rs2
</span></span><span class="line"><span class="cl">    rd = 0
</span></span><span class="line"><span class="cl">  else:
</span></span><span class="line"><span class="cl">    rd = nonzero
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="compare-and-swap-çš„-lrsc-å®ç°">Compare-and-Swap çš„ LR/SC å®ç°</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">cas</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmp_val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">old_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">old_val</span> <span class="o">==</span> <span class="n">cmp_val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cas:
</span></span><span class="line"><span class="cl">  lr.w  t0, (a0)       # Load original value.
</span></span><span class="line"><span class="cl">  bne   t0, a1, fail   # Doesnâ€™t match, so fail.
</span></span><span class="line"><span class="cl">  sc.w  t0, a2, (a0)   # Try to update.
</span></span><span class="line"><span class="cl">  bnez  t0, cas        # Retry if store-conditional failed.
</span></span><span class="line"><span class="cl">  li a0, 0             # Set return to success.
</span></span><span class="line"><span class="cl">  jr ra                # Return.
</span></span><span class="line"><span class="cl">fail:
</span></span><span class="line"><span class="cl">  li a0, 1             # Set return to failure.
</span></span><span class="line"><span class="cl">  jr ra                # Return
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>lrï¼Œscè¿˜å¯ä»¥æ£€æµ‹ğŸ”’çš„æ‹¥å µç¨‹åº¦</li>
</ul>
<h4 id="lrsc-çš„ç¡¬ä»¶å®ç°">LR/SC çš„ç¡¬ä»¶å®ç°</h4>
<ul>
<li>
<p>BOOM (Berkeley Out-of-Order Processor)</p>
</li>
<li>
<p><a href="https://github.com/riscv-boom/riscv-boom" target="_blank" rel="noopener noreffer">riscv-boom</a></p>
</li>
<li>
<p><a href="https://github.com/riscv-boom/riscv-boom/blob/master/src/main/scala/lsu/dcache.scala#L655" target="_blank" rel="noopener noreffer">lsu/dcache.scala</a></p>
</li>
<li>
<p>ç•™æ„s2_sc_failçš„æ¡ä»¶</p>
<ul>
<li>s2 æ˜¯æµæ°´çº¿ Stage 2</li>
</ul>
</li>
<li>
<p>(yzh æ‰’å‡ºçš„ä»£ç )</p>
</li>
</ul>
<h2 id="äº’æ–¥é”-mutex-lock">äº’æ–¥é” (Mutex Lock)</h2>
<h3 id="è‡ªæ—‹é”çš„ç¼ºé™·">è‡ªæ—‹é”çš„ç¼ºé™·</h3>
<ul>
<li>
<p>æ€§èƒ½é—®é¢˜ (0)</p>
<ul>
<li>è‡ªæ—‹ (å…±äº«å˜é‡) ä¼šè§¦å‘<b>å¤„ç†å™¨é—´çš„ç¼“å­˜åŒæ­¥ï¼Œå»¶è¿Ÿå¢åŠ ï¼ˆæ€»çº¿éå†cacheè¸¢å‰¯æœ¬ï¼‰</b></li>
</ul>
</li>
<li>
<p>æ€§èƒ½é—®é¢˜ (1)</p>
<ul>
<li>
<p>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨ç©ºè½¬<b>ï¼ˆçœ‹è‡ªæ—‹é”çš„å®ç°ä»£ç ï¼Œæ²¡æœ‰æ‹¿åˆ°ğŸ”’çš„çº¿ç¨‹åœ¨ç©ºè½¬æ­»å¾ªç¯ï¼‰</b></p>
<ul>
<li>ä¼šé€ æˆå¤šCPUæœºå™¨åˆ©ç”¨ç‡è¿‡ä½çš„é—®é¢˜ï¼ˆå°±æœ‰ğŸ”’çš„åœ¨å·¥ä½œï¼‰</li>
</ul>
</li>
<li>
<p><b>äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½</b></p>
</li>
</ul>
</li>
<li>
<p>æ€§èƒ½é—®é¢˜ (2)</p>
<ul>
<li>è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹<b>å¯èƒ½è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»ï¼ˆå‡ºç°åœ¨å•CPUæ—¶é—´ç‰‡è½®è½¬çš„æ¡ä»¶ä¸‹ï¼Œè½®è½¬æ—¶é—´ç‰‡å¯¼è‡´æ‹¿ğŸ”’çš„çº¿ç¨‹ä¼‘çœ ï¼Œç›¸å½“äºä½ æ‹¿ç€ğŸ”’å›å®¿èˆç¡è§‰ï¼Œå…¨æ•™å®¤çš„äººåªèƒ½ç­‰ç€ä½  $\Longrightarrow$ è¿˜åœ¨æ­»å¾ªç¯é‡Œé¢ç©ºè½¬ï¼‰</b>
<ul>
<li>æ“ä½œç³»ç»Ÿä¸ â€œæ„ŸçŸ¥â€ çº¿ç¨‹åœ¨åšä»€ä¹ˆ</li>
<li>(ä½†ä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ) $\Longrightarrow$ è¯¾åæ€è€ƒ</li>
</ul>
</li>
</ul>
</li>
<li>
<p><b>å®ç° 100% çš„èµ„æºæµªè´¹</b></p>
</li>
</ul>
<div class="mermaid" id="id-5"></div>
<h3 id="scalability-æ€§èƒ½çš„æ–°ç»´åº¦">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</h3>
<blockquote>
<p><u>åŒä¸€ä»½è®¡ç®—ä»»åŠ¡ï¼Œæ—¶é—´ (CPU cycles) å’Œç©ºé—´ (mapped memory) ä¼šéšå¤„ç†å™¨æ•°é‡çš„å¢é•¿è€Œå˜åŒ–</u>ã€‚</p>
<p><b>æ³¨æ„å’Œæ•°æ®ç»“æ„é‡Œé¢çš„è®¡ç®—æ•°æ®é‡nåŒºåˆ«ï¼Œè¿™é‡Œé¢è¡¡é‡çš„æ ‡å‡†æ˜¯ä¾æ®å¤„ç†å™¨çš„æ•°é‡è€Œå®šçš„</b></p>
</blockquote>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/sum-scalability.c" target="_blank" rel="noopener noreffer">sum-scalability.c</a>ï¼Œ<a href="https://jyywiki.cn/pages/OS/2022/demos/stat.py" target="_blank" rel="noopener noreffer">stat.py</a></li>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/thread-sync.h" target="_blank" rel="noopener noreffer">thread-sync.h</a></li>
<li>ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾
<ul>
<li>CPU åŠ¨æ€åŠŸè€—ï¼ˆæ•£çƒ­è·Ÿä¸ä¸Šåªèƒ½åšä¸€å³°âŒšçœŸğŸ‘¨ï¼ˆæ‚² ï¼‰</li>
<li>ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹</li>
<li>â€¦â€¦</li>
</ul>
</li>
<li><a href="https://www.cse.unsw.edu.au/~gernot/benchmarking-crimes.html" target="_blank" rel="noopener noreffer">Benchmarking crimes</a></li>
</ul>
<p>sum-scalability.cï¼Œé‡Œé¢ç”¨çš„å°±æ˜¯<b>è‡ªæ—‹é”</b>ï¼Œåœ¨è‡ªæ—‹é”çš„ä¿æŠ¤ä¸‹æ‰§è¡Œsum++</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 10000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">spinlock_t</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">SPIN_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">n</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sum</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nthread</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">nthread</span><span class="p">;</span> <span class="c1">//nthreadæ˜¯çº¿ç¨‹æ•°é‡ï¼Œnå°±æ˜¯å¹³æ‘Šä¸‹æ¥æ¯ä¸ªçº¿ç¨‹è¦æ‰§è¡Œçš„sum++ï¼ˆä¹Ÿå°±æ˜¯ğŸ”’ï¼‰çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nthread</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">sum</span> <span class="o">==</span> <span class="n">n</span> <span class="o">*</span> <span class="n">nthread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡ªæ—‹é”çš„å®ç°(æ¥è‡ª<code>thread-sync.h</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">spin_lock</span><span class="p">(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">intptr_t</span> <span class="n">value</span> <span class="o">=</span> <span class="n">atomic_xchg</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">spin_unlock</span><span class="p">(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomic_xchg</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-09 15:20</p>
<p>ç»·ä¸ä½ç›´æ¥ğŸ˜ªäº†ï¼Œç¡é†’ç»§ç»­</p>
</div>
        </div>
    </div>
<ul>
<li>è¿è¡Œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc sum-scalability.c -O2 -lpthread
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:25:37 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.043s
</span></span><span class="line"><span class="cl">user    0m0.016s
</span></span><span class="line"><span class="cl">sys     0m0.021s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:25:40 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.229s
</span></span><span class="line"><span class="cl">user    0m0.337s
</span></span><span class="line"><span class="cl">sys     0m0.071s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:25:44 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.337s
</span></span><span class="line"><span class="cl">user    0m0.393s
</span></span><span class="line"><span class="cl">sys     0m0.166s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:26:21 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m1.316s
</span></span><span class="line"><span class="cl">user    0m2.176s
</span></span><span class="line"><span class="cl">sys     0m0.288s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:26:35 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m1.230s
</span></span><span class="line"><span class="cl">user    0m2.040s
</span></span><span class="line"><span class="cl">sys     0m0.255s
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç°è±¡ï¼š<b>åŒæ ·çš„å·¥ä½œé‡ï¼Œçº¿ç¨‹è¶Šå¤šï¼Œæ•ˆç‡è¶Šä½</b></li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter5-2.jpg" title="/img/Operating System/chapter5-2.jpg" data-thumbnail="/img/Operating System/chapter5-2.jpg" data-sub-html="<h2>å›¾åƒ</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/img/Operating%20System/chapter5-2.jpg"
            data-srcset="/img/Operating%20System/chapter5-2.jpg, /img/Operating%20System/chapter5-2.jpg 1.5x, /img/Operating%20System/chapter5-2.jpg 2x"
            data-sizes="auto"
            alt="/img/Operating System/chapter5-2.jpg" />
    </a><figcaption class="image-caption">å›¾åƒ</figcaption>
    </figure>
<h3 id="è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</h3>
<ul>
<li><b>ä¸¤ä¸ªé‡è¦çš„çº¦æŸ</b>
<ul>
<li>ä¸´ç•ŒåŒºå‡ ä¹ä¸â€œæ‹¥å µâ€$\Longrightarrow$ <b>å‡ ä¹å°±åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒº</b> $\Longrightarrow$ è¿™æ ·äº‰æŠ¢ğŸ”’çš„çŠ¶å†µå°±ä¼šå¾ˆå°‘</li>
<li>æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢ $\Longrightarrow$ ç¿»è¯‘æˆä¸Šé¢çš„äººè¯å°±æ˜¯ç¦æ­¢æ‹¿ç€ğŸ”’å›å®¿èˆğŸ˜´ $\Longrightarrow$ <b>ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯åšä¸åˆ°è¿™ä¸€ç‚¹çš„ï¼ˆå¦‚æœåº”ç”¨ç¨‹åºèƒ½å¤Ÿé˜²æ­¢è‡ªå·±åœ¨æ—¶é—´ç‰‡è½®è½¬çš„æ—¶å€™è¢«åˆ‡å‡ºå»ï¼Œé‚£ä¹ˆä¸€ä¸ªwhile(1);å°±èƒ½è®©ç”µè„‘å´©æºƒï¼Œæ“ä½œç³»ç»Ÿæ˜¯ç»å¯¹ç¦æ­¢è¿™æ ·çš„äº‹æƒ…çš„ï¼‰</b></li>
</ul>
</li>
</ul>
<h4 id="ä½¿ç”¨åœºæ™¯æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„-çŸ­ä¸´ç•ŒåŒº">ä½¿ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)</h4>
<ul>
<li><b>æ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å </b> $\Longrightarrow$ è¿™å°±æ˜¯å’Œåº”ç”¨ç¨‹åºä¸ä¸€æ ·çš„åœ°æ–¹
<ul>
<li>ä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”</li>
</ul>
</li>
<li>(å¦‚æœæ˜¯è™šæ‹Ÿæœºå‘¢&hellip;ğŸ˜‚)
<ul>
<li>PAUSE æŒ‡ä»¤ä¼šè§¦å‘ VM Exit $\Longrightarrow$ é˜²æ­¢æœ‰æ•…éšœæŠŠç‰©ç†æœºç»™å¡æ­»</li>
</ul>
</li>
<li>ä½†ä¾æ—§å¾ˆéš¾åšå¥½
<ul>
<li><a href="https://www.usenix.org/conference/osdi10/analysis-linux-scalability-many-cores" target="_blank" rel="noopener noreffer">An analysis of Linux scalability to many cores</a> (OSDI'10) ï¼ˆ10å¹´paperï¼Œåæ§½Linuxå†…æ ¸çš„è‡ªæ—‹é”æœ‰å¤šçƒ‚ï¼‰</li>
</ul>
</li>
</ul>
<h3 id="å®ç°çº¿ç¨‹--é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</h3>
<blockquote>
<p>ä½œä¸šé‚£ä¹ˆå¤šï¼Œä¸å…¶å¹²ç­‰ Online Judge å‘å¸ƒï¼Œä¸å¦‚æŠŠè‡ªå·± (CPU) è®©ç»™å…¶ä»–ä½œä¸š (çº¿ç¨‹) æ‰§è¡Œï¼Ÿ</p>
<p><u>è¯´ç™½äº†å°±æ˜¯æœ‰äº‹æƒ…å¡ä½äº†å°±å»å¹²åˆ«çš„ï¼Œåˆ«å°±çğŸ”8ï¸âƒ£å¹²ç­‰ç€è¿™ä¸€ä»¶äº‹ï¼ˆè¿™ä¹Ÿå°±æ˜¯æ¯”è‡ªæ—‹é”é«˜æ˜çš„åœ°æ–¹ï¼‰</u></p>
</blockquote>
<p>â€œè®©â€ ä¸æ˜¯ C è¯­è¨€ä»£ç å¯ä»¥åšåˆ°çš„ (C ä»£ç åªèƒ½è®¡ç®—)</p>
<ul>
<li>
<p>æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œå°±å¥½å•¦ï¼$\Longrightarrow$ ç³»ç»Ÿè°ƒç”¨</p>
<ul>
<li>
<p><code>syscall(SYSCALL_lock, &amp;lk);</code></p>
<ul>
<li><b>è¯•å›¾è·å¾— <code>lk</code>ï¼Œä½†å¦‚æœå¤±è´¥ï¼Œ<u>å°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹</u>Â $\Longrightarrow$ è¿™ä¸ªå°±æ˜¯ç²¾é«“</b></li>
</ul>
</li>
<li>
<p><code>syscall(SYSCALL_unlock, &amp;lk);</code></p>
<ul>
<li><b>é‡Šæ”¾ <code>lk</code>ï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’</b></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-09 19:15</p>
<p>å¹²æ‹Œé¢åƒå®ŒçœŸæ’‘çš„æ…Œï¼Œä¸‹å›è¿˜æ˜¯åƒæ±¤é¢</p>
<p>æ™šä¸Šçœ‹å®Œ</p>
</div>
        </div>
    </div>
<h3 id="å®ç°çº¿ç¨‹--é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥-contd">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (cont&rsquo;d)</h3>
<ul>
<li>
<p><b>æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜</b></p>
</li>
<li>
<p>å…ˆåˆ°çš„äºº (çº¿ç¨‹)</p>
<ul>
<li>æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†</li>
<li><code>*lock = ğŸ”’</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›</li>
</ul>
</li>
<li>
<p>ååˆ°çš„äºº (çº¿ç¨‹)</p>
<ul>
<li>ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…</li>
<li><b>çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)</b></li>
</ul>
</li>
<li>
<p>æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)</p>
<ul>
<li>
<p>äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº</p>
</li>
<li>
<p><b>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</b></p>
</li>
<li>
<p><b>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ<code>*lock = âœ…</code></b></p>
</li>
</ul>
</li>
<li>
<p><b><font color="red">ç®¡ç†å‘˜ (OS) ä½¿ç”¨<u>è‡ªæ—‹é”</u>ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„</font></b></p>
</li>
</ul>
<h2 id="futex--spin--mutex">Futex = Spin + Mutex</h2>
<h3 id="å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ">å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</h3>
<ul>
<li>
<p>è‡ªæ—‹é” (çº¿ç¨‹ç›´æ¥å…±äº« locked)</p>
<ul>
<li>
<p>æ›´å¿«çš„ fast path</p>
<ul>
<li>xchg æˆåŠŸ â†’ ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å¾ˆå°</li>
</ul>
</li>
<li>
<p>æ›´æ…¢çš„ slow path</p>
<ul>
<li>xchg å¤±è´¥ â†’ æµªè´¹ CPU è‡ªæ—‹ç­‰å¾…ï¼ˆäº¤æ¢ä¸€äº›ä¸æ˜¯ğŸ”’ï¼Œæ²¡ç”¨çš„ä¸œè¥¿ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¡çœ ï¼ˆäº’æ–¥ï¼‰é” (é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—® locked)</p>
<ul>
<li>
<p>æ›´å¿«çš„ slow path</p>
<ul>
<li>ä¸Šé”å¤±è´¥çº¿ç¨‹ä¸å†å ç”¨ CPU</li>
</ul>
</li>
<li>
<p>æ›´æ…¢çš„ fast path</p>
<ul>
<li>å³ä¾¿ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦<u>è¿›å‡ºå†…æ ¸ (syscall)</u> $\Longrightarrow$ é€Ÿåº¦ç›¸å¯¹æ¯”è¾ƒæ…¢</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="futex-fast-userspace-mutexes">Futex: Fast Userspace muTexes</h3>
<blockquote>
<p>è§£å†³æ–¹æ¡ˆï¼šå…¨éƒ½è¦</p>
</blockquote>
<div class="mermaid" id="id-6"></div>
<ul>
<li>
<p><b><font color="red">æ€§èƒ½ä¼˜åŒ–çš„æœ€å¸¸è§æŠ€å·§</font></b></p>
<ul>
<li>çœ‹ average (frequent) case è€Œä¸æ˜¯ worst case $\Longrightarrow$ <b>è¿™é‡Œæ˜¯å’Œç®—æ³•é¢˜åšå¯¹æ¯”ï¼Œç®—æ³•é¢˜è¦ä¿è¯æ‰€æœ‰å¯èƒ½çš„æƒ…å†µéƒ½å¯ä»¥è¢«é«˜æ•ˆè®¡ç®—ï¼ˆworst caseï¼‰ï¼Œè€Œæ“ä½œç³»ç»Ÿè¦æ±‚çš„åˆ™æ˜¯å¤§éƒ¨åˆ†æƒ…å†µéƒ½å¯ä»¥è¢«å¿«é€Ÿå¤„ç†ï¼Œå°‘æ•°çš„æƒ…å†µå¤„ç†åœ°æ…¢ä¹Ÿå¯ä»¥ï¼ˆaverageï¼‰</b></li>
</ul>
</li>
<li>
<p>POSIX çº¿ç¨‹åº“ä¸­çš„äº’æ–¥é” (<code>pthread_mutex</code>) $\Longrightarrow$ ä¸¤ç§ğŸ”’çš„å¥½å¤„éƒ½å¾—äº†</p>
</li>
<li>
<p>æˆ‘ä»¬å°†<a href="https://jyywiki.cn/pages/OS/2022/demos/sum-scalability.c" target="_blank" rel="noopener noreffer">sum-scalability.c</a>é‡Œé¢çš„è‡ªæ—‹é”æ¢æˆäº’æ–¥é”</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">mutex_t</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">MUTEX_INIT</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>äº’æ–¥é”çš„å®ç°ï¼ˆé€šè¿‡syscallï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mutex_lock</span><span class="p">(</span><span class="n">mutex_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>   <span class="p">{</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mutex_unlock</span><span class="p">(</span><span class="n">mutex_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¼–è¯‘+æµ‹è¯•</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> 2023-03-09 20:11:45 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ gcc sum-scalability.c -O2 -lpthread
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:06 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.065s
</span></span><span class="line"><span class="cl">user    0m0.037s
</span></span><span class="line"><span class="cl">sys     0m0.019s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:12 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.180s
</span></span><span class="line"><span class="cl">user    0m0.121s
</span></span><span class="line"><span class="cl">sys     0m0.185s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:26 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.179s
</span></span><span class="line"><span class="cl">user    0m0.156s
</span></span><span class="line"><span class="cl">sys     0m0.152s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:28 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.106s
</span></span><span class="line"><span class="cl">user    0m0.100s
</span></span><span class="line"><span class="cl">sys     0m0.039s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:20:18 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.087s
</span></span><span class="line"><span class="cl">user    0m0.056s
</span></span><span class="line"><span class="cl">sys     0m0.060s
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><b>å¯ä»¥çœ‹åˆ°å½“çº¿ç¨‹æ•°é‡å˜å¤šçš„æ—¶å€™ï¼Œ<code>pthread_mutex</code>å¤„ç†çš„æ•ˆç‡è¦è¿œé«˜äºè‡ªæ—‹é”</b></p>
</li>
<li>
<p>è§‚å¯Ÿç³»ç»Ÿè°ƒç”¨ (strace) $\Longrightarrow$ å¤ªé•¿äº†å°±å¤åˆ¶ä¸€æ®µ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">2023-03-09 20:11:24 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ strace -f ./a.out <span class="m">64</span>
</span></span><span class="line"><span class="cl">execve<span class="o">(</span><span class="s2">&#34;./a.out&#34;</span>, <span class="o">[</span><span class="s2">&#34;./a.out&#34;</span>, <span class="s2">&#34;64&#34;</span><span class="o">]</span>, 0x7ffe8bbc7370 /* <span class="m">64</span> vars */<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55d83eca4000
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>0x3001 /* ARCH_??? */, 0x7ffcb38f0700<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>æ— æ•ˆçš„å‚æ•°<span class="o">)</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56b2a000
</span></span><span class="line"><span class="cl">access<span class="o">(</span><span class="s2">&#34;/etc/ld.so.preload&#34;</span>, R_OK<span class="o">)</span>      <span class="o">=</span> -1 ENOENT <span class="o">(</span>æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/etc/ld.so.cache&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>76495, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 76495, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56b17000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\237\2\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class="o">)</span> <span class="o">=</span> <span class="m">784</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\4\0\0\0 \0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&#34;</span>..., 48, 848<span class="o">)</span> <span class="o">=</span> <span class="m">48</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0i8\235HZ\227\223\333\350s\360\352,\223\340.&#34;</span>..., 68, 896<span class="o">)</span> <span class="o">=</span> <span class="m">68</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>2216304, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class="o">)</span> <span class="o">=</span> <span class="m">784</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 2260560, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56800000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda56828000, 1658880, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x28000<span class="o">)</span> <span class="o">=</span> 0x7fda56828000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda569bd000, 360448, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1bd000<span class="o">)</span> <span class="o">=</span> 0x7fda569bd000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda56a15000, 24576, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x214000<span class="o">)</span> <span class="o">=</span> 0x7fda56a15000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda56a1b000, 52816, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56a1b000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 12288, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56b14000
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>ARCH_SET_FS, 0x7fda56b14740<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">set_tid_address<span class="o">(</span>0x7fda56b14a10<span class="o">)</span>         <span class="o">=</span> <span class="m">4614</span>
</span></span><span class="line"><span class="cl">set_robust_list<span class="o">(</span>0x7fda56b14a20, 24<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rseq<span class="o">(</span>0x7fda56b150e0, 0x20, 0, 0x53053053<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7fda56a15000, 16384, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x55d83cf2f000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7fda56b64000, 8192, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">prlimit64<span class="o">(</span>0, RLIMIT_STACK, NULL, <span class="o">{</span><span class="nv">rlim_cur</span><span class="o">=</span>8192*1024, <span class="nv">rlim_max</span><span class="o">=</span>RLIM64_INFINITY<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">munmap<span class="o">(</span>0x7fda56b17000, 76495<span class="o">)</span>           <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rt_sigaction<span class="o">(</span>SIGRT_1, <span class="o">{</span><span class="nv">sa_handler</span><span class="o">=</span>0x7fda568918f0, <span class="nv">sa_mask</span><span class="o">=[]</span>, <span class="nv">sa_flags</span><span class="o">=</span>SA_RESTORER<span class="p">|</span>SA_ONSTACK<span class="p">|</span>SA_RESTART<span class="p">|</span>SA_SIGINFO, <span class="nv">sa_restorer</span><span class="o">=</span>0x7fda56842520<span class="o">}</span>, NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rt_sigprocmask<span class="o">(</span>SIG_UNBLOCK, <span class="o">[</span>RTMIN RT_1<span class="o">]</span>, NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda55fff000
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7fda56000000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">getrandom<span class="o">(</span><span class="s2">&#34;\xc0\x0d\x30\x79\xa6\xc0\x9a\x32&#34;</span>, 8, GRND_NONBLOCK<span class="o">)</span> <span class="o">=</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55d83eca4000
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>0x55d83ecc5000<span class="o">)</span>                     <span class="o">=</span> 0x55d83ecc5000
</span></span><span class="line"><span class="cl">rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>, <span class="o">[]</span>, 8<span class="o">)</span>   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda567ff910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda567ff910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda55fff000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda567ff640<span class="o">}</span>strace: Process <span class="m">4615</span> <span class="nv">attached</span>
</span></span><span class="line"><span class="cl"> <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4615<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4615</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> rseq<span class="o">(</span>0x7fda567fffe0, 0x20, 0, 0x53053053 &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... rseq resumed&gt;<span class="o">)</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> set_robust_list<span class="o">(</span>0x7fda567ff920, <span class="m">24</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda557fe000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... set_robust_list resumed&gt;<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda557ff000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>, <span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda55ffe910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda55ffe910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda557fe000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda55ffe640<span class="o">}</span>strace: Process <span class="m">4616</span> <span class="nv">attached</span>
</span></span><span class="line"><span class="cl"> <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4616<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4616</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> rseq<span class="o">(</span>0x7fda55ffefe0, 0x20, 0, 0x53053053 &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... rseq resumed&gt;<span class="o">)</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> set_robust_list<span class="o">(</span>0x7fda55ffe920, <span class="m">24</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda54ffd000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... set_robust_list resumed&gt;<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda54ffe000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;<span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda557fd910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda557fd910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda54ffd000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda557fd640<span class="o">}</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, 1<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">strace: Process <span class="m">4617</span> attached
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... clone3 resumed&gt; <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4617<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4617</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> rseq<span class="o">(</span>0x7fda557fdfe0, 0x20, 0, 0x53053053 &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... rseq resumed&gt;<span class="o">)</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> set_robust_list<span class="o">(</span>0x7fda557fd920, <span class="m">24</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda547fc000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... set_robust_list resumed&gt;<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda547fd000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;<span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda54ffc910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda54ffc910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda547fc000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda54ffc640<span class="o">}</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... clone3 resumed&gt; <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4618<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4618</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>, NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda53ffb000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda53ffc000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;<span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda547fb910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda547fb910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda53ffb000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda547fb640<span class="o">}</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é‡Œé¢æœ‰å¾ˆå¤šç±»ä¼¼73è¡Œçš„è¯­å¥<code>[pid  4616] futex(0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;</code></li>
</ul>
<blockquote>
<p><strong>ä¸€ã€ä»€ä¹ˆæ˜¯futexï¼Ÿ</strong></p>
<p>futexæ˜¯Fast Userspace muTEXçš„ç¼©å†™ï¼Œè¯¥æœºåˆ¶æ˜¯ç”±Rusty Russellã€Hubertus Frankeå’ŒMathew Kirkwoodåœ¨2.5.7ç‰ˆæœ¬çš„å†…æ ¸ä¸­å¼•å…¥ï¼Œè™½ç„¶åå­—ä¸­æœ‰äº’æ–¥é”ï¼ˆmutexï¼‰çš„å«ä¹‰ï¼Œä½†å®é™…å®ƒæ˜¯ä¸€ç§ç”¨äºç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºçš„é€šç”¨åŒæ­¥å·¥å…·ï¼ˆåŸºäºfutexå¯ä»¥åœ¨userspaceå®ç°äº’æ–¥é”ã€è¯»å†™é”ã€condition variableç­‰åŒæ­¥æœºåˆ¶ï¼‰ã€‚Futexç»„æˆåŒ…æ‹¬ï¼š</p>
<ul>
<li>å†…æ ¸ç©ºé—´çš„ç­‰å¾…é˜Ÿåˆ—</li>
<li>ç”¨æˆ·ç©ºé—´å±‚çš„32-bit futex wordï¼ˆæ‰€æœ‰å¹³å°éƒ½æ˜¯32bitï¼ŒåŒ…æ‹¬64ä½å¹³å°ï¼‰</li>
</ul>
<p><b>åœ¨æ²¡æœ‰ç«äº‰çš„åœºæ™¯ä¸‹ï¼Œé”çš„è·å–å’Œé‡Šæ”¾æ€§èƒ½éƒ½éå¸¸é«˜ï¼Œä¸éœ€è¦å†…æ ¸çš„å‚ä¸ï¼Œä»…ä»…æ˜¯é€šè¿‡ç”¨æˆ·ç©ºé—´çš„åŸå­æ“ä½œæ¥ä¿®æ”¹futex wordçš„çŠ¶æ€å³å¯</b>ã€‚åœ¨æœ‰ç«äº‰çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœçº¿ç¨‹æ— æ³•è·å–futexé”ï¼Œé‚£ä¹ˆæŠŠè‡ªå·±æ”¾å…¥åˆ° wait queueä¸­ï¼ˆé™·å…¥å†…æ ¸ï¼Œæœ‰ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼‰ï¼Œè€Œåœ¨owner taské‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°æœ‰ç«äº‰ï¼ˆç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰é˜»å¡ä»»åŠ¡ï¼‰ï¼Œå°±ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä½¿å…¶æ¢å¤æ‰§è¡Œï¼Œç»§ç»­å»æŒé”ã€‚å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œé‚£ä¹ˆä¹Ÿæ— éœ€é™·å…¥å†…æ ¸ã€‚</p>
<p>æ‘˜è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/568678633" target="_blank" rel="noopener noreffer">ã€Šä»€ä¹ˆæ˜¯futexï¼Ÿã€‹</a></p>
</blockquote>
<blockquote>
<p>Futexï¼ˆFast Userspace Mutexï¼‰æ˜¯ä¸€ç§ç”¨æˆ·ç©ºé—´é”ï¼Œå®ƒæ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºæ§åˆ¶å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ä¹‹é—´çš„è®¿é—®å…±äº«èµ„æºã€‚Futexä¸»è¦ç”¨äºå®ç°æ›´é«˜çº§åˆ«çš„åŒæ­¥åŸè¯­ï¼Œä¾‹å¦‚æ¡ä»¶å˜é‡å’Œè¯»å†™é”ã€‚Futexæä¾›äº†ä¸€ç§ä½å¼€é”€çš„é”æœºåˆ¶ï¼Œå½“é”è¢«æŒæœ‰æ—¶ï¼Œå®ƒå¯ä»¥é¿å…å°†çº¿ç¨‹æˆ–è¿›ç¨‹é˜»å¡åœ¨å†…æ ¸ç©ºé—´ã€‚</p>
<p>åœ¨Futexä¸­ï¼Œé”çš„çŠ¶æ€ä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè€Œä¸æ˜¯å†…æ ¸ç©ºé—´ä¸­ï¼Œå½“çº¿ç¨‹æˆ–è¿›ç¨‹éœ€è¦è·å–é”æ—¶ï¼Œå®ƒä¼šå°è¯•å°†é”çš„çŠ¶æ€ä»â€œæœªé”å®šâ€æ”¹ä¸ºâ€œé”å®šâ€çŠ¶æ€ã€‚å¦‚æœæˆåŠŸï¼Œçº¿ç¨‹æˆ–è¿›ç¨‹å°±å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚å¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹å ç”¨ï¼Œåˆ™å®ƒå°†åœ¨ç”¨æˆ·ç©ºé—´å†…å¿™ç­‰å¾…ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚</p>
<p>Futexè¿˜æ”¯æŒä¸€äº›å…¶ä»–çš„æ“ä½œï¼Œä¾‹å¦‚ç­‰å¾…ä¸€ä¸ªç‰¹å®šçš„å€¼æˆ–æ¯”è¾ƒå¹¶äº¤æ¢å€¼ï¼Œè¿™äº›æ“ä½œå¯ä»¥ç”¨äºå®ç°æ¡ä»¶å˜é‡å’Œè¯»å†™é”ç­‰é«˜çº§åˆ«çš„åŒæ­¥åŸè¯­ã€‚ç”±äºFutexçš„ä½å¼€é”€å’Œé«˜æ•ˆæ€§ï¼Œå®ƒæˆä¸ºäº†Linuxç³»ç»Ÿä¸­è®¸å¤šé«˜çº§åˆ«åŒæ­¥åŸè¯­çš„åŸºç¡€ã€‚</p>
<p>æ¥è‡ª<a href="https://openai.com/blog/chatgpt" target="_blank" rel="noopener noreffer">ChatGPT</a></p>
</blockquote>
<ul>
<li>
<p><b>å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿå°±ä¼šå‘ç°ï¼Œfutexè°ƒç”¨çš„æ•°é‡è¿œè¿œå°äºlockå’Œunlockçš„æ•°é‡</b></p>
</li>
<li>
<p>gdb è°ƒè¯•</p>
<ul>
<li><code>set scheduler-locking on</code>, <code>info threads</code>, <code>thread X</code></li>
</ul>
</li>
</ul>
<h3 id="futex-fast-userspace-mutexes-contd">Futex: Fast Userspace muTexes (cont&rsquo;d)</h3>
<p>å…ˆåœ¨ç”¨æˆ·ç©ºé—´è‡ªæ—‹</p>
<ul>
<li>å¦‚æœè·å¾—é”ï¼Œç›´æ¥è¿›å…¥</li>
<li>æœªèƒ½è·å¾—é”ï¼Œç³»ç»Ÿè°ƒç”¨</li>
<li>è§£é”ä»¥åä¹Ÿéœ€è¦ç³»ç»Ÿè°ƒç”¨
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/futex.py" target="_blank" rel="noopener noreffer">futex.py</a></li>
<li>æ›´å¥½çš„è®¾è®¡å¯ä»¥åœ¨ fast-path ä¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
</ul>
<p>futex.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Futex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span><span class="p">,</span> <span class="n">waits</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tryacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Test-and-set (cmpxchg)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Same effect, but more efficient than xchg</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>     <span class="c1"># User</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="c1"># Kernel</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>      <span class="c1"># Kernel</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>                         <span class="c1"># User</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>                            <span class="c1"># User</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>                    <span class="c1"># Kernel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;3&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;blue&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;green&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t3&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;yellow&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_both</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;t3&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>pythonä»£ç çš„ä¼˜åŠ¿ï¼šå¦‚æœä½ æƒ³è®©ä¸€å¥ä»£ç åŸå­æ‰§è¡Œâ€”â€”&gt;åŠ å…¥<code>yield breakpoint()</code></p>
</li>
<li>
<p><code>python3 model-checker.py futex.py | python3 visualize.py -t &gt; a.html </code>é‡å®šå‘ï¼Œå¯è§†åŒ–</p>
</li>
<li>
<p><a href="https://github.com/Jungle430/check-for-NJU-OS" target="_blank" rel="noopener noreffer">æ ·ä¾‹ä»“åº“</a></p>
</li>
</ul>
<hr>
<p>RTFM (åŠé€€)</p>
<ul>
<li>futex (7), futex (2)</li>
<li><a href="https://lwn.net/Articles/360699/" target="_blank" rel="noopener noreffer">A futex overview and update</a> (LWN)</li>
<li><a href="https://jyywiki.cn/pages/OS/manuals/futexes-are-tricky.pdf" target="_blank" rel="noopener noreffer">Futexes are tricky</a> (è®º model checker çš„é‡è¦æ€§) $\Longrightarrow$ <u>åŒæ—¶ä¹Ÿæç¤ºæˆ‘ä»¬ä»æœ€ç®€å•çš„å†™èµ·ï¼Œåƒä¸‡ä¸è¦è§‰å¾—è‡ªå·±è¡Œå°±è£…ğŸ–Šæå¤§çš„</u></li>
<li>(æˆ‘ä»¬ä¸è®²å¹¶å‘ç®—æ³•)</li>
</ul>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå®ç°äº’æ–¥ï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘ (è‡ªæ—‹é”)</li>
<li>ç”¨æˆ·ä¸å¤Ÿï¼Œå†…æ ¸æ¥å‡‘ (äº’æ–¥é”)
<ul>
<li><b><font color="red">æ‰¾åˆ°ä½ ä¾èµ–çš„å‡è®¾ï¼Œå¹¶å¤§èƒ†åœ°æ‰“ç ´å®ƒ</font></b></li>
</ul>
</li>
<li>Fast/slow paths: æ€§èƒ½ä¼˜åŒ–çš„é‡è¦é€”å¾„</li>
</ul>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/operating-system/">Operating System</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>æ›´æ–°äº 2023-03-08</span>
            </div><div class="post-info-mod"></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥" data-hashtags="Operating System"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-hashtag="Operating System"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Linkedin" data-sharer="linkedin" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° WhatsApp" data-sharer="whatsapp" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Myspace" data-sharer="myspace" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Blogger" data-sharer="blogger" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer="baidu" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Evernote" data-sharer="evernote" data-url="https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/" data-title="Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥"><i class="fab fa-evernote fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/posts/operating-system/operating-system-chapter4/" class="prev" rel="prev" title="Operating System Chapter4 ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
            <a href="/posts/operating-system/operating-system-chapter6/" class="next" rel="next" title="Operating System Chapter6 å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥">Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/khusika/FeelIt" target="_blank" rel="noopener noreffer" title="FeelIt 1.0.1"><i class="fas fa-hand-holding-heart fa-fw"></i> FeelIt</a>
        </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/Jungle430">Jungle</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=0.0.1', { scope: '/' })
        .then(() => {
            console.info('Jungle\u0027s Blog\u00A0Service Worker Registered');
        }, err => console.error('Jungle\u0027s Blog\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('Jungle\u0027s Blog\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/auto-render.min.js"></script><script src="/lib/katex/copy-tex.min.js"></script><script src="/lib/katex/mhchem.min.js"></script><script src="/lib/mermaid/mermaid.min.js"></script><script>window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":100},"comment":{},"data":{"id-1":"graph TB\nA(CPU1)\nB(CPU2)\nC(Memory)\nA----C\nB----C","id-2":"graph TB\nA(CPU1)\nB(CPU2)\nC(cache11)\nD(cache21)\nE(Memory)\nF(cache12)\nG(cache22)\nA----C----F----E\nB----D----G----E","id-3":"graph TB\nA(CPU1)\nB(CPU2)\nC(cache11)\nD(cache21)\nE(Memory)\nF(cache12)\nG(cache22)\nH(m)\nA----C----F----E\nB----D----G----E\nH----C\nH----D","id-4":"graph\nA(CPU1)\nB(CPU2)\nC(CPU3)\nD(CPU4)\nA----B----C----D----A","id-5":"graph LR\nA(T1)\nB(T2)\nC(T3)\nD(\"ğŸ”’\")\nD----A\nE(Sleep)\nA--\u003eB--\u003eC\nA----\u003eE","id-6":"graph TB\nA(\"Fast path: ä¸€æ¡åŸå­æŒ‡ä»¤ï¼Œä¸Šé”æˆåŠŸç«‹å³è¿”å›\")\nB(\"Slow path: ä¸Šé”å¤±è´¥ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ç¡çœ \")\nC(ä¸¤è€…ç»“åˆ)\nC--\u003eA\nC--\u003eB"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js"></script></body></html>
