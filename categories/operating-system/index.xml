<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>Operating System - åˆ†ç±» - Jungle&#39;s Blog</title>
        <link>https://Jungle430.github.io/categories/operating-system/</link>
        <description>Operating System - åˆ†ç±» - Jungle&#39;s Blog</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>1239946358@qq.com (Jungle)</managingEditor>
            <webMaster>1239946358@qq.com (Jungle)</webMaster><lastBuildDate>Sat, 25 Mar 2023 23:21:44 &#43;0800</lastBuildDate><atom:link href="https://Jungle430.github.io/categories/operating-system/" rel="self" type="application/rss+xml" /><item>
    <title>Operating System Chapter9 æ“ä½œç³»ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter9/</link>
    <pubDate>Sat, 25 Mar 2023 23:21:44 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter9/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>å¹¶å‘â€¦â€¦å°±è¿™ä¹ˆâ€¦â€¦è®²å®Œäº†â€¦â€¦
<ul>
<li>ç†è§£çš„æ–¹å¼ï¼šâ€œç©ä¸€ç©â€ ç¤ºä¾‹ä»£ç </li>
</ul>
</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¬è¯´æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åºã€‚é‚£åˆ°åº•æ˜¯é¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡ï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>è½¯ä»¶å’Œç¡¬ä»¶çš„æ¡¥æ¢</li>
<li>æ“ä½œç³»ç»Ÿçš„åŠ è½½å’Œåˆå§‹åŒ–</li>
<li>AbstractMachine ä»£ç å¯¼è¯»</li>
</ul>
<h2 id="è‡ªå·±åŠ¨æ‰‹å†™æ“ä½œç³»ç»Ÿ">è‡ªå·±åŠ¨æ‰‹å†™æ“ä½œç³»ç»Ÿ</h2>
<h3 id="æ—¶äº‹çƒ­è¯„">æ—¶äº‹çƒ­è¯„</h3>
<p><a href="https://www.bilibili.com/video/BV14T4y1D7y8" target="_blank" rel="noopener noreffer">å°å­¦ç”Ÿå†™äº†ä¸‰ä¸ªæœˆçš„æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</a></p>
<ul>
<li>çœ‹åˆ° i386 å°±çŸ¥é“äº†å˜›</li>
</ul>
<h3 id="æœ¬å­¦æœŸçš„-oslabs">æœ¬å­¦æœŸçš„ OSLabs</h3>
<p>çƒ­èº«å®éªŒ</p>
<ul>
<li>Lab0 (amgame): ç†Ÿæ‚‰ä»£ç æ¡†æ¶</li>
</ul>
<hr>
<p>æ­£ç»å®éªŒ</p>
<ul>
<li>
<p>Lab1 (pmm): Physical memory management</p>
<ul>
<li>å¤šå¤„ç†å™¨ (bare-metal) ä¸Šçš„ kalloc/free</li>
</ul>
</li>
<li>
<p>Lab2 (kmt): Kernel multi-threading</p>
<ul>
<li>ä¸­æ–­å’Œå¼‚å¸¸é©±åŠ¨çš„ä¸Šä¸‹æ–‡ (çº¿ç¨‹) åˆ‡æ¢</li>
</ul>
</li>
<li>
<p>Lab3 (uproc): User processes</p>
<ul>
<li>è™šæ‹Ÿåœ°å€ç©ºé—´ã€ç”¨æˆ·æ€è¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
<li>
<p>Lab4 (vfs): Virtual file system</p>
<ul>
<li>devfs, procfs, ç®€å•çš„æ–‡ä»¶ç³»ç»Ÿï¼›ELF åŠ è½½å™¨</li>
</ul>
</li>
</ul>
<h3 id="å¤§å­¦çš„çœŸæ­£æ„ä¹‰">å¤§å­¦çš„çœŸæ­£æ„ä¹‰</h3>
<blockquote>
<p>å°†å·²æœ‰çš„çŸ¥è¯†å’Œæ–¹æ³•é‡æ–°æ¶ˆåŒ–ï¼Œä¸ºå¤§å®¶å»ºç«‹å¥½ â€œå°é˜¶â€ï¼Œåœ¨æœ‰é™çš„æ—¶é—´é‡Œè¿…é€Ÿ<font color="red">èµ¶ä¸Šæ•°åå¹´æ¥å»ºç«‹èµ·çš„å­¦ç§‘ä½“ç³»</font></p>
</blockquote>
<hr>
<ul>
<li>
<p>ä¾‹å­ï¼šç ´é™¤ â€œå†™æ“ä½œç³»ç»Ÿå¾ˆéš¾â€ã€â€œå†™æ“ä½œç³»ç»Ÿå¾ˆç‰›â€ çš„é”™è¯¯è®¤è¯†</p>
<ul>
<li>
<p>æ“ä½œç³»ç»ŸçœŸçš„å°±æ˜¯ä¸ª C ç¨‹åº</p>
</li>
<li>
<p>ä½ åªæ˜¯éœ€è¦ â€œè¢«æ­£ç¡®å‘ŠçŸ¥â€ ä¸€äº›é¢å¤–çš„çŸ¥è¯†</p>
<ul>
<li>ç„¶åå†™ä»£ç ã€åƒè‹¦å¤´</li>
<li>ä»è€Œå»ºç«‹æ­£ç¡®çš„ â€œä¸“ä¸šä¸–ç•Œè§‚â€</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ä¾‹å­">ä¾‹å­</h3>
<ul>
<li>
<p>â€œä¸“ä¸šä¸–ç•Œè§‚â€ çš„ä¾‹å­ (è¿™äº›éƒ½æ²¡å•¥ï¼Œpaper éƒ½å‘ä¸äº†)</p>
<ul>
<li>
<p>å†™ x86 æ¨¡æ‹Ÿå™¨çš„æ—¶å€™ï¼Œä¸çŸ¥é“å“ªæ¡æŒ‡ä»¤é”™äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
</li>
<li>
<p>åšæ“ä½œç³»ç»Ÿå®éªŒçš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°ç¥ç§˜ CPU Resetï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
</li>
<li>
<p>åšå®éªŒåšä¸ä¸‹å»çš„æ—¶å€™ï¼Œè¯¥å®ç°ä»€ä¹ˆå·¥å…·ï¼Ÿ</p>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>â€œä¸“ä¸šä¸–ç•Œè§‚â€ çš„å­¦ä¹ æ–¹æ³•</p>
<ul>
<li>
<p>ç»å…¸ç ”ç©¶è®ºæ–‡ (OSDI, SOSP, ATC, EuroSys, &hellip;)</p>
</li>
<li>
<p>ä¹…ç»è€ƒéªŒçš„ç»å…¸æ•™å­¦ææ–™ (xv6, OSTEP, CSAPP, &hellip;)</p>
</li>
<li>
<p>æµ·é‡çš„å¼€æºå·¥å…· (GNU ç³»åˆ—, qemu, gdb, &hellip;)</p>
</li>
<li>
<p>ç¬¬ä¸‰æ–¹èµ„æ–™ï¼Œæ…ç”¨ (tutorials, osdev wiki, &hellip;)</p>
</li>
</ul>
</li>
</ul>
<h2 id="ç¡¬ä»¶å’Œè½¯ä»¶çš„æ¡¥æ¢">ç¡¬ä»¶å’Œè½¯ä»¶çš„æ¡¥æ¢</h2>
<h3 id="c-ç¨‹åº">C ç¨‹åº</h3>
<ul>
<li>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•å†™ä¸€ä¸ª â€œæœ€å°â€ çš„ C ç¨‹åºäº†ï¼š</p>
<ul>
<li>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/minimal.S" target="_blank" rel="noopener noreffer">minimal.S</a></p>
</li>
<li>
<p>ä¸éœ€è¦é“¾æ¥ä»»ä½•åº“ï¼Œå°±èƒ½åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ</p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">globl</span> <span class="n">_start</span>
</span></span><span class="line"><span class="cl"><span class="nl">_start</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">SYS_write</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span>   <span class="c1">// write(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span>         <span class="o">%</span><span class="n">rdi</span>   <span class="c1">//   fd=1,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">movq</span> <span class="err">$</span><span class="n">st</span><span class="p">,</span>        <span class="o">%</span><span class="n">rsi</span>   <span class="c1">//   buf=st,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">movq</span> <span class="err">$</span><span class="p">(</span><span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">),</span> <span class="o">%</span><span class="n">rdx</span>   <span class="c1">//   count=ed-st
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">syscall</span>                 <span class="c1">// );
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">SYS_exit</span><span class="p">,</span>  <span class="o">%</span><span class="n">rax</span>   <span class="c1">// exit(
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span>         <span class="o">%</span><span class="n">rdi</span>   <span class="c1">//   status=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">syscall</span>                 <span class="c1">// );
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nl">st</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">ascii</span> <span class="s">&#34;</span><span class="se">\033</span><span class="s">[01;31mHello, OS World</span><span class="se">\033</span><span class="s">[0m</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ed</span><span class="p">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>â€œç¨‹åº = çŠ¶æ€æœºâ€ æ²¡é—®é¢˜</p>
</li>
<li>
<p>å¸¦æ¥æ›´å¤šçš„ç–‘é—®</p>
<ul>
<li><font color="red">ä½†è°åˆ›å»ºçš„è¿™ä¸ªçŠ¶æ€æœºï¼Ÿï¼Ÿï¼Ÿ</font>
<ul>
<li>å½“ç„¶æ˜¯æ“ä½œç³»ç»Ÿäº†â€¦â€¦å‘ƒâ€¦â€¦ $\Longrightarrow$ å‚è€ƒ<a href="https://jungle430.github.io/posts/operating-system/support2/#%E4%BB%8E%E6%88%91%E4%BB%AC%E7%BB%88%E7%AB%AF%E6%95%B2%E5%9B%9E%E8%BD%A6%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%A2%AB%E8%BD%BD%E5%85%A5%E6%89%A7%E8%A1%8C%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88" target="_blank" rel="noopener noreffer">ä»æˆ‘ä»¬ç»ˆç«¯æ•²å›è½¦åˆ°ç¨‹åºè¢«è½½å…¥æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</a></li>
</ul>
</li>
<li><font color="red">è¿™ä¸ªç¨‹åºå¯ä»¥åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„ç¡¬ä»¶ä¸Šè¿è¡Œå—ï¼Ÿ</font>
<ul>
<li>â€œå¯åŠ¨â€ çŠ¶æ€æœºæ˜¯ç”± â€œåŠ è½½å™¨â€ å®Œæˆçš„</li>
<li>åŠ è½½å™¨ä¹Ÿæ˜¯ä¸€æ®µç¨‹åº (çŠ¶æ€æœº)</li>
<li>è¿™ä¸ªç¨‹åºç”±æ˜¯ç”±è°åŠ è½½çš„ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â”Œâ”€â”€<span class="o">(</span>kaliã‰¿kali<span class="o">)</span>-<span class="o">[</span>~/chapter9<span class="o">]</span>
</span></span><span class="line"><span class="cl">â””â”€$ file minimal
</span></span><span class="line"><span class="cl">minimal: ELF 64-bit LSB executable, x86-64, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, not stripped
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bare-metal-ä¸ç¨‹åºå‘˜çš„çº¦å®š">Bare-metal ä¸ç¨‹åºå‘˜çš„çº¦å®š</h3>
<ul>
<li>
<p>è®¡ç®—æœºç¡¬ä»¶è¿è¡Œçš„æ—¶å€™ä¹Ÿæ˜¯çŠ¶æ€æœº</p>
</li>
<li>
<p>ä¸ºäº†è®©è®¡ç®—æœºèƒ½<font color="red">è¿è¡Œä»»ä½•æˆ‘ä»¬çš„ç¨‹åº</font>ï¼Œä¸€å®šå­˜åœ¨è½¯ä»¶/ç¡¬ä»¶çš„çº¦å®š</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><b>CPU reset</b> åï¼Œå¤„ç†å™¨å¤„äºæŸä¸ª<b>ç¡®å®šçš„çŠ¶æ€</b></p>
<ul>
<li><b>PC æŒ‡é’ˆ</b>ä¸€èˆ¬æŒ‡å‘ä¸€æ®µ <font color="blue">memory-mapped ROM</font>
<ul>
<li>ROM å­˜å‚¨äº†å‚å•†æä¾›çš„ firmware (å›ºä»¶)</li>
</ul>
</li>
<li>å¤„ç†å™¨çš„å¤§éƒ¨åˆ†ç‰¹æ€§å¤„äºå…³é—­çŠ¶æ€
<ul>
<li>ç¼“å­˜ã€è™šæ‹Ÿå­˜å‚¨ã€â€¦â€¦</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Firmware (å›ºä»¶ï¼Œå‚å•†æä¾›çš„ä»£ç )</p>
<ul>
<li>å°†ç”¨æˆ·æ•°æ®åŠ è½½åˆ°å†…å­˜
<ul>
<li>ä¾‹å¦‚å­˜å‚¨ä»‹è´¨ä¸Šçš„ç¬¬äºŒçº§ loader (åŠ è½½å™¨)</li>
<li>æˆ–è€…ç›´æ¥åŠ è½½æ“ä½œç³»ç»Ÿ (åµŒå…¥å¼ç³»ç»Ÿ)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="x86-family-cpu-reset-è¡Œä¸º">x86 Family: CPU Reset è¡Œä¸º</h3>
<ul>
<li>
<p>CPU Reset (<a href="https://software.intel.com/en-us/articles/intel-sdm" target="_blank" rel="noopener noreffer">IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</a>, Volume 3A/3B)</p>
</li>
<li>
<p>å¯„å­˜å™¨ä¼šæœ‰åˆå§‹çŠ¶æ€</p>
<ul>
<li>
<p><code>EIP = 0x0000fff0</code></p>
</li>
<li>
<p><code>CR0 = 0x60000010</code></p>
<ul>
<li>16-bit æ¨¡å¼ $\Longrightarrow$ 2010å¹´å‰çš„è€ç”µè„‘ä¼šå…¼å®¹è€æ¥å£å’Œè€çš„æ“ä½œç³»ç»Ÿ</li>
</ul>
</li>
<li>
<p><code>EFLAGS = 0x00000002</code></p>
</li>
<li>
<p>interrupt disabledï¼ˆä¸­æ–­å…³é—­ï¼‰</p>
</li>
</ul>
</li>
<li>
<p>TFM (5,000 é¡µ by 2019)</p>
<ul>
<li>æœ€éœ€è¦çš„ Volume 3A åªæœ‰ 468 é¡µ</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter9-1.png" title="/img/Operating System/chapter9-1.png" data-thumbnail="/img/Operating System/chapter9-1.png" data-sub-html="<h2>friendly manual</h2>">
        
    </a><figcaption class="image-caption"><code>friendly manual</code></figcaption>
    </figure>
<ul>
<li>è®©<code>qemu</code>æ¨¡æ‹Ÿå™¨åœåœ¨ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸Šï¼Œå’Œä¸Šé¢çš„æ‰‹å†Œå¯¹ç…§ï¼Œä¼šå‘ç°å’Œæ‰‹å†Œä¸€è‡´</li>
</ul>
<h3 id="cpu-reset-ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆ">CPU Reset ä¹‹åï¼šå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h3>
<ul>
<li>
<p>ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹ï¼š<font color="red">ä¸ä»…æ˜¯ç¨‹åºï¼Œæ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº</font></p>
<ul>
<li>
<p>ä» PC (<code>CS:IP</code>) æŒ‡é’ˆå¤„å–æŒ‡ä»¤ã€è¯‘ç ã€æ‰§è¡Œâ€¦â€¦</p>
</li>
<li>
<p>ä» firmware å¼€å§‹æ‰§è¡Œ</p>
<ul>
<li><code>ffff0</code>(PCåˆå§‹åŒ–çš„å€¼) é€šå¸¸æ˜¯ä¸€æ¡å‘ firmware è·³è½¬çš„ jmp æŒ‡ä»¤</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å‚å•†ä¼šåœ¨<code>ROW</code>é‡Œé¢æ”¾å¥½å†™æ­»çš„ä»£ç ï¼ˆOnly-readï¼‰</p>
</li>
<li>
<p>Firmware: <a href="https://www.zhihu.com/question/21672895" target="_blank" rel="noopener noreffer">BIOS vs. UEFI</a></p>
<ul>
<li>
<p>éƒ½æ˜¯ä¸»æ¿/ä¸»æ¿ä¸Šå¤–æ’è®¾å¤‡çš„è½¯ä»¶æŠ½è±¡</p>
<ul>
<li>æ”¯æŒç³»ç»Ÿç®¡ç†ç¨‹åºè¿è¡Œ</li>
</ul>
</li>
<li>
<p>Legacy BIOS (Basic I/O System)</p>
</li>
<li>
<p>UEFI (Unified Extensible Firmware Interface)</p>
</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter9-2.png" title="/img/Operating System/chapter9-2.png" data-thumbnail="/img/Operating System/chapter9-2.png" data-sub-html="<h2>BIOS</h2>">
        
    </a><figcaption class="image-caption"><code>BIOS</code></figcaption>
    </figure>
<h3 id="legacy-bios-çº¦å®š">Legacy BIOS: çº¦å®š</h3>
<p><b>Firmware å¿…é¡»æä¾›æœºåˆ¶ï¼Œå°†ç”¨æˆ·æ•°æ®è½½å…¥å†…å­˜</b></p>
<div class="mermaid" id="id-1"></div>
<ul>
<li>
<p>Legacy BIOS æŠŠ<b>ç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºåŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ <code>7c00</code> ä½ç½®</b>ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬Firewareå’ŒOSä¹‹é—´çš„ç¬¬ä¸€æ¬¡ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€æ¬¡æ¡æ‰‹</p>
<ul>
<li>
<p>æ­¤æ—¶å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼</p>
</li>
<li>
<p>è§„å®š <code>CS:IP = 0x7c00</code>, <code>(R[CS] &lt;&lt; 4) | R[IP] == 0x7c00</code></p>
<ul>
<li>
<p>å¯èƒ½æ€§1ï¼š<code>CS = 0x07c0, IP = 0</code></p>
</li>
<li>
<p>å¯èƒ½æ€§2ï¼š<code>CS = 0, IP = 0x7c00</code></p>
</li>
</ul>
</li>
<li>
<p>å…¶ä»–æ²¡æœ‰ä»»ä½•çº¦æŸ</p>
</li>
</ul>
</li>
<li>
<p>Windowså¯åŠ¨æ¨¡å¼ï¼šè€çš„Windowsçš„Aï¼ŒBç›˜éƒ½æ˜¯è½¯ç›˜ï¼ŒBIOSå…ˆå»è½¯ç›˜é‡Œé¢è¯»å‰512ä¸ª<code>bytes</code>ï¼Œçœ‹æœ€åä¸¤ä¸ªbyteæ˜¯å¦ä¸º<code>55aa</code>ï¼ˆå¤§ç«¯ï¼‰ï¼Œå¦‚æœæ˜¯å°±åŠ è½½è¿™å—ç£ç›˜ï¼Œå¦åˆ™è¯»ä¸‹ä¸€å—ï¼Œå¦‚æœéƒ½ä¸æ˜¯å°±å¯åŠ¨å¤±è´¥ã€‚è¯»å®ŒA/Bç›˜ä¹‹åå¼•å¯¼åˆ°Cç›˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä»Šå¤©çš„Windowsæ“ä½œç³»ç»ŸCç›˜æ˜¯ç³»ç»Ÿç›˜çš„åŸå› </p>
</li>
<li>
<p>Firmwareåšçš„äº‹æƒ…ï¼ˆä»¥BIOSä¸ºä¾‹ï¼‰</p>
</li>
</ul>
<div class="mermaid" id="id-2"></div>
<h3 id="èƒ½ä¸èƒ½çœ‹ä¸€ä¸‹ä»£ç ">èƒ½ä¸èƒ½çœ‹ä¸€ä¸‹ä»£ç ï¼Ÿ</h3>
<blockquote>
<p>Talk is cheap. Show me the code. â€”â€”Linus Torvalds</p>
</blockquote>
<ul>
<li>
<p>æœ‰æ²¡æœ‰å¯èƒ½æˆ‘ä»¬çœŸçš„å»çœ‹ä» CPU Reset ä»¥åæ¯ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼Ÿ</p>
</li>
<li>
<p><font color="red">è®¡ç®—æœºç³»ç»Ÿå…¬ç†ï¼šä½ æƒ³åˆ°çš„å°±ä¸€å®šæœ‰äººåšåˆ°</font></p>
</li>
<li>
<p>æ¨¡æ‹Ÿæ–¹æ¡ˆï¼šQEMU</p>
<ul>
<li>ä¼ å¥‡é»‘å®¢ã€å¤©æ‰ç¨‹åºå‘˜ <a href="https://www.zhihu.com/question/28388113" target="_blank" rel="noopener noreffer">Fabrice Bellard</a> çš„æ°ä½œï¼ˆå…¶ä»–:ffmpeg)
<ul>
<li><a href="https://www.usenix.org/legacy/publications/library/proceedings/usenix05/tech/freenix/full_papers/bellard/bellard.pdf" target="_blank" rel="noopener noreffer">QEMU, A fast and portable dynamic translator</a> (USENIX ATC'05)</li>
<li>Android Virtual Device, VirtualBox, &hellip; èƒŒåéƒ½æ˜¯ QEMU</li>
</ul>
</li>
</ul>
</li>
<li>
<p>çœŸæœºæ–¹æ¡ˆï¼šJTAG (Joint Test Action Group) debugger</p>
<ul>
<li>ä¸€ç³»åˆ— (ç‰©ç†) è°ƒè¯•å¯„å­˜å™¨ï¼Œå¯ä»¥å®ç° gdb æ¥å£ (!!!)</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter9-3.png" title="/img/Operating System/chapter9-3.png" data-thumbnail="/img/Operating System/chapter9-3.png" data-sub-html="<h2>ffmpeg</h2>">
        
    </a><figcaption class="image-caption"><code>ffmpeg</code></figcaption>
    </figure>
<h3 id="è°ƒè¯•-qemu-ç¡®è®¤-firmware-çš„è¡Œä¸º">è°ƒè¯• QEMU: ç¡®è®¤ Firmware çš„è¡Œä¸º</h3>
<blockquote>
<p>äº²çœ¼ç¡®è®¤ Firmware åˆ°åº•æ˜¯ä¸æ˜¯ä¼šåŠ è½½å¯åŠ¨ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºåˆ° <code>0x7c00</code> å†…å­˜ä½ç½®ï¼</p>
</blockquote>
<p>è°ƒè¯• QEMU æ¨¡æ‹Ÿå™¨</p>
<ul>
<li>
<p>æŸ¥çœ‹ CPU Reset åçš„å¯„å­˜å™¨</p>
<ul>
<li><code>info registers</code></li>
</ul>
</li>
<li>
<p>æŸ¥çœ‹<code>0x7c00</code>å†…å­˜çš„åŠ è½½</p>
<ul>
<li><code>watch *0x7c00</code> - ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹çš„è‰¯è‹¦ç”¨å¿ƒ</li>
<li>æŸ¥çœ‹å½“å‰æŒ‡ä»¤ <code>x/i ($cs * 16 + $rip)</code></li>
<li>æ‰“å°å†…å­˜ <code>x/16xb 0x7c00</code></li>
</ul>
</li>
<li>
<p>è¿›å…¥<code>0x7c00</code>ä»£ç çš„æ‰§è¡Œ</p>
<ul>
<li><code>b *0x7c00</code>, <code>c</code> (æ’’èŠ±ï¼æˆ‘ä»¬ä¸€ä¼šå†å›æ¥)</li>
</ul>
</li>
</ul>
<h3 id="é¸¡å’Œè›‹çš„é—®é¢˜è§£å†³">é¸¡å’Œè›‹çš„é—®é¢˜è§£å†³</h3>
<ul>
<li>
<p>æœ‰ä¸ªåŸå§‹çš„é¸¡ï¼šFirmware</p>
<ul>
<li>
<p>ä»£ç ç›´æ¥å­˜åœ¨äºç¡¬ä»¶é‡Œ</p>
</li>
<li>
<p>CPU Reset å Firmware ä¼šæ‰§è¡Œ</p>
<ul>
<li>åŠ è½½ 512 å­—èŠ‚åˆ°å†…å­˜ (Legacy Boot)
<ul>
<li>ç„¶ååŠŸæˆèº«é€€</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Firmware çš„å¦ä¸€ç”¨å¤„</p>
<ul>
<li>æ”¾ç½®ä¸€äº› â€œç»å¯¹å®‰å…¨çš„ä»£ç â€
<ul>
<li><a href="https://jyywiki.cn/pages/OS/manuals/BIOS-interrupts.pdf" target="_blank" rel="noopener noreffer">BIOS ä¸­æ–­</a> (Hello World æ˜¯å¦‚ä½•è¢«æ‰“å°çš„)</li>
<li>å¦‚æœåŠ è½½å¤±è´¥å°†é”™è¯¯ä¿¡æ¯æ‰“å°å‡ºæ¥</li>
<li>ARM Trusted Firmware
<ul>
<li>Boot-Level 1, 2, 3.1, 3.2, 3.3</li>
<li><a href="https://www.denx.de/wiki/U-Boot" target="_blank" rel="noopener noreffer">U-Boot</a>: the universal boot loader</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å°æ’æ›²firmware-çš„ç—…æ¯’-1998">å°æ’æ›²ï¼šFirmware çš„ç—…æ¯’ (1998)</h3>
<ul>
<li>
<p>Firmware é€šå¸¸æ˜¯åªè¯»çš„ (å½“ç„¶â€¦â€¦)</p>
</li>
<li>
<p>Intel 430TX (Pentium) èŠ¯ç‰‡ç»„å…è®¸<font color="red">å†™å…¥ Flash ROM</font></p>
<ul>
<li>
<p>åªè¦å‘ Flash BIOS å†™å…¥ç‰¹å®šåºåˆ—ï¼ŒFlash ROM å°±å˜ä¸ºå¯å†™</p>
<ul>
<li>ç•™ç»™ firmware æ›´æ–°çš„é€šé“</li>
</ul>
</li>
<li>
<p>è¦å¾—åˆ°è¿™ä¸ªåºåˆ—å…¶å®å¹¶ä¸å›°éš¾</p>
<ul>
<li>ä¼¼ä¹æ–‡æ¡£é‡Œå°±æœ‰ ğŸ¤” Boomâ€¦â€¦</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><a href="https://zh.wikipedia.org/zh-tw/CIH%E7%97%85%E6%AF%92" target="_blank" rel="noopener noreffer">CIH</a> çš„ä½œè€…é™ˆç›ˆè±ªè¢«é€®æ•ï¼Œä½†å¹¶æœªè¢«å®šç½ª</p>
</blockquote>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter9-4.gif" title="/img/Operating System/chapter9-4.gif" data-thumbnail="/img/Operating System/chapter9-4.gif" data-sub-html="<h2>ç—…æ¯’ä»£ç ç»“å°¾çš„CIH</h2>">
        
    </a><figcaption class="image-caption"><code>ç—…æ¯’ä»£ç ç»“å°¾çš„CIH</code></figcaption>
    </figure>
]]></description>
</item>
<item>
    <title>Operating System Chapter8 å¹¶å‘ bug å’Œåº”å¯¹</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/</link>
    <pubDate>Fri, 17 Mar 2023 13:48:22 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter8/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥</li>
<li>å¹¶å‘ç¼–ç¨‹çš„åº”ç”¨åœºæ™¯ï¼šé«˜æ€§èƒ½è®¡ç®—ã€æ•°æ®ä¸­å¿ƒã€ç½‘é¡µ/ç§»åŠ¨åº”ç”¨</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¹¶å‘ç¼–ç¨‹é‚£ä¹ˆéš¾ï¼Œæˆ‘å†™å‡º bug æ€ä¹ˆåŠï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>åº”å¯¹ bug (å’Œå¹¶å‘ bug) çš„æ–¹æ³•</li>
<li>æ­»é”å’Œæ•°æ®ç«äº‰</li>
</ul>
<h2 id="åº”å¯¹-bug-çš„æ–¹æ³•">åº”å¯¹ Bug çš„æ–¹æ³•</h2>
<h3 id="åŸºæœ¬æ€è·¯å¦å®šä½ è‡ªå·±">åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±</h3>
<blockquote>
<p>è™½ç„¶ä¸å¤ªæ„¿æ„æ‰¿è®¤ï¼Œä½†å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„ã€‚</p>
</blockquote>
<p>ç„¶åå‘¢ï¼Ÿ</p>
<ul>
<li>åšå¥½æµ‹è¯•</li>
<li>æ£€æŸ¥å“ªé‡Œé”™äº†</li>
<li>å†æ£€æŸ¥å“ªé‡Œé”™äº†</li>
<li>å†å†æ£€æŸ¥å“ªé‡Œé”™äº†
<ul>
<li>(æŠŠä»»ä½•ä½ è®¤ä¸º â€œä¸å¯¹â€ çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€é)</li>
</ul>
</li>
</ul>
<h3 id="bug-å¤šçš„æ ¹æœ¬åŸå› ç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·">Bug å¤šçš„æ ¹æœ¬åŸå› ï¼šç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·</h3>
<blockquote>
<p>è½¯ä»¶æ˜¯éœ€æ±‚ (è§„çº¦) åœ¨è®¡ç®—æœºæ•°å­—ä¸–ç•Œçš„<b>æŠ•å½±</b>ï¼ˆå…³äºå˜é‡çš„æ›´å¤šå†…å®¹ä¸¢å¤±äº†ï¼Œåªæ˜ å°„äº†ä¸€éƒ¨åˆ†ï¼‰</p>
</blockquote>
<p>åªç®¡ â€œç¿»è¯‘â€ ä»£ç ï¼Œä¸ç®¡å’Œå®é™…éœ€æ±‚ (è§„çº¦) æ˜¯å¦åŒ¹é…</p>
<ul>
<li>å¯ä»¥åŠ å…¥assertæ¥è¿›è¡Œè¯æ˜</li>
</ul>
<hr>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/alipay.c" target="_blank" rel="noopener noreffer">alipay.c</a>çš„ä¾‹å­
<ul>
<li>å˜é‡ <code>balance</code> ä»£è¡¨ â€œä½™é¢â€</li>
<li>æ€ä¹ˆçœ‹ withdraw ä»¥å 0 â†’ 18446744073709551516 éƒ½ä¸å¯¹</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">balance</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Alipay_withdraw</span><span class="p">(</span><span class="kt">int</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// unexpected delays
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">balance</span> <span class="o">-=</span> <span class="n">amt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Talipay</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Alipay_withdraw</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Talipay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Talipay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;balance = %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>ä¸‰åå¹´åçš„ç¼–ç¨‹è¯­è¨€å’Œç¼–ç¨‹æ–¹æ³•ï¼Ÿ</p>
<ul>
<li>Annotation verifier (<a href="https://dafny-lang.github.io/dafny/" target="_blank" rel="noopener noreffer">Dafny</a>)</li>
<li>Specification mining (<a href="http://plse.cs.washington.edu/daikon/" target="_blank" rel="noopener noreffer">Daikon</a>)</li>
<li><a href="https://dl.acm.org/doi/10.1145/113446.113468" target="_blank" rel="noopener noreffer">Refinement types</a></li>
<li><a href="https://link.springer.com/article/10.1007/s10009-012-0249-7" target="_blank" rel="noopener noreffer">Program sketching</a>â€¦â€¦</li>
</ul>
<h3 id="æ›´å®åœ¨çš„æ–¹æ³•é˜²å¾¡æ€§ç¼–ç¨‹">æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹</h3>
<blockquote>
<p>æŠŠç¨‹åºéœ€è¦æ»¡è¶³çš„æ¡ä»¶ç”¨ <code>assert</code> è¡¨è¾¾å‡ºæ¥ $\Longrightarrow$ <b>å’Œä¸Šé¢çš„é˜²å¾¡æ€§ç¼–ç¨‹ç›¸å¯¹åº”</b></p>
</blockquote>
<p>ä¾‹å­ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>ã€äºŒå‰æ ‘çš„æ—‹è½¬</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define A 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define B 2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BARRIER __sync_synchronize()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_int</span> <span class="n">nested</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_long</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d threads in the critical section @ count=%ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="k">volatile</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">turn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>                <span class="n">BARRIER</span><span class="p">;</span> <span class="c1">// &lt;- this is critcal for x86
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">y</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>         <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">turn</span> <span class="o">!=</span> <span class="n">B</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TB</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>                <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>         <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">turn</span> <span class="o">!=</span> <span class="n">A</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter8-1.jpg" title="/img/Operating System/chapter8-1.jpg" data-thumbnail="/img/Operating System/chapter8-1.jpg" data-sub-html="<h2>äºŒå‰æ ‘çš„æ—‹è½¬ï¼Œç»´æŠ¤çš„ä¸€äº›æ–¹æ³•assert(y-&gt;parent == x&#39;-&gt;parent &amp;&amp; y-&gt;left == x &amp;&amp; y-&gt;right == c);</h2>">
        
    </a><figcaption class="image-caption">äºŒå‰æ ‘çš„æ—‹è½¬ï¼Œç»´æŠ¤çš„ä¸€äº›æ–¹æ³•<code>assert(y-&gt;parent == x'-&gt;parent &amp;&amp; y-&gt;left == x &amp;&amp; y-&gt;right == c);</code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-2.png" title="/img/Operating System/chapter8-2.png" data-thumbnail="/img/Operating System/chapter8-2.png" data-sub-html="<h2>assertå°±æ˜¯æœ€æœ‰æ•ˆçš„é˜²å¾¡æ‰‹æ®µ,ç›¸å½“äºassert(i == 1);</h2>">
        
    </a><figcaption class="image-caption"><code>assert</code>å°±æ˜¯æœ€æœ‰æ•ˆçš„é˜²å¾¡æ‰‹æ®µ,ç›¸å½“äº<code>assert(i == 1);</code></figcaption>
    </figure>
<ul>
<li>
<p>æŠŠassertå†™å‡ºæ¥ï¼Œä½ ä¹Ÿå°±çŸ¥é“æ€ä¹ˆå†™ä»£ç äº†</p>
</li>
<li>
<p><font color="red"><b>ï¼ï¼ï¼é¢è¯•çš„æ—¶å€™èƒ½å†™å‡ºå¹²å‡€åˆ©è½çš„assertä»£ç æ˜¯ä¸€ä¸ªé‡è¦çš„åŠ åˆ†é¡¹ï¼Œå¯¹å¢å¼ºä»£ç çš„é€»è¾‘æ€§å’Œå¯è¯»æ€§ä»¥åŠdebugéƒ½æœ‰å¾ˆå¤§å¸®åŠ© $\Longrightarrow$Â æ²¡æœ‰äººèƒ½å¤Ÿå†™å‡ºå®Œç¾çš„ä»£ç ï¼Œä»£ç éƒ¨åˆ†å’Œassertæ˜¯äº’ç›¸å°è¯çš„ï¼Œä½¿å¾—ä»£ç çš„å¯é æ€§ä¸Šå‡äº†ä¸€ä¸ªæ•°é‡çº§</b></font></p>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-3.gif" title="/img/Operating System/chapter8-3.gif" data-thumbnail="/img/Operating System/chapter8-3.gif" data-sub-html="<h2>å³ä½¿æ˜¯Linus Torvaldså£°ç§°è‡ªå·±çš„ä»£ç æ²¡æœ‰bugæœ€åä¹Ÿè¢«æ‰“è„¸</h2>">
        
    </a><figcaption class="image-caption">å³ä½¿æ˜¯<a href="https://en.wikipedia.org/wiki/Linus_Torvalds" target="_blank" rel="noopener noreffer">Linus Torvalds</a>å£°ç§°è‡ªå·±çš„ä»£ç æ²¡æœ‰bugæœ€åä¹Ÿè¢«æ‰“è„¸</figcaption>
    </figure>
<ul>
<li>assertä¸ä¸€å®šéœ€è¦ç»å¯¹çš„æ­£ç¡®ï¼Œæ¯”å¦‚åœ¨ä¸Šé¢çš„æ”¯ä»˜å®ï¼Œå¦‚æœæµ‹è¯•è¿‡ç¨‹ä¸­é‡‘é¢è¾ƒå°ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨<code>assert(balance &lt;= 100000);</code>è¿™æ ·çš„ä»£ç </li>
<li>è¿˜å¯ä»¥æœ‰è¿™æ ·çš„assert</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">assert</span><span class="p">(</span><span class="n">ptr</span> <span class="n">in</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">assert</span><span class="p">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿™äº›assertçœ‹èµ·æ¥å’Œæˆ‘ä»¬çš„ç°å®ä¸–ç•Œçš„é€»è¾‘å¹¶æ²¡æœ‰å…³ç³»ï¼Œä½†æ˜¯å®ƒé˜²æ­¢äº†$Memory\ Error\newline$</li>
</ul>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘">é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘</h3>
<ul>
<li>ä½ çŸ¥é“å¾ˆå¤šå˜é‡çš„<font color="red">å«ä¹‰</font></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define CHECK_INT(x, cond) \
</span></span></span><span class="line"><span class="cl"><span class="cp">  ({ panic_on(!((x) cond), &#34;int check fail: &#34; #x &#34; &#34; #cond); })
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHECK_HEAP(ptr) \
</span></span></span><span class="line"><span class="cl"><span class="cp">  ({ panic_on(!IN_RANGE((ptr), heap)); })
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>å˜é‡æœ‰ â€œtyped annotationâ€</p>
<ul>
<li>
<p><code>CHECK_INT(waitlist-&gt;count, &gt;= 0);</code></p>
</li>
<li>
<p><code>CHECK_INT(pid, &lt; MAX_PROCS);</code></p>
</li>
<li>
<p><code>CHECK_HEAP(ctx-&gt;rip); CHECK_HEAP(ctx-&gt;cr3);</code></p>
</li>
</ul>
</li>
<li>
<p>å˜é‡å«ä¹‰æ”¹å˜ â†’ å‘ç”Ÿå¥‡æ€ªé—®é¢˜ (overflow, memory error, &hellip;)</p>
<ul>
<li><font color="red"><b>ä¸è¦å°çœ‹è¿™äº›æ£€æŸ¥</b></font>ï¼Œå®ƒä»¬åœ¨åº•å±‚ç¼–ç¨‹ (M2, L1, &hellip;) æ—¶éå¸¸å¸¸è§ã€‚å°¤å…¶æ˜¯Cè¯­è¨€â€œè£¸å¥”â€å†™OSå†…æ ¸ï¼Œæ—¢æ²¡æœ‰è¯­è¨€å±‚é¢çš„ä¿æŠ¤ï¼Œä¹Ÿæ²¡æœ‰OSå†…æ ¸çš„ä¿æŠ¤ï¼ˆå› ä¸ºä½ å†™çš„å°±æ˜¯è¿™ç©æ„ï¼‰ï¼Œæ‰€ä»¥è¿™äº›æ£€æŸ¥å°¤å…¶é‡è¦ï¼</li>
<li>è¿™äº›æ£€æŸ¥é€æ¸å°±ä»Cè¯­è¨€æ¼”å˜æˆäº†é›†æˆåº¦å’Œå®‰å…¨æ€§æ›´é«˜çš„ä¸€äº›C++æ ‡å‡†åº“è¿˜æœ‰Rustçš„ç¼–è¯‘å™¨ï¼ˆæ£€æŸ¥å¾ˆä¸¥æ ¼ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½ç›´æ¥å«è·Œï¼‰</li>
<li>åœ¨è™šæ‹Ÿæœºç¥ç§˜é‡å¯/å¡ä½/&hellip;å‰å‘å‡ºè­¦æŠ¥</li>
</ul>
</li>
</ul>
<h2 id="å¹¶å‘-bugæ­»é”-deadlock">å¹¶å‘ Bugï¼šæ­»é” (Deadlock)</h2>
<h3 id="æ­»é”-deadlock">æ­»é” (Deadlock)</h3>
<blockquote>
<p>A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action.</p>
</blockquote>
<ul>
<li>å‡ºç°çº¿ç¨‹ â€œäº’ç›¸ç­‰å¾…â€ çš„æƒ…å†µ</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-4.jpg" title="/img/Operating System/chapter8-4.jpg" data-thumbnail="/img/Operating System/chapter8-4.jpg" data-sub-html="<h2> äº’ç›¸åœ¨ç­‰å¾…ï¼ˆä½ ç­‰æˆ‘ï¼Œæˆ‘ç­‰ä½ ï¼Œæˆ‘ç­‰æˆ‘è‡ªå·±ï¼‰</h2>">
        
    </a><figcaption class="image-caption"><code> äº’ç›¸åœ¨ç­‰å¾…ï¼ˆä½ ç­‰æˆ‘ï¼Œæˆ‘ç­‰ä½ ï¼Œæˆ‘ç­‰æˆ‘è‡ªå·±ï¼‰</code></figcaption>
    </figure>
<h3 id="aa-deadlock">AA-Deadlock</h3>
<ul>
<li>
<p>å‡è®¾ä½ çš„ spinlock ä¸å°å¿ƒå‘ç”Ÿäº†ä¸­æ–­</p>
<ul>
<li>
<p>åœ¨ä¸è¯¥æ‰“å¼€ä¸­æ–­çš„æ—¶å€™å¼€äº†ä¸­æ–­</p>
</li>
<li>
<p>åœ¨ä¸è¯¥åˆ‡æ¢çš„æ—¶å€™æ‰§è¡Œäº† <code>yield()</code></p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">os_run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xxx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xxx</span><span class="p">);</span> <span class="c1">// ---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>                          <span class="c1">//    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="c1">//    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">on_interrupt</span><span class="p">()</span> <span class="p">{</span>      <span class="c1">//    |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>   <span class="c1">// &lt;--+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>lockå…³é—­ä¸­æ–­ï¼Œè€Œunlockæ‰“å¼€ä¸­æ–­ã€‚<b>ä¸Šé¢çš„ç¨‹åºä¸Šäº†ä¸¤æŠŠé”ï¼Œå´åœ¨åªå¼€ä¸€æŠŠé”çš„æƒ…å†µä¸‹æ‰“å¼€äº†ä¸­æ–­ã€‚$\Longrightarrow$ ä¸­æ–­éœ€è¦ç­‰ç¬¬ä¸€æŠŠé”é‡Šæ”¾ï¼Œç¬¬ä¸€ä¸ªunlockæ‰§è¡Œéœ€è¦ç­‰ä¸­æ–­è¿”å›æ‰èƒ½æ‰§è¡Œå®Œæ¯•</b>ã€‚</li>
</ul>
<div class="mermaid" id="id-1"></div>
<h3 id="abba-deadlock">ABBA-Deadlock</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé”çš„é¡ºåºå¾ˆé‡è¦â€¦â€¦</p>
<ul>
<li>
<p>swapæœ¬èº«çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜</p>
<ul>
<li><code>swap(1, 2)</code>; <code>swap(2, 3)</code>, <code>swap(3, 1)</code> â†’ æ­»é” $\Longrightarrow$ å¦‚æœä¸‰ä¸ªå¹¶å‘æ‰§è¡Œå¹¶åŒæ—¶ğŸ”’ä½äº†1ï¼Œ2ï¼Œ3ï¼Œé‚£å°±å’Œå“²å­¦å®¶é—®é¢˜é‡Œé¢æ‰€æœ‰äººéƒ½æ‹¿èµ·å·¦æ‰‹çš„å‰å­ä¸€æ ·å˜æˆäº†æ­»é”</li>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/philosopher.c" target="_blank" rel="noopener noreffer">philosopher.c</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sem_t</span> <span class="n">locks</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tphilosopher</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">lhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">id</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;T%d Got %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;T%d Got %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">SEM_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tphilosopher</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é¿å…æ­»é”">é¿å…æ­»é”</h3>
<ul>
<li>
<p>æ­»é”äº§ç”Ÿçš„å››ä¸ª<b>å¿…è¦æ¡ä»¶</b> (<a href="https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr." target="_blank" rel="noopener noreffer">Edward G. Coffman</a>, 1971):</p>
<ul>
<li>
<p>äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼ˆä¾‹å¦‚ğŸ”’ï¼‰</p>
</li>
<li>
<p>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æºï¼ˆæ¯”å¦‚å¤±è´¥ç‰ˆçš„å“²å­¦å®¶åƒé¥­ï¼Œå³æ‰‹æ‹¿å‰å­è¢«é˜»å¡çš„æ—¶å€™ä¸ä¼šæŠŠå·¦æ‰‹æ‹¿åˆ°çš„å‰å­é‡Šæ”¾æ‰ï¼‰</p>
</li>
<li>
<p>ä¸å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤ºï¼ˆğŸ”’æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œè·å¾—ä¹‹åä»»ä½•äººéƒ½æ‹¿ä¸èµ°ï¼‰</p>
</li>
<li>
<p>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆ<b>å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æº</b>å…³ç³»ï¼ˆå‚è€ƒAA-Deadlocké‡Œé¢çš„mermaidå›¾åƒä»¥åŠåå­—è·¯å£çš„å›¾åƒï¼‰</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢<b>æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æº</b>ã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€ â€”â€”Bullshit $\Longrightarrow$ <font color="orange">ç»å…¸æ•™ç§‘ä¹¦åºŸè¯ï¼Œè¿™å››ä¸ªæ¡ä»¶æƒ³è¦ç ´é™¤éå¸¸å›°éš¾</font></p>
</blockquote>
<h3 id="é¿å…æ­»é”-contd">é¿å…æ­»é” (cont&rsquo;d)</h3>
<ul>
<li>
<p>AA-Deadlock</p>
<ul>
<li>
<p>AA å‹çš„æ­»é”å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤</p>
</li>
<li>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/spinlock-xv6.c" target="_blank" rel="noopener noreffer">spinlock-xv6.c</a> ä¸­çš„å„ç§é˜²å¾¡æ€§ç¼–ç¨‹</p>
<ul>
<li><code>if (holding(lk)) panic();</code> $\Longrightarrow$ å¦‚æœè¿™æŠŠğŸ”’åœ¨ä¸ŠğŸ”’çš„æ—¶å€™ï¼Œçº¿ç¨‹å·²ç»å¾—åˆ°äº†ğŸ”’ï¼Œç›´æ¥å°±panic()ï¼Œç„¶åcrushã€‚é˜²æ­¢å‡ºç°æ­»ğŸ”’ä¹‹åè‡ªå·±åˆ°å¤„æ‰¾ï¼Œè¿™ç§ç¼–ç¨‹æ¨¡å¼èƒ½å¤Ÿè¿…é€Ÿå¸®ä½ å®šä½è‡ªå·±çš„ç¼ºé™·å’Œbugã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Mutual exclusion spin locks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;types.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;param.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;memlayout.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;spinlock.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;riscv.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;proc.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;defs.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">initlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Acquire the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Loops (spins) until the lock is acquired.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">push_off</span><span class="p">();</span> <span class="c1">// disable interrupts to avoid deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;acquire&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// On RISC-V, sync_lock_test_and_set turns into an atomic swap:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   a5 = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   s1 = &amp;lk-&gt;locked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   amoswap.w.aq a5, a5, (s1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span><span class="p">(</span><span class="n">__sync_lock_test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Tell the C compiler and the processor to not move loads or stores
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// past this point, to ensure that the critical section&#39;s memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// references happen strictly after the lock is acquired.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// On RISC-V, this emits a fence instruction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__sync_synchronize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Record info about lock acquisition for holding() and debugging.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">mycpu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Release the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">release</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">holding</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;release&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Tell the C compiler and the CPU to not move loads or stores
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// past this point, to ensure that all the stores in the critical
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// section are visible to other CPUs before the lock is released,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and that loads in the critical section occur strictly before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// the lock is released.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// On RISC-V, this emits a fence instruction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__sync_synchronize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Release the lock, equivalent to lk-&gt;locked = 0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This code doesn&#39;t use a C assignment, since the C standard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// implies that an assignment might be implemented with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// multiple store instructions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// On RISC-V, sync_lock_release turns into an atomic swap:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   s1 = &amp;lk-&gt;locked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   amoswap.w zero, zero, (s1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__sync_lock_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pop_off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Check whether this cpu is holding the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Interrupts must be off.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">holding</span><span class="p">(</span><span class="k">struct</span> <span class="n">spinlock</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">&amp;&amp;</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">mycpu</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// push_off/pop_off are like intr_off()/intr_on() except that they are matched:
</span></span></span><span class="line"><span class="cl"><span class="c1">// it takes two pop_off()s to undo two push_off()s.  Also, if interrupts
</span></span></span><span class="line"><span class="cl"><span class="c1">// are initially off, then push_off, pop_off leaves them off.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">push_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">intr_get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">intr_off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">intena</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">pop_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">mycpu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">intr_get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;pop_off - interruptible&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;pop_off&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">intena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">intr_on</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ABBA-Deadlock</p>
<ul>
<li>
<p>ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</p>
</li>
<li>
<p>ä¸¥æ ¼<b>æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é”</b> (lock ordering; æ¶ˆé™¤ â€œå¾ªç¯ç­‰å¾…â€)</p>
<ul>
<li>
<p><b>æ¯”å¦‚è¯´æœ‰X,A,B,Cå››æŠŠğŸ”’ï¼Œæ— è®ºå¦‚ä½•éƒ½è¦ç»™è¿™å››æŠŠğŸ”’æ’ä¸€ä¸‹é¡ºåº</b></p>
<div class="mermaid" id="id-2"></div>
</li>
</ul>
</li>
<li>
<p><b>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å¾—å…¶ä¸­çš„ä»»ä½•å‡ æŠŠğŸ”’ï¼Œéƒ½å¿…é¡»è¦æŒ‰ç…§æ’å¥½çš„é¡ºåºæ¥</b></p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//------&gt; âˆš ï¼œï¼ˆï¼¾ï¼ï¼¾ï¼‰ï¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//-----&gt; Ã— 
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>é‡äº‹ä¸å†³å¯è§†åŒ–ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/lock-ordering.py" target="_blank" rel="noopener noreffer">lock-ordering.py</a></p>
</li>
<li>
<p>è¿›è€Œè¯æ˜$@thread-T_1:A \rightarrow B \rightarrow C;@thread-T_2:B \rightarrow C$æ˜¯å®‰å…¨çš„</p>
<ul>
<li>â€œåœ¨ä»»æ„æ—¶åˆ»æ€»æ˜¯æœ‰è·å¾— â€œæœ€é åâ€ é”çš„å¯ä»¥ç»§ç»­æ‰§è¡Œâ€
<ul>
<li><b>å³ä½¿æœ‰è®¸å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæ€»ä¼šæœ‰ä¸€ä¸ªè·‘çš„æœ€å¿«çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯ğŸ”’çš„ä½ç½®æœ€é å³/ç¼–å·æœ€å¤§ï¼Œåªæœ‰ğŸ”’æœ€å¤§çš„çº¿ç¨‹æ‰èƒ½è·å¾—ä¸‹ä¸€æŠŠğŸ”’ $\Longrightarrow$ <font color="red">å³ä½¿åé¢çš„çº¿ç¨‹éƒ½å¡æ­»äº†ï¼Œæœ€å‰é¢çš„çº¿ç¨‹ä»ç„¶â€œç•…é€šæ— é˜»â€œã€‚</font><font color="orange">æœ€å¤§çš„çº¿ç¨‹èµ°è¿›ä¸´ç•ŒåŒºä»¥åï¼Œå®ƒå°±ä¼šæŠŠæ‰€æœ‰çš„ğŸ”’éƒ½ç»™é‡Šæ”¾æ‰ã€‚</font></b></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LockOrdering</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locks</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tryacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">lk</span><span class="p">],</span> <span class="n">seen</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">lk</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">seen</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="p">[</span><span class="n">lk</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¯è§†åŒ–<a href="https://github.com/Jungle430/check-for-NJU-OS/blob/main/lock-ordering.html" target="_blank" rel="noopener noreffer">lock-ordering.html</a></li>
</ul>
<hr>
<ul>
<li>æ€»ç»“ï¼šä¸¤æ¡æŠ€æœ¯
<ol>
<li>é˜²å¾¡ç¼–ç¨‹ $\Longrightarrow$ AA-Deadlock</li>
<li>lock-order $\Longrightarrow$ ABBA-Deadlock</li>
</ol>
</li>
</ul>
<h3 id="lock-ordering-åº”ç”¨-linux-kernel-rmapc">Lock Ordering: åº”ç”¨ (Linux Kernel: rmap.c)</h3>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-5.png" title="/img/Operating System/chapter8-5.png" data-thumbnail="/img/Operating System/chapter8-5.png" data-sub-html="<h2>Linux Kernelï¼šrmap.cä¸­çš„Lock Ordering</h2>">
        
    </a><figcaption class="image-caption">Linux Kernelï¼šrmap.cä¸­çš„<code>Lock Ordering</code></figcaption>
    </figure>
<h3 id="ä½†æ˜¯ä½ åˆ-naive-äº†">ä½†æ˜¯â€¦â€¦ä½ åˆ Naive äº†â€¦â€¦</h3>
<blockquote>
<p>Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. <b><em>Practice will tell you that this approach doesn&rsquo;t scale</em>:</b> when I create a new lock, I don&rsquo;t understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p><b>The best locks are encapsulated</b>: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don&rsquo;t even need to know you are using a lock.</p>
<p>â€”â€” <em><a href="https://www.kernel.org/doc/html/latest/kernel-hacking/locking.html" target="_blank" rel="noopener noreffer">Unreliable Guide to Locking</a></em> by Rusty Russell</p>
</blockquote>
<ul>
<li>æˆ‘ä»¬ç¨åå›åˆ°è¿™ä¸ªé—®é¢˜ï¼Œç»§ç»­çœ‹æ›´å¤šçš„ bugs</li>
</ul>
<h2 id="å¹¶å‘-bugæ•°æ®ç«äº‰-data-race-longrightarrow-ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—">å¹¶å‘ Bugï¼šæ•°æ®ç«äº‰ (Data Race) $\Longrightarrow$ ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—ï¼Ÿ</h2>
<h3 id="æ•°æ®ç«äº‰">æ•°æ®ç«äº‰</h3>
<blockquote>
<p><font color="red"><b>ä¸åŒçš„çº¿ç¨‹</b></font>åŒæ—¶è®¿é—®<font color="red"><b>åŒä¸€æ®µå†…å­˜</b></font>ï¼Œä¸”<font color="red"><b>è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™</b></font>ã€‚</p>
</blockquote>
<div class="mermaid" id="id-3"></div>
<ul>
<li>ä¸¤ä¸ªå†…å­˜è®¿é—®åœ¨ â€œèµ›è·‘â€ï¼Œ<b>â€œè·‘èµ¢â€ çš„æ“ä½œå…ˆæ‰§è¡Œ</b> $\Longrightarrow$ ç¨‹åºæœ€ç»ˆçš„ç»“æœä¸è°è·‘èµ¢æœ‰å…³ $\Longrightarrow$ è®¡ç»„ä¸­å’Œçš„â€œè¯»åå†™â€ä¸â€œå†™åè¯»â€æœ‰å…³çš„æµæ°´çº¿æ’åºé—®é¢˜
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>: å†…å­˜è®¿é—®éƒ½åœ¨èµ›è·‘
<ul>
<li><a href="https://www.felixcloutier.com/x86/mfence" target="_blank" rel="noopener noreffer">MFENCE</a>ï¼š<del>å¦‚ä½•ç•™ä¸‹æœ€å°‘çš„ fenceï¼Œä¾ç„¶ä¿è¯ç®—æ³•æ­£ç¡®ï¼Ÿ</del></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="æ•°æ®ç«äº‰-contd">æ•°æ®ç«äº‰ (cont&rsquo;d)</h3>
<ul>
<li>
<p>Peterson ç®—æ³•å‘Šè¯‰å¤§å®¶ï¼š</p>
<ul>
<li>
<p><font color="red">ä½ ä»¬å†™ä¸å¯¹æ— é”çš„å¹¶å‘ç¨‹åº</font></p>
</li>
<li>
<p>æ‰€ä»¥äº‹æƒ…åè€Œç®€å•äº†</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç”¨äº’æ–¥é”ä¿æŠ¤å¥½å…±äº«æ•°æ®</p>
<p>æ¶ˆç­ä¸€åˆ‡æ•°æ®ç«äº‰</p>
</blockquote>
<div class="mermaid" id="id-4"></div>
<h3 id="æ•°æ®ç«äº‰ä¾‹å­">æ•°æ®ç«äº‰ï¼šä¾‹å­</h3>
<ul>
<li>ä»¥ä¸‹ä»£ç æ¦‚æ‹¬äº†ä½ ä»¬é‡åˆ°æ•°æ®ç«äº‰çš„å¤§éƒ¨åˆ†æƒ…å†µ
<ul>
<li>ä¸è¦ç¬‘ï¼Œä½ ä»¬çš„ bug å‡ ä¹éƒ½æ˜¯è¿™ä¸¤ç§æƒ…å†µçš„å˜ç§</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Case #1: ä¸Šé”™äº†é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">thread1</span><span class="p">()</span> <span class="p">{</span> <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">thread2</span><span class="p">()</span> <span class="p">{</span> <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Case #2: å¿˜è®°ä¸Šé”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">thread1</span><span class="p">()</span> <span class="p">{</span> <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">thread2</span><span class="p">()</span> <span class="p">{</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ›´å¤šç±»å‹çš„å¹¶å‘-bug">æ›´å¤šç±»å‹çš„å¹¶å‘ Bug</h2>
<h3 id="ç¨‹åºå‘˜èŠ±å¼çŠ¯é”™">ç¨‹åºå‘˜ï¼šèŠ±å¼çŠ¯é”™</h3>
<ul>
<li>
<p>å›é¡¾æˆ‘ä»¬å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·</p>
<ul>
<li>
<p>äº’æ–¥é” (lock/unlock) - åŸå­æ€§</p>
</li>
<li>
<p>æ¡ä»¶å˜é‡ (wait/signal) - åŒæ­¥</p>
</li>
</ul>
</li>
<li>
<p>å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)</p>
</li>
<li>
<p>å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)</p>
</li>
<li>
<p>Empirical study: åœ¨ 105 ä¸ªå¹¶å‘ bug ä¸­ (non-deadlock/deadlock)</p>
<ul>
<li>
<p>MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</p>
</li>
<li>
<p><font color="red">97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯ AV æˆ– OV</font></p>
</li>
</ul>
</li>
</ul>
<h3 id="åŸå­æ€§è¿å-av">åŸå­æ€§è¿å (AV)</h3>
<ul>
<li>â€œABAâ€
<ul>
<li>æˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-6.png" title="/img/Operating System/chapter8-6.png" data-thumbnail="/img/Operating System/chapter8-6.png" data-sub-html="<h2>ABA</h2>">
        
    </a><figcaption class="image-caption"><code>ABA</code></figcaption>
    </figure>
<h3 id="åŸå­æ€§è¿å-contd">åŸå­æ€§è¿å (cont&rsquo;d)</h3>
<ul>
<li>æœ‰æ—¶å€™ä¸Šé”ä¹Ÿä¸è§£å†³é—®é¢˜
<ul>
<li>â€œTOCTTOUâ€ - time of check to time of use</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-7.png" title="/img/Operating System/chapter8-7.png" data-thumbnail="/img/Operating System/chapter8-7.png" data-sub-html="<h2>TOCTTOU</h2>">
        
    </a><figcaption class="image-caption"><code>TOCTTOU</code></figcaption>
    </figure>
<ul>
<li><a href="https://www.usenix.org/legacy/events/fast05/tech/full_papers/wei/wei.pdf" target="_blank" rel="noopener noreffer">TOCTTOU vulnerabilities in UNIX-style file systems: An anatomical study</a>(FAST'05)</li>
</ul>
<h3 id="é¡ºåºè¿å-ov">é¡ºåºè¿å (OV)</h3>
<ul>
<li>â€œBAâ€
<ul>
<li>æ€ä¹ˆå°±æ²¡æŒ‰æˆ‘é¢„æƒ³çš„é¡ºåºæ¥å‘¢ï¼Ÿ
<ul>
<li>ä¾‹å­ï¼šconcurrent use after free</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter8-8.png" title="/img/Operating System/chapter8-8.png" data-thumbnail="/img/Operating System/chapter8-8.png" data-sub-html="<h2>BA</h2>">
        
    </a><figcaption class="image-caption"><code>BA</code></figcaption>
    </figure>
<h2 id="åº”å¯¹å¹¶å‘-bug-çš„æ–¹æ³•">åº”å¯¹å¹¶å‘ Bug çš„æ–¹æ³•</h2>
<h3 id="å®Œå…¨ä¸€æ ·çš„åŸºæœ¬æ€è·¯å¦å®šä½ è‡ªå·±">å®Œå…¨ä¸€æ ·çš„åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±</h3>
<blockquote>
<p>è¿˜æ˜¯å¾—<font color="red">å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„</font></p>
</blockquote>
<ul>
<li>
<p>ç„¶åå‘¢ï¼Ÿ</p>
<ul>
<li>
<p>åšå¥½æµ‹è¯•</p>
</li>
<li>
<p>æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li>
<p>å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li>
<p>å†å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
<ul>
<li>(æŠŠä»»ä½•ä½ è®¤ä¸º â€œä¸å¯¹â€ çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€é)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¾‹å¦‚ï¼šç”¨ lock ordering å½»åº•é¿å…æ­»é”ï¼Ÿ</p>
<ul>
<li>ä½ æƒ³å¤šäº†ï¼šå¹¶å‘é‚£ä¹ˆå¤æ‚ï¼Œç¨‹åºå‘˜å“ªèƒ½å……åˆ†æµ‹è¯•å•Š</li>
</ul>
</li>
</ul>
<h3 id="lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥">Lockdep: è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥</h3>
<p>Lockdep è§„çº¦ (Specification)</p>
<ul>
<li>ä¸ºæ¯ä¸€ä¸ªé”ç¡®å®šå”¯ä¸€çš„ â€œallocation siteâ€
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/lock-site.c" target="_blank" rel="noopener noreffer">lock-site.c</a></li>
<li>assert: åŒä¸€ä¸ª allocation site çš„é”å­˜åœ¨å…¨å±€å”¯ä¸€çš„ä¸Šé”é¡ºåº</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">lock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">locked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">site</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">lock_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define STRINGIFY(s) #s
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TOSTRING(s)  STRINGIFY(s)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOCK_INIT() \
</span></span></span><span class="line"><span class="cl"><span class="cp">  ( (lock_t) { .locked = 0, .site = __FILE__ &#34;:&#34; TOSTRING(__LINE__), } )
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">lock_t</span> <span class="n">lk1</span> <span class="o">=</span> <span class="n">LOCK_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">lock_t</span> <span class="n">lk2</span> <span class="o">=</span> <span class="n">LOCK_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;LOCK   %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">site</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;UNLOCK %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">site</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">some_object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">object_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">some_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="n">LOCK_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">some_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">some_object</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">object_init</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter8-9.png" title="/img/Operating System/chapter8-9.png" data-thumbnail="/img/Operating System/chapter8-9.png" data-sub-html="<h2>ChatGPT</h2>">
        
    </a><figcaption class="image-caption"><code>ChatGPT</code></figcaption>
    </figure>
<ul>
<li>æ£€æŸ¥æ–¹æ³•ï¼šprintf
<ul>
<li>è®°å½•æ‰€æœ‰è§‚å¯Ÿåˆ°çš„ä¸Šé”é¡ºåºï¼Œä¾‹å¦‚</li>
</ul>
</li>
</ul>
<p>$$
[x,y,z] \Longrightarrow x \rightarrow y,x\rightarrow z,y\rightarrow z
$$</p>
<ul>
<li>
<p>æ£€æŸ¥æ˜¯å¦å­˜åœ¨$x â‡ y âˆ§ y â‡ x$</p>
</li>
<li>
<p><font color="red">ç»´æŠ¤ä¸€ä¸ªå›¾ï¼Œå›¾é‡Œé¢ä¸èƒ½æœ‰ç¯ï¼ˆæœ‰ç¯å°±è¿åäº†Lock-Orderï¼‰</font></p>
</li>
<li>
<p><a href="https://jyywiki.cn/OS/OS_Lockdep" target="_blank" rel="noopener noreffer">Lockdep çš„å®ç°</a></p>
<ul>
<li>Since Linux Kernel 2.6.17, also in <a href="https://gitee.com/openharmony" target="_blank" rel="noopener noreffer">OpenHarmony</a>!</li>
</ul>
</li>
</ul>
<h3 id="threadsanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥">ThreadSanitizer: è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥</h3>
<ul>
<li>
<p>ä¸ºæ‰€æœ‰äº‹ä»¶å»ºç«‹ happens-before å…³ç³»å›¾ $\Longrightarrow$ å›¾è®º</p>
<ul>
<li>
<p>Program-order + release-acquire</p>
</li>
<li>
<p>å¯¹äºå‘ç”Ÿåœ¨ä¸åŒçº¿ç¨‹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™çš„$x,y$æ£€æŸ¥</p>
</li>
</ul>
</li>
</ul>
<p>$$
x â‰º y âˆ¨ y â‰º x
$$</p>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/359545.359563" target="_blank" rel="noopener noreffer">Time, clocks, and the ordering of events in a distributed system</a></li>
</ul>
<h3 id="æ›´å¤šçš„æ£€æŸ¥åŠ¨æ€ç¨‹åºåˆ†æ">æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ</h3>
<ul>
<li>
<p>åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è®°å½•</p>
<ul>
<li>
<p>Lockdep: lock/unlock</p>
</li>
<li>
<p>ThreadSanitizer: å†…å­˜è®¿é—® + lock/unlock</p>
</li>
</ul>
</li>
<li>
<p>è§£æè®°å½•æ£€æŸ¥é—®é¢˜</p>
<ul>
<li>Lockdep: $x â‡ y âˆ§ y â‡ x$</li>
<li>ThreadSanitizer: $x \nprec y âˆ§ y \nprec x$</li>
</ul>
</li>
<li>
<p>ä»˜å‡ºçš„ä»£ä»·å’Œæƒè¡¡</p>
<ul>
<li>
<p>ç¨‹åºæ‰§è¡Œå˜æ…¢</p>
</li>
<li>
<p>ä½†æ›´å®¹æ˜“æ‰¾åˆ° bug (å› æ­¤åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¸¸ç”¨)</p>
</li>
</ul>
</li>
</ul>
<h3 id="åŠ¨æ€åˆ†æå·¥å…·sanitizers">åŠ¨æ€åˆ†æå·¥å…·ï¼šSanitizers</h3>
<ul>
<li>
<p>æ²¡ç”¨è¿‡ lint/sanitizersï¼Ÿ</p>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/AddressSanitizer.html" target="_blank" rel="noopener noreffer">AddressSanitizer</a> (asan); <a href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany" target="_blank" rel="noopener noreffer">(paper)</a>: éæ³•å†…å­˜è®¿é—®</p>
<ul>
<li>Buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, &hellip;</li>
<li>Demo: <a href="https://jyywiki.cn/pages/OS/2022/demos/uaf.c" target="_blank" rel="noopener noreffer">uaf.c</a>; <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html" target="_blank" rel="noopener noreffer">kasan</a></li>
</ul>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" target="_blank" rel="noopener noreffer">ThreadSanitizer</a> (tsan): æ•°æ®ç«äº‰</p>
<ul>
<li>Demo: <a href="https://jyywiki.cn/pages/OS/2022/demos/fish.c" target="_blank" rel="noopener noreffer">fish.c</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/sum.c" target="_blank" rel="noopener noreffer">sum.c</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>; <a href="https://github.com/google/ktsan" target="_blank" rel="noopener noreffer">ktsan</a></li>
</ul>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/MemorySanitizer.html" target="_blank" rel="noopener noreffer">MemorySanitizer</a> (msan): æœªåˆå§‹åŒ–çš„è¯»å–</p>
</li>
<li>
<p><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" target="_blank" rel="noopener noreffer">UBSanitizer</a> (ubsan): undefined behavior</p>
<ul>
<li>Misaligned pointer, signed integer overflow, &hellip;</li>
<li>Kernel ä¼šå¸¦ç€ <code>-fwrapv</code> ç¼–è¯‘</li>
</ul>
</li>
<li>
<p>ç¤ºä¾‹ï¼štest.c</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -g test.c -fsanitize<span class="o">=</span>address -o <span class="nb">test</span> <span class="o">&amp;&amp;</span> ./test
</span></span><span class="line"><span class="cl"><span class="o">=================================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">37384</span><span class="o">==</span>ERROR: AddressSanitizer: heap-use-after-free on address 0x602000000010 at pc 0x55c0a903b213 bp 0x7ffe5d50fcd0 sp 0x7ffe5d50fcc8
</span></span><span class="line"><span class="cl">WRITE of size <span class="m">4</span> at 0x602000000010 thread T0
</span></span><span class="line"><span class="cl">    <span class="c1">#0 0x55c0a903b212 in main /home/kali/chapter7/test.c:7</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#1 0x7f8416046189 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#2 0x7f8416046244 in __libc_start_main_impl ../csu/libc-start.c:381</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#3 0x55c0a903b0b0 in _start (/home/kali/chapter7/test+0x10b0)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0x602000000010 is located <span class="m">0</span> bytes inside of 4-byte region <span class="o">[</span>0x602000000010,0x602000000014<span class="o">)</span>
</span></span><span class="line"><span class="cl">freed by thread T0 here:
</span></span><span class="line"><span class="cl">    <span class="c1">#0 0x7f84162b76a8 in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:52</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#1 0x55c0a903b1db in main /home/kali/chapter7/test.c:6</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#2 0x7f8416046189 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">previously allocated by thread T0 here:
</span></span><span class="line"><span class="cl">    <span class="c1">#0 0x7f84162b89cf in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:69</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#1 0x55c0a903b18a in main /home/kali/chapter7/test.c:4</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#2 0x7f8416046189 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SUMMARY: AddressSanitizer: heap-use-after-free /home/kali/chapter7/test.c:7 in main
</span></span><span class="line"><span class="cl">Shadow bytes around the buggy address:
</span></span><span class="line"><span class="cl">  0x0c047fff7fb0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7fc0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7fd0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7fe0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  0x0c047fff7ff0: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">00</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt;0x0c047fff8000: fa fa<span class="o">[</span>fd<span class="o">]</span>fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span class="line"><span class="cl">Shadow byte legend <span class="o">(</span>one shadow byte represents <span class="m">8</span> application bytes<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  Addressable:           <span class="m">00</span>
</span></span><span class="line"><span class="cl">  Partially addressable: <span class="m">01</span> <span class="m">02</span> <span class="m">03</span> <span class="m">04</span> <span class="m">05</span> <span class="m">06</span> <span class="m">07</span> 
</span></span><span class="line"><span class="cl">  Heap left redzone:       fa
</span></span><span class="line"><span class="cl">  Freed heap region:       fd
</span></span><span class="line"><span class="cl">  Stack left redzone:      f1
</span></span><span class="line"><span class="cl">  Stack mid redzone:       f2
</span></span><span class="line"><span class="cl">  Stack right redzone:     f3
</span></span><span class="line"><span class="cl">  Stack after <span class="k">return</span>:      f5
</span></span><span class="line"><span class="cl">  Stack use after scope:   f8
</span></span><span class="line"><span class="cl">  Global redzone:          f9
</span></span><span class="line"><span class="cl">  Global init order:       f6
</span></span><span class="line"><span class="cl">  Poisoned by user:        f7
</span></span><span class="line"><span class="cl">  Container overflow:      <span class="nb">fc</span>
</span></span><span class="line"><span class="cl">  Array cookie:            ac
</span></span><span class="line"><span class="cl">  Intra object redzone:    bb
</span></span><span class="line"><span class="cl">  ASan internal:           fe
</span></span><span class="line"><span class="cl">  Left alloca redzone:     ca
</span></span><span class="line"><span class="cl">  Right alloca redzone:    <span class="nv">cb</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">37384</span><span class="o">==</span>ABORTING
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter8-10.png" title="/img/Operating System/chapter8-10.png" data-thumbnail="/img/Operating System/chapter8-10.png" data-sub-html="<h2>æ£€æŸ¥sum.cçš„thread</h2>">
        
    </a><figcaption class="image-caption"><code>æ£€æŸ¥sum.cçš„thread</code></figcaption>
    </figure>
<h2 id="è¿™ä¸å°±æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹å—">è¿™ä¸å°±æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹å—ï¼Ÿ</h2>
<ul>
<li>åªä¸è¿‡ä¸éœ€è¦æˆ‘äº²è‡ªåŠ¨æ‰‹æŠŠä»£ç æ”¹å¾—ä¹±ä¸ƒå…«ç³Ÿäº†â€¦â€¦</li>
</ul>
<h3 id="æˆ‘ä»¬ä¹Ÿå¯ä»¥buffer-overrun-æ£€æŸ¥">æˆ‘ä»¬ä¹Ÿå¯ä»¥ï¼Buffer Overrun æ£€æŸ¥</h3>
<ul>
<li>
<p>Canary (é‡‘ä¸é›€) å¯¹ä¸€æ°§åŒ–ç¢³éå¸¸æ•æ„Ÿ</p>
<ul>
<li>ç”¨ç”Ÿå‘½é¢„è­¦çŸ¿äº•ä¸‹çš„ç“¦æ–¯æ³„éœ² (since 1911)</li>
</ul>
</li>
<li>
<p>è®¡ç®—æœºç³»ç»Ÿä¸­çš„ canary</p>
<ul>
<li>â€œç‰ºç‰²â€ ä¸€äº›å†…å­˜å•å…ƒï¼Œæ¥é¢„è­¦ memory error çš„å‘ç”Ÿ
<ul>
<li>(ç¨‹åºè¿è¡Œæ—¶æ²¡æœ‰åŠ¨ç‰©å—åˆ°å®è´¨çš„ä¼¤å®³)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="canary-çš„ä¾‹å­ä¿æŠ¤æ ˆç©ºé—´-m2l2">Canary çš„ä¾‹å­ï¼šä¿æŠ¤æ ˆç©ºé—´ (M2/L2)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define MAGIC 0x55555555
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BOTTOM (STK_SZ / sizeof(u32) - 1)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">struct</span> <span class="n">stack</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">STK_SZ</span><span class="p">];</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">canary_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">stack</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CANARY_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">canary_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">stack</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CANARY_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">&#34;underflow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">&#34;overflow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="çƒ«çƒ«çƒ«å±¯å±¯å±¯å’Œè‘ºè‘ºè‘º">çƒ«çƒ«çƒ«ã€å±¯å±¯å±¯å’Œè‘ºè‘ºè‘º</h3>
<ul>
<li>
<p>msvc ä¸­ debug mode çš„ guard/fence/canary</p>
<ul>
<li>
<p>æœªåˆå§‹åŒ–æ ˆ: <code>0xcccccccc</code></p>
</li>
<li>
<p>æœªåˆå§‹åŒ–å †: <code>0xcdcdcdcd</code></p>
</li>
<li>
<p>å¯¹è±¡å¤´å°¾: <code>0xfdfdfdfd</code></p>
</li>
<li>
<p>å·²å›æ”¶å†…å­˜: <code>0xdddddddd</code></p>
</li>
</ul>
</li>
<li>
<p><code>(b'**\xcc**' * 80).decode('gb2312')</code></p>
</li>
</ul>
<blockquote>
<p>æ‰‹æŒä¸¤æŠŠé”Ÿæ–¤æ‹·ï¼Œå£ä¸­ç–¾å‘¼çƒ«çƒ«çƒ«</p>
<p>è„šè¸åƒæœµå±¯å±¯å±¯ï¼Œç¬‘çœ‹ä¸‡ç‰©é”˜é”˜é”˜</p>
<p>(å®ƒä»¬ä¸€ç›´åœ¨æ— å½¢ä¸­ä¿æŠ¤ä½ )</p>
</blockquote>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹ä½é…ç‰ˆ-lockdep">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Lockdep</h3>
<ul>
<li>ä¸å¿…å¤§è´¹å‘¨ç« è®°å½•ä»€ä¹ˆä¸Šé”é¡ºåº
<ul>
<li>ç»Ÿè®¡å½“å‰çš„ spin count
<ul>
<li>å¦‚æœè¶…è¿‡æŸä¸ªæ˜æ˜¾ä¸æ­£å¸¸çš„æ•°å€¼ (1,000,000,000) å°±æŠ¥å‘Š</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">spin_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">spin_cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">SPIN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Too many spin @ %s:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é…åˆè°ƒè¯•å™¨å’Œçº¿ç¨‹ backtrace ä¸€ç§’è¯Šæ–­æ­»é”</li>
</ul>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹ä½é…ç‰ˆ-sanitizer-l1">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Sanitizer (L1)</h3>
<ul>
<li>å†…å­˜åˆ†é…è¦æ±‚<code>malloc and free</code>ï¼šå·²åˆ†é…å†…å­˜$S=[l_0,r_0) \cup [l_1,r_1) \cup &hellip;$
<ul>
<li>$kalloc(S)$è¿”å›çš„$[l,r)$ å¿…é¡»æ»¡è¶³$[l,r) \cup S = \empty$
<ul>
<li>thread-local allocation + å¹¶å‘çš„ free è¿˜è›®å®¹æ˜“å¼„é”™çš„</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// allocation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">&#34;double-allocation&#34;</span><span class="p">);</span><span class="c1">//åˆ†é…çš„æ—¶å€™çœ‹åˆ°äº†mallocé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span> <span class="c1">//åˆ·ä¸Šmallocé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">alloc_size</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;double-free&#34;</span><span class="p">);</span><span class="c1">//åˆ†é…çš„æ—¶å€™çœ‹åˆ°äº†freeé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//åˆ·ä¸Šfreeé¢œè‰²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•æ‹¯æ•‘äººç±»ä¸æ“…é•¿çš„å¹¶å‘ç¼–ç¨‹ï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>å¸¸è§çš„å¹¶å‘ bug
<ul>
<li>æ­»é”ã€æ•°æ®ç«äº‰ã€åŸå­æ€§/é¡ºåºè¿å</li>
</ul>
</li>
<li>ä¸è¦ç›²ç›®ç›¸ä¿¡è‡ªå·±ï¼šæ£€æŸ¥ã€æ£€æŸ¥ã€æ£€æŸ¥
<ul>
<li>é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ£€æŸ¥</li>
<li>åŠ¨æ€åˆ†æï¼šæ‰“å° + æ£€æŸ¥</li>
</ul>
</li>
</ul>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
]]></description>
</item>
<item>
    <title>Operating System Chapter7 çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter7/</link>
    <pubDate>Wed, 15 Mar 2023 13:26:02 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter7/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: ä»€ä¹ˆæ ·çš„ä»»åŠ¡æ˜¯éœ€è¦å¹¶è¡Œ/å¹¶å‘çš„ï¼Ÿå®ƒä»¬åº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹</li>
<li>æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹</li>
<li>æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹</li>
</ul>
<h2 id="é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹">é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹</h2>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/359327.359336" target="_blank" rel="noopener noreffer">CRAY-1 Supercomputer</a>, 1976 @ 138 MFLOPS, SIMD Processor</li>
</ul>
<h3 id="é«˜æ€§èƒ½è®¡ç®—ç¨‹åºç‰¹ç‚¹">é«˜æ€§èƒ½è®¡ç®—ç¨‹åºï¼šç‰¹ç‚¹</h3>
<blockquote>
<p>â€œA technology that harnesses the power of supercomputers or computer clusters to solve complex problems requiring massive computation.â€ (IBM)</p>
</blockquote>
<ul>
<li>
<p>ä»¥è®¡ç®—ä¸ºä¸­å¿ƒ</p>
<ul>
<li>
<p>ç³»ç»Ÿæ¨¡æ‹Ÿï¼šå¤©æ°”é¢„æŠ¥ã€èƒ½æºã€åˆ†å­ç”Ÿç‰©å­¦</p>
</li>
<li>
<p>äººå·¥æ™ºèƒ½ï¼šç¥ç»ç½‘ç»œè®­ç»ƒ</p>
</li>
<li>
<p>çŸ¿å‚ï¼šçº¯ç²¹çš„ hash è®¡ç®—</p>
</li>
<li>
<p><a href="http://www.hpc100.cn/top100/20/" target="_blank" rel="noopener noreffer">HPC-China 100</a></p>
</li>
</ul>
</li>
</ul>
<h3 id="é«˜æ€§èƒ½è®¡ç®—ä¸»è¦æŒ‘æˆ˜">é«˜æ€§èƒ½è®¡ç®—ï¼šä¸»è¦æŒ‘æˆ˜</h3>
<p>è®¡ç®—ä»»åŠ¡å¦‚ä½•åˆ†è§£</p>
<ul>
<li>
<p>è®¡ç®—å›¾éœ€è¦å®¹æ˜“å¹¶è¡ŒåŒ–</p>
<ul>
<li>æœºå™¨-çº¿ç¨‹ä¸¤çº§ä»»åŠ¡åˆ†è§£</li>
</ul>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="o">*</span> <span class="k">if</span> <span class="n">array1</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">array2</span><span class="p">[</span><span class="n">y</span><span class="p">],</span><span class="n">we</span> <span class="n">can</span> <span class="n">know</span> <span class="n">that</span> <span class="n">it</span> <span class="n">is</span> <span class="n">form</span> <span class="n">the</span> <span class="s">&#34;decreasing and conquer&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">so</span> <span class="n">we</span> <span class="n">should</span> <span class="n">make</span> <span class="n">matrix</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="k">else</span> <span class="n">array1</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">array2</span><span class="p">[</span><span class="n">y</span><span class="p">],</span><span class="n">we</span> <span class="n">can</span> <span class="n">know</span> <span class="n">that</span> <span class="n">it</span> <span class="n">is</span> <span class="n">form</span> <span class="n">the</span> <span class="s">&#34;divide and conquer&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">so</span> <span class="n">we</span> <span class="n">should</span> <span class="n">make</span> <span class="n">matrix</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è®¡ç®—å›¾</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-1.jpg" title="/img/Operating System/chapter7-1.jpg" data-thumbnail="/img/Operating System/chapter7-1.jpg" data-sub-html="<h2>è®¡ç®—å›¾ï¼ˆçœ‹ä¾èµ–å…³ç³»ï¼Œè¡¨æ˜äº†è®¡ç®—çš„é¡ºåºé™åˆ¶ï¼‰</h2>">
        
    </a><figcaption class="image-caption">è®¡ç®—å›¾ï¼ˆçœ‹ä¾èµ–å…³ç³»ï¼Œè¡¨æ˜äº†è®¡ç®—çš„é¡ºåºé™åˆ¶ï¼‰</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-2.jpg" title="/img/Operating System/chapter7-2.jpg" data-thumbnail="/img/Operating System/chapter7-2.jpg" data-sub-html="<h2>çœ‹æˆæœ‰å‘å›¾è¿›è¡Œæ‹“æ‰‘æ’åºï¼Œç¡®å®šè®¡ç®—é¡ºåºã€‚å¯ä»¥çœ‹å‡ºçŸ©é˜µè§„æ¨¡å°çš„æ—¶å€™å¹¶è¡Œåº¦å¾ˆä½ï¼Œä¸å¦‚å•çº¿ç¨‹è®¡ç®—ã€‚ä½†æ˜¯çŸ©é˜µè§„æ¨¡å¤§çš„æ—¶å€™å°±è¦è€ƒè™‘å¹¶è¡Œè®¡ç®—äº†</h2>">
        
    </a><figcaption class="image-caption">çœ‹æˆæœ‰å‘å›¾è¿›è¡Œæ‹“æ‰‘æ’åºï¼Œç¡®å®šè®¡ç®—é¡ºåºã€‚<br>å¯ä»¥çœ‹å‡ºçŸ©é˜µè§„æ¨¡å°çš„æ—¶å€™å¹¶è¡Œåº¦å¾ˆä½ï¼Œä¸å¦‚å•çº¿ç¨‹è®¡ç®—ã€‚ä½†æ˜¯çŸ©é˜µè§„æ¨¡å¤§çš„æ—¶å€™å°±è¦è€ƒè™‘å¹¶è¡Œè®¡ç®—äº†</figcaption>
    </figure>
<ul>
<li>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ä¸€åˆ‡</p>
<ul>
<li><a href="https://hpc-tutorials.llnl.gov/mpi/" target="_blank" rel="noopener noreffer">MPI</a> - â€œa specification for the developers and users of message passing librariesâ€, <a href="https://www.openmp.org/" target="_blank" rel="noopener noreffer">OpenMP</a> - â€œmulti-platform shared-memory parallel programming in C/C++ and Fortranâ€</li>
</ul>
</li>
<li>
<p><a href="https://web.mit.edu/dimitrib/www/pdc.html" target="_blank" rel="noopener noreffer">Parallel and Distributed Computation: Numerical Methods</a>ï¼ˆä¸é«˜æ€§èƒ½è®¡ç®—æœ‰å…³ï¼‰</p>
</li>
</ul>
<p>çº¿ç¨‹é—´å¦‚ä½•é€šä¿¡</p>
<ul>
<li>é€šä¿¡ä¸ä»…å‘ç”Ÿåœ¨èŠ‚ç‚¹/çº¿ç¨‹ä¹‹é—´ï¼Œè¿˜å‘ç”Ÿåœ¨ä»»ä½•å…±äº«å†…å­˜è®¿é—®</li>
<li>è¿˜è®°å¾—è¢« <a href="https://jyywiki.cn/pages/OS/2022/demos/mem-ordering.c" target="_blank" rel="noopener noreffer">mem-ordering.c</a> æ”¯é…çš„ææƒ§å—ï¼Ÿ</li>
</ul>
<p><font color="red"><b>æ¨¡æ‹Ÿè®¡ç®—ï¼šç°å®ä¸­çš„ç‰©ç†ä¸–ç•Œå°±æ˜¯å¹¶å‘çš„</b></font></p>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/mandelbrot.c" target="_blank" rel="noopener noreffer">mandelbrot.c</a> (embarrassingly parallel)<font color="orange">ç¯å¢ƒæœ‰ç‚¹éš¾é…ï¼Œè¿™ä¸ªç¨‹åºåœ¨kaliä¸Šé¢çš„è¿è¡Œé€Ÿåº¦è¦æ¯”ä¹Œç­å›¾å¿«</font>ã€‚çº¿ç¨‹æ•°è¶Šå¤šï¼Œè¿è¡Œé€Ÿåº¦è¶Šå¿«ã€‚è€Œä¸”æˆ‘ä»¬ä¼šå‘ç°çº¿ç¨‹ä¼šå°†åŒºåŸŸåˆ’åˆ†ï¼Œç„¶ååªè´Ÿè´£è‡ªå·±é‚£ä¸€éƒ¨åˆ†çš„åŒºåŸŸã€‚ï¼ˆç”±äºåŒºåŸŸé—´æ²¡æœ‰å…³è”ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“è¿›è¡Œåˆ’åˆ†å’Œå¹¶è¡Œï¼‰</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-3.png" title="/img/Operating System/chapter7-3.png" data-thumbnail="/img/Operating System/chapter7-3.png" data-sub-html="<h2>æœ€ç»ˆæ•ˆæœ</h2>">
        
    </a><figcaption class="image-caption">æœ€ç»ˆæ•ˆæœ</figcaption>
    </figure>
<h2 id="æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹">æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹</h2>
<h3 id="æ•°æ®ä¸­å¿ƒç¨‹åºç‰¹ç‚¹">æ•°æ®ä¸­å¿ƒç¨‹åºï¼šç‰¹ç‚¹</h3>
<blockquote>
<p>â€œA network of computing and storage resources that enable the delivery of shared applications and data.â€ (CISCO)</p>
</blockquote>
<p>ä»¥æ•°æ® (å­˜å‚¨) ä¸ºä¸­å¿ƒ</p>
<ul>
<li>ä»äº’è”ç½‘æœç´¢ (Google)ã€ç¤¾äº¤ç½‘ç»œ (Facebook/Twitter) èµ·å®¶</li>
<li>æ”¯æ’‘å„ç±»äº’è”ç½‘åº”ç”¨ï¼šå¾®ä¿¡/QQ/æ”¯ä»˜å®/æ¸¸æˆ/ç½‘ç›˜/â€¦â€¦</li>
</ul>
<p>ç®—æ³•/ç³»ç»Ÿå¯¹ HPC å’Œæ•°æ®ä¸­å¿ƒçš„æ„ä¹‰</p>
<ul>
<li>ä½ æœ‰ 1,000,000 å°æœåŠ¡å™¨</li>
<li>å¦‚æœä¸€ä¸ªç®—æ³•/å®ç°èƒ½å¿« 1%ï¼Œå°±èƒ½çœ 10,000 å°æœåŠ¡å™¨
<ul>
<li>å‚è€ƒï¼š$NJU$å¯¹é¢ä¸€å¥—æˆ¿ â‰ˆ 50 å°æœåŠ¡å™¨ (ä¸è®¡è¿ç»´æˆæœ¬)</li>
</ul>
</li>
</ul>
<h3 id="æ•°æ®ä¸­å¿ƒä¸»è¦æŒ‘æˆ˜">æ•°æ®ä¸­å¿ƒï¼šä¸»è¦æŒ‘æˆ˜</h3>
<p>å¤šå‰¯æœ¬æƒ…å†µä¸‹çš„<b>é«˜å¯é </b>ã€<b>ä½å»¶è¿Ÿ</b>æ•°æ®è®¿é—®</p>
<div class="mermaid" id="id-1"></div>
<p><b>ä¸ºäº†å¯é æ€§ï¼ˆåšæ•°æ®æ¢å¤ï¼‰æ¯ä¸ªæ•°æ®åœ¨å¤šä¸ªæœåŠ¡å™¨é‡Œé¢éƒ½æœ‰å‰¯æœ¬</b></p>
<p>å…¶ä¸­çš„è®¡ç®—æœºç§°ä¸º$Key-value-storage$<code>{key : value}</code>ï¼Œ<font color="red"><b>æ˜¯ç°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ€æµè¡Œçš„æ¨¡å‹</b></font></p>
<ul>
<li>åœ¨æœåŠ¡æµ·é‡åœ°ç†åˆ†å¸ƒè¯·æ±‚çš„å‰æä¸‹
<ul>
<li>æ•°æ®è¦ä¿æŒä¸€è‡´ $\Longrightarrow$ å¤šä¸ªå‰¯æœ¬éƒ½è¦è·Ÿç€å˜åŠ¨(Consistency)</li>
<li>æœåŠ¡æ—¶åˆ»ä¿æŒå¯ç”¨ (Availability)</li>
<li>å®¹å¿æœºå™¨ç¦»çº¿ (Partition tolerance)</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-4.png" title="/img/Operating System/chapter7-4.png" data-thumbnail="/img/Operating System/chapter7-4.png" data-sub-html="<h2>é‡å­çº ç¼ </h2>">
        
    </a><figcaption class="image-caption">é‡å­çº ç¼ </figcaption>
    </figure>
<h3 id="è¿™é—¨è¯¾çš„é—®é¢˜å¦‚ä½•ç”¨å¥½ä¸€å°è®¡ç®—æœº">è¿™é—¨è¯¾çš„é—®é¢˜ï¼šå¦‚ä½•ç”¨å¥½ä¸€å°è®¡ç®—æœºï¼Ÿ</h3>
<p>å¦‚ä½•ç”¨ä¸€å° (å¯é çš„) è®¡ç®—æœº<b>å°½å¯èƒ½å¤šåœ°æœåŠ¡å¹¶è¡Œçš„è¯·æ±‚</b></p>
<ul>
<li>å…³é”®æŒ‡æ ‡ï¼šQPS, tail latency, &hellip;</li>
</ul>
<p>æˆ‘ä»¬æœ‰çš„å·¥å…·</p>
<ul>
<li>çº¿ç¨‹ (threads)
<ul>
<li>çº¿ç¨‹çš„åˆ‡æ¢éœ€è¦ä»£ä»·<font color="purple"><b>ï¼ˆä»ä¸€ä¸ªçŠ¶æ€æœºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€æœºÂ $\Longrightarrow$ ä¿å­˜PCï¼Œä¿å­˜æ‰€æœ‰å¯„å­˜å™¨ï¼ˆç©ºé—´å¼€é”€ï¼‰ï¼Œå‹æ ˆï¼Œé™·å…¥ç®¡æ€ç­‰ï¼‰</b></font></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">thread</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">println</span><span class="p">(</span><span class="s">&#34;${Thread.currentThread()} has run.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><b>åç¨‹ (coroutines)</b>
<ul>
<li><code>code: co_yield ==&gt; asm: call &lt;co_yield&gt;</code> $\Longrightarrow$ <font color="red"><b>å®é™…ä¸Šæ˜¯å‡½æ•°è°ƒç”¨</b></font>ã€‚åªéœ€è¦è¿›è¡Œ<font color="red"><b>ä¸€éƒ¨åˆ†æ ˆå’Œä¸€éƒ¨åˆ†å¯„å­˜å™¨</b></font>çš„æ“ä½œ</li>
<li>å¤šä¸ªå¯ä»¥ä¿å­˜/æ¢å¤çš„æ‰§è¡Œæµ (<a href="https://jyywiki.cn/OS/2022/labs/M2" target="_blank" rel="noopener noreffer">M2 - libco</a>)</li>
<li><b>æ¯”çº¿ç¨‹æ›´è½»é‡ (å®Œå…¨æ²¡æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ²¡æœ‰æ“ä½œç³»ç»ŸçŠ¶æ€)</b></li>
</ul>
</li>
</ul>
<h3 id="æ•°æ®ä¸­å¿ƒåç¨‹å’Œçº¿ç¨‹">æ•°æ®ä¸­å¿ƒï¼šåç¨‹å’Œçº¿ç¨‹</h3>
<ul>
<li>æ•°æ®ä¸­å¿ƒç®€åŒ–æ¨¡å‹</li>
</ul>
<div class="mermaid" id="id-2"></div>
<ul>
<li>
<p>æ•°æ®ä¸­å¿ƒ</p>
<ul>
<li>
<p>åŒä¸€æ—¶é—´æœ‰æ•°åƒ/æ•°ä¸‡ä¸ªè¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨</p>
</li>
<li>
<p>è®¡ç®—éƒ¨åˆ†</p>
<ul>
<li><b>éœ€è¦åˆ©ç”¨å¥½å¤šå¤„ç†å™¨</b>
<ul>
<li>çº¿ç¨‹ â†’ <b><font color="red">è¿™å°±æ˜¯æˆ‘æ“…é•¿çš„ (Mandelbrot Set)</font>ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šå ç”¨ç›¸å½“å¯è§‚çš„æ“ä½œç³»ç»Ÿèµ„æº<font color="orange">ï¼ˆéœ€è¦æŒ‚PCï¼Œä¿å­˜çŠ¶æ€ç­‰ï¼Œå¼€é”€æ¯”åç¨‹å¤§çš„å¤šï¼‰</font></b></li>
<li>åç¨‹ â†’ <b>ä¸€äººå‡ºåŠ›ï¼Œä»–äººæ‘¸é±¼ $\Longrightarrow$ <font color="red">ï¼ˆåç¨‹ä¸å—æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œä¸€ä¸ªçº¿ç¨‹é‡Œé¢ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªåç¨‹ï¼‰ä¾‹å¦‚åç¨‹ç¢°åˆ°read(),å°±ä¼šåè¿‡æ¥é˜»å¡å¯¹åº”çš„çº¿ç¨‹</font></b></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>I/O éƒ¨åˆ†</p>
<ul>
<li>ä¼šåœ¨ç³»ç»Ÿè°ƒç”¨ä¸Š block (ä¾‹å¦‚è¯·æ±‚å¦ä¸€ä¸ªæœåŠ¡æˆ–è¯»ç£ç›˜)
<ul>
<li>åç¨‹ â†’ ä¸€äººå¹²ç­‰ï¼Œä»–äººå›´è§‚</li>
<li>çº¿ç¨‹ â†’ æ¯ä¸ªçº¿ç¨‹éƒ½å ç”¨å¯è§‚çš„æ“ä½œç³»ç»Ÿèµ„æº</li>
</ul>
</li>
</ul>
</li>
<li>
<p>(è¿™ä¸ªé—®é¢˜æ¯”ä½ æƒ³è±¡çš„å¤æ‚ï¼Œä¾‹å¦‚è™šæ‹Ÿæœº)</p>
</li>
</ul>
<h3 id="go-å’Œ-goroutine">Go å’Œ Goroutine</h3>
<blockquote>
<p>Go: å°å­©å­æ‰åšé€‰æ‹©ï¼Œå¤šå¤„ç†å™¨å¹¶è¡Œå’Œè½»é‡çº§å¹¶å‘<b><font color="red">æˆ‘å…¨éƒ½è¦</font></b>ï¼</p>
</blockquote>
<p><b>Goroutine: æ¦‚å¿µä¸Šæ˜¯çº¿ç¨‹ï¼Œå®é™…æ˜¯çº¿ç¨‹å’Œåç¨‹çš„æ··åˆä½“</b> $\Longrightarrow$ è§£å†³äº†é«˜å¹¶å‘$I/O$çš„é—®é¢˜</p>
<div class="mermaid" id="id-3"></div>
<ul>
<li>
<p><b>å³åˆ©ç”¨çš„åç¨‹çš„é«˜æ•ˆæ€§ï¼Œåˆé€šè¿‡ä¸€å®šçš„æœºåˆ¶é˜²æ­¢åç¨‹é€ æˆçš„é˜»å¡</b></p>
</li>
<li>
<p>è°ƒåº¦å™¨ä¼šå¸®åŠ©ä½ ç®¡ç†å¥½<b>Goroutine</b></p>
</li>
<li>
<p>åŒæ—¶å¹¶è¡Œæ‰§è¡Œçš„æœ€å¤šä¹Ÿåªæœ‰ä¸€ä¸ªCPUå’Œä¸€ä¸ªçº¿ç¨‹</p>
<ul>
<li><font color="red"><b>ä¸€ä¸ªCPUéƒ½ä¸ä¼šåœ¨ä¸¤ä¸ªgoçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œçœæ‰äº†åˆ‡æ¢CPUçº¿ç¨‹çš„æ—¶é—´ï¼Œè¿è¡Œå’Œåˆ‡æ¢çš„éƒ½æ˜¯åç¨‹</b></font></li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>æ¯ä¸ª CPU ä¸Šæœ‰ä¸€ä¸ª Go Workerï¼Œè‡ªç”±è°ƒåº¦ goroutines</li>
<li>æ‰§è¡Œåˆ° blocking API æ—¶ (ä¾‹å¦‚ sleep, read)
<ul>
<li>Go Worker å·å·æ”¹æˆ non-blocking çš„ç‰ˆæœ¬
<ul>
<li>æˆåŠŸ â†’ ç«‹å³ç»§ç»­æ‰§è¡Œ</li>
<li>å¤±è´¥ â†’ ç«‹å³ yield åˆ°å¦ä¸€ä¸ªéœ€è¦ CPU çš„ goroutine
<ul>
<li>å¤ªå·§å¦™äº†ï¼CPU å’Œæ“ä½œç³»ç»Ÿå…¨éƒ¨ç”¨åˆ° 100%</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p>ä¾‹å­</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/fib.go" target="_blank" rel="noopener noreffer">fib.go</a>; <a href="https://books.studygolang.com/gopl-zh/ch9/ch9-08.html" target="_blank" rel="noopener noreffer"><em>The Go Programming Language</em> (ch 9.8)</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Example from &#34;The Go Programming Language&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">go</span> <span class="nf">spinner</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="nx">n</span> <span class="p">=</span> <span class="mi">45</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fibN</span> <span class="o">:=</span> <span class="nf">fib</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="c1">// slow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\rFibonacci(%d) = %d\n&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">fibN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">spinner</span><span class="p">(</span><span class="nx">delay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="s">`-\|/`</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\r%c&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fib</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">fib</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">fib</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>go spinner(100 * time.Millisecond)</code>æ¦‚å¿µæ˜¯çº¿ç¨‹ï¼Œå®ç°æ˜¯åç¨‹</p>
</li>
<li>
<p><code>spinner</code>å®è·µä¸Šä¼šè¢«è°ƒåº¦åˆ°å¦å¤–ä¸€ä¸ªCPUä¸Šé¢æ‰§è¡Œ</p>
</li>
</ul>
<a class="lightgallery" href="/img/Operating%20System/chapter7-5.png" title="/img/Operating System/chapter7-5.png" data-thumbnail="/img/Operating System/chapter7-5.png">
        
    </a>
<h3 id="ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸Šçš„ç³»ç»Ÿç¼–ç¨‹">ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸Šçš„ç³»ç»Ÿç¼–ç¨‹</h3>
<blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating. â€”â€”<em>Effective Go</em></p>
</blockquote>
<p><font color="red">å…±äº«å†…å­˜ = ä¸‡æ¶ä¹‹æº</font></p>
<ul>
<li>åœ¨å¥‡æ€ªè°ƒåº¦ä¸‹å‘ç”Ÿçš„å„ç§å¹¶å‘ bugs
<ul>
<li>æ¡ä»¶å˜é‡ï¼šbroadcast æ€§èƒ½ä½ï¼Œä¸ broadcast å®¹æ˜“é”™</li>
<li>ä¿¡å·é‡ï¼šåœ¨ç®¡ç†å¤šç§èµ„æºæ—¶å°±æ²¡é‚£ä¹ˆå¥½ç”¨äº†</li>
</ul>
</li>
</ul>
<hr>
<p><b>æ—¢ç„¶ç”Ÿäº§è€…-æ¶ˆè´¹è€…èƒ½è§£å†³ç»å¤§éƒ¨åˆ†é—®é¢˜ï¼Œæä¾›ä¸€ä¸ª API ä¸å°±å¥½äº†ï¼Ÿ</b></p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/producer-consumer.go" target="_blank" rel="noopener noreffer">producer-consumer.go</a>
<ul>
<li>ç¼“å­˜ä¸º 0 çš„ channel å¯ä»¥ç”¨æ¥åŒæ­¥ <font color="red"><b>(å…ˆåˆ°è€…ç­‰å¾…)</b></font></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">stream</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">n</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">produce</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;produce&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stream</span> <span class="o">&lt;-</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">consume</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="nx">stream</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;consume&#34;</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nf">produce</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">consume</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>stream &lt;- i</code> $\Longrightarrow$ æŠŠiä¸¢è¿›channel</li>
<li><code>x := &lt;- stream</code> $\Longrightarrow$ æŠŠiä»channelä¸­æ‹‰å‡ºæ¥</li>
</ul>
<a class="lightgallery" href="/img/Operating%20System/chapter7-6.png" title="/img/Operating System/chapter7-6.png" data-thumbnail="/img/Operating System/chapter7-6.png">
        
    </a>
<a class="lightgallery" href="/img/Operating%20System/chapter7-7.png" title="/img/Operating System/chapter7-7.png" data-thumbnail="/img/Operating System/chapter7-7.png">
        
    </a>
<h2 id="æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹">æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹</h2>
<h3 id="web-20-æ—¶ä»£-1999">Web 2.0 æ—¶ä»£ (1999)</h3>
<p>äººä¸äººä¹‹é—´è”ç³»æ›´åŠ ç´§å¯†çš„äº’è”ç½‘</p>
<ul>
<li>â€œUsers were encouraged to provide content, rather than just viewing it.â€</li>
<li>ä½ ç”šè‡³å¯ä»¥æ‰¾åˆ°ä¸€äº› â€œWeb 3.0â€/Metaverse çš„çº¿ç´¢</li>
</ul>
<hr>
<p>æ˜¯ä»€ä¹ˆæˆå°±äº†ä»Šå¤©çš„ Web 2.0?</p>
<ul>
<li><font color="red"><b>æµè§ˆå™¨ä¸­çš„å¹¶å‘ç¼–ç¨‹</b></font>ï¼šAjax (Asynchronous JavaScript + XML)</li>
<li>HTML (DOM Tree) + CSS ä»£è¡¨äº†ä½ èƒ½çœ‹è§çš„ä¸€åˆ‡
<ul>
<li>é€šè¿‡ JavaScript å¯ä»¥æ”¹å˜å®ƒ</li>
<li>é€šè¿‡ JavaScript å¯ä»¥å»ºç«‹è¿æ¥æœ¬åœ°å’ŒæœåŠ¡å™¨</li>
<li>ä½ å°±æ‹¥æœ‰äº†å…¨ä¸–ç•Œï¼</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-8.png" title="/img/Operating System/chapter7-8.png" data-thumbnail="/img/Operating System/chapter7-8.png" data-sub-html="<h2>æµè§ˆå™¨ä¸­çš„DOM Tree</h2>">
        
    </a><figcaption class="image-caption">æµè§ˆå™¨ä¸­çš„<code>DOM Tree</code></figcaption>
    </figure>
<h3 id="äººæœºäº¤äº’ç¨‹åºç‰¹ç‚¹å’Œä¸»è¦æŒ‘æˆ˜">äººæœºäº¤äº’ç¨‹åºï¼šç‰¹ç‚¹å’Œä¸»è¦æŒ‘æˆ˜</h3>
<ul>
<li>
<p>ç‰¹ç‚¹ï¼šä¸å¤ªå¤æ‚</p>
<ul>
<li>
<p>æ—¢æ²¡æœ‰å¤ªå¤šè®¡ç®—</p>
<ul>
<li>DOM Tree ä¹Ÿä¸è‡³äºå¤ªå¤§ (å¤§äº†äººä¹Ÿçœ‹ä¸è¿‡æ¥)</li>
<li>DOM Tree æ€ä¹ˆç”»æµè§ˆå™¨å…¨å¸®æˆ‘ä»¬æå®šäº†</li>
</ul>
</li>
<li>
<p>ä¹Ÿæ²¡æœ‰å¤ªå¤š I/O</p>
<ul>
<li>å°±æ˜¯ä¸€äº›ç½‘ç»œè¯·æ±‚<b>ï¼ˆè°ƒç”¨çš„å¿«ï¼Œè¿”å›çš„æ…¢ï¼‰</b></li>
</ul>
</li>
</ul>
</li>
<li>
<p>æŒ‘æˆ˜ï¼šç¨‹åºå‘˜å¤š $\Longrightarrow$<b>ï¼ˆåé¢éç§‘ç­ï¼Œè®¾è®¡å¸ˆï¼ŒåŸç”»å¸ˆè¿™æ ·çš„ç¾¤ä½“ä¹Ÿä¼šå‚ä¸è¿›æ¥ï¼‰</b></p>
<ul>
<li>
<p><b><font color="red">é›¶åŸºç¡€</font>çš„äººä½ è®©ä»–æ•´å…±äº«å†…å­˜ä¸Šçš„å¤šçº¿ç¨‹</b></p>
</li>
<li>
<p>ææ€•æˆ‘ä»¬ç°åœ¨ç”¨çš„åˆ°å¤„éƒ½æ˜¯ bug å§ï¼Ÿï¼Ÿï¼Ÿ</p>
</li>
</ul>
</li>
</ul>
<h3 id="å•çº¿ç¨‹--äº‹ä»¶æ¨¡å‹">å•çº¿ç¨‹ + äº‹ä»¶æ¨¡å‹</h3>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-9.jpg" title="/img/Operating System/chapter7-9.jpg" data-thumbnail="/img/Operating System/chapter7-9.jpg" data-sub-html="<h2>å•çº¿ç¨‹&#43;äº‹ä»¶æ¨¡å‹ï¼Œäº‹ä»¶ä¸€æ—¦å¼€å§‹æ‰§è¡Œå°±å¿…é¡»æ‰§è¡Œåˆ°ç»“æŸ $\Longrightarrow$ è¿™æ ·å°±é¿å…äº†å¹¶å‘bug</h2>">
        
    </a><figcaption class="image-caption">å•çº¿ç¨‹+äº‹ä»¶æ¨¡å‹ï¼Œäº‹ä»¶ä¸€æ—¦å¼€å§‹æ‰§è¡Œå°±å¿…é¡»æ‰§è¡Œåˆ°ç»“æŸ $\Longrightarrow$ <b><code>è¿™æ ·å°±é¿å…äº†å¹¶å‘bug</code></b></figcaption>
    </figure>
<ul>
<li>
<p>ä½†æ˜¯äº‹ä»¶é‡Œé¢è¯·æ±‚ç½‘ç»œçš„æ—¶å€™è¦æ³¨æ„æˆåŠŸå’Œå¤±è´¥çš„å¤„ç†æ–¹æ³•ã€‚<b>å› ä¸ºç½‘ç»œæ˜¯æœ‰å»¶è¿Ÿè€Œä¸”ä¸ç¨³å®šçš„ï¼Œä¸èƒ½å› ä¸ºè¯·æ±‚ç½‘ç»œå¤±è´¥å°±å¯¼è‡´åœ¨å¯¹åº”çš„äº‹ä»¶é‡Œé¢å µæ­»</b></p>
</li>
<li>
<p>å°½å¯èƒ½å°‘ä½†åˆè¶³å¤Ÿçš„å¹¶å‘</p>
<ul>
<li>
<p>ä¸€ä¸ªçº¿ç¨‹ã€å…¨å±€çš„äº‹ä»¶é˜Ÿåˆ—ã€<b><font color="red">æŒ‰åºæ‰§è¡Œ (run-to-complete)</font></b>ï¼Œ<b>æ²¡æœ‰lockï¼Œç¼–å†™å®¹æ˜“</b></p>
</li>
<li>
<p>è€—æ—¶çš„ API (Timer, Ajax, &hellip;) è°ƒç”¨ä¼šç«‹å³è¿”å›</p>
<ul>
<li>æ¡ä»¶æ»¡è¶³æ—¶å‘é˜Ÿåˆ—é‡Œå¢åŠ ä¸€ä¸ªäº‹ä»¶</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span> <span class="p">{</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;https://xxx.yyy.zzz/login&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span> <span class="p">{</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;https://xxx.yyy.zzz/cart&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter7-10.jpg" title="/img/Operating System/chapter7-10.jpg" data-thumbnail="/img/Operating System/chapter7-10.jpg" data-sub-html="<h2>è¯·æ±‚æˆåŠŸçš„æƒ…å†µ</h2>">
        
    </a><figcaption class="image-caption">è¯·æ±‚æˆåŠŸçš„æƒ…å†µ</figcaption>
    </figure>
<h3 id="å¼‚æ­¥äº‹ä»¶æ¨¡å‹">å¼‚æ­¥äº‹ä»¶æ¨¡å‹</h3>
<ul>
<li>
<p>å¹¶å‘æ¨¡å‹ç®€å•äº†å¾ˆå¤š</p>
<ul>
<li>å‡½æ•°çš„æ‰§è¡Œæ˜¯åŸå­çš„ (ä¸èƒ½å¹¶è¡Œï¼Œå‡å°‘äº†å¹¶å‘ bug çš„å¯èƒ½æ€§)</li>
</ul>
</li>
<li>
<p><b>API ä¾ç„¶å¯ä»¥å¹¶è¡Œï¼ˆç”±æµè§ˆå™¨åå°å¸®ä½ æå®šå¹¶è¡Œï¼‰</b></p>
<ul>
<li>é€‚åˆç½‘é¡µè¿™ç§ â€œå¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨æ¸²æŸ“å’Œç½‘ç»œè¯·æ±‚â€ çš„åœºæ™¯
<ul>
<li>JavaScript ä»£ç åªè´Ÿè´£ â€œæè¿°â€ <code>DOM Tree</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>åå¤„</p>
<ul>
<li>Callback hell (ç¥–ä¼ å±å±±)
<ul>
<li>åˆšæ‰çš„ä»£ç åµŒå¥— 5 å±‚ï¼Œå¯ç»´æŠ¤æ€§å·²ç»æ¥è¿‘äºé›¶äº†</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å¼‚æ­¥ç¼–ç¨‹promise">å¼‚æ­¥ç¼–ç¨‹ï¼šPromise</h3>
<blockquote>
<p>å¯¼è‡´ callback hell çš„æœ¬è´¨ï¼šäººç±»è„‘è¢‹é‡Œæƒ³çš„æ˜¯ â€œæµç¨‹å›¾â€ï¼Œçœ‹åˆ°çš„æ˜¯ â€œå›è°ƒâ€ã€‚</p>
</blockquote>
<ul>
<li>The Promise object represents the <em>eventual completion</em> (or failure) of an asynchronous operation and its resulting value.</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter7-11.png" title="/img/Operating System/chapter7-11.png" data-thumbnail="/img/Operating System/chapter7-11.png" data-sub-html="<h2>Promise: æµç¨‹å›¾çš„æ„é€ æ–¹æ³• (Mozilla-MDN Docs)</h2>">
        
    </a><figcaption class="image-caption">Promise: æµç¨‹å›¾çš„æ„é€ æ–¹æ³• (Mozilla-MDN Docs)</figcaption>
    </figure>
<h3 id="promise-æè¿°-workflow-çš„-åµŒå…¥å¼è¯­è¨€">Promise: æè¿° Workflow çš„ â€œåµŒå…¥å¼è¯­è¨€â€</h3>
<p>Chaining</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">loadScript</span><span class="p">(</span><span class="s2">&#34;/article/promise-chaining/one.js&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">script</span> <span class="p">=&gt;</span> <span class="nx">loadScript</span><span class="p">(</span><span class="s2">&#34;/article/promise-chaining/two.js&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">script</span> <span class="p">=&gt;</span> <span class="nx">loadScript</span><span class="p">(</span><span class="s2">&#34;/article/promise-chaining/three.js&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">script</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// scripts are loaded, we can use functions declared there
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> <span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter7-12.png" title="/img/Operating System/chapter7-12.png" data-thumbnail="/img/Operating System/chapter7-12.png" data-sub-html="<h2>ä»£ç æè¿°</h2>">
        
    </a><figcaption class="image-caption">ä»£ç æè¿°</figcaption>
    </figure>
<p>Fork-join</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter7-13.png" title="/img/Operating System/chapter7-13.png" data-thumbnail="/img/Operating System/chapter7-13.png" data-sub-html="<h2>ä»£ç æè¿°</h2>">
        
    </a><figcaption class="image-caption">ä»£ç æè¿°</figcaption>
    </figure>
<h3 id="async-await-even-better">Async-Await: Even Better</h3>
<p>async function</p>
<ul>
<li>æ€»æ˜¯è¿”å›ä¸€ä¸ª <code>Promise</code> object</li>
<li><code>async_func()</code> - fork</li>
</ul>
<hr>
<p>await promise</p>
<ul>
<li><code>await promise</code> - join</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">A</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">await</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;/hello/a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">B</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">await</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;/hello/b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">C</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">await</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;/hello/c&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">hello</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">A</span><span class="p">(),</span> <span class="nx">B</span><span class="p">(),</span> <span class="nx">C</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl"><span class="nx">hello</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fetch failed!&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter7-14.png" title="/img/Operating System/chapter7-14.png" data-thumbnail="/img/Operating System/chapter7-14.png" data-sub-html="<h2>ä»£ç æè¿°</h2>">
        
    </a><figcaption class="image-caption">ä»£ç æè¿°</figcaption>
    </figure>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: ä»€ä¹ˆæ ·çš„ä»»åŠ¡æ˜¯éœ€è¦å¹¶è¡Œ/å¹¶å‘çš„ï¼Ÿå®ƒä»¬åº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>å¹¶å‘ç¼–ç¨‹çš„çœŸå®åº”ç”¨åœºæ™¯
<ul>
<li><b>é«˜æ€§èƒ½è®¡ç®— (æ³¨é‡ä»»åŠ¡åˆ†è§£): ç”Ÿäº§è€…-æ¶ˆè´¹è€… (MPI/OpenMP)</b></li>
<li><b>æ•°æ®ä¸­å¿ƒ (æ³¨é‡ç³»ç»Ÿè°ƒç”¨): çº¿ç¨‹-åç¨‹ (Goroutine)</b></li>
<li><b>äººæœºäº¤äº’ (æ³¨é‡æ˜“ç”¨æ€§): äº‹ä»¶-æµå›¾ (Promise)</b></li>
</ul>
</li>
<li>ç¼–ç¨‹å·¥å…·çš„å‘å±•çªé£çŒ›è¿›
<ul>
<li>è‡ª Web 2.0 ä»¥æ¥ï¼Œå¼€æºç¤¾åŒºæ”¹å˜äº†è®¡ç®—æœºç§‘å­¦çš„å­¦ä¹ æ–¹å¼</li>
<li>å¸Œæœ›æ¯ä¸ªåŒå­¦éƒ½æœ‰ä¸€ä¸ª<font color="red"><b> â€œä¸»åŠ›ç°ä»£ç¼–ç¨‹è¯­è¨€â€</b></font>
<ul>
<li>Modern C++, Rust, Javascript, &hellip;</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
]]></description>
</item>
<item>
    <title>Operating System Chapter6 å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter6/</link>
    <pubDate>Fri, 10 Mar 2023 20:32:20 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter6/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-10 20:48</p>
<p>åœ¨æ´²çš„æé†’ä¸‹ï¼Œâœ‹æ‰å‘ç°åŸæ¥ç§Ÿå›½å¤–ç”µè¯å·é‚£ä¸ªç½‘ç«™å¯ä»¥æœ‰è®¿é—®<a href="https://openai.com/blog/chatgpt" target="_blank" rel="noopener noreffer">ChatGPT</a>çš„æ•™ç¨‹ï¼Œä¹‹å‰é¦–å°”çº¿å’Œç¾å›½çº¿éƒ½å› ä¸ºåIPç»™banäº†ï¼Œè¿™ç½‘ç«™éƒ½æ²¡ä»”ç»†çœ‹ï¼ŒçœŸæ˜¯è¡€äº</p>
<p>ä¸‹åˆé—®ChatGPTä¸€ä¸ªä¸€ä¸ªé—®é¢˜ï¼Œä¸å¾—æ„Ÿå¹ï¼šç‰›é€¼æ»´ç‹ å‘ï¼</p>
<p>åªèƒ½è¯´æœ‰äº†å®ƒï¼Œå†™ä½œä¸šç¬é—´è½»æ¾äº†åå€ç”šè‡³ä¹å€ï¼ˆèµèµ</p>
</div>
        </div>
    </div>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>äº’æ–¥ï¼šè‡ªæ—‹é”ã€äº’æ–¥é”ã€futex</li>
<li><del>æ˜¯æ—¶å€™é¢å¯¹çœŸæ­£çš„å¹¶å‘ç¼–ç¨‹äº†</del></li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: <b>å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ</b></li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>å…¸å‹çš„åŒæ­¥é—®é¢˜ï¼š<b>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</b>ï¼›å“²å­¦å®¶åƒé¥­</li>
<li>åŒæ­¥çš„å®ç°æ–¹æ³•ï¼šä¿¡å·é‡ã€æ¡ä»¶å˜é‡</li>
</ul>
<h2 id="çº¿ç¨‹åŒæ­¥">çº¿ç¨‹åŒæ­¥</h2>
<h3 id="åŒæ­¥-synchronization">åŒæ­¥ (Synchronization)</h3>
<ul>
<li>
<p><b>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„<u>ç›¸å¯¹å…³ç³»</u></b></p>
</li>
<li>
<p>iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)</p>
</li>
<li>
<p>å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)</p>
</li>
<li>
<p>åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºé€Ÿåº¦ä¸€è‡´)</p>
</li>
<li>
<p>åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)</p>
</li>
</ul>
<hr>
<ul>
<li><b>å¼‚æ­¥ (Asynchronous) = ä¸åŒæ­¥</b>
<ul>
<li>ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)</li>
</ul>
</li>
</ul>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-11 14:00</p>
<p>ä¹Œç­å›¾æ‰“èµ¢å¤æ´»èµ›æˆåŠŸï¼ˆèµèµï¼$\Longrightarrow$ å¤§çˆ¹å¤æ´»åšå®¢<a href="https://blog.csdn.net/ningmengzhihe/article/details/127295333" target="_blank" rel="noopener noreffer">ã€ŠGPartedç»™ubuntuç³»ç»Ÿç£ç›˜resizeå¤§å°æ—¶å€™å‡ºç°cannot resize read-only file systemè§£å†³åŠæ³•ã€‹</a>ï¼ˆååˆ†ç”šè‡³ä¹åˆ†çš„ç‰›é€¼</p>
<p>æ˜¨æ™šæ‰“åªç‹¼æ‰“ä¸Šå¤´äº†ï¼Œä¸€è§‰ç¡åˆ°ä¸­åˆï¼ˆå¯ä»¥é‡å¼€äº†</p>
<p>ä¸‹åˆç»§ç»­æ‹¿ç€ä¹Œç­å›¾å¬è¯¾ï¼ˆå–œ</p>
</div>
        </div>
    </div>
<h3 id="å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥">å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥</h3>
<ul>
<li>
<p><b>å¹¶å‘ç¨‹åºçš„æ­¥è°ƒå¾ˆéš¾ä¿æŒ â€œ<font color="red">å®Œå…¨</font>ä¸€è‡´â€</b></p>
<ul>
<li><b>çº¿ç¨‹åŒæ­¥ï¼š<font color="red">åœ¨æŸä¸ªæ—¶é—´ç‚¹å…±åŒè¾¾åˆ°äº’ç›¸å·²çŸ¥çš„çŠ¶æ€</font></b>ï¼Œï¼ˆå…ˆæ•´å®Œçš„ç­‰å¦ä¸€ä¸ª</li>
</ul>
</li>
<li>
<p>å†æ¬¡æŠŠçº¿ç¨‹æƒ³è±¡æˆæˆ‘ä»¬è‡ªå·±</p>
<ul>
<li>NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨/ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥</li>
<li>èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­</li>
<li>å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜</li>
<li>jyyï¼š<del>ç­‰æˆ‘æˆä¸ºå·ç‹å°±èººå¹³</del>
<ul>
<li><font color="red"><b>â€œå…ˆåˆ°å…ˆç­‰â€</b></font></li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç›®æ ‡ï¼šå†™çº¿ç¨‹æ¨¡æ‹Ÿä¸Šé¢çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚Açº¿ç¨‹ä»£è¡¨ä½ æ‰“æ¸¸æˆï¼ŒBçº¿ç¨‹ä»£è¡¨ä½ èˆå‹ä¿®bugï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹è¦åšçš„æ˜¯åœ¨ä½ æ‰“å®Œæ¸¸æˆï¼Œèˆå‹ä¿®å®Œbugä¹‹åä¸€èµ·å»å¹²é¥­</p>
</li>
</ul>
<h3 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜å­¦åºŸä½ å°±èµ¢äº†">ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†</h3>
<blockquote>
<p><b><font color="red">99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ã€‚</font></b></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tproduce</span><span class="p">()</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tconsume</span><span class="p">()</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;)&#34;</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>printf</code> å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³</p>
<ul>
<li>ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„<b>å‰ç¼€</b></li>
<li>æ‹¬å·<b>åµŒå¥—çš„æ·±åº¦</b>ä¸è¶…è¿‡$n$
<ul>
<li>$n=3$, <code>((())())(((</code> åˆæ³•</li>
<li>$n=3$, <code>(((())))</code>, <code>(()))</code> ä¸åˆæ³•</li>
</ul>
</li>
<li>åŒæ­¥
<ul>
<li><b>ç­‰åˆ°æœ‰ç©ºä½ï¼ˆåµŒå¥—å±‚æ•°ä¸å¤šï¼‰å†æ‰“å°å·¦æ‹¬å·</b></li>
<li><b>ç­‰åˆ°èƒ½é…å¯¹æ—¶å†æ‰“å°å³æ‹¬å·</b></li>
</ul>
</li>
</ul>
<h4 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜åˆ†æ">ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šåˆ†æ</h4>
<ul>
<li>
<p>ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ</p>
<ul>
<li>
<p><b>å·¦æ‹¬å·ï¼šç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥é˜Ÿåˆ—</b></p>
</li>
<li>
<p><b>å³æ‹¬å·ï¼šä»é˜Ÿåˆ—å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ</b></p>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ</p>
<ul>
<li>å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³$n$æ—¶æ‰èƒ½æ‰“å°</li>
<li>å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) &gt; 1æ—¶æ‰èƒ½æ‰“å°</li>
</ul>
</li>
<li>
<p><font color="red">å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº†</font>ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/pc.c" target="_blank" rel="noopener noreffer">pc.c</a></p>
<ul>
<li><font color="red">ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹</font></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">mutex_t</span> <span class="n">lk</span> <span class="o">=</span> <span class="n">MUTEX_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tproduce</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tconsume</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tproduce</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tconsume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å‹åŠ›æµ‹è¯•çš„æ£€æŸ¥å½“ç„¶ä¸èƒ½å°‘ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/pc-check.py" target="_blank" rel="noopener noreffer">pc-check.py</a> $\Longrightarrow$ <b>å­¦ä¸€é—¨è„šæœ¬è¯­è¨€æ¥åšè‡ªåŠ¨åŒ–æ£€æµ‹ï¼ˆå¾ˆé‡è¦ï¼ï¼‰ï¼Œæ€»æ¯”$OJ$ç»™ä½ æŠ¥é”™ä½ ä¸çŸ¥é“é”™åœ¨å“ªé‡Œå¥½å¾ˆå¤š</b></li>
<li>å°‘é¢å‘OJç¼–ç¨‹ï¼ˆçœŸæ­£çš„projectæ²¡æœ‰è¿™ç©æ„å„¿ï¼‰</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-1.png" title="/img/Operating System/chapter6-1.png" data-thumbnail="/img/Operating System/chapter6-1.png" data-sub-html="<h2>æœ‰æ—¶é—´çœ‹ä¸€çœ‹</h2>">
        
    </a><figcaption class="image-caption">æœ‰æ—¶é—´çœ‹ä¸€çœ‹</figcaption>
    </figure>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">count</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">limit</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> Ok.&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Model checker å½“ç„¶ä¹Ÿä¸èƒ½å°‘ (ç•™ä½œä¹ é¢˜)</p>
</li>
<li>
<p>ç®¡é“é€šä¿¡+è‡ªåŠ¨åŒ–è„šæœ¬æ£€æµ‹</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> 2023-03-11 15:21:02 âŒš  jungle-virtual-machine in ~/chapter6
</span></span><span class="line"><span class="cl">â—‹ â†’ ./pc <span class="m">3</span> <span class="p">|</span> python3 pc-check.py <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-11 15:23:26 âŒš  jungle-virtual-machine in ~/chapter6
</span></span><span class="line"><span class="cl">â—‹ â†’ ./pc <span class="m">3</span> <span class="p">|</span> python3 pc-check.py <span class="m">2</span>
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/home/jungle/chapter6/pc-check.py&#34;</span>, line 9, in &lt;module&gt;
</span></span><span class="line"><span class="cl">    assert <span class="m">0</span> &lt;<span class="o">=</span> count &lt;<span class="o">=</span> limit
</span></span><span class="line"><span class="cl">AssertionError
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ¡ä»¶å˜é‡ä¸‡èƒ½åŒæ­¥æ–¹æ³•">æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½åŒæ­¥æ–¹æ³•</h2>
<h3 id="åŒæ­¥é—®é¢˜åˆ†æ">åŒæ­¥é—®é¢˜ï¼šåˆ†æ</h3>
<blockquote>
<p>ä»»ä½•åŒæ­¥é—®é¢˜éƒ½<b><font color="red">æœ‰å…ˆæ¥å…ˆç­‰å¾…çš„æ¡ä»¶</font></b></p>
</blockquote>
<ul>
<li>
<p>çº¿ç¨‹ join (<a href="https://jyywiki.cn/pages/OS/2022/demos/thread.h" target="_blank" rel="noopener noreffer">thread.h</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/sum.c" target="_blank" rel="noopener noreffer">sum.c</a>)</p>
<ul>
<li>ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸåç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç­‰å¾…</li>
</ul>
</li>
<li>
<p>NPY çš„ä¾‹å­</p>
<ul>
<li>æ‰“å®Œæ¸¸æˆä¸”æ´—å®Œå¤´åç»§ç»­æ‰§è¡Œ <code>date()</code>ï¼Œå¦åˆ™ç­‰å¾…</li>
</ul>
</li>
<li>
<p>ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜</p>
<ul>
<li>å·¦æ‹¬å·ï¼šæ·±åº¦$k &lt; n$æ—¶<code>printf</code>ï¼Œå¦åˆ™ç­‰å¾…</li>
<li>å³æ‹¬å·ï¼š$k &gt; 0$æ—¶<code>printf</code>ï¼Œå¦åˆ™ç­‰å¾…
<ul>
<li>å†çœ‹ä¸€çœ¼ <a href="https://jyywiki.cn/pages/OS/2022/demos/pc.c" target="_blank" rel="noopener noreffer">pc.c</a> $\Longrightarrow$ threadæ¯æ¬¡åœä¸‹æ¥éƒ½è¦æ‰§è¡Œâ€œ<b>ä¸ŠğŸ”’ $\rightarrow$ <b><font color="orange">è®©æˆ‘çœ‹çœ‹ï¼</font></b>(èµ„æºï¼Œå¥½åº·çš„ä¸œè¥¿) $\rightarrow$ æ‰§è¡Œæˆ–è§£ğŸ”’</b>â€ï¼ˆä»£ç ï¼š<code>retry:mutex_lock(&amp;lk);if (count == 0) {mutex_unlock(&amp;lk);goto retry;}</code>ï¼‰æµªè´¹äº†æ—¶é—´ï¼Œèƒ½ä¸èƒ½ä¼˜åŒ–æ‰â€œ<b>ä¸ŠğŸ”’ $\rightarrow$ <b><font color="orange">è®©æˆ‘çœ‹çœ‹ï¼</font></b>$\rightarrow$ æ‰§è¡Œæˆ–è§£ğŸ”’</b>â€çš„æ—¶é—´ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-2.png" title="/img/Operating System/chapter6-2.png" data-thumbnail="/img/Operating System/chapter6-2.png" data-sub-html="<h2>jyyçš„threadåº“é€šè¿‡ChatGPTçœ‹èµ·æ¥èˆ’æœå¤šäº†</h2>">
        
    </a><figcaption class="image-caption">jyyçš„threadåº“é€šè¿‡ChatGPTçœ‹èµ·æ¥èˆ’æœå¤šäº†</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-3.png" title="/img/Operating System/chapter6-3.png" data-thumbnail="/img/Operating System/chapter6-3.png" data-sub-html="<h2>joinä¹Ÿå‘Šè¯‰ä½ åœ¨å¹²å•¥äº†</h2>">
        
    </a><figcaption class="image-caption">joinä¹Ÿå‘Šè¯‰ä½ åœ¨å¹²å•¥äº†</figcaption>
    </figure>
<ul>
<li>
<p>ç›®å‰ç†è§£ï¼š<code>join() = while(!terminated_all);</code></p>
</li>
<li>
<p>æˆ‘ä»¬æƒ³è¦åšçš„ï¼š<b>å°†â€œä¸ŠğŸ”’ $\rightarrow$ <b><font color="orange">è®©æˆ‘çœ‹çœ‹ï¼</font></b>$\rightarrow$ æ‰§è¡Œæˆ–è§£ğŸ”’â€å˜æˆâ€œçœ‹å®Œäº†ï¼Œèµ„æºä¸å¯¹ï¼Œé‚£å°±ç¡è§‰ï¼ˆæ‚²â€</b>ï¼ˆä»£ç ï¼š<code>mutex_lock(&amp;lk);if (count == 0){mutex_unlock_and_sleep(&amp;lk);}</code>ï¼‰ï¼Œä¹Ÿå°±æ˜¯â€œåŠè‡ªæ—‹â€$\Longrightarrow$ ä¼‘çœ </p>
<ul>
<li>åŒæ—¶ï¼Œå¦ä¸€ä¸ªthreadåœ¨æ‰§è¡Œ<b>å®Œè¯¥åšçš„ä»»åŠ¡åè¦å«é†’ä¼‘çœ çš„çº¿ç¨‹</b></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="p">);</span> <span class="c1">//finish my work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">wake_up</span><span class="p">(</span><span class="n">other_thread</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="conditional-variables-æ¡ä»¶å˜é‡-cv">Conditional Variables (æ¡ä»¶å˜é‡, CV)</h3>
<ul>
<li>
<p>æ¡ä»¶å˜é‡ API</p>
<ul>
<li>wait(cv, mutex) ğŸ’¤
<ul>
<li>è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex</li>
<li>é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€</li>
</ul>
</li>
</ul>
</li>
<li>
<p>signal/notify(cv) ğŸ’¬ ç§ä¿¡ï¼šèµ°èµ·</p>
<ul>
<li>å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹</li>
</ul>
</li>
<li>
<p>broadcast/notifyAll(cv) ğŸ“£ æ‰€æœ‰äººï¼šèµ°èµ·</p>
<ul>
<li>å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹ï¼ˆå‘ƒå‘ƒå‘ƒï¼ŒåŸæ¥å»å¹´cydçš„Javaæ•™çš„å°±æ˜¯è¿™ç©æ„å•Šï¼ŒğŸ®é­”å·®ç‚¹å†™æ­»âœŒï¼‰</li>
</ul>
</li>
</ul>
<h3 id="æ¡ä»¶å˜é‡å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…">æ¡ä»¶å˜é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h3>
<ul>
<li>æ”¹è‰¯ä»£ç </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tproduce</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="p">);</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span> <span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tconsume</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;)&#34;</span><span class="p">);</span> <span class="n">count</span><span class="o">--</span><span class="p">;</span> <span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‹åŠ›æµ‹è¯•ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/pc-cv.c" target="_blank" rel="noopener noreffer">pc-cv.c</a>ï¼›æ¨¡å‹æ£€éªŒï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/pc-cv.py" target="_blank" rel="noopener noreffer">pc-cv.py</a></p>
<ul>
<li>(Small scope hypothesis)</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-4.png" title="/img/Operating System/chapter6-4.png" data-thumbnail="/img/Operating System/chapter6-4.png" data-sub-html="<h2>æˆ‘è‡ªå·±çš„ç–‘é—®</h2>">
        
    </a><figcaption class="image-caption">æˆ‘è‡ªå·±çš„ç–‘é—®</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-5.png" title="/img/Operating System/chapter6-5.png" data-thumbnail="/img/Operating System/chapter6-5.png" data-sub-html="<h2>ç»§ç»­æé—®</h2>">
        
    </a><figcaption class="image-caption">ç»§ç»­æé—®</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-6.png" title="/img/Operating System/chapter6-6.png" data-thumbnail="/img/Operating System/chapter6-6.png" data-sub-html="<h2>ç»§ç»­æé—®</h2>">
        
    </a><figcaption class="image-caption">ç»§ç»­æé—®</figcaption>
    </figure>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/pc-cv.c" target="_blank" rel="noopener noreffer">pc-cv.c</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">mutex_t</span> <span class="n">lk</span> <span class="o">=</span> <span class="n">MUTEX_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">cond_t</span> <span class="n">cv</span> <span class="o">=</span> <span class="n">COND_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tproduce</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="p">);</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tconsume</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;)&#34;</span><span class="p">);</span> <span class="n">count</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tproduce</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tconsume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è§‚å¯Ÿ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tproduce</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tconsume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>i &lt; 1</code>çš„æ—¶å€™æ²¡é—®é¢˜ï¼Œè€Œ<code>i &lt; 8</code>çš„æ—¶å€™å°±å‡ºäº†é—®é¢˜</p>
</li>
<li>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/pc-cv.py" target="_blank" rel="noopener noreffer">pc-cy.py</a></p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ProducerConsumer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">waits</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tryacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">locked</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">seen</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">():</span> <span class="k">pass</span> <span class="c1"># mutex_lock()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># cond_wait</span>
</span></span><span class="line"><span class="cl">                <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">():</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># cond_signal</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="c1"># mutex_unlock()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">():</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">():</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tc2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">():</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;3&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">():</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿‡ç¨‹è§£è¯»ï¼ˆä¸Šé¢çš„pc-cv.cï¼‰</li>
</ul>
<div class="mermaid" id="id-1"></div>
<ul>
<li>
<p>ä»ç”Ÿæˆè€…å¼€å§‹å¾€ä¸‹èµ°ï¼Œ<b>ä¸€ä¸ªç”Ÿæˆææ–™ç”ŸæˆæˆåŠŸï¼Œè€Œæ¶ˆè´¹è¿‡ç¨‹æ‰§è¡Œäº†ä¸¤æ¬¡</b> $\Longrightarrow$ å¯„äº†ï¼</p>
<ul>
<li><b>ä¸ºä»€ä¹ˆå‘¢ï¼šåŒç±»å”¤é†’äº†åŒç±»ï¼Œè¿™æ˜¯é”™è¯¯çš„</b></li>
<li><b>éœ€è¦ä¸¤ä¸ªæ¡ä»¶å˜é‡ï¼Œä¿è¯åªèƒ½å”¤é†’å¼‚ç±»</b>ï¼Œè¯¾åè‡ªå·±é˜…è¯»ç›¸å…³ææ–™</li>
</ul>
</li>
<li>
<p><a href="https://github.com/Jungle430/check-for-NJU-OS/blob/main/pc-cv.html" target="_blank" rel="noopener noreffer">å¯è§†åŒ–</a></p>
</li>
</ul>
<h3 id="æ¡ä»¶å˜é‡æ­£ç¡®çš„æ‰“å¼€æ–¹å¼">æ¡ä»¶å˜é‡ï¼šæ­£ç¡®çš„æ‰“å¼€æ–¹å¼</h3>
<ul>
<li>éœ€è¦<b><font color="red">ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶</font></b></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">assert</span><span class="p">(</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1">// äº’æ–¥é”ä¿è¯äº†åœ¨æ­¤æœŸé—´æ¡ä»¶ cond æ€»æ˜¯æˆç«‹
</span></span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><b><font color="red">å…¶ä»–çº¿ç¨‹æ¡ä»¶å¯èƒ½è¢«æ»¡è¶³æ—¶</font></b></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¿®æ”¹ <a href="https://jyywiki.cn/pages/OS/2022/demos/pc-cv.c" target="_blank" rel="noopener noreffer">pc-cv.c</a> å’Œ <a href="https://jyywiki.cn/pages/OS/2022/demos/pc-cv.py" target="_blank" rel="noopener noreffer">pc-cv.py</a> $if \rightarrow while\ and\ signal \rightarrow boardcast\newline$</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-8.png" title="/img/Operating System/chapter6-8.png" data-thumbnail="/img/Operating System/chapter6-8.png" data-sub-html="<h2>ä¸¤è€…åŒºåˆ«</h2>">
        
    </a><figcaption class="image-caption">ä¸¤è€…åŒºåˆ«</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-9.png" title="/img/Operating System/chapter6-9.png" data-thumbnail="/img/Operating System/chapter6-9.png" data-sub-html="<h2>ä¸ºä»€ä¹ˆè¦å”¤é†’å…¨éƒ¨çº¿ç¨‹çš„åŸå› ã€‚æ€»ç®—ææ˜ç™½ä¸ºä»€ä¹ˆä¹‹å‰åªæ”¹$if \rightarrow while$çš„æƒ…å†µä¸‹ç¨‹åºä¼šå¡æ­»</h2>">
        
    </a><figcaption class="image-caption">ä¸ºä»€ä¹ˆè¦å”¤é†’å…¨éƒ¨çº¿ç¨‹çš„åŸå› ã€‚æ€»ç®—ææ˜ç™½ä¸ºä»€ä¹ˆä¹‹å‰åªæ”¹$if \rightarrow while$çš„æƒ…å†µä¸‹ç¨‹åºä¼šå¡æ­»</figcaption>
    </figure>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">2023-03-11 20:47:45 âŒš  jungle-virtual-machine in ~/chapter6
</span></span><span class="line"><span class="cl">â—‹ â†’ ./pc-cv <span class="m">3</span> <span class="p">|</span> python3 pc-check.py <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span><span class="line"><span class="cl"><span class="m">100000</span> Ok.
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿è¡ŒæˆåŠŸï¼</li>
<li>é—®å¤§çˆ¹ChatGPT</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-7.png" title="/img/Operating System/chapter6-7.png" data-thumbnail="/img/Operating System/chapter6-7.png" data-sub-html="<h2>ifæ˜¯å‡ç¡çœ ï¼Œåªèƒ½ç¡ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡å°±ä¼šè‹é†’ï¼Œè€Œwhileæ‰æ˜¯çœŸç¡çœ ï¼Œåªæœ‰æ¡ä»¶æ»¡è¶³æ—¶æ‰è‹é†’</h2>">
        
    </a><figcaption class="image-caption"><code>if</code>æ˜¯<b>å‡ç¡çœ </b>ï¼Œåªèƒ½ç¡ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡å°±ä¼šè‹é†’ï¼Œè€Œ<code>while</code>æ‰æ˜¯<b>çœŸç¡çœ </b>ï¼Œåªæœ‰æ¡ä»¶æ»¡è¶³æ—¶æ‰è‹é†’</figcaption>
    </figure>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pthread_mutex_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pthread_cond_t</span> <span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">thread_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Thread %d: data = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_t</span> <span class="n">tid1</span><span class="p">,</span> <span class="n">tid2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¡ä»¶å˜é‡å®ç°å¹¶è¡Œè®¡ç®—">æ¡ä»¶å˜é‡ï¼šå®ç°å¹¶è¡Œè®¡ç®—</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">job</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">run</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">job</span> <span class="o">=</span> <span class="n">get_job</span><span class="p">())</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">job</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span> <span class="c1">// ä¸éœ€è¦æŒæœ‰é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="c1">// å¯ä»¥ç”Ÿæˆæ–°çš„ job
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="c1">// æ³¨æ„å›æ”¶åˆ†é…çš„èµ„æº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸‹é¢å¼€å§‹å°†æœ€é•¿å…¬å…±å­ä¸²çš„dpç®—æ³•ï¼Œè§†é¢‘æ–­äº†ï¼Œè¿™ä¸ªä¹‹å‰åšå®¢é‡Œé¢æœ‰<a href="https://jungle430.github.io/posts/data-structures-and-algorithms/dynamic-programming/#longest-common-subsequence-by-dynamic-programming" target="_blank" rel="noopener noreffer">ã€ŠDynamic Programmingã€‹</a>å›å»å¤ä¹ </li>
<li>è§†é¢‘ä¸­æ–­ï¼Œä½†æ˜¯å¤§è‡´å¬å‡ºæ¥ä¼˜åŒ–çš„æ–¹æ³•ï¼Œå› ä¸ºä¸Šé¢çš„æœ€é•¿å…¬å…±å­ä¸²çš„è®¡ç®—æ˜¯<b>æœ‰ä¸€å®šé¡ºåº</b>çš„ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®—$depth$æ¯”è¾ƒæµ…çš„ï¼Œç„¶åå†ç®—$depth$æ¯”è¾ƒæµ…çš„ $\Longrightarrow$ <font color="red">æ˜¯ä¸æ˜¯å’Œä¸Šé¢çš„ç”Ÿæˆè€…ï¼Œæ¶ˆè´¹è€…é—®é¢˜æœ‰ç€ç›¸ä¼¼çš„åœ°æ–¹ï¼Ÿ</font><b>æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªæƒ³æ³•åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œåˆ©ç”¨sleepå’Œnotifyæ¥ä¿æŒç›¸å¯¹çš„ä¸€ä¸ªé¡ºåºæ¥å¯¹æˆ‘ä»¬ä¹‹å‰çš„ç®—æ³•åšä¼˜åŒ–ï¼ï¼ˆæ³¨æ„åˆ©ç”¨ä¸Šé¢çš„jobåº“ï¼‰</b></li>
<li>ç ”ç©¶è¿™é“é¢˜<a href="https://leetcode.cn/problems/building-h2o" target="_blank" rel="noopener noreffer">$H_20$ç”Ÿæˆ</a></li>
</ul>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Pause<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Pause in 2023-03-11 21:30</p>
<p>æ„Ÿè§‰è¿™èŠ‚è¯¾å†…å®¹å¥½â„¢ï¸çš„å¤šï¼Œå·²ç»ä¸æ˜¯ä»…ä»…å°±é™åˆ¶äºä¸€ä¸ªä¸€ä¸ªç®—æ³•äº†ï¼Œéš¾æ»´å¾ˆå‘ï¼ˆï¼</p>
<p>ä»Šå¤©å…ˆå¬åˆ°è¿™ç½¢ï¼Œä¸è¿‡æ”¶è·ä¹Ÿæ˜¯å¾ˆå¤šï¼Œå»å¹´cydçš„Javaä¸Šé¢è®²çš„Threadé‚£äº›ä¸œè¥¿ç»ˆäºå¼€å§‹ç†è§£äº†ï¼Œè€Œä¸æ˜¯åƒå½“æ—¶é‚£æ ·åœ¨å®¿èˆçğŸ”8ï¸âƒ£å†™ä¸€ä¸ªä¸€ä¸ªThreadï¼ˆæ€’</p>
<p>æ„Ÿè°¢<a href="https://github.com/derecknowayback" target="_blank" rel="noopener noreffer">Dereck Chen</a>æ¨èçš„ä¸¤ç¯‡æœ‰å…³<code>xv6</code>é”çš„æ–‡ç« <a href="https://zhuanlan.zhihu.com/p/352699414" target="_blank" rel="noopener noreffer">ã€ŠChapter 6: Lockingã€‹</a>å’Œ<a href="https://zhuanlan.zhihu.com/p/353400345" target="_blank" rel="noopener noreffer">ã€ŠChapter 6.5: More Tools, Examples and Deadlocksã€‹</a>ï¼Œä¸€å®šæ‰¾æ—¶é—´å¥½å¥½çœ‹</p>
<p>æ„Ÿè°¢æ´²å¸®æˆ‘æ‰¾åˆ°äº†ç”¨å°æ¹¾çº¿ä¸Š<a href="https://openai.com/blog/chatgpt" target="_blank" rel="noopener noreffer">ChatGPT</a>çš„æ–¹æ³•ï¼ˆå¤§å–œï¼Œä¹‹å‰é¦–å°”çº¿å’Œç¾å›½çº¿è¢«banäº†å¯¼è‡´åé¢éƒ½æ²¡ç”¨ä¸Šï¼ˆæ‚²</p>
</div>
        </div>
    </div>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-12 11:30</p>
<p>ğŸ‘€âœ‹ä»Šå¤©è–„çº±ä½ è¿™ç« </p>
</div>
        </div>
    </div>
<h3 id="æ¡ä»¶å˜é‡æ›´å¤æ€ªçš„ä¹ é¢˜é¢è¯•é¢˜">æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜/é¢è¯•é¢˜</h3>
<p>æœ‰ä¸‰ç§çº¿ç¨‹ï¼Œåˆ†åˆ«æ‰“å° <code>&lt;</code>, <code>&gt;</code>, å’Œ <code>_</code></p>
<ul>
<li>å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—æ‰“å°å‡ºçš„åºåˆ—æ€»æ˜¯ <code>&lt;&gt;&lt;_</code> å’Œ <code>&gt;&lt;&gt;_</code> ç»„åˆ</li>
</ul>
<hr>
<p>ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œåªè¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>æ‰“å° â€œ<code>&lt;</code>â€ çš„æ¡ä»¶ï¼Ÿ</li>
<li>æ‰“å° â€œ<code>&gt;</code>â€ çš„æ¡ä»¶ï¼Ÿ</li>
<li>æ‰“å° â€œ<code>_</code>â€ çš„æ¡ä»¶ï¼Ÿ
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/fish.c" target="_blank" rel="noopener noreffer">fish.c</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LENGTH(arr) (sizeof(arr) / sizeof(arr[0]))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">rule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">rule</span> <span class="n">rules</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">A</span><span class="p">,</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">B</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">B</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">C</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">C</span><span class="p">,</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">D</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">A</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">E</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">E</span><span class="p">,</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">F</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">F</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">D</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">D</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">,</span> <span class="n">A</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">A</span><span class="p">,</span> <span class="n">quota</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pthread_mutex_t</span> <span class="n">lk</span>   <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pthread_cond_t</span>  <span class="n">cond</span> <span class="o">=</span> <span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">next</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LENGTH</span><span class="p">(</span><span class="n">rules</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rule</span> <span class="o">*</span><span class="n">rule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">from</span> <span class="o">==</span> <span class="n">current</span> <span class="o">&amp;&amp;</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fish_before</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">next</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">quota</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// can proceed only if (next(ch) &amp;&amp; quota)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">quota</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fish_after</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">quota</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">current</span> <span class="o">=</span> <span class="n">next</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="n">roles</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;.&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;___&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fish_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">role</span> <span class="o">=</span> <span class="n">roles</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fish_before</span><span class="p">(</span><span class="n">role</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">putchar</span><span class="p">(</span><span class="n">role</span><span class="p">);</span> <span class="c1">// can be long; no lock protection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fish_after</span><span class="p">(</span><span class="n">role</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">roles</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">fish_thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¿¡å·é‡">ä¿¡å·é‡</h2>
<h3 id="å¤ä¹ äº’æ–¥é”å’Œæ›´è¡£å®¤ç®¡ç†">å¤ä¹ ï¼šäº’æ–¥é”å’Œæ›´è¡£å®¤ç®¡ç†</h3>
<p>æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜</p>
<ul>
<li>å…ˆåˆ°çš„äºº (çº¿ç¨‹)
<ul>
<li>æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†</li>
<li><code>*lk = ğŸ”’</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›</li>
</ul>
</li>
<li>ååˆ°çš„äºº (çº¿ç¨‹)
<ul>
<li>ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…</li>
<li>çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)</li>
</ul>
</li>
<li>æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)
<ul>
<li>äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ<code>*lk = âœ…</code></li>
</ul>
</li>
<li>ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„</li>
</ul>
<h3 id="æ›´è¡£å®¤ç®¡ç†">æ›´è¡£å®¤ç®¡ç†</h3>
<p>å®Œå…¨æ²¡æœ‰å¿…è¦é™åˆ¶æ‰‹ç¯çš„æ•°é‡â€”â€”è®©æ›´å¤šåŒå­¦å¯ä»¥è¿›å…¥æ›´è¡£å®¤</p>
<ul>
<li>ç®¡ç†å‘˜å¯ä»¥æŒæœ‰ä»»æ„æ•°é‡çš„æ‰‹ç¯ (æ›´è¡£å®¤å®¹é‡ä¸Šé™)
<ul>
<li>å…ˆè¿›å…¥æ›´è¡£å®¤çš„åŒå­¦å…ˆå¾—åˆ°</li>
<li>æ‰‹ç¯ç”¨å®Œåæ‰éœ€è¦ç­‰åŒå­¦å‡ºæ¥</li>
</ul>
</li>
</ul>
<h3 id="æ›´è¡£å®¤ç®¡ç†-by-ew-dijkstra">æ›´è¡£å®¤ç®¡ç† (by E.W. Dijkstra)</h3>
<p>åšä¸€ç‚¹æ‰©å±•â€”â€”çº¿ç¨‹å¯ä»¥ä»»æ„ â€œå˜å‡ºâ€ ä¸€ä¸ªæ‰‹ç¯</p>
<ul>
<li>æŠŠæ‰‹ç¯çœ‹æˆæ˜¯ä»¤ç‰Œ</li>
<li>å¾—åˆ°ä»¤ç‰Œçš„å¯ä»¥è¿›å…¥æ‰§è¡Œ</li>
<li>å¯ä»¥éšæ—¶åˆ›å»ºä»¤ç‰Œ</li>
</ul>
<a class="lightgallery" href="/img/Operating%20System/chapter6-10.gif" title="/img/Operating System/chapter6-10.gif" data-thumbnail="/img/Operating System/chapter6-10.gif">
        
    </a>
<p>â€œæ‰‹ç¯â€ = â€œä»¤ç‰Œâ€ = â€œä¸€ä¸ªèµ„æºâ€ = â€œä¿¡å·é‡â€ (semaphore)</p>
<ul>
<li>P(&amp;sem) - prolaag = try + decrease; wait; down; in
<ul>
<li>ç­‰å¾…ä¸€ä¸ªæ‰‹ç¯åè¿”å›</li>
<li>å¦‚æœæ­¤æ—¶ç®¡ç†å‘˜æ‰‹ä¸Šæœ‰ç©ºé—²çš„æ‰‹ç¯ï¼Œç«‹å³è¿”å›</li>
</ul>
</li>
<li>V(&amp;sem) - verhoog = increase; post; up; out
<ul>
<li>å˜å‡ºä¸€ä¸ªæ‰‹ç¯ï¼Œé€ç»™ç®¡ç†å‘˜</li>
</ul>
</li>
<li>ä¿¡å·é‡çš„è¡Œä¸ºå»ºæ¨¡: <a href="https://jyywiki.cn/pages/OS/2022/demos/sem.py" target="_blank" rel="noopener noreffer">sem.py</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Semaphore</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span><span class="p">,</span> <span class="n">waits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="c1"># ä»ä¸€æŠŠğŸ”‘å˜æˆäº†å¥½å¤šæŠŠğŸ”‘ï¼Œtokenç°åœ¨æ˜¯ä¸€ä¸ªè®¡æ•°å™¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">):</span> <span class="c1"># æ‹¿ğŸ”‘</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># æœ‰è¶…è¿‡ä¸€æŠŠğŸ”‘ï¼ŒğŸ”‘-1ï¼Œè‡ªå·±å¾—åˆ°äº†ä¸€æŠŠğŸ”‘</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">-=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="n">tid</span> <span class="c1"># æ²¡æœ‰ğŸ”‘å°±åªèƒ½æŠŠè‡ªå·±æ”¾åœ¨ç­‰å¾…é˜Ÿåˆ—é‡Œé¢ï¼Œç­‰åˆ°åˆ«äººæŠŠæˆ‘å”¤é†’</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># äº¤ä»˜ğŸ”‘</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># å¦‚æœæœ‰äººåœ¨ç­‰å¾…é˜Ÿåˆ—é‡Œé¢ï¼Œç›´æ¥å”¤é†’ä»–ï¼ˆä¸éœ€è¦é€šè¿‡ç®¡ç†å‘˜ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># å¦‚æœæ— äººç­‰å¾…ç›´æ¥æŠŠæ‰‹ç¯äº¤ç»™ç®¡ç†å‘˜</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="s1">&#39;1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;blue&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;green&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_both</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://github.com/Jungle430/check-for-NJU-OS/blob/main/sem.html" target="_blank" rel="noopener noreffer">model-checker</a></li>
</ul>
<h3 id="ä¿¡å·é‡å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…">ä¿¡å·é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h3>
<p>ä¿¡å·é‡è®¾è®¡çš„é‡ç‚¹</p>
<ul>
<li>è€ƒè™‘ â€œæ‰‹ç¯â€ (æ¯ä¸€å•ä½çš„ â€œ<font color="red"><b>èµ„æº</b></font>â€) æ˜¯ä»€ä¹ˆï¼Œè°åˆ›é€ ï¼Ÿè°è·å–ï¼Ÿ
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/pc-sem.c" target="_blank" rel="noopener noreffer">pc-sem.c</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">producer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span>   <span class="c1">// P()è¿”å› -&gt; å¾—åˆ°æ‰‹ç¯ ï¼ˆæ£€æµ‹åŒ…é‡Œé¢æ˜¯å¦è¿˜æœ‰ç©ºä½ï¼Œæœ‰ç©ºä½å°±åŠ å…¥ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(&#34;</span><span class="p">);</span> <span class="c1">// å‡è®¾çº¿ç¨‹å®‰å…¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fill</span><span class="p">);</span> <span class="c1">//æ‰“å°å°±å°±ç›¸å½“äºå‘åŒ…é‡Œæ”¾ä¸€ä¸ªä¸œè¥¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">consumer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fill</span><span class="p">);</span> <span class="c1">//æ£€æµ‹åŒ…é‡Œé¢æ˜¯å¦è¿˜æœ‰ä¸œè¥¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span> <span class="c1">//æŠŠåŒ…é‡Œé¢çš„ä¸€ä¸ªä¸œè¥¿ç»™åƒæ‰äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//éå¸¸å¯¹ç§°ä¼˜ç¾ï¼
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åœ¨ â€œ<font color="red"><b>ä¸€å•ä½èµ„æº</b></font>â€ æ˜ç¡®çš„é—®é¢˜ä¸Šæ›´å¥½ç”¨</li>
<li>â€å‡­ç©ºåˆ›é€ ğŸ”‘â€œè€Œä¸æ˜¯åƒä¹‹å‰é‚£æ ·ä½¿ç”¨â€é…å¯¹çš„æ‰‹ç¯â€œï¼Œç¨‹åºçš„æ­£ç¡®æ€§æ›´åŠ å±é™©ã€‚ã€‚ã€‚</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-11.png" title="/img/Operating System/chapter6-11.png" data-thumbnail="/img/Operating System/chapter6-11.png" data-sub-html="<h2>å›å»å°±ç¿»csapp</h2>">
        
    </a><figcaption class="image-caption">å›å»å°±ç¿»<code>csapp</code></figcaption>
    </figure>
<blockquote>
<p>ChatGPTç”Ÿæˆçš„ä¸€äº›ä»£ç </p>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜æ˜¯ä¸€ä¸ªç»å…¸çš„å¹¶å‘é—®é¢˜ï¼Œæè¿°äº†ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…åœ¨å…±äº«èµ„æºçš„ç¯å¢ƒä¸­çš„äº’åŠ¨ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€äº›äº§å“å¹¶å°†å®ƒä»¬æ”¾å…¥ä¸€ä¸ªå…±äº«ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…ä»å…±äº«ç¼“å†²åŒºä¸­å–å‡ºäº§å“å¹¶å°†å…¶æ¶ˆè´¹ã€‚ä¸ºäº†ç¡®ä¿ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ­£ç¡®äº’åŠ¨ï¼Œéœ€è¦ä½¿ç”¨ä¿¡å·é‡æ¥å®ç°åŒæ­¥å’Œäº’æ–¥ã€‚</p>
</blockquote>
<p>C++å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;ctime&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;semaphore.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å®šä¹‰ä¿¡å·é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">sem_t</span> <span class="n">empty</span><span class="p">,</span> <span class="n">full</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">producer</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ç­‰å¾…ç©ºç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ æ•°æ®åˆ°ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buffer</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Producer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; produced data &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, buffer size is &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å‘ä¿¡å·é‡é€šçŸ¥æœ‰æ–°æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">consumer</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ç­‰å¾…æœ‰æ•°æ®çš„ä¿¡å·é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»ç¼“å†²åŒºä¸­å–å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Consumer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; consumed data &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, buffer size is &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å‘ä¿¡å·é‡é€šçŸ¥æœ‰ç©ºç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–éšæœºç§å­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">srand</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">time</span><span class="p">(</span><span class="k">nullptr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–ä¿¡å·é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">producer1</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">producer2</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">consumer1</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">consumer2</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿è¡Œä¸€æ®µæ—¶é—´åç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é€šçŸ¥çº¿ç¨‹ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">producer1</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">producer2</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">consumer1</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">consumer2</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é”€æ¯ä¿¡å·é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sem_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sem_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter6-12.png" title="/img/Operating System/chapter6-12.png" data-thumbnail="/img/Operating System/chapter6-12.png" data-sub-html="<h2>ä¾‹å­1</h2>">
        
    </a><figcaption class="image-caption"><code>ä¾‹å­1</code></figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-13.png" title="/img/Operating System/chapter6-13.png" data-thumbnail="/img/Operating System/chapter6-13.png" data-sub-html="<h2>ä¾‹å­2</h2>">
        
    </a><figcaption class="image-caption"><code>ä¾‹å­2</code></figcaption>
    </figure>
<h2 id="å“²å­¦å®¶åƒé¥­é—®é¢˜e-w-dijkstra-1960">å“²â™‚ï¸å­¦å®¶åƒé¥­é—®é¢˜(E. W. Dijkstra, 1960)</h2>
<p>å“²å­¦å®¶ (çº¿ç¨‹) æœ‰æ—¶æ€è€ƒï¼Œæœ‰æ—¶åƒé¥­</p>
<ul>
<li><b>åƒé¥­éœ€è¦åŒæ—¶å¾—åˆ°å·¦æ‰‹å’Œå³æ‰‹çš„å‰å­</b></li>
<li>å½“å‰å­è¢«å…¶ä»–äººå æœ‰æ—¶ï¼Œå¿…é¡»ç­‰å¾…ï¼Œå¦‚ä½•å®ŒæˆåŒæ­¥ï¼Ÿ
<ul>
<li><a href="https://leetcode.cn/problems/the-dining-philosophers" target="_blank" rel="noopener noreffer">å¦‚ä½•ç”¨äº’æ–¥é”/ä¿¡å·é‡å®ç°ï¼Ÿ</a></li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter6-14.jpg" title="/img/Operating System/chapter6-14.jpg" data-thumbnail="/img/Operating System/chapter6-14.jpg" data-sub-html="<h2>å“²â™‚ï¸å­¦å®¶</h2>">
        
    </a><figcaption class="image-caption">å“²â™‚ï¸å­¦å®¶</figcaption>
    </figure>
<h3 id="å¤±è´¥ä¸æˆåŠŸçš„å°è¯•">å¤±è´¥ä¸æˆåŠŸçš„å°è¯•</h3>
<p>å¤±è´¥çš„å°è¯•</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/philosopher.c" target="_blank" rel="noopener noreffer">philosopher.c</a> (å¦‚ä½•è§£å†³ï¼Ÿ)</li>
<li>è¿™é‡Œé¢ä½¿ç”¨äº†ä¿¡å·é‡</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sem_t</span> <span class="n">locks</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tphilosopher</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">lhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">id</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span> <span class="c1">//æ‹¿å·¦è¾¹çš„å‰å­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;T%d Got %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span> <span class="c1">//æ‹¿å³è¾¹çš„å‰å­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;T%d Got %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span> <span class="c1">//æ”¾å›å·¦å‰å­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span> <span class="c1">//æ”¾å›å³å‰å­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//å°†é”åˆå§‹åŒ–ä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">SEM_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tphilosopher</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸Šé¢çš„ç¨‹åºä¼šå¡æ­»ï¼ˆéƒ½æ‹¿å·¦å‰å­çš„æ—¶å€™æ‰§è¡Œæ‹¿å³å‰å­çš„åŠ¨ä½œçš„æ—¶å€™ä¼šä¸€ç›´<code>wait</code>ç›´åˆ°æœ‰äºº<code>notify</code>å®ƒï¼Œå¯æ˜¯è¿™ä¸ªåœºæ™¯ä¸‹æ²¡äºº<code>notify</code>å®ƒ $\Longrightarrow$ ç¨‹åºæ­»é”ï¼‰</li>
</ul>
<blockquote>
<p>è¿™æ®µä»£ç å®ç°äº†ç»å…¸çš„å“²å­¦å®¶å°±é¤é—®é¢˜ï¼ˆDining Philosophers Problemï¼‰ã€‚åœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œæœ‰ $N$ ä¸ªå“²å­¦å®¶å’Œ $N$ ä¸ªå‰å­ï¼Œæ¯ä¸ªå“²å­¦å®¶éœ€è¦åŒæ—¶æ‹¿åˆ°ä¸¤ä¸ªç›¸é‚»çš„å‰å­æ‰èƒ½åƒé¥­ï¼Œä½†æ˜¯å‰å­ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªå“²å­¦å®¶æ‹¿èµ°ï¼Œå› æ­¤å½“æ‰€æœ‰å“²å­¦å®¶éƒ½æ‹¿èµ·ä¸€ä¸ªå‰å­æ—¶ï¼Œå°±ä¼šå‡ºç°æ­»é”ã€‚è¿™æ®µä»£ç ä½¿ç”¨ä¿¡å·é‡æ¥é¿å…æ­»é”ï¼Œå…·ä½“æ¥è¯´ï¼Œæ¯ä¸ªå‰å­å¯¹åº”ä¸€ä¸ªä¿¡å·é‡ï¼Œå“²å­¦å®¶å…ˆå°è¯•è·å–å·¦è¾¹çš„å‰å­ï¼Œå¦‚æœè·å–ä¸åˆ°åˆ™ç­‰å¾…ï¼Œå¦åˆ™å†å°è¯•è·å–å³è¾¹çš„å‰å­ã€‚è·å–åˆ°ä¸¤ä¸ªå‰å­åï¼Œå“²å­¦å®¶åƒå®Œåå°†ä¸¤ä¸ªå‰å­éƒ½æ”¾å›åŸå¤„ï¼Œå†æ¬¡å°è¯•è·å–å‰å­ã€‚ç”±äºæ¯ä¸ªå“²å­¦å®¶åªå…è®¸åŒæ—¶æŒæœ‰ä¸€ä¸ªå‰å­ï¼Œå› æ­¤ä¸ä¼šå‡ºç°æ­»é”ã€‚</p>
<p>åœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ <code>SEM_INIT</code> å‡½æ•°å°†æ‰€æœ‰é”åˆå§‹åŒ–ä¸º1ï¼Œè¡¨ç¤ºæ‰€æœ‰å‰å­éƒ½æ²¡æœ‰è¢«å ç”¨ã€‚ç„¶åä½¿ç”¨ <code>create</code> å‡½æ•°åˆ›å»º $N$ ä¸ªå“²å­¦å®¶çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œ <code>Tphilosopher</code> å‡½æ•°ï¼Œå³å°è¯•è·å–å‰å­ã€‚åœ¨ <code>Tphilosopher</code> å‡½æ•°ä¸­ï¼Œé¦–å…ˆè·å–å·¦è¾¹çš„å‰å­ï¼Œç„¶åè·å–å³è¾¹çš„å‰å­ï¼Œå¦‚æœä¸¤ä¸ªå‰å­éƒ½è·å–åˆ°äº†ï¼Œå°±åƒé¥­ï¼Œå¹¶å°†ä¸¤ä¸ªå‰å­éƒ½æ”¾å›åŸå¤„ï¼Œå†æ¬¡å¾ªç¯ã€‚åœ¨è·å–å’Œæ”¾å›å‰å­æ—¶ï¼Œä½¿ç”¨ <code>P</code> å’Œ <code>V</code> å‡½æ•°æ“ä½œä¿¡å·é‡ï¼Œå…¶ä¸­ <code>P</code> è¡¨ç¤ºè·å–é”ï¼Œå¦‚æœé”å·²ç»è¢«å ç”¨ï¼Œåˆ™é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ï¼›<code>V</code> è¡¨ç¤ºé‡Šæ”¾é”ï¼Œå°†é”çš„å€¼åŠ 1ï¼Œå”¤é†’ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹ã€‚</p>
<hr>
<p>ä¸Šé¢çš„ä»£ç å­˜åœ¨æ­»é”çš„é—®é¢˜ï¼ŒåŸå› æ˜¯å½“æ‰€æœ‰çš„å“²å­¦å®¶åŒæ—¶æ‹¿èµ·è‡ªå·±å·¦è¾¹çš„å‰å­åï¼Œä¼šå‘ç”Ÿæ­»é”ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œå‡è®¾å½“å‰æ‰€æœ‰çš„å“²å­¦å®¶éƒ½æ‹¿èµ·äº†è‡ªå·±å·¦è¾¹çš„å‰å­ï¼Œé‚£ä¹ˆæ¯ä¸ªå“²å­¦å®¶éƒ½åœ¨ç­‰å¾…è‡ªå·±çš„å³è¾¹çš„å‰å­è¢«é‡Šæ”¾ï¼Œä»¥ä¾¿æ‹¿èµ·å³è¾¹çš„å‰å­ã€‚ä½†æ˜¯å³è¾¹çš„å‰å­å·²ç»è¢«é‚»åº§çš„å“²å­¦å®¶æ‹¿èµ°äº†ï¼Œä»–ä»¬ä¹Ÿåœ¨ç­‰å¾…ä»–ä»¬å·¦è¾¹çš„å‰å­è¢«é‡Šæ”¾ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å“²å­¦å®¶éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥äº†æ­»é”çŠ¶æ€ã€‚</p>
<p>ä¸ºäº†é¿å…æ­»é”ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ï¼š</p>
<ol>
<li>å°†æŸä¸ªå“²å­¦å®¶çš„å·¦å³å‰å­åŒæ—¶æ‹¿èµ·æ¥ï¼Œè¿™æ ·ä»–å°±å¯ä»¥å¼€å§‹è¿›é¤äº†ï¼Œé¿å…äº†æ‰€æœ‰å“²å­¦å®¶éƒ½æ‹¿èµ·è‡ªå·±å·¦è¾¹çš„å‰å­å¯¼è‡´çš„æ­»é”ã€‚</li>
<li>æ”¹å˜æŸäº›å“²å­¦å®¶çš„æ‹¿å‰å­é¡ºåºï¼Œä¾‹å¦‚å…ˆæ‹¿å³è¾¹çš„å‰å­å†æ‹¿å·¦è¾¹çš„å‰å­ï¼Œé¿å…äº†æ‰€æœ‰å“²å­¦å®¶éƒ½æ‹¿èµ·è‡ªå·±å·¦è¾¹çš„å‰å­å¯¼è‡´çš„æ­»é”ã€‚</li>
</ol>
<p>æ¥è‡ªå¸¦çˆ¹<a href="https://openai.com/blog/chatgpt" target="_blank" rel="noopener noreffer">ChatGPT</a></p>
</blockquote>
<ul>
<li>æˆåŠŸçš„å°è¯• (ä¸‡èƒ½çš„æ–¹æ³•)</li>
<li><b>OSå“²å­¦ï¼šé€šç”¨ $&gt;$ å°èªæ˜</b>ï¼ˆâ¬›âœ‹ï¼šåˆ«è£…ğŸ…±ï¸ï¼ï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">avail</span><span class="p">[</span><span class="n">lhs</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">avail</span><span class="p">[</span><span class="n">rhs</span><span class="p">]))</span> <span class="p">{</span> <span class="c1">//å·¦å³æ‰‹çš„å‰å­éƒ½åœ¨çš„æ—¶å€™æ‰èƒ½åƒé¥­ï¼Œå¦åˆ™ç­‰ç€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">avail</span><span class="p">[</span><span class="n">lhs</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail</span><span class="p">[</span><span class="n">rhs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">//ä¸€ä¸‹å­æ‹¿ä¸¤ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">avail</span><span class="p">[</span><span class="n">lhs</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail</span><span class="p">[</span><span class="n">rhs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">//ä¸€ä¸‹å­è¿˜å›å»ä¸¤ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><font color="red">ä¸ä¸Šé¢é‚£ä¸ªå¤±è´¥çš„ä¾‹å­ç›¸æ¯”ï¼Œè¿™ä¸ªç¨‹åºé‡Œé¢çš„å“²â™‚ï¸å­¦å®¶<b>ä¸€çœ‹çœ‹å·¦å³ä¸¤è¾¹çš„å‰å­</b>ï¼Œ<b>æ‹¿å–å’Œå½’è¿˜ä¹Ÿæ˜¯æŒ‰åŒ</b>ï¼Œä¸ä¼šå†åƒå‰é¢é‚£æ ·ä¸€ä¸ªä¸€ä¸ªæ‹¿ï¼Œæœ€åé€ æˆæ­»é”çš„æƒ…å†µ</font>ã€‚</li>
</ul>
<h3 id="å¿˜äº†ä¿¡å·é‡è®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†å‰å­å§">å¿˜äº†ä¿¡å·é‡ï¼Œè®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†å‰å­å§ï¼</h3>
<p>â€œLeader/followerâ€ - ç”Ÿäº§è€…/æ¶ˆè´¹è€…</p>
<ul>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸å¸¸è§çš„è§£å†³æ€è·¯ (HDFS, &hellip;)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tphilosopher</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">send_request</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">EAT</span><span class="p">);</span> <span class="c1">//å‘waiterè¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">P</span><span class="p">(</span><span class="n">allowed</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span> <span class="c1">// waiter ä¼šæŠŠå‰å­é€’ç»™å“²å­¦å®¶ï¼ˆè¿™ä¸ªè¿‡ç¨‹éœ€è¦ç­‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">philosopher_eat</span><span class="p">();</span> <span class="c1">//å¹²é¥­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">send_request</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">DONE</span><span class="p">);</span> <span class="c1">//å‘è¯·æ±‚å½’è¿˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Twaiter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="n">receive_request</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">EAT</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">DONE</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter6-13.png" title="/img/Operating System/chapter6-13.png" data-thumbnail="/img/Operating System/chapter6-13.png" data-sub-html="<h2>å’Œä¸Šé¢çš„ä¾‹å­å¾ˆåƒï¼Œç”¨ä¸€ä¸ªæœåŠ¡å‘˜åšæ€»ç®¡ç†</h2>">
        
    </a><figcaption class="image-caption"><code>å’Œä¸Šé¢çš„ä¾‹å­å¾ˆåƒï¼Œç”¨ä¸€ä¸ªæœåŠ¡å‘˜åšæ€»ç®¡ç†</code></figcaption>
    </figure>
<ul>
<li>è¿™ä¸ªæ˜¯ä¸€ä¸ª<b>é›†ä¸­å¼ç®—æ³•</b>ï¼Œè¦æ¯”<b>åˆ†å¸ƒå¼ç®—æ³•</b>æ›´å®¹æ˜“æ•´å¯¹,<code>Twaiter</code>æ˜¯ä¸€ä¸ªè°ƒåº¦å™¨</li>
</ul>
<h3 id="å¿˜äº†é‚£äº›å¤æ‚çš„åŒæ­¥ç®—æ³•å§">å¿˜äº†é‚£äº›å¤æ‚çš„åŒæ­¥ç®—æ³•å§ï¼</h3>
<ul>
<li>
<p>ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œç®¡å‰å­çš„äººæ˜¯æ€§èƒ½ç“¶é¢ˆ</p>
<ul>
<li>
<p>ä¸€å¤§æ¡Œäººåƒé¥­ï¼Œæ¯ä¸ªäººéƒ½å«æœåŠ¡å‘˜çš„æ„Ÿè§‰</p>
</li>
<li>
<p>$Premature\ optimization\ is\ the\ root\ of\ all\ evil\ (D. E. Knuth)\newline$</p>
</li>
<li>
<p><b>ä¸æ•°æ®ç»“æ„ä¸åŒï¼ŒOSæ›´å¤šè€ƒè™‘ç°å®æƒ…å†µ</b></p>
</li>
</ul>
</li>
<li>
<p><font color="red"><b>æŠ›å¼€ workload è°ˆä¼˜åŒ–å°±æ˜¯è€æµæ°“</b></font></p>
<ul>
<li>
<p>åƒé¥­çš„æ—¶é—´é€šå¸¸è¿œè¿œå¤§äºè¯·æ±‚æœåŠ¡å‘˜çš„æ—¶é—´</p>
</li>
<li>
<p>å¦‚æœä¸€ä¸ª manager æä¸å®šï¼Œå¯ä»¥åˆ†å¤šä¸ª (fast/slow path)ï¼ˆå¤šä¸ªæœåŠ¡å‘˜+æ€»æœåŠ¡å‘˜ï¼Œæ¯ä¸ªæœåŠ¡å‘˜éƒ½æœ‰ä¸€æŠŠå‰å­ï¼‰</p>
<ul>
<li>æŠŠç³»ç»Ÿè®¾è®¡å¥½ï¼Œä½¿é›†ä¸­ç®¡ç†ä¸æˆä¸ºç“¶é¢ˆ
<ul>
<li><a href="https://www.usenix.org/conference/nsdi20/presentation/brooker" target="_blank" rel="noopener noreffer">Millions of tiny databases</a> (NSDI'20)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>å®ç°åŒæ­¥çš„æ–¹æ³•
<ul>
<li>æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ï¼›ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</li>
<li>Job queue å¯ä»¥å®ç°å‡ ä¹ä»»ä½•å¹¶è¡Œç®—æ³•</li>
</ul>
</li>
<li>ä¸è¦ â€œè‡ªä½œèªæ˜â€ è®¾è®¡ç®—æ³•ï¼Œå°å¿ƒæ±‚è¯</li>
</ul>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>END<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>in 2023-03-12 15:30</p>
<p>è¿™ç« å¥½â„¢ï¸çš„éš¾ï¼Œæ„Ÿè§‰æ˜¯æœ¬é—¨è¯¾å¬åˆ°ç›®å‰ä¸ºæ­¢é™¤äº†ç¬¬ä¸‰ç« ä»¥å¤–æœ€åƒåŠ›çš„ä¸€èŠ‚è¯¾ä¹‹ä¸€äº†ï¼Œå¯èƒ½ä¹Ÿå’Œå‰ç½®çŸ¥è¯†ç¼ºå¤±æœ‰å…³ï¼ˆæ¯•ç«Ÿä¸æ˜¯å—å¤§âœ‹ï¼‰</p>
<ul>
<li>
<p>è€Œä¸”å‘ç°æœ‰å¾ˆå¤šä¸œè¥¿è¦çœ‹äº†</p>
<ul>
<li>
<p>ã€ŠCSAPPã€‹ç¬¬12ç« </p>
</li>
<li>
<p>ã€ŠUNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹ã€‹ç¬¬15ç« ï¼ˆä¹‹å‰<a href="https://z217blog.cn" target="_blank" rel="noopener noreffer">z217</a>å­¦é•¿å°±æ¨èäº†è¿™æœ¬ä¹¦ï¼‰</p>
</li>
<li>
<p>C++å¤šçº¿ç¨‹éƒ¨åˆ†çš„æ ‡å‡†åº“ï¼Œä¸ç„¶åŠ›æ‰£çš„é¢˜åšä¸äº†ï¼Œè€Œä¸”åé¢è¿™ä¸ªè¿˜è¦ç”¨</p>
</li>
</ul>
</li>
</ul>
<p><del>æœ‰æ—¶é—´èµ¶ç´§çœ‹(bushi</del></p>
</div>
        </div>
    </div>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
]]></description>
</item>
<item>
    <title>Operating System Chapter5 å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/</link>
    <pubDate>Wed, 08 Mar 2023 17:23:11 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter5/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-08 17:30</p>
<p>ç»§ç»­çœ‹ï¼Œå¹¶å‘çœŸâ„¢ï¸ğŸ‘¨</p>
</div>
        </div>
    </div>
<h2 id="overview">Overview</h2>
<p>å¤ä¹ </p>
<ul>
<li>çŠ¶æ€æœºã€çŠ¶æ€æœºã€çŠ¶æ€æœº</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°çº¿ç¨‹äº’æ–¥ï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>è‡ªæ—‹é”çš„å®ç°</li>
<li>äº’æ–¥é”çš„å®ç°</li>
</ul>
<h2 id="å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥">å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥</h2>
<h3 id="å›é¡¾å¹¶å‘ç¼–ç¨‹">å›é¡¾ï¼šå¹¶å‘ç¼–ç¨‹</h3>
<p>ç†è§£å¹¶å‘çš„å·¥å…·</p>
<ul>
<li>çº¿ç¨‹ = äºº (å¤§è„‘èƒ½å®Œæˆå±€éƒ¨å­˜å‚¨å’Œè®¡ç®—)</li>
<li>å…±äº«å†…å­˜ = ç‰©ç†ä¸–ç•Œ (ç‰©ç†ä¸–ç•Œå¤©ç”Ÿå¹¶è¡Œ)</li>
<li>ä¸€åˆ‡éƒ½æ˜¯çŠ¶æ€æœº</li>
</ul>
<h3 id="å›é¡¾äº’æ–¥ç®—æ³•">å›é¡¾ï¼šäº’æ–¥ç®—æ³•</h3>
<p>äº’æ–¥ (mutual exclusion)ï¼Œâ€œäº’ç›¸æ’æ–¥â€</p>
<ul>
<li>å®ç° <code>lock_t</code> æ•°æ®ç»“æ„å’Œ <code>lock/unlock</code> API:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">lock_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>ä¸€æŠŠ â€œæ’ä»–æ€§â€ çš„é”â€”â€”å¯¹äºé”å¯¹è±¡ <code>lk</code></p>
<ul>
<li>å¦‚æœæŸä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹çš„ <code>lock</code> ä¸èƒ½è¿”å›</li>
</ul>
<h3 id="åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥">åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥</h3>
<p>å¤±è´¥çš„å°è¯•</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/mutex-bad.py" target="_blank" rel="noopener noreffer">mutex-bad.py</a></li>
</ul>
<hr>
<p>(éƒ¨åˆ†) æˆåŠŸçš„å°è¯•</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a></li>
</ul>
<hr>
<p>å®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾ï¼šä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜</p>
<ul>
<li>load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œåªèƒ½ â€œçœ‹ä¸€çœ¼å°±æŠŠçœ¼ç›é—­ä¸Šâ€
<ul>
<li>çœ‹åˆ°çš„ä¸œè¥¿é©¬ä¸Šå°±è¿‡æ—¶äº†</li>
</ul>
</li>
<li>store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œåªèƒ½ â€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€
<ul>
<li>ä¹Ÿä¸çŸ¥é“æŠŠä»€ä¹ˆæ”¹æˆäº†ä»€ä¹ˆ</li>
</ul>
</li>
<li>è¿™æ˜¯<del>ç®€å•ã€ç²—æš´ (ç¨³å®š)ã€æœ‰æ•ˆ</del>çš„ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾</li>
</ul>
<h2 id="è‡ªæ—‹é”-spin-lock">è‡ªæ—‹é” (Spin Lock)</h2>
<h3 id="è§£å†³é—®é¢˜çš„ä¸¤ç§æ–¹æ³•">è§£å†³é—®é¢˜çš„ä¸¤ç§æ–¹æ³•</h3>
<blockquote>
<p>æå‡ºç®—æ³•ã€è§£å†³é—®é¢˜ (Dekker/Peterson/&hellip;&rsquo;s Protocols)</p>
</blockquote>
<p>æˆ–è€…â€¦â€¦</p>
<blockquote>
<p>æ”¹å˜å‡è®¾ (è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘$\Longrightarrow$ x86æ¶æ„çš„é£æ ¼ï¼Œè½¯ä»¶æŒ‡ä»¤åšä¸å¥½ç›´æ¥å†™ä¸€ä¸ªæŒ‡ä»¤é›†è®©ç¡¬ä»¶è¿™ä¹ˆåšhhh)</p>
</blockquote>
<hr>
<p>å‡è®¾ç¡¬ä»¶èƒ½ä¸ºæˆ‘ä»¬æä¾›ä¸€æ¡ â€œç¬é—´å®Œæˆâ€ çš„è¯» + å†™æŒ‡ä»¤</p>
<ul>
<li>è¯·æ‰€æœ‰äººé—­ä¸Šçœ¼ç›ï¼Œçœ‹ä¸€çœ¼ (load)ï¼Œç„¶åè´´ä¸Šæ ‡ç­¾ (store)
<ul>
<li>å¦‚æœå¤šäººåŒæ—¶è¯·æ±‚ï¼Œç¡¬ä»¶é€‰å‡ºä¸€ä¸ª â€œèƒœè€…â€</li>
<li>â€œè´¥è€…â€ è¦ç­‰ â€œèƒœè€…â€ å®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œ</li>
</ul>
</li>
</ul>
<h3 id="x86-åŸå­æ“ä½œlock-æŒ‡ä»¤å‰ç¼€">x86 åŸå­æ“ä½œï¼š<code>LOCK</code> æŒ‡ä»¤å‰ç¼€</h3>
<p>ä¾‹å­ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/sum-atomic.c" target="_blank" rel="noopener noreffer"><code>sum-atomic.c</code></a></p>
<ul>
<li><code>sum = 200000000</code></li>
</ul>
<hr>
<p>Atomic exchange (load + store)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">xchg</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&#34;lock xchg %0, %1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="s">&#34;+m&#34;</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">),</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">(</span><span class="n">newval</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><b>é‡ç‚¹å°±æ˜¯asmå†…è”æ±‡ç¼–é‚£å¥ï¼Œè¿™é‡Œæ˜¯â€œä¸€æ°”å‘µæˆâ€çš„</b></p>
</li>
<li>
<p>æ›´å¤šçš„åŸå­æŒ‡ä»¤ï¼š<a href="https://en.cppreference.com/w/cpp/header/stdatomic.h" target="_blank" rel="noopener noreffer">stdatomic.h</a> (C11)</p>
</li>
</ul>
<h3 id="ç”¨-xchg-å®ç°äº’æ–¥ä¹Ÿå°±æ˜¯è‡ªæ—‹é”çš„æœ¬è´¨å®ç°è¿‡ç¨‹">ç”¨ <code>xchg</code> å®ç°äº’æ–¥ï¼ˆä¹Ÿå°±æ˜¯è‡ªæ—‹é”çš„æœ¬è´¨å®ç°è¿‡ç¨‹ï¼‰</h3>
<ul>
<li>xchgåœ¨ä¹‹å‰çš„<a href="https://jungle430.github.io/posts/operating-system/support2" target="_blank" rel="noopener noreffer">æ–‡ç« </a>ä¸­æœ‰æåˆ°è¿‡</li>
</ul>
<p>å¦‚ä½•åè°ƒå®¿èˆè‹¥å¹²ä½åŒå­¦ä¸Šå•æ‰€é—®é¢˜ï¼Ÿ</p>
<ul>
<li>åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­ (å…±äº«å˜é‡)
<ul>
<li>åˆå§‹æ—¶ï¼Œæ¡Œä¸Šæ˜¯ ğŸ”‘</li>
</ul>
</li>
</ul>
<hr>
<p>å®ç°äº’æ–¥çš„åè®®</p>
<ul>
<li>æƒ³ä¸Šå•æ‰€çš„åŒå­¦ (ä¸€æ¡ xchg æŒ‡ä»¤)
<ul>
<li>å¤©é»‘è¯·é—­çœ¼</li>
<li>çœ‹ä¸€çœ¼æ¡Œå­ä¸Šæœ‰ä»€ä¹ˆ (ğŸ”‘ æˆ– ğŸ”)</li>
<li>æŠŠ ğŸ” æ”¾åˆ°æ¡Œä¸Š (è¦†ç›–ä¹‹å‰æœ‰çš„ä»»ä½•ä¸œè¥¿)</li>
<li>å¤©äº®è¯·ççœ¼ï¼›çœ‹åˆ° ğŸ”‘ æ‰å¯ä»¥è¿›å•æ‰€å“¦</li>
</ul>
</li>
<li>å‡ºå•æ‰€çš„åŒå­¦
<ul>
<li>æŠŠ ğŸ”‘ æ”¾åˆ°æ¡Œä¸Š</li>
</ul>
</li>
</ul>
<h3 id="å®ç°äº’æ–¥è‡ªæ—‹é”">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">table</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">got</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">,</span> <span class="n">NOPE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">NOPE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">YES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">,</span> <span class="n">YES</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">lock</span><span class="p">()</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unlock</span><span class="p">()</span> <span class="p">{</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é‡è¦çš„è¿˜æ˜¯xchgè¿™ä¸ªä¸œè¥¿ï¼Œä¿è¯é‚£ä¸€æ­¥æ˜¯åŸå­æ€§çš„ï¼Œå°±æ²¡æœ‰å…¶ä»–äº‹æƒ…äº†</li>
</ul>
<h3 id="å®ç°äº’æ–¥è‡ªæ—‹é”-contd">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é” (cont&rsquo;d)</h3>
<p>å¹¶å‘ç¼–ç¨‹ï¼šåƒä¸‡å°å¿ƒ</p>
<ul>
<li>åšè¯¦å°½çš„æµ‹è¯• (åœ¨æ­¤çœç•¥ï¼Œä½ ä»¬åš Labs å°±çŸ¥é“äº†)</li>
<li>å°½å¯èƒ½åœ°è¯æ˜ (<a href="https://jyywiki.cn/pages/OS/2022/demos/model-checker.py" target="_blank" rel="noopener noreffer">model-checker.py</a> å’Œ <a href="https://jyywiki.cn/pages/OS/2022/demos/spinlock.py" target="_blank" rel="noopener noreffer">spinlock.py</a>)</li>
</ul>
<hr>
<p>åŸå­æŒ‡ä»¤çš„æ¨¡å‹</p>
<ul>
<li>ä¿è¯ä¹‹å‰çš„ store éƒ½å†™å…¥å†…å­˜</li>
<li>ä¿è¯ load/store ä¸ä¸åŸå­æŒ‡ä»¤ä¹±åº</li>
</ul>
<h3 id="åŸå­æŒ‡ä»¤çš„è¯ç”Ÿbus-lock-80486">åŸå­æŒ‡ä»¤çš„è¯ç”Ÿï¼šBus Lock (80486)</h3>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-09 10:00</p>
<p>æ—©èµ·å¼€å®ŒSBå¤§ä¼šï¼Œâœ‹æ¥ç€çœ‹</p>
<p>å’–å•¡æœºé‡Œé¢çš„å’–å•¡çœŸæç¥ï¼Œä¼°è®¡ä¸‹åˆæ¯›æ¦‚å¾—ç‹ ç‹ ç¡ä¸€æŠŠ</p>
</div>
        </div>
    </div>
<ul>
<li>486 (20-50MHz) å°±æ”¯æŒ <code>dual-socket</code> äº†</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter5-1.jpg" title="/img/Operating System/chapter5-1.jpg" data-thumbnail="/img/Operating System/chapter5-1.jpg" data-sub-html="<h2>80486</h2>">
        
    </a><figcaption class="image-caption">80486</figcaption>
    </figure>
<div class="mermaid" id="id-1"></div>
<ul>
<li>
<p>å¦‚æœCPU1éœ€è¦æ‰§è¡Œ<code>add x, 1</code>ï¼Œé‚£ä¹ˆéœ€è¦åˆ†æˆ3æ­¥</p>
<ul>
<li>ä»memoryé‡Œé¢load</li>
<li>å†æŠŠè¿™ä¸ªå€¼add 1ä¹‹åå…ˆæ”¾å…¥ä¸€ä¸ªå†…éƒ¨çš„å¯„å­˜å™¨é‡Œ</li>
<li>å†storeæŠŠmçš„å€¼å†™å›å†…å­˜é‡Œ</li>
</ul>
</li>
<li>
<p>ä¸ºä»€ä¹ˆ486æ—¶ä»£ä¼šè¯ç”Ÿ<b>LOCK</b>è¿™æ ·çš„æŒ‡ä»¤å‘¢ï¼Ÿ</p>
<ul>
<li>å› ä¸ºæ¶‰åŠäº†ä¸¤ä¸ªCPUé¢å¯¹åŒä¸€ä¸ªmemoryçš„çŠ¶å†µï¼Œæ‰€ä»¥éœ€è¦å¯¹memoryè¿›è¡Œlockçš„æ“ä½œ</li>
</ul>
</li>
<li>
<p>è®¾è®¡æ–¹æ³•</p>
<ul>
<li>x86çš„æŒ‡ä»¤é›†æœ‰æŒ‡ä»¤çš„å‰ç¼€ï¼ˆæ¯”å¦‚<code>rep</code>ï¼‰ï¼Œæˆ‘ä»¬è®©<code>lock</code>ä¹Ÿå˜æˆä¸€ä¸ª<b>æŒ‡ä»¤å‰ç¼€</b></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lock + |æŒ‡ä»¤|
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><u>å½“CPUå¼€å§‹è¯»æŒ‡ä»¤çš„æ—¶å€™ï¼Œå®ƒä¼šå…ˆè¯»åˆ°lockæŒ‡ä»¤ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸Šé”ï¼ˆä¹Ÿå³æ˜¯å¯¹åº”çš„CPUæ‹¿åˆ°äº†æ€»çº¿çš„é”ï¼‰</u></li>
<li><u>ç­‰åˆ°CPUæ‹¿åˆ°æ€»çº¿çš„é”ä¹‹åï¼Œå®ƒä¼šå†æ‰§è¡Œåé¢çš„éƒ¨åˆ†</u></li>
<li><u>æŠŠæœ‰å…³æŒ‡ä»¤æ‰§è¡Œå®Œæˆä¹‹åå†æŠŠé”é‡Šæ”¾æ‰</u></li>
</ul>
<h4 id="è´Ÿæ‹…">è´Ÿæ‹…</h4>
<ul>
<li><b>ä»Šå¤©çš„CPUä¸memoryä¹‹é—´éƒ½æœ‰å„è‡ªçš„cacheï¼Œè€Œä¸”cacheå·²ç»å’ŒCPUé›†æˆåœ¨ä¸€ä¸ªå…ƒä»¶ä¸Šé¢äº†ï¼Œè€Œä¸”æ˜¯å¤šçº§cache</b></li>
<li><b>486æ—¶ä»£ä»…ä»…åªæœ‰å¤–é¢çš„ä¸€å—cacheï¼ˆè€Œä¸”è¿™å—cacheåœ¨ä¸»æ¿ä¸Šï¼‰ï¼Œæ‰€ä»¥è¯´åªè¦CPUæ‹¿åˆ°äº†æ€»çº¿ğŸ”’çš„æ§åˆ¶æƒï¼Œå°±æŠŠè‡ªå·±å’Œå¤–é¢çš„ä¸€åˆ‡éš”ç¦»å¼€äº†</b></li>
</ul>
<div class="mermaid" id="id-2"></div>
<ul>
<li>
<p><b>å¤šçº§cacheä¼šä½¿å¾—lockå˜å¾—å¾ˆéº»çƒ¦</b></p>
</li>
<li>
<p>ä¾‹å­ï¼šä¸€ä¸ªæ•°æ®åœ¨ä¸¤ä¸ªCPUçš„cacheé‡Œé¢éƒ½æœ‰å‰¯æœ¬</p>
</li>
</ul>
<div class="mermaid" id="id-3"></div>
<ul>
<li><b>è¿™ä¸ªæ—¶å€™å¦‚æœCPU1è¦lockè®¿é—®mçš„è¯ï¼Œå°±è¦å°†cache21é‡Œé¢çš„må‰¯æœ¬â€œè¸¢æ‰â€</b> $\Longrightarrow$ ä¹Ÿå°±æ˜¯ä»Šå¤©interä¸€ä¸ªå¾ˆå¤§çš„å†å²åŒ…è¢±ï¼šç¼“å­˜çš„ä¸€è‡´æ€§ $\Longrightarrow$ è§£å†³æ–¹æ¡ˆï¼šå°†æ‰€æœ‰çš„cacheç”¨æ€»çº¿è¿æ¥èµ·æ¥</li>
</ul>
<div class="mermaid" id="id-4"></div>
<ul>
<li>ä¸€æ—¦å…¶ä¸­æœ‰ä¸€ä¸ªæ•°æ®éœ€è¦è¢«lockï¼Œé‚£ä¹ˆæ€»çº¿éœ€è¦éå†ä¸€éæ‰€æœ‰CPUçš„cacheï¼Œå¦‚æœå‘ç°äº†è¯¥æ•°æ®çš„å‰¯æœ¬ï¼Œå°±è¦å°†è¯¥æ•°æ®ä»å…¶ä»–CPUçš„cacheé‡Œé¢â€œè¸¢æ‰â€ï¼Œ<b>è¿™æ˜¯å¾ˆæµªè´¹æ—¶é—´çš„</b></li>
</ul>
<h3 id="lock-æŒ‡ä»¤çš„ç°ä»£å®ç°">Lock æŒ‡ä»¤çš„ç°ä»£å®ç°</h3>
<p>åœ¨ L1 cache å±‚ä¿æŒä¸€è‡´æ€§ (ring/mesh bus)</p>
<ul>
<li>ç›¸å½“äºæ¯ä¸ª cache line æœ‰åˆ†åˆ«çš„é”</li>
<li>store(x) è¿›å…¥ L1 ç¼“å­˜å³ä¿è¯å¯¹å…¶ä»–å¤„ç†å™¨å¯è§
<ul>
<li>ä½†è¦å°å¿ƒ store buffer å’Œä¹±åºæ‰§è¡Œ</li>
</ul>
</li>
</ul>
<hr>
<p>L1 cache line æ ¹æ®çŠ¶æ€è¿›è¡Œåè°ƒ</p>
<ul>
<li>M (Modified), è„å€¼</li>
<li>E (Exclusive), ç‹¬å è®¿é—®</li>
<li>S (Shared), åªè¯»å…±äº«</li>
<li>I (Invalid), ä¸æ‹¥æœ‰ cache line</li>
</ul>
<h3 id="risc-v-å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡">RISC-V: å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡</h3>
<p>è€ƒè™‘å¸¸è§çš„åŸå­æ“ä½œï¼š</p>
<ul>
<li>atomic test-and-set
<ul>
<li><code>reg = load(x); if (reg == XX) { store(x, YY); }</code></li>
</ul>
</li>
<li>lock xchg
<ul>
<li><code>reg = load(x); store(x, XX);</code></li>
</ul>
</li>
<li>lock add
<ul>
<li><code>t = load(x); t++; store(x, t);</code></li>
</ul>
</li>
</ul>
<hr>
<p><b>å®ƒä»¬çš„æœ¬è´¨éƒ½æ˜¯</b></p>
<ol>
<li>load</li>
<li>exec (å¤„ç†å™¨æœ¬åœ°å¯„å­˜å™¨çš„è¿ç®—)</li>
<li>store</li>
</ol>
<h3 id="load-reservedstore-conditional-lrsc">Load-Reserved/Store-Conditional (LR/SC)</h3>
<ul>
<li>LR: åœ¨å†…å­˜ä¸Šæ ‡è®° reserved (ç›¯ä¸Šä½ äº†)ï¼Œä¸­æ–­ã€å…¶ä»–å¤„ç†å™¨å†™å…¥éƒ½ä¼šå¯¼è‡´æ ‡è®°æ¶ˆé™¤
<ul>
<li><b>æˆ‘å…ˆè¯»ï¼Œè¯»å®Œä¹‹ååœ¨è¿™ä¸ªç‰©å“ä¸Šé¢åšä¸€ä¸ªæ ‡è®°</b></li>
<li><b>æ ‡è®°ä¸€ç›´åœ¨ç‰©å“ä¸Šï¼ŒåŒæ—¶åœ¨åšæœ¬åœ°çš„è®¡ç®—</b></li>
<li><b>æœ¬åœ°è®¡ç®—ç®—å®Œäº†ï¼Œè¯¥å†™äº†</b></li>
<li><b>å†™çš„æ—¶å€™è¦å…ˆæ£€æµ‹æ ‡è®°ï¼Œåªæœ‰æ ‡è®°è¿˜åœ¨çš„æ—¶å€™æ‰å¯ä»¥å†™ï¼Œå¦åˆ™è¿”å›failï¼Œåªèƒ½å†æ¬¡å°è¯•é‡æ–°ä¸Šé”å†™å…¥</b></li>
</ul>
</li>
<li><u>æœ¬åœ°å†…å­˜çš„è®¡ç®—ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯<b>å…±äº«å†…å­˜çš„è®¡ç®—</b></u></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lr.w rd, (rs1)
</span></span><span class="line"><span class="cl">  rd = M[rs1]
</span></span><span class="line"><span class="cl">  reserve M[rs1]
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<ul>
<li>SC: å¦‚æœ â€œç›¯ä¸Šâ€ æœªè¢«è§£é™¤ï¼Œåˆ™å†™å…¥</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sc.w rd, rs2, (rs1)
</span></span><span class="line"><span class="cl">  if still reserved:
</span></span><span class="line"><span class="cl">    M[rs1] = rs2
</span></span><span class="line"><span class="cl">    rd = 0
</span></span><span class="line"><span class="cl">  else:
</span></span><span class="line"><span class="cl">    rd = nonzero
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="compare-and-swap-çš„-lrsc-å®ç°">Compare-and-Swap çš„ LR/SC å®ç°</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">cas</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmp_val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">old_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">old_val</span> <span class="o">==</span> <span class="n">cmp_val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">;</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cas:
</span></span><span class="line"><span class="cl">  lr.w  t0, (a0)       # Load original value.
</span></span><span class="line"><span class="cl">  bne   t0, a1, fail   # Doesnâ€™t match, so fail.
</span></span><span class="line"><span class="cl">  sc.w  t0, a2, (a0)   # Try to update.
</span></span><span class="line"><span class="cl">  bnez  t0, cas        # Retry if store-conditional failed.
</span></span><span class="line"><span class="cl">  li a0, 0             # Set return to success.
</span></span><span class="line"><span class="cl">  jr ra                # Return.
</span></span><span class="line"><span class="cl">fail:
</span></span><span class="line"><span class="cl">  li a0, 1             # Set return to failure.
</span></span><span class="line"><span class="cl">  jr ra                # Return
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>lrï¼Œscè¿˜å¯ä»¥æ£€æµ‹ğŸ”’çš„æ‹¥å µç¨‹åº¦</li>
</ul>
<h4 id="lrsc-çš„ç¡¬ä»¶å®ç°">LR/SC çš„ç¡¬ä»¶å®ç°</h4>
<ul>
<li>
<p>BOOM (Berkeley Out-of-Order Processor)</p>
</li>
<li>
<p><a href="https://github.com/riscv-boom/riscv-boom" target="_blank" rel="noopener noreffer">riscv-boom</a></p>
</li>
<li>
<p><a href="https://github.com/riscv-boom/riscv-boom/blob/master/src/main/scala/lsu/dcache.scala#L655" target="_blank" rel="noopener noreffer">lsu/dcache.scala</a></p>
</li>
<li>
<p>ç•™æ„s2_sc_failçš„æ¡ä»¶</p>
<ul>
<li>s2 æ˜¯æµæ°´çº¿ Stage 2</li>
</ul>
</li>
<li>
<p>(yzh æ‰’å‡ºçš„ä»£ç )</p>
</li>
</ul>
<h2 id="äº’æ–¥é”-mutex-lock">äº’æ–¥é” (Mutex Lock)</h2>
<h3 id="è‡ªæ—‹é”çš„ç¼ºé™·">è‡ªæ—‹é”çš„ç¼ºé™·</h3>
<ul>
<li>
<p>æ€§èƒ½é—®é¢˜ (0)</p>
<ul>
<li>è‡ªæ—‹ (å…±äº«å˜é‡) ä¼šè§¦å‘<b>å¤„ç†å™¨é—´çš„ç¼“å­˜åŒæ­¥ï¼Œå»¶è¿Ÿå¢åŠ ï¼ˆæ€»çº¿éå†cacheè¸¢å‰¯æœ¬ï¼‰</b></li>
</ul>
</li>
<li>
<p>æ€§èƒ½é—®é¢˜ (1)</p>
<ul>
<li>
<p>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨ç©ºè½¬<b>ï¼ˆçœ‹è‡ªæ—‹é”çš„å®ç°ä»£ç ï¼Œæ²¡æœ‰æ‹¿åˆ°ğŸ”’çš„çº¿ç¨‹åœ¨ç©ºè½¬æ­»å¾ªç¯ï¼‰</b></p>
<ul>
<li>ä¼šé€ æˆå¤šCPUæœºå™¨åˆ©ç”¨ç‡è¿‡ä½çš„é—®é¢˜ï¼ˆå°±æœ‰ğŸ”’çš„åœ¨å·¥ä½œï¼‰</li>
</ul>
</li>
<li>
<p><b>äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½</b></p>
</li>
</ul>
</li>
<li>
<p>æ€§èƒ½é—®é¢˜ (2)</p>
<ul>
<li>è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹<b>å¯èƒ½è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»ï¼ˆå‡ºç°åœ¨å•CPUæ—¶é—´ç‰‡è½®è½¬çš„æ¡ä»¶ä¸‹ï¼Œè½®è½¬æ—¶é—´ç‰‡å¯¼è‡´æ‹¿ğŸ”’çš„çº¿ç¨‹ä¼‘çœ ï¼Œç›¸å½“äºä½ æ‹¿ç€ğŸ”’å›å®¿èˆç¡è§‰ï¼Œå…¨æ•™å®¤çš„äººåªèƒ½ç­‰ç€ä½  $\Longrightarrow$ è¿˜åœ¨æ­»å¾ªç¯é‡Œé¢ç©ºè½¬ï¼‰</b>
<ul>
<li>æ“ä½œç³»ç»Ÿä¸ â€œæ„ŸçŸ¥â€ çº¿ç¨‹åœ¨åšä»€ä¹ˆ</li>
<li>(ä½†ä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ) $\Longrightarrow$ è¯¾åæ€è€ƒ</li>
</ul>
</li>
</ul>
</li>
<li>
<p><b>å®ç° 100% çš„èµ„æºæµªè´¹</b></p>
</li>
</ul>
<div class="mermaid" id="id-5"></div>
<h3 id="scalability-æ€§èƒ½çš„æ–°ç»´åº¦">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</h3>
<blockquote>
<p><u>åŒä¸€ä»½è®¡ç®—ä»»åŠ¡ï¼Œæ—¶é—´ (CPU cycles) å’Œç©ºé—´ (mapped memory) ä¼šéšå¤„ç†å™¨æ•°é‡çš„å¢é•¿è€Œå˜åŒ–</u>ã€‚</p>
<p><b>æ³¨æ„å’Œæ•°æ®ç»“æ„é‡Œé¢çš„è®¡ç®—æ•°æ®é‡nåŒºåˆ«ï¼Œè¿™é‡Œé¢è¡¡é‡çš„æ ‡å‡†æ˜¯ä¾æ®å¤„ç†å™¨çš„æ•°é‡è€Œå®šçš„</b></p>
</blockquote>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/sum-scalability.c" target="_blank" rel="noopener noreffer">sum-scalability.c</a>ï¼Œ<a href="https://jyywiki.cn/pages/OS/2022/demos/stat.py" target="_blank" rel="noopener noreffer">stat.py</a></li>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/thread-sync.h" target="_blank" rel="noopener noreffer">thread-sync.h</a></li>
<li>ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾
<ul>
<li>CPU åŠ¨æ€åŠŸè€—ï¼ˆæ•£çƒ­è·Ÿä¸ä¸Šåªèƒ½åšä¸€å³°âŒšçœŸğŸ‘¨ï¼ˆæ‚² ï¼‰</li>
<li>ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹</li>
<li>â€¦â€¦</li>
</ul>
</li>
<li><a href="https://www.cse.unsw.edu.au/~gernot/benchmarking-crimes.html" target="_blank" rel="noopener noreffer">Benchmarking crimes</a></li>
</ul>
<p>sum-scalability.cï¼Œé‡Œé¢ç”¨çš„å°±æ˜¯<b>è‡ªæ—‹é”</b>ï¼Œåœ¨è‡ªæ—‹é”çš„ä¿æŠ¤ä¸‹æ‰§è¡Œsum++</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread-sync.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 10000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">spinlock_t</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">SPIN_INIT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">n</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sum</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nthread</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">nthread</span><span class="p">;</span> <span class="c1">//nthreadæ˜¯çº¿ç¨‹æ•°é‡ï¼Œnå°±æ˜¯å¹³æ‘Šä¸‹æ¥æ¯ä¸ªçº¿ç¨‹è¦æ‰§è¡Œçš„sum++ï¼ˆä¹Ÿå°±æ˜¯ğŸ”’ï¼‰çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nthread</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">sum</span> <span class="o">==</span> <span class="n">n</span> <span class="o">*</span> <span class="n">nthread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡ªæ—‹é”çš„å®ç°(æ¥è‡ª<code>thread-sync.h</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">spin_lock</span><span class="p">(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">intptr_t</span> <span class="n">value</span> <span class="o">=</span> <span class="n">atomic_xchg</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">spin_unlock</span><span class="p">(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomic_xchg</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-09 15:20</p>
<p>ç»·ä¸ä½ç›´æ¥ğŸ˜ªäº†ï¼Œç¡é†’ç»§ç»­</p>
</div>
        </div>
    </div>
<ul>
<li>è¿è¡Œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc sum-scalability.c -O2 -lpthread
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:25:37 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.043s
</span></span><span class="line"><span class="cl">user    0m0.016s
</span></span><span class="line"><span class="cl">sys     0m0.021s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:25:40 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.229s
</span></span><span class="line"><span class="cl">user    0m0.337s
</span></span><span class="line"><span class="cl">sys     0m0.071s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:25:44 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.337s
</span></span><span class="line"><span class="cl">user    0m0.393s
</span></span><span class="line"><span class="cl">sys     0m0.166s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:26:21 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m1.316s
</span></span><span class="line"><span class="cl">user    0m2.176s
</span></span><span class="line"><span class="cl">sys     0m0.288s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 15:26:35 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m1.230s
</span></span><span class="line"><span class="cl">user    0m2.040s
</span></span><span class="line"><span class="cl">sys     0m0.255s
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç°è±¡ï¼š<b>åŒæ ·çš„å·¥ä½œé‡ï¼Œçº¿ç¨‹è¶Šå¤šï¼Œæ•ˆç‡è¶Šä½</b></li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter5-2.jpg" title="/img/Operating System/chapter5-2.jpg" data-thumbnail="/img/Operating System/chapter5-2.jpg" data-sub-html="<h2>å›¾åƒ</h2>">
        
    </a><figcaption class="image-caption">å›¾åƒ</figcaption>
    </figure>
<h3 id="è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</h3>
<ul>
<li><b>ä¸¤ä¸ªé‡è¦çš„çº¦æŸ</b>
<ul>
<li>ä¸´ç•ŒåŒºå‡ ä¹ä¸â€œæ‹¥å µâ€$\Longrightarrow$ <b>å‡ ä¹å°±åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒº</b> $\Longrightarrow$ è¿™æ ·äº‰æŠ¢ğŸ”’çš„çŠ¶å†µå°±ä¼šå¾ˆå°‘</li>
<li>æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢ $\Longrightarrow$ ç¿»è¯‘æˆä¸Šé¢çš„äººè¯å°±æ˜¯ç¦æ­¢æ‹¿ç€ğŸ”’å›å®¿èˆğŸ˜´ $\Longrightarrow$ <b>ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯åšä¸åˆ°è¿™ä¸€ç‚¹çš„ï¼ˆå¦‚æœåº”ç”¨ç¨‹åºèƒ½å¤Ÿé˜²æ­¢è‡ªå·±åœ¨æ—¶é—´ç‰‡è½®è½¬çš„æ—¶å€™è¢«åˆ‡å‡ºå»ï¼Œé‚£ä¹ˆä¸€ä¸ªwhile(1);å°±èƒ½è®©ç”µè„‘å´©æºƒï¼Œæ“ä½œç³»ç»Ÿæ˜¯ç»å¯¹ç¦æ­¢è¿™æ ·çš„äº‹æƒ…çš„ï¼‰</b></li>
</ul>
</li>
</ul>
<h4 id="ä½¿ç”¨åœºæ™¯æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„-çŸ­ä¸´ç•ŒåŒº">ä½¿ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)</h4>
<ul>
<li><b>æ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å </b> $\Longrightarrow$ è¿™å°±æ˜¯å’Œåº”ç”¨ç¨‹åºä¸ä¸€æ ·çš„åœ°æ–¹
<ul>
<li>ä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”</li>
</ul>
</li>
<li>(å¦‚æœæ˜¯è™šæ‹Ÿæœºå‘¢&hellip;ğŸ˜‚)
<ul>
<li>PAUSE æŒ‡ä»¤ä¼šè§¦å‘ VM Exit $\Longrightarrow$ é˜²æ­¢æœ‰æ•…éšœæŠŠç‰©ç†æœºç»™å¡æ­»</li>
</ul>
</li>
<li>ä½†ä¾æ—§å¾ˆéš¾åšå¥½
<ul>
<li><a href="https://www.usenix.org/conference/osdi10/analysis-linux-scalability-many-cores" target="_blank" rel="noopener noreffer">An analysis of Linux scalability to many cores</a> (OSDI'10) ï¼ˆ10å¹´paperï¼Œåæ§½Linuxå†…æ ¸çš„è‡ªæ—‹é”æœ‰å¤šçƒ‚ï¼‰</li>
</ul>
</li>
</ul>
<h3 id="å®ç°çº¿ç¨‹--é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</h3>
<blockquote>
<p>ä½œä¸šé‚£ä¹ˆå¤šï¼Œä¸å…¶å¹²ç­‰ Online Judge å‘å¸ƒï¼Œä¸å¦‚æŠŠè‡ªå·± (CPU) è®©ç»™å…¶ä»–ä½œä¸š (çº¿ç¨‹) æ‰§è¡Œï¼Ÿ</p>
<p><u>è¯´ç™½äº†å°±æ˜¯æœ‰äº‹æƒ…å¡ä½äº†å°±å»å¹²åˆ«çš„ï¼Œåˆ«å°±çğŸ”8ï¸âƒ£å¹²ç­‰ç€è¿™ä¸€ä»¶äº‹ï¼ˆè¿™ä¹Ÿå°±æ˜¯æ¯”è‡ªæ—‹é”é«˜æ˜çš„åœ°æ–¹ï¼‰</u></p>
</blockquote>
<p>â€œè®©â€ ä¸æ˜¯ C è¯­è¨€ä»£ç å¯ä»¥åšåˆ°çš„ (C ä»£ç åªèƒ½è®¡ç®—)</p>
<ul>
<li>
<p>æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œå°±å¥½å•¦ï¼$\Longrightarrow$ ç³»ç»Ÿè°ƒç”¨</p>
<ul>
<li>
<p><code>syscall(SYSCALL_lock, &amp;lk);</code></p>
<ul>
<li><b>è¯•å›¾è·å¾— <code>lk</code>ï¼Œä½†å¦‚æœå¤±è´¥ï¼Œ<u>å°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹</u>Â $\Longrightarrow$ è¿™ä¸ªå°±æ˜¯ç²¾é«“</b></li>
</ul>
</li>
<li>
<p><code>syscall(SYSCALL_unlock, &amp;lk);</code></p>
<ul>
<li><b>é‡Šæ”¾ <code>lk</code>ï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’</b></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-09 19:15</p>
<p>å¹²æ‹Œé¢åƒå®ŒçœŸæ’‘çš„æ…Œï¼Œä¸‹å›è¿˜æ˜¯åƒæ±¤é¢</p>
<p>æ™šä¸Šçœ‹å®Œ</p>
</div>
        </div>
    </div>
<h3 id="å®ç°çº¿ç¨‹--é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥-contd">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (cont&rsquo;d)</h3>
<ul>
<li>
<p><b>æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜</b></p>
</li>
<li>
<p>å…ˆåˆ°çš„äºº (çº¿ç¨‹)</p>
<ul>
<li>æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†</li>
<li><code>*lock = ğŸ”’</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›</li>
</ul>
</li>
<li>
<p>ååˆ°çš„äºº (çº¿ç¨‹)</p>
<ul>
<li>ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…</li>
<li><b>çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)</b></li>
</ul>
</li>
<li>
<p>æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)</p>
<ul>
<li>
<p>äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº</p>
</li>
<li>
<p><b>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</b></p>
</li>
<li>
<p><b>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ<code>*lock = âœ…</code></b></p>
</li>
</ul>
</li>
<li>
<p><b><font color="red">ç®¡ç†å‘˜ (OS) ä½¿ç”¨<u>è‡ªæ—‹é”</u>ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„</font></b></p>
</li>
</ul>
<h2 id="futex--spin--mutex">Futex = Spin + Mutex</h2>
<h3 id="å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ">å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</h3>
<ul>
<li>
<p>è‡ªæ—‹é” (çº¿ç¨‹ç›´æ¥å…±äº« locked)</p>
<ul>
<li>
<p>æ›´å¿«çš„ fast path</p>
<ul>
<li>xchg æˆåŠŸ â†’ ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å¾ˆå°</li>
</ul>
</li>
<li>
<p>æ›´æ…¢çš„ slow path</p>
<ul>
<li>xchg å¤±è´¥ â†’ æµªè´¹ CPU è‡ªæ—‹ç­‰å¾…ï¼ˆäº¤æ¢ä¸€äº›ä¸æ˜¯ğŸ”’ï¼Œæ²¡ç”¨çš„ä¸œè¥¿ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¡çœ ï¼ˆäº’æ–¥ï¼‰é” (é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—® locked)</p>
<ul>
<li>
<p>æ›´å¿«çš„ slow path</p>
<ul>
<li>ä¸Šé”å¤±è´¥çº¿ç¨‹ä¸å†å ç”¨ CPU</li>
</ul>
</li>
<li>
<p>æ›´æ…¢çš„ fast path</p>
<ul>
<li>å³ä¾¿ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦<u>è¿›å‡ºå†…æ ¸ (syscall)</u> $\Longrightarrow$ é€Ÿåº¦ç›¸å¯¹æ¯”è¾ƒæ…¢</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="futex-fast-userspace-mutexes">Futex: Fast Userspace muTexes</h3>
<blockquote>
<p>è§£å†³æ–¹æ¡ˆï¼šå…¨éƒ½è¦</p>
</blockquote>
<div class="mermaid" id="id-6"></div>
<ul>
<li>
<p><b><font color="red">æ€§èƒ½ä¼˜åŒ–çš„æœ€å¸¸è§æŠ€å·§</font></b></p>
<ul>
<li>çœ‹ average (frequent) case è€Œä¸æ˜¯ worst case $\Longrightarrow$ <b>è¿™é‡Œæ˜¯å’Œç®—æ³•é¢˜åšå¯¹æ¯”ï¼Œç®—æ³•é¢˜è¦ä¿è¯æ‰€æœ‰å¯èƒ½çš„æƒ…å†µéƒ½å¯ä»¥è¢«é«˜æ•ˆè®¡ç®—ï¼ˆworst caseï¼‰ï¼Œè€Œæ“ä½œç³»ç»Ÿè¦æ±‚çš„åˆ™æ˜¯å¤§éƒ¨åˆ†æƒ…å†µéƒ½å¯ä»¥è¢«å¿«é€Ÿå¤„ç†ï¼Œå°‘æ•°çš„æƒ…å†µå¤„ç†åœ°æ…¢ä¹Ÿå¯ä»¥ï¼ˆaverageï¼‰</b></li>
</ul>
</li>
<li>
<p>POSIX çº¿ç¨‹åº“ä¸­çš„äº’æ–¥é” (<code>pthread_mutex</code>) $\Longrightarrow$ ä¸¤ç§ğŸ”’çš„å¥½å¤„éƒ½å¾—äº†</p>
</li>
<li>
<p>æˆ‘ä»¬å°†<a href="https://jyywiki.cn/pages/OS/2022/demos/sum-scalability.c" target="_blank" rel="noopener noreffer">sum-scalability.c</a>é‡Œé¢çš„è‡ªæ—‹é”æ¢æˆäº’æ–¥é”</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">mutex_t</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">MUTEX_INIT</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>äº’æ–¥é”çš„å®ç°ï¼ˆé€šè¿‡syscallï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mutex_lock</span><span class="p">(</span><span class="n">mutex_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>   <span class="p">{</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mutex_unlock</span><span class="p">(</span><span class="n">mutex_t</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span> <span class="p">{</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¼–è¯‘+æµ‹è¯•</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> 2023-03-09 20:11:45 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ gcc sum-scalability.c -O2 -lpthread
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:06 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.065s
</span></span><span class="line"><span class="cl">user    0m0.037s
</span></span><span class="line"><span class="cl">sys     0m0.019s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:12 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.180s
</span></span><span class="line"><span class="cl">user    0m0.121s
</span></span><span class="line"><span class="cl">sys     0m0.185s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:26 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.179s
</span></span><span class="line"><span class="cl">user    0m0.156s
</span></span><span class="line"><span class="cl">sys     0m0.152s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:16:28 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.106s
</span></span><span class="line"><span class="cl">user    0m0.100s
</span></span><span class="line"><span class="cl">sys     0m0.039s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2023-03-09 20:20:18 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ <span class="nb">time</span> ./a.out <span class="m">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.087s
</span></span><span class="line"><span class="cl">user    0m0.056s
</span></span><span class="line"><span class="cl">sys     0m0.060s
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><b>å¯ä»¥çœ‹åˆ°å½“çº¿ç¨‹æ•°é‡å˜å¤šçš„æ—¶å€™ï¼Œ<code>pthread_mutex</code>å¤„ç†çš„æ•ˆç‡è¦è¿œé«˜äºè‡ªæ—‹é”</b></p>
</li>
<li>
<p>è§‚å¯Ÿç³»ç»Ÿè°ƒç”¨ (strace) $\Longrightarrow$ å¤ªé•¿äº†å°±å¤åˆ¶ä¸€æ®µ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">2023-03-09 20:11:24 âŒš  jungle-virtual-machine in ~/chapter5
</span></span><span class="line"><span class="cl">â—‹ â†’ strace -f ./a.out <span class="m">64</span>
</span></span><span class="line"><span class="cl">execve<span class="o">(</span><span class="s2">&#34;./a.out&#34;</span>, <span class="o">[</span><span class="s2">&#34;./a.out&#34;</span>, <span class="s2">&#34;64&#34;</span><span class="o">]</span>, 0x7ffe8bbc7370 /* <span class="m">64</span> vars */<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55d83eca4000
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>0x3001 /* ARCH_??? */, 0x7ffcb38f0700<span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>æ— æ•ˆçš„å‚æ•°<span class="o">)</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8192, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56b2a000
</span></span><span class="line"><span class="cl">access<span class="o">(</span><span class="s2">&#34;/etc/ld.so.preload&#34;</span>, R_OK<span class="o">)</span>      <span class="o">=</span> -1 ENOENT <span class="o">(</span>æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•<span class="o">)</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/etc/ld.so.cache&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>76495, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 76495, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56b17000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">read<span class="o">(</span>3, <span class="s2">&#34;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\237\2\0\0\0\0\0&#34;</span>..., 832<span class="o">)</span> <span class="o">=</span> <span class="m">832</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class="o">)</span> <span class="o">=</span> <span class="m">784</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\4\0\0\0 \0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&#34;</span>..., 48, 848<span class="o">)</span> <span class="o">=</span> <span class="m">48</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0i8\235HZ\227\223\333\350s\360\352,\223\340.&#34;</span>..., 68, 896<span class="o">)</span> <span class="o">=</span> <span class="m">68</span>
</span></span><span class="line"><span class="cl">newfstatat<span class="o">(</span>3, <span class="s2">&#34;&#34;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>2216304, ...<span class="o">}</span>, AT_EMPTY_PATH<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">pread64<span class="o">(</span>3, <span class="s2">&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class="o">)</span> <span class="o">=</span> <span class="m">784</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 2260560, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56800000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda56828000, 1658880, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x28000<span class="o">)</span> <span class="o">=</span> 0x7fda56828000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda569bd000, 360448, PROT_READ, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x1bd000<span class="o">)</span> <span class="o">=</span> 0x7fda569bd000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda56a15000, 24576, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x214000<span class="o">)</span> <span class="o">=</span> 0x7fda56a15000
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>0x7fda56a1b000, 52816, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56a1b000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 12288, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda56b14000
</span></span><span class="line"><span class="cl">arch_prctl<span class="o">(</span>ARCH_SET_FS, 0x7fda56b14740<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">set_tid_address<span class="o">(</span>0x7fda56b14a10<span class="o">)</span>         <span class="o">=</span> <span class="m">4614</span>
</span></span><span class="line"><span class="cl">set_robust_list<span class="o">(</span>0x7fda56b14a20, 24<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rseq<span class="o">(</span>0x7fda56b150e0, 0x20, 0, 0x53053053<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7fda56a15000, 16384, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x55d83cf2f000, 4096, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7fda56b64000, 8192, PROT_READ<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">prlimit64<span class="o">(</span>0, RLIMIT_STACK, NULL, <span class="o">{</span><span class="nv">rlim_cur</span><span class="o">=</span>8192*1024, <span class="nv">rlim_max</span><span class="o">=</span>RLIM64_INFINITY<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">munmap<span class="o">(</span>0x7fda56b17000, 76495<span class="o">)</span>           <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rt_sigaction<span class="o">(</span>SIGRT_1, <span class="o">{</span><span class="nv">sa_handler</span><span class="o">=</span>0x7fda568918f0, <span class="nv">sa_mask</span><span class="o">=[]</span>, <span class="nv">sa_flags</span><span class="o">=</span>SA_RESTORER<span class="p">|</span>SA_ONSTACK<span class="p">|</span>SA_RESTART<span class="p">|</span>SA_SIGINFO, <span class="nv">sa_restorer</span><span class="o">=</span>0x7fda56842520<span class="o">}</span>, NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">rt_sigprocmask<span class="o">(</span>SIG_UNBLOCK, <span class="o">[</span>RTMIN RT_1<span class="o">]</span>, NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, 0<span class="o">)</span> <span class="o">=</span> 0x7fda55fff000
</span></span><span class="line"><span class="cl">mprotect<span class="o">(</span>0x7fda56000000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">getrandom<span class="o">(</span><span class="s2">&#34;\xc0\x0d\x30\x79\xa6\xc0\x9a\x32&#34;</span>, 8, GRND_NONBLOCK<span class="o">)</span> <span class="o">=</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55d83eca4000
</span></span><span class="line"><span class="cl">brk<span class="o">(</span>0x55d83ecc5000<span class="o">)</span>                     <span class="o">=</span> 0x55d83ecc5000
</span></span><span class="line"><span class="cl">rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>, <span class="o">[]</span>, 8<span class="o">)</span>   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda567ff910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda567ff910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda55fff000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda567ff640<span class="o">}</span>strace: Process <span class="m">4615</span> <span class="nv">attached</span>
</span></span><span class="line"><span class="cl"> <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4615<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4615</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> rseq<span class="o">(</span>0x7fda567fffe0, 0x20, 0, 0x53053053 &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... rseq resumed&gt;<span class="o">)</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> set_robust_list<span class="o">(</span>0x7fda567ff920, <span class="m">24</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda557fe000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... set_robust_list resumed&gt;<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda557ff000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>, <span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda55ffe910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda55ffe910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda557fe000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda55ffe640<span class="o">}</span>strace: Process <span class="m">4616</span> <span class="nv">attached</span>
</span></span><span class="line"><span class="cl"> <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4616<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4616</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> rseq<span class="o">(</span>0x7fda55ffefe0, 0x20, 0, 0x53053053 &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... rseq resumed&gt;<span class="o">)</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> set_robust_list<span class="o">(</span>0x7fda55ffe920, <span class="m">24</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda54ffd000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... set_robust_list resumed&gt;<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda54ffe000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;<span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda557fd910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda557fd910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda54ffd000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda557fd640<span class="o">}</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, 1<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">strace: Process <span class="m">4617</span> attached
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... clone3 resumed&gt; <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4617<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4617</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> rseq<span class="o">(</span>0x7fda557fdfe0, 0x20, 0, 0x53053053 &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... rseq resumed&gt;<span class="o">)</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> set_robust_list<span class="o">(</span>0x7fda557fd920, <span class="m">24</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda547fc000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... set_robust_list resumed&gt;<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda547fd000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;<span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda54ffc910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda54ffc910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda547fc000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda54ffc640<span class="o">}</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... clone3 resumed&gt; <span class="o">=</span>&gt; <span class="o">{</span><span class="nv">parent_tid</span><span class="o">=[</span>4618<span class="o">]}</span>, 88<span class="o">)</span> <span class="o">=</span> <span class="m">4618</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_SETMASK, <span class="o">[]</span>, NULL, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mmap<span class="o">(</span>NULL, 8392704, PROT_NONE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_STACK, -1, <span class="m">0</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mmap resumed&gt;<span class="o">)</span>         <span class="o">=</span> 0x7fda53ffb000
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> mprotect<span class="o">(</span>0x7fda53ffc000, 8388608, PROT_READ<span class="p">|</span>PROT_WRITE &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... mprotect resumed&gt;<span class="o">)</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4617<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> rt_sigprocmask<span class="o">(</span>SIG_BLOCK, ~<span class="o">[]</span>,  &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> &lt;... rt_sigprocmask resumed&gt;<span class="o">[]</span>, 8<span class="o">)</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4614<span class="o">]</span> clone3<span class="o">({</span><span class="nv">flags</span><span class="o">=</span>CLONE_VM<span class="p">|</span>CLONE_FS<span class="p">|</span>CLONE_FILES<span class="p">|</span>CLONE_SIGHAND<span class="p">|</span>CLONE_THREAD<span class="p">|</span>CLONE_SYSVSEM<span class="p">|</span>CLONE_SETTLS<span class="p">|</span>CLONE_PARENT_SETTID<span class="p">|</span>CLONE_CHILD_CLEARTID, <span class="nv">child_tid</span><span class="o">=</span>0x7fda547fb910, <span class="nv">parent_tid</span><span class="o">=</span>0x7fda547fb910, <span class="nv">exit_signal</span><span class="o">=</span>0, <span class="nv">stack</span><span class="o">=</span>0x7fda53ffb000, <span class="nv">stack_size</span><span class="o">=</span>0x7fff00, <span class="nv">tls</span><span class="o">=</span>0x7fda547fb640<span class="o">}</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> futex<span class="o">(</span>0x55d83cf30060, FUTEX_WAKE_PRIVATE, <span class="m">1</span> &lt;unfinished ...&gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4615<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> -1 EAGAIN <span class="o">(</span>èµ„æºæš‚æ—¶ä¸å¯ç”¨<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>pid  4616<span class="o">]</span> &lt;... futex resumed&gt;<span class="o">)</span>        <span class="o">=</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é‡Œé¢æœ‰å¾ˆå¤šç±»ä¼¼73è¡Œçš„è¯­å¥<code>[pid  4616] futex(0x55d83cf30060, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;</code></li>
</ul>
<blockquote>
<p><strong>ä¸€ã€ä»€ä¹ˆæ˜¯futexï¼Ÿ</strong></p>
<p>futexæ˜¯Fast Userspace muTEXçš„ç¼©å†™ï¼Œè¯¥æœºåˆ¶æ˜¯ç”±Rusty Russellã€Hubertus Frankeå’ŒMathew Kirkwoodåœ¨2.5.7ç‰ˆæœ¬çš„å†…æ ¸ä¸­å¼•å…¥ï¼Œè™½ç„¶åå­—ä¸­æœ‰äº’æ–¥é”ï¼ˆmutexï¼‰çš„å«ä¹‰ï¼Œä½†å®é™…å®ƒæ˜¯ä¸€ç§ç”¨äºç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºçš„é€šç”¨åŒæ­¥å·¥å…·ï¼ˆåŸºäºfutexå¯ä»¥åœ¨userspaceå®ç°äº’æ–¥é”ã€è¯»å†™é”ã€condition variableç­‰åŒæ­¥æœºåˆ¶ï¼‰ã€‚Futexç»„æˆåŒ…æ‹¬ï¼š</p>
<ul>
<li>å†…æ ¸ç©ºé—´çš„ç­‰å¾…é˜Ÿåˆ—</li>
<li>ç”¨æˆ·ç©ºé—´å±‚çš„32-bit futex wordï¼ˆæ‰€æœ‰å¹³å°éƒ½æ˜¯32bitï¼ŒåŒ…æ‹¬64ä½å¹³å°ï¼‰</li>
</ul>
<p><b>åœ¨æ²¡æœ‰ç«äº‰çš„åœºæ™¯ä¸‹ï¼Œé”çš„è·å–å’Œé‡Šæ”¾æ€§èƒ½éƒ½éå¸¸é«˜ï¼Œä¸éœ€è¦å†…æ ¸çš„å‚ä¸ï¼Œä»…ä»…æ˜¯é€šè¿‡ç”¨æˆ·ç©ºé—´çš„åŸå­æ“ä½œæ¥ä¿®æ”¹futex wordçš„çŠ¶æ€å³å¯</b>ã€‚åœ¨æœ‰ç«äº‰çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœçº¿ç¨‹æ— æ³•è·å–futexé”ï¼Œé‚£ä¹ˆæŠŠè‡ªå·±æ”¾å…¥åˆ° wait queueä¸­ï¼ˆé™·å…¥å†…æ ¸ï¼Œæœ‰ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼‰ï¼Œè€Œåœ¨owner taské‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°æœ‰ç«äº‰ï¼ˆç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰é˜»å¡ä»»åŠ¡ï¼‰ï¼Œå°±ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä½¿å…¶æ¢å¤æ‰§è¡Œï¼Œç»§ç»­å»æŒé”ã€‚å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œé‚£ä¹ˆä¹Ÿæ— éœ€é™·å…¥å†…æ ¸ã€‚</p>
<p>æ‘˜è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/568678633" target="_blank" rel="noopener noreffer">ã€Šä»€ä¹ˆæ˜¯futexï¼Ÿã€‹</a></p>
</blockquote>
<blockquote>
<p>Futexï¼ˆFast Userspace Mutexï¼‰æ˜¯ä¸€ç§ç”¨æˆ·ç©ºé—´é”ï¼Œå®ƒæ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºæ§åˆ¶å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ä¹‹é—´çš„è®¿é—®å…±äº«èµ„æºã€‚Futexä¸»è¦ç”¨äºå®ç°æ›´é«˜çº§åˆ«çš„åŒæ­¥åŸè¯­ï¼Œä¾‹å¦‚æ¡ä»¶å˜é‡å’Œè¯»å†™é”ã€‚Futexæä¾›äº†ä¸€ç§ä½å¼€é”€çš„é”æœºåˆ¶ï¼Œå½“é”è¢«æŒæœ‰æ—¶ï¼Œå®ƒå¯ä»¥é¿å…å°†çº¿ç¨‹æˆ–è¿›ç¨‹é˜»å¡åœ¨å†…æ ¸ç©ºé—´ã€‚</p>
<p>åœ¨Futexä¸­ï¼Œé”çš„çŠ¶æ€ä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè€Œä¸æ˜¯å†…æ ¸ç©ºé—´ä¸­ï¼Œå½“çº¿ç¨‹æˆ–è¿›ç¨‹éœ€è¦è·å–é”æ—¶ï¼Œå®ƒä¼šå°è¯•å°†é”çš„çŠ¶æ€ä»â€œæœªé”å®šâ€æ”¹ä¸ºâ€œé”å®šâ€çŠ¶æ€ã€‚å¦‚æœæˆåŠŸï¼Œçº¿ç¨‹æˆ–è¿›ç¨‹å°±å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚å¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹å ç”¨ï¼Œåˆ™å®ƒå°†åœ¨ç”¨æˆ·ç©ºé—´å†…å¿™ç­‰å¾…ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚</p>
<p>Futexè¿˜æ”¯æŒä¸€äº›å…¶ä»–çš„æ“ä½œï¼Œä¾‹å¦‚ç­‰å¾…ä¸€ä¸ªç‰¹å®šçš„å€¼æˆ–æ¯”è¾ƒå¹¶äº¤æ¢å€¼ï¼Œè¿™äº›æ“ä½œå¯ä»¥ç”¨äºå®ç°æ¡ä»¶å˜é‡å’Œè¯»å†™é”ç­‰é«˜çº§åˆ«çš„åŒæ­¥åŸè¯­ã€‚ç”±äºFutexçš„ä½å¼€é”€å’Œé«˜æ•ˆæ€§ï¼Œå®ƒæˆä¸ºäº†Linuxç³»ç»Ÿä¸­è®¸å¤šé«˜çº§åˆ«åŒæ­¥åŸè¯­çš„åŸºç¡€ã€‚</p>
<p>æ¥è‡ª<a href="https://openai.com/blog/chatgpt" target="_blank" rel="noopener noreffer">ChatGPT</a></p>
</blockquote>
<ul>
<li>
<p><b>å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿå°±ä¼šå‘ç°ï¼Œfutexè°ƒç”¨çš„æ•°é‡è¿œè¿œå°äºlockå’Œunlockçš„æ•°é‡</b></p>
</li>
<li>
<p>gdb è°ƒè¯•</p>
<ul>
<li><code>set scheduler-locking on</code>, <code>info threads</code>, <code>thread X</code></li>
</ul>
</li>
</ul>
<h3 id="futex-fast-userspace-mutexes-contd">Futex: Fast Userspace muTexes (cont&rsquo;d)</h3>
<p>å…ˆåœ¨ç”¨æˆ·ç©ºé—´è‡ªæ—‹</p>
<ul>
<li>å¦‚æœè·å¾—é”ï¼Œç›´æ¥è¿›å…¥</li>
<li>æœªèƒ½è·å¾—é”ï¼Œç³»ç»Ÿè°ƒç”¨</li>
<li>è§£é”ä»¥åä¹Ÿéœ€è¦ç³»ç»Ÿè°ƒç”¨
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/futex.py" target="_blank" rel="noopener noreffer">futex.py</a></li>
<li>æ›´å¥½çš„è®¾è®¡å¯ä»¥åœ¨ fast-path ä¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
</ul>
<p>futex.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Futex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span><span class="p">,</span> <span class="n">waits</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">tryacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Test-and-set (cmpxchg)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Same effect, but more efficient than xchg</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>     <span class="c1"># User</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="c1"># Kernel</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>      <span class="c1"># Kernel</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>                         <span class="c1"># User</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>                            <span class="c1"># User</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>                    <span class="c1"># Kernel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryacquire</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span> <span class="o">+</span> <span class="s1">&#39;3&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;blue&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;green&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t3&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;yellow&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_both</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;t3&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>pythonä»£ç çš„ä¼˜åŠ¿ï¼šå¦‚æœä½ æƒ³è®©ä¸€å¥ä»£ç åŸå­æ‰§è¡Œâ€”â€”&gt;åŠ å…¥<code>yield breakpoint()</code></p>
</li>
<li>
<p><code>python3 model-checker.py futex.py | python3 visualize.py -t &gt; a.html </code>é‡å®šå‘ï¼Œå¯è§†åŒ–</p>
</li>
<li>
<p><a href="https://github.com/Jungle430/check-for-NJU-OS" target="_blank" rel="noopener noreffer">æ ·ä¾‹ä»“åº“</a></p>
</li>
</ul>
<hr>
<p>RTFM (åŠé€€)</p>
<ul>
<li>futex (7), futex (2)</li>
<li><a href="https://lwn.net/Articles/360699/" target="_blank" rel="noopener noreffer">A futex overview and update</a> (LWN)</li>
<li><a href="https://jyywiki.cn/pages/OS/manuals/futexes-are-tricky.pdf" target="_blank" rel="noopener noreffer">Futexes are tricky</a> (è®º model checker çš„é‡è¦æ€§) $\Longrightarrow$ <u>åŒæ—¶ä¹Ÿæç¤ºæˆ‘ä»¬ä»æœ€ç®€å•çš„å†™èµ·ï¼Œåƒä¸‡ä¸è¦è§‰å¾—è‡ªå·±è¡Œå°±è£…ğŸ–Šæå¤§çš„</u></li>
<li>(æˆ‘ä»¬ä¸è®²å¹¶å‘ç®—æ³•)</li>
</ul>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå®ç°äº’æ–¥ï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘ (è‡ªæ—‹é”)</li>
<li>ç”¨æˆ·ä¸å¤Ÿï¼Œå†…æ ¸æ¥å‡‘ (äº’æ–¥é”)
<ul>
<li><b><font color="red">æ‰¾åˆ°ä½ ä¾èµ–çš„å‡è®¾ï¼Œå¹¶å¤§èƒ†åœ°æ‰“ç ´å®ƒ</font></b></li>
</ul>
</li>
<li>Fast/slow paths: æ€§èƒ½ä¼˜åŒ–çš„é‡è¦é€”å¾„</li>
</ul>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
]]></description>
</item>
<item>
    <title>Operating System Chapter4 ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter4/</link>
    <pubDate>Mon, 06 Mar 2023 19:34:15 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter4/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="typeit"><div id="id-1" class=""></div></div>
<p>æ™šä¸Šçœ‹çš„ï¼Œ<b>Peterson</b>ç®—æ³•å¥½â„¢ï¸çš„ğŸ‘¨ï¼Œè¯æ˜ç­‰è¿‡ä¸¤å¤©æœ‰æ—¶é—´ç»™çœ‹äº†</div>
        </div>
    </div>
<h2 id="ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ">ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ</h2>
<h3 id="å¤ä¹ ">å¤ä¹ </h3>
<ul>
<li>ä¸€èˆ¬ç¨‹åºæ‰§è¡Œ</li>
</ul>
<div class="mermaid" id="id-2"></div>
<p>çº¿ç¨‹çš„æ ˆå¸§ä¼šç”¨ä¸€ä¸ª<code>list</code>æ¥å­˜æ”¾</p>
<ul>
<li>å¤šçº¿ç¨‹</li>
</ul>
<div class="mermaid" id="id-3"></div>
<p>T1,T2éšæœºæ¥å›è½¬æ¢æ‰§è¡Œ</p>
<ul>
<li><b>å¹¶å‘ç¨‹åº = å¤šä¸ªæ‰§è¡Œæµã€å…±äº«å†…å­˜çš„<u>çŠ¶æ€æœº</u></b></li>
</ul>
<h3 id="ç”»çŠ¶æ€æœºç†è§£å¹¶å‘ç¨‹åº">ç”»çŠ¶æ€æœºç†è§£å¹¶å‘ç¨‹åº</h3>
<blockquote>
<p><u>äº’æ–¥ï¼šä¿è¯ä¸¤ä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶æ‰§è¡Œä¸€æ®µä»£ç </u></p>
</blockquote>
<ul>
<li>æ’å…¥ â€œç¥ç§˜ä»£ç â€ï¼Œä½¿å¾— <a href="https://jyywiki.cn/pages/OS/2022/demos/sum.c" target="_blank" rel="noopener noreffer">sum.c</a> (æˆ–è€…ä»»æ„å…¶ä»–ä»£ç ) èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç¥ç§˜ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">sum</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç¥ç§˜ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¯ä»¥é€šè¿‡<code>__sync_synchronize();</code>æ¥ä¿è¯åŸå­æ“ä½œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__sync_synchronize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// æˆ– int t = x;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__sync_synchronize</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å¤±è´¥çš„å°è¯•">å¤±è´¥çš„å°è¯•</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="n">UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">locked</span> <span class="o">!=</span> <span class="n">UNLOCK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">locked</span> <span class="o">=</span> <span class="n">LOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// critical section
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">locked</span> <span class="o">=</span> <span class="n">UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>åŸå› </p>
<ul>
<li>çœ‹åˆ°çš„çŠ¶æ€åˆ°çœŸæ­£åšä¸‹ä¸€ä»¶äº‹ä¹‹é—´çš„çŠ¶æ€æ˜¯å¦è¢«äººæ”¹äº†ï¼Ÿï¼ˆ<u>çœ‹åˆ°çš„ä¸œè¥¿ä»…ä»…åªæ˜¯ä¸€ä¸ªå†å²ï¼Œç¦»åšè¿˜æœ‰å‡ ä¸ªå‘¨æœŸï¼Œè€Œåšæ˜¯æ ¹æ®è¿™ä¸ª<b>â€œå†å²â€</b>çš„çŠ¶æ€æ¥å†³å®šçš„</u>ï¼‰$\Longrightarrow$ å’Œäººçœ¼çœ‹ç€ä¸œè¥¿å¯¹æ¯”ï¼Œäººçœ¼æ˜¯<b>ä¸€ç›´åœ¨çœ‹çš„</b>ï¼Œè€ŒCPUå¹¶è¡Œæ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œçœ‹è¿™ä¸ªæŒ‡ä»¤æ‰§è¡Œå®Œäº†ä¹‹åå¯èƒ½CPUä¼šå»æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„å‡ æ¡æŒ‡ä»¤ï¼Œè¿™ç§æƒ…å†µä¸‹ç›¸å½“äºè¿™ä¸ªäºº<b>çœ‹å®Œåé—­ä¸Šçœ¼ç›ç­‰äº†å‡ ç§’</b>ï¼Œç„¶åæ ¹æ®å‡ ç§’å‰æ‰€çœ‹çš„ä¸œè¥¿æ¥åˆ¤æ–­è‡ªå·±è¦å¹²å•¥ï¼Œ<b>å¯æ˜¯è¿™ä¸ªä¸œè¥¿åœ¨å‰å‡ ç§’å¯èƒ½å·²ç»è®©å¦ä¸€ä¸ªçº¿ç¨‹çš„æŸäº›æŒ‡ä»¤æ”¹è¿‡äº†</b></li>
<li><b>å¤„ç†å™¨é»˜è®¤ä¸ä¿è¯ load + store çš„åŸå­æ€§ï¼ˆå•æ“ä½œå¯ä»¥ä¿è¯ï¼‰</b></li>
</ul>
</li>
<li>
<p>ä¸€ç§å¤±è´¥çš„æƒ…å†µ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 100000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LOCK 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define UNLOCK 0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="n">UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>  <span class="c1">//T2åœ¨è¿™ä¸ªæ—¶å€™ä¹Ÿæ‰§è¡Œåˆ°äº†locked != UNLOCKçš„åˆ¤æ–­ï¼Œè€Œlock = LOCK,T2ä¹Ÿè¿›å»äº†ï¼Œæ²¡é”ä½ï¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">locked</span> <span class="o">!=</span> <span class="n">UNLOCK</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//&lt;--------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>                                        <span class="c1">//  |
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>                                                    <span class="c1">//  |  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">locked</span> <span class="o">=</span> <span class="n">LOCK</span><span class="p">;</span>         <span class="c1">//T1æ‰§è¡Œåˆ°äº†è¿™é‡Œ æ­¤æ—¶locked = LOCK-|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sum</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">locked</span> <span class="o">=</span> <span class="n">UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;sum = %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯•-peterson-ç®—æ³•">æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯• (<code>Peterson</code> ç®—æ³•)</h4>
<ul>
<li>
<p>A å’Œ B äº‰ç”¨å•æ‰€çš„åŒ…å¢</p>
</li>
<li>
<p>æƒ³è¿›å…¥åŒ…å¢ä¹‹å‰ï¼ŒA/B éƒ½è¦å…ˆä¸¾èµ·è‡ªå·±çš„æ——å­</p>
<ul>
<li>A ç¡®è®¤æ——å­ä¸¾å¥½ä»¥åï¼Œå¾€å•æ‰€é—¨ä¸Šè´´ä¸Š <b>â€œB æ­£åœ¨ä½¿ç”¨â€</b> çš„æ ‡ç­¾</li>
<li>B ç¡®è®¤æ——å­ä¸¾å¥½ä»¥åï¼Œå¾€å•æ‰€é—¨ä¸Šè´´ä¸Š <b>â€œA æ­£åœ¨ä½¿ç”¨â€</b> çš„æ ‡ç­¾</li>
</ul>
</li>
<li>
<p>ç„¶å<b>å¦‚æœå¯¹æ–¹çš„æ——å­ä¸¾èµ·æ¥ï¼Œä¸”é—¨ä¸Šçš„åå­—ä¸æ˜¯è‡ªå·±</b>ï¼Œç­‰å¾…</p>
<ul>
<li>å¦åˆ™å¯ä»¥è¿›å…¥åŒ…å¢</li>
</ul>
</li>
<li>
<p><b>å‡ºåŒ…å¢åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­</b></p>
</li>
<li>
<p>ç¤ºä¾‹ä»£ç ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-simple.c" target="_blank" rel="noopener noreffer">peterson-simple.c</a></p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define A 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define B 2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_int</span> <span class="n">nested</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_long</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="k">volatile</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">turn</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TA</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=1 */</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=2 */</span> <span class="n">turn</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=3 */</span> <span class="k">while</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">turn</span> <span class="o">==</span> <span class="n">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=4 */</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=1 */</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=2 */</span> <span class="n">turn</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=3 */</span> <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">turn</span> <span class="o">==</span> <span class="n">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* PC=4 */</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="petersons-protocol-verified-">Peterson&rsquo;s Protocol Verified ğŸ–</h4>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="typeit"><div id="id-4" class=""></div></div>
<p>åŸæ¥è¯æ˜å’Œåˆ¤æ–­å¯ä»¥ç”¨çŠ¶æ€ğŸŒ³æ¥è¯æ˜ï¼ˆå’Œå…¨æ•°å­¦ç›¸æ¯”å¯èƒ½ä¸ä¸¥è°¨ï¼Œä½†æ˜¯ä»CSçš„è§’åº¦æ¥è¯´å¤Ÿç”¨äº†ï¼‰</p>
<p>å…ˆğŸ˜´ï¼Œå›æ¥å†çœ‹</p>
</div>
        </div>
    </div>
<blockquote>
<p>æˆ‘ä»¬ (åœ¨å®Œå…¨ä¸ç†è§£ç®—æ³•çš„å‰æä¸‹) è¯æ˜äº† Sequential å†…å­˜æ¨¡å‹ä¸‹ Peterson&rsquo;s Protocol çš„ Safetyã€‚å®ƒèƒ½å¤Ÿå®ç°äº’æ–¥ã€‚</p>
</blockquote>
<ul>
<li>â€œ<a href="https://zoo.cs.yale.edu/classes/cs323/doc/Peterson.pdf" target="_blank" rel="noopener noreffer">Myths about the mutual exclusion problem</a>â€ (IPL, 1981ï¼Œ<code>Peterson</code>ç®—æ³•è®ºæ–‡ï¼Œ<u>ç»ˆäºç»™äº†ä¸€ä¸ªå¯¹äºæˆ‘ä»¬æ¥è¯´ç†è§£èµ·æ¥<b>ç›¸å¯¹</b>å®¹æ˜“çš„ä¸€ä¸ªç®—æ³•</u>)</li>
<li>ä¹‹å‰æœ‰å…³é”çš„ä¸€äº›å¤æ‚ç®—æ³•ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/dekker.py" target="_blank" rel="noopener noreffer">dekker.py</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Dekker</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="p">,</span> <span class="n">another</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">another</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="n">another</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="n">another</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="n">another</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="p">,</span> <span class="n">another</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">another</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="n">another</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="n">another</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="n">another</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;blue&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;green&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_both</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸€äº›ç°çŠ¶
<ul>
<li>ä»Šå¤©æœ‰éå¸¸åš (å†…) å® (å·) çš„ç†è®ºä½“ç³»</li>
<li>å°å¿ƒç¼–è¯‘å™¨å’Œå¤šå¤„ç†å™¨ç¡¬ä»¶ï¼ˆç¼–è¯‘å™¨ä¼˜åŒ–ï¼ŒCPUæŒ‡ä»¤æµæ°´çº¿ä¼˜åŒ–ï¼‰
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c" target="_blank" rel="noopener noreffer">peterson-barrier.c</a>ï¼ˆ<b>æ”¹è‰¯ç‰ˆï¼Œé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–é€ æˆçš„ç»“æœå’Œé¢„æœŸä¸ç¬¦</b>ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define A 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define B 2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BARRIER __sync_synchronize()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_int</span> <span class="n">nested</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">atomic_long</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d threads in the critical section @ count=%ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="k">volatile</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">turn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>                <span class="n">BARRIER</span><span class="p">;</span> <span class="c1">// &lt;- this is critcal for x86
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">y</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>         <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">turn</span> <span class="o">!=</span> <span class="n">B</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TB</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">turn</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>                <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>         <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">turn</span> <span class="o">!=</span> <span class="n">A</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_section</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="n">BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">TB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¯¾åæ€è€ƒï¼š<b>å“ªäº› barrier æ˜¯å¤šä½™çš„å—ï¼Ÿ</b></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define BARRIER __sync_synchronize() </span><span class="c1">//é‡ç‚¹ç ”ç©¶è¿™ä¸ªå®çš„ä½œç”¨
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è‡ªåŠ¨-ç”»çŠ¶æ€æœºç†è§£å¹¶å‘ç¨‹åº">(è‡ªåŠ¨) ç”»çŠ¶æ€æœºç†è§£å¹¶å‘ç¨‹åº</h3>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="typeit"><div id="id-5" class=""></div></div>
<p>ä½“è‚²è¯¾ç´¯æ­‡é€¼äº†ï¼Œæ™šä¸Šç»™çœ‹å®Œ</div>
        </div>
    </div>
<ul>
<li>
<p>å¹¶å‘ç®—æ³•çš„è®¾è®¡å›°å¢ƒ</p>
<ul>
<li>
<p>ä¸æ•¢ä¸ç”»ï¼šè°çŸ¥é“æœ‰ä»€ä¹ˆå¥‡æ€ªæƒ…å†µä¼šå‘ç”Ÿï¼Ÿ</p>
</li>
<li>
<p>ä¸æ•¢ä¹±ç”»ï¼šç”»é”™äº†å°±éƒ½å®Œäº†</p>
</li>
</ul>
</li>
<li>
<p>è§£å†³æ–¹æ³•</p>
<ul>
<li>è®©ç”µè„‘å¸®æˆ‘ä»¬ç”»ï¼ˆå› ä¸ºç”»çŠ¶æ€æœºå°±æ˜¯ä¸€ä¸ª<b>æœºæ¢°</b>çš„äº‹æƒ…ï¼‰</li>
</ul>
</li>
</ul>
<p><a href="https://jyywiki.cn/pages/OS/2022/demos/model-checker.py" target="_blank" rel="noopener noreffer">model-checker.py</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">ast</span><span class="o">,</span> <span class="nn">astor</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">threads</span><span class="p">,</span> <span class="n">marker_fn</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">thread</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Decorate a member function as a thread&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">threads</span>
</span></span><span class="line"><span class="cl">    <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">fn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">marker</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Decorate a member function as a state marker&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">marker_fn</span>
</span></span><span class="line"><span class="cl">    <span class="n">marker_fn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">localvar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Return local variable value of thread t in state s&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{}))[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">checkpoint</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Instrumented `yield checkpoint()` goes here&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span> <span class="c1"># stack[1] is the caller of checkpoint()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hack</span><span class="p">(</span><span class="n">Class</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Hack Class to instrument @mc.thread functions&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Instrument</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">in_fn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># a @mc.thread function -&gt; instrument it</span>
</span></span><span class="line"><span class="cl">                    <span class="n">in_fn</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># a decorated function like @mc.mark -&gt; remove it</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># prepend each line with `yield checkpoint()`</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">in_fn</span><span class="p">:</span> <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Yield</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])))</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">in_fn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">node</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="s1">&#39;hacked&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">hacked_ast</span> <span class="o">=</span> <span class="n">Instrument</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">Class</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">hacked_src</span><span class="p">,</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">astor</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">hacked_ast</span><span class="p">),</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># set a breakpoint() here to see **magic happens**!</span>
</span></span><span class="line"><span class="cl">        <span class="n">exec</span><span class="p">(</span><span class="n">hacked_src</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">vars</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">.</span><span class="n">hacked</span><span class="p">,</span> <span class="n">Class</span><span class="o">.</span><span class="n">hacked_src</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="n">Class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">hacked_src</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Class</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Execute trace (like [0,0,0,2,2,1,1,1]) on Class&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">obj</span> <span class="o">=</span> <span class="n">hack</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="o">.</span><span class="n">hacked</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">())</span> <span class="c1"># a generator for a thread</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="p">{</span> <span class="n">t</span><span class="p">:</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">trace</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chosen</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">threads</span><span class="p">[</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">trace</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">T</span><span class="p">[</span><span class="n">chosen</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">chosen</span><span class="p">]</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T</span><span class="p">[</span><span class="n">chosen</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">S</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Class</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;s</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">freeze</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;Create an object&#39;s hashable frozen (immutable) counterpart&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nb">zip</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot freeze&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Serialize all model checking results&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CLASS(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">Class</span><span class="o">.</span><span class="n">hacked_src</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sid</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s0</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sid</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">sid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;s</span><span class="si">{</span><span class="n">sid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">vertices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">mk</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">marker_fn</span> <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">state</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;STATE(</span><span class="si">{</span><span class="n">name</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">mk</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">chosen</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TRANS(</span><span class="si">{</span><span class="n">name</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">name</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">chosen</span><span class="p">])</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_bfs</span><span class="p">(</span><span class="n">Class</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Enumerate all possible thread interleavings of @mc.thread functions&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s0</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># breadth-first search to find all possible thread interleavings</span>
</span></span><span class="line"><span class="cl">    <span class="n">queue</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">s0</span><span class="p">],</span> <span class="p">{</span><span class="n">s0</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">s0</span><span class="p">},</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">u</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">trace</span> <span class="o">+</span> <span class="p">[</span><span class="n">chosen</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">vertices</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">chosen</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">serialize</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">src</span><span class="p">,</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read_text</span><span class="p">(),</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">exec</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">vars</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="o">=</span> <span class="p">[</span><span class="n">C</span> <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">setattr</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">check_bfs</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>$Model$ $\Longrightarrow$ $Input$</p>
</li>
<li>
<p>$checker$ $\Longrightarrow$ éå†æ‰€æœ‰çŠ¶æ€</p>
</li>
<li>
<p>é€šè¿‡ä¸€äº›classæ¥è¯´æ˜ä½ çš„å¹¶å‘ç®—æ³•ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/mutex-bad.py" target="_blank" rel="noopener noreffer">mutex-bad.py</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/peterson-flag.py" target="_blank" rel="noopener noreffer">peterson-flag.py</a>, <a href="https://jyywiki.cn/pages/OS/2022/demos/dekker.py" target="_blank" rel="noopener noreffer">dekker.py</a></p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Mutex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@thread</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">cs</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;blue&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_t2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;green&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@marker</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mark_both</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">localvar</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä½¿ç”¨ä¾‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">python3 model-checker.py peterson-flag.py
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>åé¢è·Ÿç€modelçš„å‚æ•°è„šæœ¬å³å¯</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆè¾“å‡ºæ¨¡å¼è¿™ä¹ˆåäººç±» $\Longrightarrow$ å› ä¸ºè¾“å‡ºæ˜¯ç»™ç¨‹åºçœ‹çš„ï¼Œåé¢çš„pythonè„šæœ¬å¯ä»¥å†™ä¸€äº›lambdaè¡¨è¾¾å¼æ¥æå–ä¿¡æ¯ $\Longrightarrow$ åŠ åˆ°åæœŸçš„å·¥å…·<a href="http://jyywiki.cn/pages/OS/2022/demos/visualize.py" target="_blank" rel="noopener noreffer">visualize.py</a>ï¼Œç›´æ¥å¯è§†åŒ–ï¼ˆå¾ˆåƒä¹‹å‰<b>zweix</b>å¤§ä½¬çš„<a href="https://github.com/zweix123/jyyslide-md" target="_blank" rel="noopener noreffer">jyyslide-md</a>ï¼‰çš„markdownè½¬htmlçš„æ„Ÿè§‰å¾ˆåƒ</p>
</li>
<li>
<p>å®‰è£…ç›¸å…³æ¨¡å—ï¼Œé™¤äº†pipçš„ä»¥å¤–Linuxçš„æœºå™¨ä¸Šè¦å®‰è£…graphviz</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install graphviz
</span></span><span class="line"><span class="cl">pip install graphviz
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç„¶åé€šè¿‡ç®¡é“é€šä¿¡å’Œé‡å®šå‘</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">python3 model-checker.py peterson-flag.py <span class="p">|</span> python3 visualize.py &gt; a.html
</span></span><span class="line"><span class="cl">open a.html
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/Jungle430/check-for-NJU-OS" target="_blank" rel="noopener noreffer">ä¸€ä¸ªcheckerçš„demo</a></p>
<h4 id="ä»£ç å¯¼è¯»python-generator">ä»£ç å¯¼è¯»ï¼šPython Generator</h4>
<p>æ­»å¾ªç¯ä¹Ÿèƒ½è¿”å›ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">numbers</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="n">init</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">+=</span> <span class="n">step</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">numbers</span> <span class="n">at</span> <span class="mh">0x107f873c0</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">g</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">g</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>yield</code>è®©æ­»å¾ªç¯è¿”å›ï¼Œä½†åˆ<b>ä¸æ˜¯å®Œå…¨è¿”å›</b></li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter4-1.png" title="/img/Operating System/chapter4-1.png" data-thumbnail="/img/Operating System/chapter4-1.png" data-sub-html="<h2>æ•ˆæœ $\Longrightarrow$ gå°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœº</h2>">
        
    </a><figcaption class="image-caption">æ•ˆæœ $\Longrightarrow$ gå°±æ˜¯ä¸€ä¸ª<code>çŠ¶æ€æœº</code></figcaption>
    </figure>
<ul>
<li>
<p>æ–‡ç« <a href="https://blog.csdn.net/mieleizhi0522/article/details/82142856" target="_blank" rel="noopener noreffer">ã€Špythonä¸­yieldçš„ç”¨æ³•è¯¦è§£â€”â€”æœ€ç®€å•ï¼Œæœ€æ¸…æ™°çš„è§£é‡Šã€‹</a></p>
</li>
<li>
<p>è¿™é‡Œå°±æ¨¡ä»¿äº†çº¿ç¨‹çš„æ‰§è¡Œ<u>ä½¿ç”¨<code>yield</code>çš„ç‰¹æ€§</u></p>
</li>
</ul>
<h4 id="model-checker-å®ç°">Model Checker: å®ç°</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Mutex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">T1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">checkpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">checkpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">==</span> <span class="s1">&#39;ğŸ”’&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">checkpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">checkpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="s1">&#39;ğŸ”’&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">thread_state</span> <span class="o">=</span> <span class="n">mutex_obj</span><span class="p">()</span><span class="o">.</span><span class="n">T1</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="n">thread_state</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span> <span class="c1"># å•æ­¥æ‰§è¡Œä¸€è¡Œ; see: execute()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="model-checker-å®ç°-contd">Model Checker: å®ç° (cont&rsquo;d)</h4>
<p>ä»€ä¹ˆæ˜¯çŠ¶æ€ç©ºé—´ï¼Ÿ</p>
<ul>
<li>æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€æœºæ‰§è¡Œåºåˆ—</li>
<li><code>BFS</code> ç”Ÿæˆï¼Œåˆå¹¶é‡å¤çŠ¶æ€</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">[0]      T1
</span></span><span class="line"><span class="cl">[1]      T2
</span></span><span class="line"><span class="cl">[0,0]    T1 -&gt; T1
</span></span><span class="line"><span class="cl">[0,1]    T1 -&gt; T2
</span></span><span class="line"><span class="cl">[0,0,0]  T1 -&gt; T1 -&gt; T1
</span></span><span class="line"><span class="cl">[0,0,1]  T1 -&gt; T1 -&gt; T2
</span></span><span class="line"><span class="cl">[0,1,0]  T1 -&gt; T2 -&gt; T1
</span></span><span class="line"><span class="cl">...      ...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="model-checking-å’Œå·¥å…·çš„æ•…äº‹">Model Checking å’Œå·¥å…·çš„æ•…äº‹</h3>
<blockquote>
<p>Model checking is a method for formally verifying finite-state systemsâ€”â€”åªè¦èƒ½ä¸ºç³»ç»Ÿå»ºç«‹æ¨¡å‹ï¼Œå°±èƒ½ç”¨ prove by brute-force è¯æ˜æ­£ç¡®/æ‰¾åˆ°é”™è¯¯ã€‚</p>
</blockquote>
<p>Model checker çš„ä¸€åˆ‡å°±æ˜¯çŠ¶æ€æœºï¼</p>
<ul>
<li>Safety: çº¢è‰²çš„çŠ¶æ€ä¸å¯åˆ°è¾¾
<ul>
<li><em>G</em>(<em>V</em>,<em>E</em>) ä¸Šçš„å¯è¾¾æ€§é—®é¢˜</li>
</ul>
</li>
<li>(Strong) Liveness: ä»ä»»æ„çŠ¶æ€å‡ºå‘ï¼Œéƒ½èƒ½åˆ°è¾¾ç»¿/è“è‰²çŠ¶æ€
<ul>
<li><em>G</em>(<em>V</em>,<em>E</em>) ä¸Šçš„ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li>
</ul>
</li>
<li>å¦‚ä½•å±•ç¤ºè¿™ä¸ªçŠ¶æ€æœºï¼Ÿ</li>
<li>å¦‚ä½•èƒ½é¿å…æ— æ•ˆçš„æ¢ç´¢ï¼Ÿ</li>
</ul>
<h4 id="æ›´å¤šçš„-model-checker">æ›´å¤šçš„ Model Checker</h4>
<p>çœŸå®ç¨‹åºçš„çŠ¶æ€ç©ºé—´å¤ªå¤§ï¼Ÿ</p>
<ul>
<li><a href="https://dl.acm.org/doi/abs/10.1145/263699.263717" target="_blank" rel="noopener noreffer">Model checking for programming languages using VeriSoft</a> (POPL'97, ç¬¬ä¸€ä¸ª â€œsoftware model checkerâ€)</li>
<li><a href="https://dl.acm.org/doi/10.5555/1855741.1855760" target="_blank" rel="noopener noreffer">Finding and reproducing Heisenbugs in concurrent programs</a> (OSDI'08, Small Scope Hypothesis ğŸª³ğŸª³ğŸª³)</li>
<li><a href="https://dl.acm.org/doi/10.1145/1189256.1189259" target="_blank" rel="noopener noreffer">Using model checking to find serious file system errors</a> (OSDI'04, Best Paper ğŸ…ï¼Œå¯ä»¥ç”¨åœ¨ä¸å¹¶å‘çš„ç³»ç»Ÿä¸Š)</li>
</ul>
<hr>
<p>ä¸æ»¡è¶³äºç®€å•çš„å†…å­˜æ¨¡å‹ï¼Ÿ</p>
<ul>
<li><a href="https://dl.acm.org/doi/abs/10.1145/3445814.3446748" target="_blank" rel="noopener noreffer">VSync: Push-button verification and optimization for synchronization primitives on weak memory models</a> (ASPLOS'21, Distinguished Paper ğŸ…)</li>
</ul>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•ç†è§£å„ç§å¹¶å‘ç¨‹åºï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>å¹¶å‘ç¨‹åº = çŠ¶æ€æœº
<ul>
<li>çº¿ç¨‹å…±äº«å†…å­˜</li>
<li>æ¯ä¸€æ­¥éç¡®å®šé€‰æ‹©çº¿ç¨‹æ‰§è¡Œ</li>
</ul>
</li>
<li>ç”»çŠ¶æ€æœºå°±å¯¹äº†
<ul>
<li>å½“ç„¶ï¼Œç”¨å·¥å…·å¸®ä½ ç”» (model checker)</li>
</ul>
</li>
</ul>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
]]></description>
</item>
<item>
    <title>Linux x86 Program Start Up or - How the heck do we get to main()?</title>
    <link>https://Jungle430.github.io/posts/operating-system/support2/</link>
    <pubDate>Sat, 04 Mar 2023 15:47:02 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/support2/</guid>
    <description><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<ul>
<li>
<p>æ–‡ç« ä»‹ç»äº†X86ç³»ç»Ÿmainå‡½æ•°è°ƒç”¨å‰åçš„ä¸€äº›ç»†èŠ‚ï¼Œå¹¶é˜è¿°äº†Cç¨‹åºçš„<b>æ„é€ å‡½æ•°</b>å’Œ<b>ææ„å‡½æ•°</b>ï¼Œ<u>ä»¥åŠ<code>.init</code>,<code>.fini</code>,<code>init_array</code>å’Œ<code>fini_array</code>å„sectionç›¸å¯¹äºmainå‡½æ•°åŠå½¼æ­¤çš„æ‰§è¡Œé¡ºåºã€‚é—æ†¾çš„æ˜¯è¿™ç¯‡æ–‡ç« æ˜¯åŸºäº32ä½CPUæ¶æ„æ¥ç ”ç©¶çš„</u></p>
</li>
<li>
<p>æ–‡ç« å¯¹$debug$ <code>main</code>å‡½æ•°ä¹‹å‰çš„ä»£ç æœ‰ä¸€å®šçš„å¸®åŠ©æ•ˆæœ</p>
</li>
<li>
<p>ä¸»è¦ä»‹ç»äº†X86 ELFæ–‡ä»¶çš„åŠ¨æ€åŠ è½½è¿‡ç¨‹</p>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/support2-1.png" title="/img/Operating System/support2-1.png" data-thumbnail="/img/Operating System/support2-1.png" data-sub-html="<h2>æ€»ä½“æµç¨‹å›¾</h2>">
        
    </a><figcaption class="image-caption">æ€»ä½“æµç¨‹å›¾</figcaption>
    </figure>
<h2 id="è°ƒç”¨è¿‡ç¨‹åˆ†æ">è°ƒç”¨è¿‡ç¨‹åˆ†æ</h2>
<h3 id="mainå‡½æ•°çš„è°ƒç”¨">mainå‡½æ•°çš„è°ƒç”¨</h3>
<ul>
<li>å…ˆå†™ä¸€ä¸ªæœ€ç®€å•çš„Cç¨‹åºprog1.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¼–è¯‘ä¸€ä¸‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -ggdb -o prog1 prog1.c
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨ï¼š<code>-ggdb</code>çš„é€‰é¡¹ä½œç”¨ï¼šç”Ÿæˆ<code>gdb</code>ä¸“ç”¨çš„è°ƒè¯•ä¿¡æ¯ï¼Œä¼šæœ‰ä¸€äº›<code>gdb</code>ä¸“ç”¨çš„æ‰©å±•</p>
</blockquote>
<ul>
<li>ç„¶åæˆ‘ä»¬ç”¨objdumpåšä¸€ä¸‹åæ±‡ç¼–</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">objdump -d prog1 &gt; prog1.asm
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä»æˆ‘ä»¬ç»ˆç«¯æ•²å›è½¦åˆ°ç¨‹åºè¢«è½½å…¥æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆ">ä»æˆ‘ä»¬ç»ˆç«¯æ•²å›è½¦åˆ°ç¨‹åºè¢«è½½å…¥æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h4>
<ul>
<li>å½“æˆ‘ä»¬ä»ç»ˆç«¯è¾“å…¥è¦è¿è¡Œçš„ç¨‹åºæˆ–è€…æ˜¯ä»æœ‰å…³çš„<code>gui</code>ç•Œé¢ç‚¹å‡»ç›¸å…³çš„buttonçš„æ—¶å€™ï¼Œ<b>shell</b>æˆ–è€…<b>gui</b>å°±ä¼šè°ƒç”¨<code>execve()</code>ã€‚è¿™é‡Œä¸æ˜¯æˆ‘ä»¬é‡ç‚¹å…³å¿ƒçš„åœ°æ–¹ï¼Œç®€å•æ¥è¯´ï¼Œexecve()ä¼šè®¾ç«‹ä¸€ä¸ªæ ˆï¼Œç„¶åå°†å‚æ•°<code>argc</code>ï¼Œ<code>argv</code>å’Œ<code>envp</code>å‹å…¥æ ˆä¸­ã€‚æ–‡ä»¶æè¿°ç¬¦0ï¼Œ1ï¼Œ2ï¼ˆstdin, stdoutå’Œstderrï¼‰ç”±ä¹‹å‰çš„shellè®¾ç½®ï¼ŒåŠ è½½å™¨ä¼šå¸®æˆ‘ä»¬å®Œæˆæœ‰å…³é‡å®šä½çš„è®¸å¤šå·¥ä½œï¼Œå½“æ‰€æœ‰æå®šä¹‹åï¼Œæ§åˆ¶æƒä¼šä¼ é€’ç»™<code>_start()</code></li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/support2-2.png" title="/img/Operating System/support2-2.png" data-thumbnail="/img/Operating System/support2-2.png" data-sub-html="<h2>shellè¾“å…¥man execveä¹‹åçš„å‡½æ•°å£°æ˜å’Œæ‰€åœ¨ä½ç½®</h2>">
        
    </a><figcaption class="image-caption">shellè¾“å…¥<code>man execve</code>ä¹‹åçš„å‡½æ•°å£°æ˜å’Œæ‰€åœ¨ä½ç½®</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/support2-4.png" title="/img/Operating System/support2-4.png" data-thumbnail="/img/Operating System/support2-4.png" data-sub-html="<h2>evnp</h2>">
        
    </a><figcaption class="image-caption"><code>evnp</code></figcaption>
    </figure>
<h4 id="_start">_start()</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">080482e0 &lt;_start&gt;:
</span></span><span class="line"><span class="cl">80482e0:       31 ed                   xor    %ebp,%ebp
</span></span><span class="line"><span class="cl">80482e2:       5e                      pop    %esi
</span></span><span class="line"><span class="cl">80482e3:       89 e1                   mov    %esp,%ecx
</span></span><span class="line"><span class="cl">80482e5:       83 e4 f0                and    $0xfffffff0,%esp
</span></span><span class="line"><span class="cl">80482e8:       50                      push   %eax
</span></span><span class="line"><span class="cl">80482e9:       54                      push   %esp
</span></span><span class="line"><span class="cl">80482ea:       52                      push   %edx
</span></span><span class="line"><span class="cl">80482eb:       68 00 84 04 08          push   $0x8048400
</span></span><span class="line"><span class="cl">80482f0:       68 a0 83 04 08          push   $0x80483a0
</span></span><span class="line"><span class="cl">80482f5:       51                      push   %ecx
</span></span><span class="line"><span class="cl">80482f6:       56                      push   %esi
</span></span><span class="line"><span class="cl">80482f7:       68 94 83 04 08          push   $0x8048394
</span></span><span class="line"><span class="cl">80482fc:       e8 c3 ff ff ff          call   80482c4 &lt;__libc_start_main@plt&gt;
</span></span><span class="line"><span class="cl">8048301:       f4                      hlt
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä»»ä½•å€¼<code>xor</code>è‡ªèº«å¾—åˆ°çš„ç»“æœéƒ½æ˜¯0ã€‚æ‰€ä»¥<code>xor %ebp,%ebp</code>è¯­å¥ä¼šæŠŠ<code>%ebp</code>è®¾ç½®ä¸º0ã€‚ABIï¼ˆApplication Binary Interface specificationï¼‰æ¨èè¿™ä¹ˆåšï¼Œç›®çš„æ˜¯ä¸ºäº†æ ‡è®°æœ€å¤–å±‚å‡½æ•°çš„é¡µå¸§ï¼ˆframeï¼‰</li>
<li>æ¥ä¸‹æ¥ï¼Œä»æ ˆä¸­å¼¹å‡ºæ ˆé¡¶çš„å€¼ä¿å­˜åˆ°<code>%esi</code>ã€‚åœ¨æœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬æŠŠ<code>argc</code>ï¼Œ<code>argv</code>å’Œ<code>envp</code>æ”¾åˆ°äº†æ ˆé‡Œï¼Œæ‰€ä»¥ç°åœ¨çš„<code>pop</code>è¯­å¥ä¼šæŠŠ<code>argc</code>æ”¾åˆ°<code>%esi</code>ä¸­</li>
<li>è¿™é‡Œåªæ˜¯ä¸´æ—¶ä¿å­˜ä¸€ä¸‹ï¼Œç¨åæˆ‘ä»¬ä¼šæŠŠå®ƒå†æ¬¡å‹å›æ ˆä¸­</li>
<li>å› ä¸ºæˆ‘ä»¬å¼¹å‡ºäº†<code>argc</code>ï¼Œæ‰€ä»¥<code>%ebp</code>ç°åœ¨æŒ‡å‘çš„æ˜¯<code>argv</code>ã€‚<code>mov</code>æŒ‡ä»¤æŠŠ<code>argv</code>æ”¾åˆ°äº†<code>%ecx</code>ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç§»åŠ¨æ ˆæŒ‡é’ˆ</li>
<li><u>ç„¶åï¼Œå°†æ ˆæŒ‡é’ˆå’Œä¸€ä¸ªå¯ä»¥æ¸…é™¤åå››ä½çš„æ©ç åš<code>and</code>æ“ä½œã€‚æ ¹æ®å½“å‰æ ˆæŒ‡é’ˆçš„ä½ç½®ä¸åŒï¼Œæ ˆæŒ‡é’ˆå°†ä¼šå‘ä¸‹ç§»åŠ¨0åˆ°15ä¸ªå­—èŠ‚ã€‚è¿™ä¹ˆåšï¼Œä¿è¯äº†ä»»ä½•æƒ…å†µä¸‹ï¼Œæ ˆæŒ‡é’ˆéƒ½æ˜¯16å­—èŠ‚çš„å¶æ•°å€å¯¹é½çš„ã€‚å¯¹é½çš„ç›®çš„æ˜¯ä¿è¯æ ˆä¸Šæ‰€æœ‰çš„å˜é‡éƒ½èƒ½å¤Ÿè¢«å†…å­˜å’Œcacheå¿«é€Ÿçš„è®¿é—®</u></li>
<li><u>è¦æ±‚è¿™ä¹ˆåšçš„æ˜¯SSEï¼Œå°±æ˜¯æŒ‡ä»¤éƒ½èƒ½åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°ç»„ä¸Šå·¥ä½œçš„é‚£ä¸ª<b>ï¼ˆæ‰©å±•æŒ‡ä»¤é›†ï¼‰</b></u></li>
<li>ä¾‹å­ï¼šæŸæ¬¡è¿è¡Œæ—¶ï¼Œ<code>_start</code>å‡½æ•°åˆšè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œ<code>%esp</code>å¤„äº<code>0xbffff770</code>ã€‚åœ¨æˆ‘ä»¬ä»æ ˆä¸Šå¼¹å‡º<code>argc</code>åï¼Œ<code>%esp</code>æŒ‡å‘<code>0xbffff774</code>ã€‚å®ƒå‘é«˜åœ°å€ç§»åŠ¨äº†ï¼ˆæ ˆå‘ä¸‹å¢é•¿ï¼‰ã€‚å½“å¯¹æ ˆæŒ‡é’ˆæ‰§è¡Œäº†<code>and</code>æ“ä½œåï¼Œæ ˆæŒ‡é’ˆå›åˆ°äº†<code>0xbffff770</code></li>
</ul>
<h4 id="__libc_start_main">__libc_start_main</h4>
<ul>
<li>ç°åœ¨ï¼Œæˆ‘ä»¬æŠŠ<code>__libc_start_main</code>å‡½æ•°çš„å‚æ•°å‹å…¥æ ˆä¸­ã€‚ç¬¬ä¸€ä¸ªå‚æ•°<code>%eax</code>è¢«å‹å…¥æ ˆä¸­ï¼Œé‡Œé¢ä¿å­˜äº†æ— æ•ˆä¿¡æ¯ï¼ŒåŸå› æ˜¯ç¨åä¼šæœ‰ä¸ƒä¸ªå‚æ•°å°†è¢«å‹å…¥æ ˆä¸­ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯16å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥éœ€è¦ç¬¬å…«ä¸ªå‚æ•°ã€‚è¿™ä¸ªå€¼ä¹Ÿå¹¶ä¸ä¼šè¢«ç”¨åˆ°ã€‚<code>__libc_start_main</code>æ˜¯åœ¨é“¾æ¥çš„æ—¶å€™ä»glibcå¤åˆ¶è¿‡æ¥çš„ã€‚åœ¨glibcçš„ä»£ç ä¸­ï¼Œå®ƒä½äº<code>csu/libc-start.c</code>æ–‡ä»¶é‡Œã€‚<code>__libc_start_main</code>çš„å®šä¹‰å¦‚ä¸‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__libc_start_main</span><span class="p">(</span>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">main</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="o">*</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="o">*</span> <span class="n">ubp_av</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rtld_fini</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">stack_end</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/support2-3.jpg" title="/img/Operating System/support2-3.jpg" data-thumbnail="/img/Operating System/support2-3.jpg" data-sub-html="<h2>å‚æ•°è¯´æ˜</h2>">
        
    </a><figcaption class="image-caption">å‚æ•°è¯´æ˜</figcaption>
    </figure>
<ul>
<li>__libc_csu_finiå‡½æ•°ä¹Ÿæ˜¯ä»glibcè¢«é“¾æ¥è¿›æˆ‘ä»¬ä»£ç çš„ï¼Œå®ƒçš„æºä»£ç ä½äºcsu/elf-init.cä¸­</li>
</ul>
<h4 id="ç¯å¢ƒå˜é‡å“ªé‡Œå»äº†">ç¯å¢ƒå˜é‡å“ªé‡Œå»äº†ï¼Ÿ</h4>
<ul>
<li>
<p>æˆ‘ä»¬å¹¶æ²¡æœ‰è·å–envpï¼ˆæ ˆé‡ŒæŒ‡å‘æˆ‘ä»¬ç¯å¢ƒå˜é‡çš„æŒ‡é’ˆï¼‰ï¼Ÿå®ƒå¹¶ä¸æ˜¯<code>__libc_start_main</code>å‡½æ•°çš„å‚æ•°ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“mainå‡½æ•°çš„åŸå‹å…¶å®æ˜¯<code>int main(int argc, char** argv, char** envp)</code>ã€‚æ‰€ä»¥ï¼Œåˆ°åº•æ€ä¹ˆå›äº‹ï¼Ÿ</p>
</li>
<li>
<p>å…¶å®ï¼Œ<code>__libc_start_main</code>å‡½æ•°ä¼šè°ƒç”¨<code>__libc_init_first</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä½¿ç”¨å†…éƒ¨ä¿¡æ¯å»æ‰¾åˆ°ç¯å¢ƒå˜é‡ï¼ˆå®é™…ä¸Šç¯å¢ƒå˜é‡å°±ä½äº<code>argv</code>çš„ç»ˆæ­¢å­—ç¬¦nullçš„åé¢ï¼‰ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡<code>__environ</code>ï¼Œè¿™ä¸ªå…¨å±€å˜é‡å¯ä»¥è¢«<code>__libc_start_main</code>å‡½æ•°å†…éƒ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼ŒåŒ…æ‹¬è°ƒç”¨mainå‡½æ•°æ—¶ã€‚å½“<code>envp</code>å»ºç«‹äº†ä¹‹åï¼Œ<code>__libc_start_main</code>å‡½æ•°ä¼šä½¿ç”¨ç›¸åŒçš„å°æŠ€å·§ï¼Œè¶Šè¿‡envpæ•°ç»„ä¹‹åçš„<code>NULL</code>å­—ç¬¦ï¼Œè·å–å¦ä¸€ä¸ªå‘é‡â€”â€”ELFè¾…åŠ©å‘é‡ï¼ˆåŠ è½½å™¨ä½¿ç”¨å®ƒç»™è¿›ç¨‹ä¼ é€’ä¸€äº›ä¿¡æ¯ï¼‰</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__libc_init_first</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg0</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg0</span><span class="p">,</span> <span class="o">**</span><span class="n">envp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">__environ</span> <span class="o">=</span> <span class="n">envp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__libc_init</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿è¡Œç¨‹åºå‰ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡<code>LD_SHOW_AUXV=1</code>,å¯ä»¥æŸ¥çœ‹é‡Œé¢çš„å†…å®¹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nv">LD_SHOW_AUXV</span><span class="o">=</span><span class="m">1</span> ./prog1
</span></span><span class="line"><span class="cl">AT_SYSINFO:      0xe62414
</span></span><span class="line"><span class="cl">AT_SYSINFO_EHDR: 0xe62000
</span></span><span class="line"><span class="cl">AT_HWCAP:    fpu vme de pse tsc msr pae mce cx8 apic
</span></span><span class="line"><span class="cl">             mtrr pge mca cmov pat pse36 clflush dts
</span></span><span class="line"><span class="cl">             acpi mmx fxsr sse sse2 ss ht tm pbe
</span></span><span class="line"><span class="cl">AT_PAGESZ:       <span class="m">4096</span>
</span></span><span class="line"><span class="cl">AT_CLKTCK:       <span class="m">100</span>
</span></span><span class="line"><span class="cl">AT_PHDR:         0x8048034
</span></span><span class="line"><span class="cl">AT_PHENT:        <span class="m">32</span>
</span></span><span class="line"><span class="cl">AT_PHNUM:        <span class="m">8</span>
</span></span><span class="line"><span class="cl">AT_BASE:         0x686000
</span></span><span class="line"><span class="cl">AT_FLAGS:        0x0
</span></span><span class="line"><span class="cl">AT_ENTRY:        0x80482e0
</span></span><span class="line"><span class="cl">AT_UID:          <span class="m">1002</span>
</span></span><span class="line"><span class="cl">AT_EUID:         <span class="m">1002</span>
</span></span><span class="line"><span class="cl">AT_GID:          <span class="m">1000</span>
</span></span><span class="line"><span class="cl">AT_EGID:         <span class="m">1000</span>
</span></span><span class="line"><span class="cl">AT_SECURE:       <span class="m">0</span>
</span></span><span class="line"><span class="cl">AT_RANDOM:       0xbff09acb
</span></span><span class="line"><span class="cl">AT_EXECFN:       ./prog1
</span></span><span class="line"><span class="cl">AT_PLATFORM:     i686
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>å„ç§å„æ ·çš„ä¿¡æ¯ã€‚<code>AT_ENTRY</code>æ˜¯<code>_start</code>çš„åœ°å€ï¼Œè¿˜æœ‰æˆ‘ä»¬çš„UIDã€æœ‰æ•ˆUIDå’ŒGID</p>
</li>
<li>
<p><b>__libc_start_mainåŠŸèƒ½æ€»ç»“</b></p>
<ul>
<li>å¤„ç†å…³äºsetuidã€setgidç¨‹åºçš„å®‰å…¨é—®é¢˜</li>
<li>å¯åŠ¨çº¿ç¨‹</li>
<li>æŠŠ<code>fini</code>å‡½æ•°å’Œ<code>rtld_fini</code>å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>at_exit</code>è°ƒç”¨ï¼Œä½¿å®ƒä»¬åœ¨<code>at_exit</code>é‡Œè¢«è°ƒç”¨ï¼Œä»è€Œå®Œæˆç”¨æˆ·ç¨‹åºå’ŒåŠ è½½å™¨çš„è°ƒç”¨ç»“æŸä¹‹åçš„æ¸…ç†å·¥ä½œ</li>
<li>è°ƒç”¨å…¶<code>init</code>å‚æ•°</li>
<li>è°ƒç”¨<code>main</code>å‡½æ•°ï¼Œå¹¶æŠŠ<code>argc</code>å’Œ<code>argv</code>å‚æ•°ã€ç¯å¢ƒå˜é‡ä¼ é€’ç»™å®ƒ</li>
<li>è°ƒç”¨<code>exit</code>å‡½æ•°ï¼Œå¹¶å°†mainå‡½æ•°çš„è¿”å›å€¼ä¼ é€’ç»™å®ƒ</li>
</ul>
</li>
</ul>
<h4 id="__libc_csu_init">__libc_csu_init</h4>
<ul>
<li><code>__libc_start_main</code>å‡½æ•°çš„<code>init</code>å‚æ•°è¢«è®¾ç½®æˆäº†<code>__libc_csu_init</code>å‡½æ•°ï¼Œå®ƒä¹Ÿæ˜¯è¢«é“¾æ¥è¿›æˆ‘ä»¬ä»£ç çš„ã€‚å®ƒæ¥æºäºglibcæºä»£ç ä¸­çš„csu/elf-init.cã€‚å…¶Cä»£ç å¦‚ä¸‹ï¼ˆåŸä»£ç åªä¸è¿‡å¤šäº†ä¸€äº›#ifdefï¼‰ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__libc_csu_init</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_init</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">__init_array_end</span> <span class="o">-</span> <span class="n">__init_array_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="n">__init_array_start</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>åŠŸèƒ½ï¼š<b>ç”¨æˆ·åº”ç”¨ç¨‹åºçš„æ„é€ å‡½æ•°</b></p>
</li>
<li>
<p><code>__libc_csu_init</code>å‡½æ•°ç›¸å½“é‡è¦ï¼Œå› ä¸ºå®ƒæ˜¯æˆ‘ä»¬<b>å¯æ‰§è¡Œç¨‹åºçš„æ„é€ å‡½æ•°</b></p>
<ul>
<li>ï¼Ÿï¼Ÿï¼Ÿè¿™ä¸æ˜¯C++ï¼Œå“ªé‡Œæ¥çš„æ„é€ å‡½æ•°ï¼Ÿï¼Ÿï¼Ÿ $\Longrightarrow$ æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„æ¦‚å¿µå¹¶éå±äºC++ï¼Œå®ƒè¯ç”Ÿæ—©äºC++</li>
<li>å¯¹äºä»»æ„çš„å¯æ‰§è¡Œç¨‹åºéƒ½å¯ä»¥æœ‰ä¸€ä¸ªCå‡½æ•°çš„<b>æ„é€ å‡½æ•°</b><code>__libc_csu_init</code>å’ŒCå‡½æ•°çš„<b>ææ„å‡½æ•°</b><code>__libc_csu_fini</code>ã€‚<u>åœ¨æ„é€ å‡½æ•°å†…éƒ¨ï¼Œå¯æ‰§è¡Œç¨‹åºä¼šæ‰¾åˆ°å…¨å±€Cå‡½æ•°ç»„æˆçš„æ„é€ å‡½æ•°é›†ï¼Œå¹¶ä¸”è°ƒç”¨å®ƒä»¬</u>ã€‚ï¼ˆä»»ä½•ä¸€ä¸ªCç¨‹åºéƒ½æ˜¯å¯ä»¥æœ‰æ„é€ å‡½æ•°é›†çš„ï¼‰ $\Longrightarrow$ <u>the executable will look for global C level constructors and call any that it finds. It&rsquo;s possible for a C program to also have these</u>ï¼ˆåŸæ–‡ï¼‰</li>
</ul>
</li>
<li>
<p><code>__libc_csu_init</code>å‡½æ•°çš„åæ±‡ç¼–ä»£ç </p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">080483a0 &lt;__libc_csu_init&gt;:
</span></span><span class="line"><span class="cl"> 80483a0:       55                      push   %ebp
</span></span><span class="line"><span class="cl"> 80483a1:       89 e5                   mov    %esp,%ebp
</span></span><span class="line"><span class="cl"> 80483a3:       57                      push   %edi
</span></span><span class="line"><span class="cl"> 80483a4:       56                      push   %esi
</span></span><span class="line"><span class="cl"> 80483a5:       53                      push   %ebx
</span></span><span class="line"><span class="cl"> 80483a6:       e8 5a 00 00 00          call   8048405 &lt;__i686.get_pc_thunk.bx&gt;
</span></span><span class="line"><span class="cl"> 80483ab:       81 c3 49 1c 00 00       add    $0x1c49,%ebx
</span></span><span class="line"><span class="cl"> 80483b1:       83 ec 1c                sub    $0x1c,%esp
</span></span><span class="line"><span class="cl"> 80483b4:       e8 bb fe ff ff          call   8048274 &lt;_init&gt;
</span></span><span class="line"><span class="cl"> 80483b9:       8d bb 20 ff ff ff       lea    -0xe0(%ebx),%edi
</span></span><span class="line"><span class="cl"> 80483bf:       8d 83 20 ff ff ff       lea    -0xe0(%ebx),%eax
</span></span><span class="line"><span class="cl"> 80483c5:       29 c7                   sub    %eax,%edi
</span></span><span class="line"><span class="cl"> 80483c7:       c1 ff 02                sar    $0x2,%edi
</span></span><span class="line"><span class="cl"> 80483ca:       85 ff                   test   %edi,%edi
</span></span><span class="line"><span class="cl"> 80483cc:       74 24                   je     80483f2 &lt;__libc_csu_init+0x52&gt;
</span></span><span class="line"><span class="cl"> 80483ce:       31 f6                   xor    %esi,%esi
</span></span><span class="line"><span class="cl"> 80483d0:       8b 45 10                mov    0x10(%ebp),%eax
</span></span><span class="line"><span class="cl"> 80483d3:       89 44 24 08             mov    %eax,0x8(%esp)
</span></span><span class="line"><span class="cl"> 80483d7:       8b 45 0c                mov    0xc(%ebp),%eax
</span></span><span class="line"><span class="cl"> 80483da:       89 44 24 04             mov    %eax,0x4(%esp)
</span></span><span class="line"><span class="cl"> 80483de:       8b 45 08                mov    0x8(%ebp),%eax
</span></span><span class="line"><span class="cl"> 80483e1:       89 04 24                mov    %eax,(%esp)
</span></span><span class="line"><span class="cl"> 80483e4:       ff 94 b3 20 ff ff ff    call   *-0xe0(%ebx,%esi,4)
</span></span><span class="line"><span class="cl"> 80483eb:       83 c6 01                add    $0x1,%esi
</span></span><span class="line"><span class="cl"> 80483ee:       39 fe                   cmp    %edi,%esi
</span></span><span class="line"><span class="cl"> 80483f0:       72 de                   jb     80483d0 &lt;__libc_csu_init+0x30&gt;
</span></span><span class="line"><span class="cl"> 80483f2:       83 c4 1c                add    $0x1c,%esp
</span></span><span class="line"><span class="cl"> 80483f5:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 80483f6:       5e                      pop    %esi
</span></span><span class="line"><span class="cl"> 80483f7:       5f                      pop    %edi
</span></span><span class="line"><span class="cl"> 80483f8:       5d                      pop    %ebp
</span></span><span class="line"><span class="cl"> 80483f9:       c3                      ret
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¿™ä¸ªå‡½æ•°éƒ½åšäº†ä»€ä¹ˆ">è¿™ä¸ªå‡½æ•°éƒ½åšäº†ä»€ä¹ˆï¼Ÿ</h5>
<h6 id="get_pc_truckå‡½æ•°">get_pc_truckå‡½æ•°</h6>
<ul>
<li>è¯¥å‡½æ•°æ˜¯ç»™ä½ç½®æ— å…³ç ä½¿ç”¨çš„ã€‚è®¾ç½®å®ƒä»¬å¯ä»¥è®©ä½ç½®æ— å…³ç æ­£å¸¸å·¥ä½œã€‚ä¸ºäº†è®©å®ƒä»¬å·¥ä½œï¼ŒåŸºå€å¯„å­˜å™¨ï¼ˆ%ebpï¼‰éœ€è¦çŸ¥é“<code>GLOBAL_OFFSET_TABLE</code>ã€‚å…¶éƒ¨åˆ†ä»£ç å¦‚ä¸‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">push %ebx
</span></span><span class="line"><span class="cl">call __get_pc_thunk_bx
</span></span><span class="line"><span class="cl">add  $_GLOBAL_OFFSET_TABLE_,%ebx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">__get_pc_thunk_bx:
</span></span><span class="line"><span class="cl">movel (%esp),%ebx
</span></span><span class="line"><span class="cl">return
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>è¿‡ç¨‹åˆ†æ</p>
<ul>
<li>
<p>è°ƒç”¨<code>__get_pc_thunk_bx</code>æ—¶ï¼Œåƒæ‰€æœ‰å…¶ä»–å‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œå°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‹å…¥æ ˆä¸­ï¼ˆè®¡ç»„ï¼šä¿å­˜ä¸Šä¸€çº§ç¨‹åºçš„<b>PC</b>ï¼‰ã€‚è¿™æ ·ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œå°±ä¼šç»§ç»­æ‰§è¡Œä¸‹æ¡æŒ‡ä»¤</p>
</li>
<li>
<p>åœ¨<code>__get_pc_thunk_bx</code>ä¸­ï¼Œæˆ‘ä»¬å°†è¿”å›åœ°å€ä»æ ˆä¸­å¤åˆ¶åˆ°<code>%ebx</code>ä¸­ã€‚å½“è¿”å›çš„æ—¶å€™ï¼Œä¸‹æ¡æŒ‡ä»¤ä¼šæŠŠ<code>_GLOBAL_OFFSET_TABLE_</code>åŠ åˆ°<code>%ebx</code>ä¸Šå»ï¼ˆå‰3å¥ï¼‰</p>
</li>
<li>
<p>å…¶ä¸­<code>_GLOBAL_OFFSET_TABLE_</code>ä»£è¡¨äº†å½“å‰åœ°å€å’Œä½ç½®æ— å…³ç ä½¿ç”¨çš„<code>GOT(global offset table)</code>çš„å·®å€¼</p>
</li>
<li>
<p>åœ¨<code>GOT</code>ä¸­ä¿å­˜äº†æˆ‘ä»¬æƒ³è®¿é—®çš„å˜é‡çš„æŒ‡é’ˆçš„é›†åˆï¼Œ<b>å¹¶ä¸”æˆ‘ä»¬åªéœ€è¦çŸ¥é“æ•°æ®åœ¨è¿™ä¸ªè¡¨ä¸­çš„åç§»é‡å°±è¡Œ</b></p>
</li>
<li>
<p>åŠ è½½å™¨ä¼šä¸ºæˆ‘ä»¬ä¿®æ”¹è¿™ä¸ªè¡¨é‡Œé¢çš„åœ°å€ã€‚å¯¹äºå‡½æ•°æ¥è®²ï¼Œä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„è¡¨ï¼ˆPLTï¼‰</p>
</li>
<li>
<p><u>æ±‡ç¼–é‡Œé¢è¿™ä¹ˆç¼–å†™å®åœ¨æ˜¯å¤ªçƒ¦äººäº†ï¼Œä½†æ˜¯ï¼Œåœ¨Cæˆ–è€…C++ä¸­ï¼Œä½ å¯ä»¥å°†-picå‚æ•°ä¼ é€’ç»™ç¼–è¯‘å™¨ï¼Œå®ƒå°†ä¼šè‡ªåŠ¨å¸®ä½ å®Œæˆè¿™ä¸ªå·¥ä½œ</u><b>ï¼ˆä½ çŸ¥é“ä½ ä¸ç”¨å…³å¿ƒè¿™ä¸ªäº‹æƒ…å°±å¯ä»¥äº†ï¼ˆmdå°±æ€•è‡ªå·±å†â„¢ï¸é’»ç‰›è§’å°–ï¼‰ï¼‰</b></p>
</li>
</ul>
</li>
<li>
<p>å’Œ64ä½æœ‰å…³çš„åŒºåˆ«</p>
</li>
</ul>
<blockquote>
<p><em>ä¸Šè¿°Â·get_pc_truckÂ·å‡½æ•°çš„ä¸»è¦ç›®çš„å…¶å®æ˜¯è·å–å˜é‡å¯¹åº”çš„GOTï¼Œä»¥é€šè¿‡å®ƒè·å–å˜é‡çœŸæ­£çš„å€¼ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆå†™ï¼Œæ˜¯å› ä¸ºåœ¨32ä½ç³»ç»Ÿé‡Œï¼Œæ²¡æœ‰ç±»ä¼¼äºripçš„å¯„å­˜å™¨ï¼Œå› æ­¤å¹¶ä¸èƒ½ç›´æ¥è·å–å½“å‰æŒ‡ä»¤çš„åœ°å€ï¼Œè€Œåœ¨64ä½ç³»ç»Ÿé‡Œå°±ä¸ç”¨è¿™ç§å°æŠ€å·§äº†</em></p>
<ul>
<li>
<p>æœ‰å…³é˜…è¯»</p>
<ul>
<li>
<p><a href="https://blog.csdn.net/mw_nice/article/details/100022610" target="_blank" rel="noopener noreffer">ã€ŠLinuxä¸­çš„GOTå’ŒPLTåˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿã€‹</a> ï¼ˆåŸæ¥çš„åšå®¢å¯„äº†ï¼Œåœ¨CSDNæ‰¾åˆ°äº†è½¬è½½ï¼‰</p>
</li>
<li>
<p><a href="https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html" target="_blank" rel="noopener noreffer">ã€ŠPLT and GOT - the key to code sharing and dynamic librariesã€‹</a> ï¼ˆè‹±æ–‡åŸæ–‡ï¼‰</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<h6 id="å‰©ä¸‹çš„å¾ªç¯åœ¨å¹²ä»€ä¹ˆ">å‰©ä¸‹çš„å¾ªç¯åœ¨å¹²ä»€ä¹ˆï¼Ÿ</h6>
<ul>
<li>ç°åœ¨æˆ‘ä»¬åªè¦è®°ä½ï¼š<b>ç¿»è¯‘çš„ä¸å¥½ï¼Œè¿™é‡Œå»ºè®®çœ‹åŸæ–‡</b></li>
</ul>
<blockquote>
<p>For now, just remember that it calls any C level initializers for our program.</p>
</blockquote>
<p>ä¸­æ–‡ç¿»è¯‘ç‰ˆï¼š</p>
<blockquote>
<p><b>å®ƒè°ƒç”¨äº†ç”¨æˆ·ç¨‹åºä¸­æ‰€æœ‰ç”¨Cä»£ç ç¼–å†™çš„<code>initializers</code></b></p>
</blockquote>
<ul>
<li>ä¸­æ–‡è¿™ä¸ªç‰ˆæœ¬å®¹æ˜“è®©äººçœ‹è·‘äº†ï¼Œè¿™ä¸ªCä»£ç ä¸ä¸€å®šæ˜¯è‡ªå·±ç¼–å†™çš„ï¼Œåªè¦æ˜¯<b>C level</b>çº§åˆ«çš„<b>initializers</b>ï¼ˆåé¢æœ‰é¢„å¤„ç†ï¼Œé“¾æ¥ï¼Œä¸­è¯‘å®¹æ˜“è®©äººçœ‹è·‘ï¼‰</li>
</ul>
<h4 id="_initå‡½æ•°åˆ†æ">_initå‡½æ•°åˆ†æ</h4>
<h5 id="æºç ">æºç </h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">08048274 &lt;_init&gt;:
</span></span><span class="line"><span class="cl"> 8048274:       55                      push   %ebp
</span></span><span class="line"><span class="cl"> 8048275:       89 e5                   mov    %esp,%ebp
</span></span><span class="line"><span class="cl"> 8048277:       53                      push   %ebx
</span></span><span class="line"><span class="cl"> 8048278:       83 ec 04                sub    $0x4,%esp
</span></span><span class="line"><span class="cl"> 804827b:       e8 00 00 00 00          call   8048280 &lt;_init+0xc&gt;
</span></span><span class="line"><span class="cl"> 8048280:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 8048281:       81 c3 74 1d 00 00       add    $0x1d74,%ebx        (.got.plt)
</span></span><span class="line"><span class="cl"> 8048287:       8b 93 fc ff ff ff       mov    -0x4(%ebx),%edx
</span></span><span class="line"><span class="cl"> 804828d:       85 d2                   test   %edx,%edx
</span></span><span class="line"><span class="cl"> 804828f:       74 05                   je     8048296 &lt;_init+0x22&gt;
</span></span><span class="line"><span class="cl"> 8048291:       e8 1e 00 00 00          call   80482b4 &lt;__gmon_start__@plt&gt;
</span></span><span class="line"><span class="cl"> 8048296:       e8 d5 00 00 00          call   8048370 &lt;frame_dummy&gt;
</span></span><span class="line"><span class="cl"> 804829b:       e8 70 01 00 00          call   8048410 &lt;__do_global_ctors_aux&gt;
</span></span><span class="line"><span class="cl"> 80482a0:       58                      pop    %eax
</span></span><span class="line"><span class="cl"> 80482a1:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 80482a2:       c9                      leave
</span></span><span class="line"><span class="cl"> 80482a3:       c3                      ret
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è°ƒç”¨">è°ƒç”¨</h5>
<ul>
<li>å½“åŠ è½½å™¨å°†æ§åˆ¶æƒäº¤ç»™<code>_start</code>å‡½æ•°ä¹‹åï¼Œ<code>_start</code>å‡½æ•°å°†ä¼šè°ƒç”¨<code>__libc_start_main</code>å‡½æ•°ï¼Œ<code>__libc_start_main</code>å‡½æ•°ä¼šè°ƒç”¨<code>__libc_csu_init</code>å‡½æ•°, <code>__libc_csu_init</code>å‡½æ•°ä¼šè°ƒç”¨<code>_init</code>å‡½æ•°</li>
</ul>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>End in 2023-03-08 0:44</p>
<p>è¿™ç§çœŸğŸ”8ï¸âƒ£ğŸ‘¨çš„æ–‡ç« çœŸæ˜¯çœ‹ç‚¹å°±çœ‹ä¸ä¸‹å»äº†ï¼Œæ˜å¤©æ¦‚ç‡è®ºï¼Œå…ˆç¡</p>
<p>æŸ<a href="https://daonan233.github.io" target="_blank" rel="noopener noreffer">55</a>ä»Šå¤©ç©äº†5h âšªï¼Œæ™šä¸Šå¸è½½ä¹‹åğŸ è‡ªå·±æ˜¯<b>S</b>ğŸ…±ï¸ï¼Œåªèƒ½è¯´æ˜¯dinnerè¡Œä¸ºäº†å§</p>
</div>
        </div>
    </div>
<h5 id="_initå‡½æ•°èµ·å§‹äºå¸¸è§„çš„cå‡½æ•°è°ƒç”¨"><code>_init</code>å‡½æ•°èµ·å§‹äºå¸¸è§„çš„Cå‡½æ•°è°ƒç”¨</h5>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Update in 2023-03-08 10:04</p>
<p>ç¡é†’äº†ï¼Œæ„Ÿè§‰çœ‹äº†èƒ½æœ‰ä¸€åŠå¤šäº†ï¼Œä»Šå¤©å†çœ‹ç‚¹</p>
</div>
        </div>
    </div>
<ul>
<li>
<p>å¦‚æœæƒ³è¦è¯¦ç»†äº†è§£Cå‡½æ•°è°ƒç”¨è§„èŒƒï¼Œè¯·é˜…è¯»<a href="http://dbp-consulting.com/tutorials/debugging/basicAsmDebuggingGDB.html" target="_blank" rel="noopener noreffer">ã€ŠBasic Assembler Debugging with GDBã€‹</a></p>
</li>
<li>
<p>å¤§è‡´è¿‡ç¨‹</p>
<ul>
<li>è°ƒç”¨è€…çš„åŸºå€å¯„å­˜å™¨ï¼ˆ<code>%ebp</code>ï¼‰ä¼šè¢«ä¿å­˜åˆ°æ ˆé‡Œ(8048274)</li>
<li>å½“å‰å‡½æ•°çš„åŸºå€å¯„å­˜å™¨ï¼ˆ<code>%ebp</code>ï¼‰ä¼š<b>æŒ‡å‘æ ˆé¡¶</b>(8048275)</li>
<li>ç„¶åï¼Œ<b>ä¿ç•™4ä¸ªå­—èŠ‚ç©ºé—´</b>(8048278) $\Longrightarrow$ <u>æ›´å¥½çš„è§£é‡Šæ˜¯pushä¹‹å<code>%esp</code>è¦sub $0x4 æ¥ä¿è¯æ ˆæŒ‡é’ˆä»ç„¶æŒ‡å‘æ ˆé¡¶ï¼ˆæ ˆå‘ä¸‹å¢é•¿ï¼‰</u></li>
<li>è¿™ä¸ªè¿‡ç¨‹å’Œè°ƒç”¨<code>get_pc_trunk</code>éå¸¸åƒ</li>
</ul>
</li>
<li>
<p>è¦å¤§è‡´äº†è§£ä¸€ä¸‹stackå’Œfunctionè°ƒç”¨çš„å…³ç³»ï¼Œé˜…è¯»æ–‡ç« <a href="https://blog.csdn.net/max_ii_min/article/details/116047509?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167824270516800182771276%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=167824270516800182771276&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-116047509-null-null.142%5ev73%5ewechat,201%5ev4%5eadd_ask,239%5ev2%5einsert_chatgpt&amp;utm_term=esp%E5%AF%84%E5%AD%98%E5%99%A8&amp;spm=1018.2226.3001.4187" target="_blank" rel="noopener noreffer">ã€Šæ±‡ç¼–-æ ˆå¸§-å¯„å­˜å™¨esp, ebpã€‹</a></p>
</li>
<li>
<p>å¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œå‘ç°è°ƒç”¨çš„æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Ÿï¼Ÿï¼Ÿå•¥æ“ä½œï¼Ÿï¼Ÿï¼Ÿ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> 804827b:       e8 00 00 00 00          call   8048280 &lt;_init+0xc&gt;
</span></span><span class="line"><span class="cl"> 8048280:       5b                      pop    %ebx
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç»™äººæ„Ÿè§‰è¿™å°±æ˜¯åœ¨é¡ºåºæ‰§è¡Œï¼Œä¸è¿‡ä½ è¦ç”¨å‡½æ•°è°ƒç”¨çš„å‹æ ˆå‡ºæ ˆæ¥å¹²ä»€ä¹ˆï¼Ÿ
<ul>
<li>$\Longrightarrow$ <b>å½“å‰çš„åœ°å€è¢«å‹å…¥äº†æ ˆä¸­ã€‚ç„¶åé€šè¿‡å¼¹å‡ºæ ˆæ“ä½œï¼ŒåˆæŠŠå®ƒæ”¾åˆ°äº†<code>%ebx</code>ä¸­ï¼Œä¹‹åå°±å¯ä»¥ç”¨å®ƒæ¥è®¾ç½®è®¿é—®å…¨å±€è®¿é—®è¡¨äº†(.got.plt)</b></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> 8048277:       53                      push   %ebx
</span></span><span class="line"><span class="cl"> 8048278:       83 ec 04                sub    $0x4,%esp
</span></span><span class="line"><span class="cl"> 804827b:       e8 00 00 00 00          call   8048280 &lt;_init+0xc&gt;
</span></span><span class="line"><span class="cl"> 8048280:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 8048281:       81 c3 74 1d 00 00       add    $0x1d74,%ebx        (.got.plt)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="gmon_startå‡½æ•°åˆ†æ">gmon_startå‡½æ•°åˆ†æ</h4>
<h5 id="ç”Ÿæˆprofilehttpsenwikipediaorgwikiprofiling_computer_programmingæ–‡ä»¶">ç”Ÿæˆ<a href="https://en.wikipedia.org/wiki/Profiling_%28computer_programming%29" target="_blank" rel="noopener noreffer">profile</a>æ–‡ä»¶</h5>
<ul>
<li><code>gmon_start</code>å‡½æ•°ã€‚å¦‚æœå®ƒæ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬è·³è¿‡å®ƒï¼Œä¸è°ƒç”¨å®ƒã€‚å¦åˆ™ï¼Œè°ƒç”¨å®ƒæ¥è®¾ç½®profilingã€‚è¯¥å‡½æ•°è°ƒç”¨ä¸€ä¸ªä¾‹ç¨‹å¼€å§‹profilingï¼Œå¹¶ä¸”è°ƒç”¨<code>at_exit</code>å»è°ƒç”¨å¦ä¸€ä¸ªç¨‹åºè¿è¡Œ,å¹¶ä¸”åœ¨è¿è¡Œç»“æŸçš„æ—¶å€™ç”Ÿæˆgmon.out</li>
</ul>
<blockquote>
<p><em>ä¸ºäº†ä¼˜åŒ–è½¯ä»¶ä¸­é¢‘ç¹è°ƒç”¨çš„éƒ¨åˆ†ï¼Œä»è€Œæé«˜ç¨‹åºæ•´ä½“æ‰§è¡Œçš„æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨gccç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š</em> <code>-pg</code><em>æ ‡å¿—ã€‚è¿™æ ·åœ¨ç¨‹åºè¿è¡Œç»“æŸçš„æ—¶å€™ä¼šç”Ÿæˆä¸€ä¸ªè®°å½•ç¨‹åºè¿è¡ŒçŠ¶æ€çš„æ–‡ä»¶å«åš</em><code>gmon.out</code><em>ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåä¸º</em><code>gprof</code><em>çš„GNU profilerå·¥å…·æ¥åˆ†æè¯¥æ–‡ä»¶ä»è€Œè·å¾—ç¨‹åºå„éƒ¨åˆ†çš„è¿è¡Œæ—¶é—´ï¼Œæ¥åæ˜ å…¶è¿è¡Œæ€§èƒ½</em></p>
<p>ç›¸å…³æ–‡ç« ï¼š<a href="https://developer.ibm.com/" target="_blank" rel="noopener noreffer">ã€ŠHome IBM Developerã€‹</a></p>
</blockquote>
<h4 id="frame_dummyå‡½æ•°åˆ†æ">frame_dummyå‡½æ•°åˆ†æ</h4>
<ul>
<li><u>æ— è®ºé‚£ç§æƒ…å†µï¼ˆå‰é¢å‡½æ•°çš„æ‰§è¡Œæƒ…å†µï¼‰</u>(åŸæ–‡æ˜¯In either case)ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å°†è°ƒç”¨<code>frame_dummy</code>å‡½æ•°</li>
<li><code>frame_dummy</code>å‡½æ•°çš„ç›®çš„æ˜¯è°ƒç”¨<code>__register_frame_info</code>å‡½æ•°ï¼Œä½†æ˜¯ï¼Œè°ƒç”¨<code>frame_dummy</code>æ˜¯ä¸ºäº†ç»™ä¸Šè¿°å‡½æ•°è®¾ç½®å‚æ•°ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†åœ¨å‡ºé”™æ—¶è®¾ç½®<code>unwinding stack frames</code> $\Longrightarrow$ ä¸æ˜¯æœ¬æ¬¡é‡ç‚¹ï¼Œæƒ³äº†è§£è¯·é˜…è¯»<a href="https://stackoverflow.com/questions/2331316/what-is-stack-unwinding" target="_blank" rel="noopener noreffer">ã€ŠWhat is stack unwinding?ã€‹</a></li>
</ul>
<h4 id="_do_global_ctors_aux-longrightarrow-finally-were-getting-constructive"><code>_do_global_ctors_aux</code> $\Longrightarrow$ Finally we&rsquo;re getting constructive!</h4>
<ul>
<li>å¦‚æœåœ¨è°ƒç”¨mainå‡½æ•°ä¹‹å‰ï¼Œä½ çš„ç¨‹åºå‡ºäº†é—®é¢˜ï¼Œä½ å¾ˆå¯èƒ½éœ€è¦çœ‹çœ‹è¿™ä¸ªå‡½æ•°ã€‚å½“ç„¶ï¼Œè¿™é‡Œå­˜æ”¾äº†å…¨å±€C++å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œä¹Ÿèƒ½å­˜æ”¾å…¶ä»–ä¸œè¥¿ã€‚</li>
</ul>
<h5 id="example">Example</h5>
<ul>
<li>æˆ‘ä»¬æŠŠprog1.cä¿®æ”¹ä¸ºprog2.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="n">a_constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>void __attribute__ ((constructor)) a_constructor()</code>ï¼šå®ƒå‘Šè¯‰GCCï¼šé“¾æ¥å™¨åº”è¯¥åœ¨<code>__do_global_ctors_aux</code>ä½¿ç”¨çš„è¡¨é‡Œåˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™é‡Œ</p>
</li>
<li>
<p><code>__FUNCTION__</code>è¢«ç¼–è¯‘å™¨æ›¿æ¢æˆäº†å½“å‰å‡½æ•°çš„åå­—</p>
</li>
<li>
<p>è¿è¡Œ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./prog2
</span></span><span class="line"><span class="cl">a_constructor
</span></span><span class="line"><span class="cl">main
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åç¼–è¯‘çœ‹ä¸€ä¸‹<code>_init</code>çš„æ±‡ç¼–ï¼ˆè‡ªå·±çš„Linuxä¸Šé¢ç¼–ä¸å‡ºæ¥çš„å¯ä»¥çœ‹ä¸€ä¸‹<a href="https://stackoverflow.com/questions/27900834/do-global-ctors-aux-not-shown-in-objdump" target="_blank" rel="noopener noreffer">ã€Š__do_global_ctors_aux not shown in objdumpã€‹</a>ï¼Œä¸è¿‡çœ‹æ–‡ç« å°±è¡Œäº†ï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">08048290 &lt;_init&gt;:
</span></span><span class="line"><span class="cl"> 8048290:       55                      push   %ebp
</span></span><span class="line"><span class="cl"> 8048291:       89 e5                   mov    %esp,%ebp
</span></span><span class="line"><span class="cl"> 8048293:       53                      push   %ebx
</span></span><span class="line"><span class="cl"> 8048294:       83 ec 04                sub    $0x4,%esp
</span></span><span class="line"><span class="cl"> 8048297:       e8 00 00 00 00          call   804829c &lt;_init+0xc&gt;
</span></span><span class="line"><span class="cl"> 804829c:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 804829d:       81 c3 58 1d 00 00       add    $0x1d58,%ebx
</span></span><span class="line"><span class="cl"> 80482a3:       8b 93 fc ff ff ff       mov    -0x4(%ebx),%edx
</span></span><span class="line"><span class="cl"> 80482a9:       85 d2                   test   %edx,%edx
</span></span><span class="line"><span class="cl"> 80482ab:       74 05                   je     80482b2 &lt;_init+0x22&gt;
</span></span><span class="line"><span class="cl"> 80482ad:       e8 1e 00 00 00          call   80482d0 &lt;__gmon_start__@plt&gt;
</span></span><span class="line"><span class="cl"> 80482b2:       e8 d9 00 00 00          call   8048390 &lt;frame_dummy&gt;
</span></span><span class="line"><span class="cl"> 80482b7:       e8 94 01 00 00          call   8048450 &lt;__do_global_ctors_aux&gt;
</span></span><span class="line"><span class="cl"> 80482bc:       58                      pop    %eax
</span></span><span class="line"><span class="cl"> 80482bd:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 80482be:       c9                      leave
</span></span><span class="line"><span class="cl"> 80482bf:       c3                      ret
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°çš„åœ°å€å’Œprog1çš„åœ°å€ç•¥å¾®æœ‰æ‰€ä¸åŒã€‚<u>è¿™äº›æœ‰å·®å¼‚çš„åœ°å€ä¼¼ä¹ç›¸å¯¹äºprog1ç§»åŠ¨äº†28ä¸ªå­—èŠ‚</u>ã€‚<b>è¿™é‡Œï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°ï¼š<code>&quot;a_constructor&quot;</code>ï¼ˆåŠ ä¸Šç»“æŸç¬¦ä¸€å…±14ä¸ªå­—èŠ‚ï¼‰ã€<code>&quot;main&quot;</code>ï¼ˆåŠ ä¸Šç»“æŸç¬¦ä¸€å…±5ä¸ªå­—èŠ‚ï¼‰å’Œä¸¤ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²<code>&quot;%s\n&quot;</code>ï¼ˆ2*4ä¸ªå­—èŠ‚ï¼ŒåŠ ä¸Šä¸€ä¸ª1å­—èŠ‚çš„æ¢è¡Œç¬¦å’Œç»ˆæ­¢ç¬¦ï¼‰ï¼Œæ‰€ä»¥14 + 5 + 4 + 4 = 27ï¼Ÿ ä¼¼ä¹è¿˜å·®ä¸€ä¸ª</b>ã€‚ä¸ç®¡æ€æ ·ï¼Œè¿™åªæ˜¯ä¸ªçŒœæƒ³ï¼Œæˆ‘å°±ä¸ä»”ç»†ç ”ç©¶äº†ã€‚ç„¶åæˆ‘ä»¬å°±è¦è·³å…¥åˆ°<code>__do_global_ctors_aux</code>å‡½æ•°ä¸­å»ï¼Œçœ‹çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</li>
</ul>
<h5 id="æºç -1">æºç </h5>
<ul>
<li>ä½äºGCCæºç ä¸­çš„gcc/crtstuff.cé‡Œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__do_global_ctors_aux</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">func_ptr</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">__CTOR_END__</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="p">(</span><span class="n">func_ptr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">p</span><span class="o">--</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¦‚ä¸Šæ‰€ç¤ºï¼Œpçš„å€¼è¢«åˆå§‹åŒ–æˆ<code>__CTOR_END__</code>å‡å»ä¸€ä¸ªå­—èŠ‚ã€‚è¿™æ˜¯ä¸€ç§æŒ‡é’ˆç®—æ³•
<ul>
<li><b>å¦‚æœæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ-1è¡¨ç¤ºå‘ä¸Šç§»åŠ¨ä¸€ä¸ªæŒ‡é’ˆæˆ–è€…è¯´4ä¸ªå­—èŠ‚</b>ã€‚<u>We&rsquo;ll see that in the assembler as well. While the pointer doesn&rsquo;t have a value of -1 (cast to a pointer), we&rsquo;ll call the function we&rsquo;re pointing at, and then back the pointer up again</u></li>
<li>è¿™ä¸ªæŒ‡é’ˆæ•°ç»„èµ·å§‹äº-1ï¼Œå¹¶ä¸”åŒ…å«è‹¥å¹²ä¸ªå‡½æ•°æŒ‡é’ˆ</li>
</ul>
</li>
</ul>
<h5 id="å¯¹åº”çš„æ±‡ç¼–">å¯¹åº”çš„æ±‡ç¼–</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">08048450 &lt;__do_global_ctors_aux&gt;:
</span></span><span class="line"><span class="cl"> 8048450:       55                      push   %ebp
</span></span><span class="line"><span class="cl"> 8048451:       89 e5                   mov    %esp,%ebp
</span></span><span class="line"><span class="cl"> 8048453:       53                      push   %ebx
</span></span><span class="line"><span class="cl"> 8048454:       83 ec 04                sub    $0x4,%esp
</span></span><span class="line"><span class="cl"> 8048457:       a1 14 9f 04 08          mov    0x8049f14,%eax
</span></span><span class="line"><span class="cl"> 804845c:       83 f8 ff                cmp    $0xffffffff,%eax
</span></span><span class="line"><span class="cl"> 804845f:       74 13                   je     8048474 &lt;__do_global_ctors_aux+0x24&gt;
</span></span><span class="line"><span class="cl"> 8048461:       bb 14 9f 04 08          mov    $0x8049f14,%ebx
</span></span><span class="line"><span class="cl"> 8048466:       66 90                   xchg   %ax,%ax
</span></span><span class="line"><span class="cl"> 8048468:       83 eb 04                sub    $0x4,%ebx
</span></span><span class="line"><span class="cl"> 804846b:       ff d0                   call   *%eax
</span></span><span class="line"><span class="cl"> 804846d:       8b 03                   mov    (%ebx),%eax
</span></span><span class="line"><span class="cl"> 804846f:       83 f8 ff                cmp    $0xffffffff,%eax
</span></span><span class="line"><span class="cl"> 8048472:       75 f4                   jne    8048468 &lt;__do_global_ctors_aux+0x18&gt;
</span></span><span class="line"><span class="cl"> 8048474:       83 c4 04                add    $0x4,%esp
</span></span><span class="line"><span class="cl"> 8048477:       5b                      pop    %ebx
</span></span><span class="line"><span class="cl"> 8048478:       5d                      pop    %ebp
</span></span><span class="line"><span class="cl"> 8048479:       c3                      ret
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å‡½æ•°æœ€å¼€å§‹çš„éƒ¨åˆ†">å‡½æ•°æœ€å¼€å§‹çš„éƒ¨åˆ†</h5>
<ul>
<li>å‡½æ•°æœ€å¼€å§‹çš„éƒ¨åˆ†ä¾ç„¶éµä»äº†Cå‡½æ•°æ­£å¸¸çš„è°ƒç”¨æƒ¯ä¾‹ï¼ˆä¿å­˜è°ƒç”¨è€…çš„æ ˆåŸºå€å¯„å­˜å™¨ï¼Œè®¾ç½®å½“å‰å‡½æ•°çš„æ ˆåŸºå€å¯„å­˜å™¨ï¼‰ï¼Œæœ¬å‡½æ•°ä¸­è¿˜å¢åŠ äº†ä¸€ç‚¹ï¼šé¢å¤–æŠŠ<code>%ebx</code>ä¿å­˜åˆ°äº†æ ˆä¸­ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°åé¢ä¼šä½¿ç”¨åˆ°å®ƒã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸ºï¼ˆCä»£ç ä¸­çš„ï¼‰æŒ‡é’ˆpä¿ç•™äº†ç©ºé—´ã€‚ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œå³ä½¿æˆ‘ä»¬åœ¨æ ˆä¸Šä¸ºå…¶å¼€è¾Ÿäº†ç©ºé—´ï¼Œä½†æ˜¯ä»æœªä½¿ç”¨è¿™éƒ¨åˆ†ç©ºé—´ã€‚<b>å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œ<code>p</code>å°†ä¼šä¿å­˜åˆ°<code>%ebx</code>ä¸­ï¼Œ<code>*p</code>ä¼šä¿å­˜åˆ°<code>%eax</code>ä¸­</b>ã€‚$\Longrightarrow$ æ³¨æ„çœ‹å‰é¢_initçš„æ±‡ç¼–ï¼Œå‡½æ•°æ‰§è¡Œå®Œæ ˆé‡Œé¢å¼¹å‡ºæ¥çš„ä¸œè¥¿ï¼Œåœ¨æœ¬å‡½æ•°çš„æ±‡ç¼–é‡Œé¢æ²¡æ‰¾åˆ° ï¼ˆâ“œï¸Dï¼ŒçœŸTMéš¾æ‰¾ï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> 80482b7:       e8 94 01 00 00          call   8048450 &lt;__do_global_ctors_aux&gt;
</span></span><span class="line"><span class="cl"> 80482bc:       58                      pop    %eax
</span></span><span class="line"><span class="cl"> 80482bd:       5b                      pop    %ebx
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å¾ªç¯ä¹‹å‰çš„è®¾ç½®">å¾ªç¯ä¹‹å‰çš„è®¾ç½®</h5>
<ul>
<li>çœ‹èµ·æ¥ç¼–è¯‘å™¨åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨å¹¶æ²¡æœ‰ç›´æ¥â€œåŠ è½½<code>__CTOR_END__</code>ï¼Œç„¶åå°†å…¶å€¼å‡å»1ï¼Œå†æŸ¥æ‰¾å®ƒæŒ‡å‘çš„å†…å®¹â€ï¼Œè€Œæ˜¯ç›´æ¥åŠ è½½<code>*(__CTOR_END__ - 1)</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç«‹å³æ•°<code>0x8049f14</code>ï¼ˆæ³¨æ„ï¼Œ<code>$0x8049f14</code>æ„æ€æ˜¯ä¸€ä¸ªç«‹å³æ•°ï¼Œè€Œä¸å¸¦<code>$</code>ï¼Œåªå†™<code>0x8049f14</code>çš„æ„æ€æ˜¯è¿™ä¸ªåœ°å€æŒ‡å‘çš„å†…å®¹ï¼‰ã€‚è¿™ä¸ªæ•°é‡Œé¢çš„å†…å®¹è¢«ç›´æ¥æ”¾åˆ°äº†%eaxä¸­ï¼Œç„¶åç«‹åˆ»æ¯”è¾ƒ%eaxå’Œ-1ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™è·³è½¬åˆ°åœ°å€0x8048474ï¼Œå›æ”¶æ ˆï¼Œå¼¹å‡ºæˆ‘ä»¬ä¿å­˜åœ¨æ ˆé‡Œçš„å†…å®¹ï¼Œå‡½æ•°è°ƒç”¨ç»“æŸï¼Œè¿”å›ã€‚</li>
<li>å‡è®¾åœ¨å‡½æ•°è¡¨ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå€¼ï¼Œç«‹å³æ•°<code>0x8049f14</code>è¢«å­˜æ”¾åˆ°<code>%ebx</code>ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æŒ‡é’ˆ<code>p</code>ï¼Œç„¶åæ‰§è¡ŒæŒ‡ä»¤<code>xchg %ax,%ax</code>ï¼Œè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ$\Downarrow$</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> 8048461:       bb 14 9f 04 08          mov    $0x8049f14,%ebx
</span></span><span class="line"><span class="cl"> 8048466:       66 90                   xchg   %ax,%ax
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><b>åŸæ¥è¿™æ˜¯X86 16æˆ–è€…32ä½é‡Œçš„ä¸€ä¸ªnopï¼ˆNo Operationï¼‰è¯­å¥ã€‚å®ƒä»€ä¹ˆä¹Ÿä¸åšï¼Œåªæ˜¯å æ®äº†ä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸï¼Œèµ·ä¸€ä¸ªå ä½ç¬¦ä½œç”¨è€Œå·²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿å¾ªç¯å¼€å§‹äº<code>8048468</code>ï¼Œè€Œä¸æ˜¯<code>8048466</code>ã€‚<u>è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä½¿å¾ªç¯å¼€å§‹çš„åœ°æ–¹ä»¥4å­—èŠ‚å¯¹é½ï¼Œè¿™æ ·æ•´ä¸ªå¾ªç¯å°†ä¼šæå¤§å¯èƒ½çš„è¢«ä¿å­˜åˆ°ä¸€ä¸ªcache lineé‡Œï¼Œè€Œä¸ä¼šè¢«åˆ†æˆä¸¤æ®µï¼Œä»è€Œèµ·åˆ°åŠ é€Ÿæ‰§è¡Œçš„ä½œç”¨</u></b> ï¼ˆè¿™æ®µæ„Ÿè§‰ç¼–è¯‘å™¨å¥½ğŸ®ğŸ…±ï¸å•Šï¼‰</li>
<li>æ¥ä¸‹æ¥ï¼Œå°†<code>%ebx</code>å‡å»4ï¼Œä»è€Œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯åšå¥½å‡†å¤‡ï¼Œè°ƒç”¨<code>%eax</code>é‡Œä¿å­˜çš„åœ°å€å¯¹åº”çš„å‡½æ•°ï¼Œç„¶åå°†ä¸‹ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç§»è‡³<code>%eax</code>ä¸­ï¼Œå¹¶ä¸”å’Œ-1æ¯”è¾ƒï¼Œå¦‚æœä¸ç­‰äº-1ï¼Œå†æ¬¡è°ƒå›åˆ°ä¸Šè¿°å¾ªç¯</li>
</ul>
<h5 id="and-finally-the-epilogue">And finally the epilogue</h5>
<p>Otherwise we fall through into our function epilogue and return to <strong>_init</strong>, which immediately falls through into its epilogue and returns to <strong><strong>libc_csu_init</strong></strong>. Bet you forgot all about him. There&rsquo;s still a loop to deal with there but first&ndash;</p>
<h5 id="ä½¿ç”¨gdbæ£€æµ‹prog2">ä½¿ç”¨gdbæ£€æµ‹prog2</h5>
<ul>
<li><b>GDBæ€»æ˜¯æ˜¾ç¤ºä½ å°†è¦æ‰§è¡Œçš„ä¸‹ä¸€è¡Œæˆ–è€…ä¸‹ä¸€æ¡æŒ‡ä»¤</b></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ !gdb
</span></span><span class="line"><span class="cl">gdb prog2
</span></span><span class="line"><span class="cl">Reading symbols from /home/patrick/src/asm/prog2...done.
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> disassemble-next-line on
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> b *0x80482b7
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> at 0x80482b7
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿è¡Œè°ƒè¯•å™¨ï¼Œæ‰“å¼€<code>disassemble-next-line</code>ï¼Œè¿™æ ·å®ƒå°±ä¼šæ€»æ˜¯æ˜¾ç¤ºä¸‹ä¸€æ¡å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„æ±‡ç¼–ä»£ç ï¼Œç„¶åæˆ‘ä»¬åœ¨<code>_init</code>å‡½æ•°å°†è¦è°ƒç”¨<code>__do_global_ctors_aux</code>å‡½æ•°çš„åœ°æ–¹è®¾ç½®ä¸€ä¸ªæ–­ç‚¹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> r
</span></span><span class="line"><span class="cl">Starting program: /home/patrick/src/asm/prog2 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Breakpoint 1, 0x080482b7 in _init <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080482b7 &lt;_init+39&gt;:    e8 <span class="m">94</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> call   0x8048450 &lt;__do_global_ctors_aux&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> si
</span></span><span class="line"><span class="cl">0x08048450 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048450 &lt;__do_global_ctors_aux+0&gt;:     <span class="m">55</span> push   %ebp
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¾“å…¥<code>r</code>ç»§ç»­è¿è¡Œç¨‹åºï¼Œåˆ°è¾¾æ–­ç‚¹å¤„ã€‚å†è¾“å…¥<code>si</code>å•æ­¥æ‰§è¡ŒæŒ‡ä»¤ï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥äº†<code>__do_global_ctors_aux</code>å‡½æ•°å†…éƒ¨ã€‚åé¢ä½ ä¼šçœ‹åˆ°è‹¥å¹²æ¬¡æˆ‘å¹¶æ²¡è¾“å…¥ä»»ä½•æŒ‡ä»¤ï¼Œä½†æ˜¯GDBå´ç»§ç»­æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºæˆ‘åªæ˜¯æŒ‰äº†å›è½¦è€Œå·²ï¼ŒGDBé»˜è®¤ä¼šé‡å¤ä¸Šæ¡æŒ‡ä»¤ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘æŒ‰ä¸‹å›è½¦ï¼ŒGDBå°†ä¼šæŒ‰ç…§è¾“å…¥<code>si</code>ç»§ç»­æ‰§è¡Œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span>
</span></span><span class="line"><span class="cl">0x08048451 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048451 &lt;__do_global_ctors_aux+1&gt;:     <span class="m">89</span> e5  mov    %esp,%ebp
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048453 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048453 &lt;__do_global_ctors_aux+3&gt;:     <span class="m">53</span> push   %ebx
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048454 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048454 &lt;__do_global_ctors_aux+4&gt;:     <span class="m">83</span> ec <span class="m">04</span>   sub    <span class="nv">$0</span>x4,%esp
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048457 in __do_global_ctors_aux <span class="o">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æ‰§è¡Œå®Œç¨‹åºæœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥å°†è¦æ‰§è¡ŒçœŸæ­£çš„ä»£ç äº†ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048457 &lt;__do_global_ctors_aux+7&gt;:     a1 <span class="m">14</span> 9f <span class="m">04</span> <span class="m">08</span> mov    0x8049f14,%eax
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x0804845c in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x0804845c &lt;__do_global_ctors_aux+12&gt;:    <span class="m">83</span> f8 ff   cmp    <span class="nv">$0</span>xffffffff,%eax
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> p/x <span class="nv">$eax</span>
</span></span><span class="line"><span class="cl"><span class="nv">$1</span> <span class="o">=</span> 0x80483b4
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æˆ‘æƒ³çŸ¥é“åŠ è½½å®ŒæŒ‡é’ˆä¹‹åä¼šæ˜¯ä»€ä¹ˆæ ·ï¼Œæ‰€ä»¥è¾“å…¥äº†<code>p/x $eax</code>ï¼Œæ„æ€æ˜¯ä»¥åå…­è¿›åˆ¶çš„å½¢å¼æ‰“å°å¯„å­˜å™¨<code>%eax</code>çš„å†…å®¹ã€‚å®ƒä¸ç­‰äº-1ï¼Œæ‰€ä»¥æˆ‘ä»¬å‡å®šç¨‹åºå°†ç»§ç»­æ‰§è¡Œå¾ªç¯ã€‚ç°åœ¨ç”±äºæˆ‘çš„æœ€åä¸€æ¡æŒ‡ä»¤æ˜¯printæŒ‡ä»¤ï¼Œæ‰€ä»¥æˆ‘ä¸èƒ½æŒ‰å›è½¦ç»§ç»­æ‰§è¡Œäº†ï¼Œä¸‹æ¬¡æˆ‘å°±å¾—è¾“å…¥<code>si</code>äº†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> si
</span></span><span class="line"><span class="cl">0x0804845f in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x0804845f &lt;__do_global_ctors_aux+15&gt;:    <span class="m">74</span> <span class="m">13</span>  je     0x8048474 &lt;__do_global_ctors_aux+36&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048461 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048461 &lt;__do_global_ctors_aux+17&gt;:    bb <span class="m">14</span> 9f <span class="m">04</span> <span class="m">08</span> mov    <span class="nv">$0</span>x8049f14,%ebx
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048466 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048466 &lt;__do_global_ctors_aux+22&gt;:    <span class="m">66</span> <span class="m">90</span>  xchg   %ax,%ax
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048468 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048468 &lt;__do_global_ctors_aux+24&gt;:    <span class="m">83</span> eb <span class="m">04</span>   sub    <span class="nv">$0</span>x4,%ebx
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x0804846b in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x0804846b &lt;__do_global_ctors_aux+27&gt;:    ff d0  call   *%eax
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">a_constructor <span class="o">()</span> at prog2.c:3
</span></span><span class="line"><span class="cl"><span class="m">3</span>   void __attribute__ <span class="o">((</span>constructor<span class="o">))</span> a_constructor<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080483b4 &lt;a_constructor+0&gt;:     <span class="m">55</span> push   %ebp
</span></span><span class="line"><span class="cl">   0x080483b5 &lt;a_constructor+1&gt;:     <span class="m">89</span> e5  mov    %esp,%ebp
</span></span><span class="line"><span class="cl">   0x080483b7 &lt;a_constructor+3&gt;:     <span class="m">83</span> ec <span class="m">18</span>   sub    <span class="nv">$0</span>x18,%esp
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>è¿™éƒ¨åˆ†ä»£ç å¾ˆæœ‰æ„æ€ã€‚æˆ‘ä»¬ä¸€æ­¥æ­¥è°ƒç”¨æ¥çœ‹çœ‹ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»è¿›å…¥äº†æˆ‘ä»¬è‡ªå·±å†™çš„å‡½æ•°<code>a_constructor</code>ã€‚å› ä¸ºGDBæ˜¯èƒ½çœ‹åˆ°æˆ‘ä»¬çš„æºä»£ç çš„ï¼Œæ‰€ä»¥å®ƒåœ¨ä¸‹ä¸€è¡Œç»™å‡ºäº†æˆ‘ä»¬æºç ã€‚åˆå› ä¸ºæˆ‘æ‰“å¼€äº†<code>disassemble-next-line</code>ï¼Œæ‰€ä»¥å®ƒä¹Ÿä¼šç»™å‡ºå¯¹åº”çš„æ±‡ç¼–ä»£ç ã€‚è¿™ä¸ªä¾‹å­ä¸­è¾“å‡ºäº†å‡½æ•°æœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œå¯¹åº”äº†å‡½æ•°çš„å£°æ˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°äº†ä¸‰è¡Œæ±‡ç¼–ã€‚æœ‰æ„æ€å§ï¼Ÿç°åœ¨ï¼Œæˆ‘è¾“å…¥<code>n</code>å‘½ä»¤ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†™çš„<code>prinf</code>å°±ä¼šè¢«è°ƒç”¨äº†ã€‚ç¬¬ä¸€ä¸ªnè·³è¿‡äº†ç¨‹åºæœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œç¬¬äºŒä¸ªnæ‰§è¡Œprinfï¼Œç¬¬ä¸‰ä¸ªnæ‰§è¡Œäº†å‡½æ•°çš„ç»“å°¾éƒ¨åˆ†ã€‚å¦‚æœä½ æƒ³çŸ¥é“ä¸ºä»€ä¹ˆä½ éœ€è¦åœ¨å‡½æ•°æœ€å¼€å§‹å’Œç»“æŸéƒ¨åˆ†åšäº›å¤„ç†çš„è¯ï¼Œç°åœ¨ï¼Œä½ ä½¿ç”¨GDBçš„å•æ­¥è°ƒè¯•åº”è¯¥èƒ½çŸ¥é“ç­”æ¡ˆäº†å§ã€‚</p>
</li>
<li>
<p>ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»æŠŠ<code>a_constructor</code>å­—ç¬¦ä¸²çš„åœ°å€ä½œä¸º<code>printf</code>çš„å‚æ•°ä¿å­˜åˆ°äº†æ ˆé‡Œï¼Œå› ä¸ºç¼–è¯‘å™¨è¶³å¤Ÿçš„æ™ºèƒ½ï¼Œå‘ç°å®é™…ä¸Š<code>puts</code>å‡½æ•°æ‰æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥å®ƒè°ƒç”¨äº†<code>puts</code>å‡½æ•°ã€‚</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(gdb) n
</span></span><span class="line"><span class="cl">4       printf(&#34;%s\n&#34;, __FUNCTION__);
</span></span><span class="line"><span class="cl">=&gt; 0x080483ba &lt;a_constructor+6&gt;:     c7 04 24 a5 84 04 08   movl   $0x80484a5,(%esp)
</span></span><span class="line"><span class="cl">   0x080483c1 &lt;a_constructor+13&gt;:    e8 2a ff ff ff call   0x80482f0 &lt;puts@plt&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å› ä¸ºæˆ‘ä»¬æ­£åœ¨è¿è¡Œä¸­æ¥è°ƒè¯•ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°äº†a_constructoræ‰“å°å‡ºäº†ä¸Šé¢çš„å†…å®¹ã€‚åæ‹¬å·}å¯¹åº”äº†å‡½æ•°çš„ç»“å°¾éƒ¨åˆ†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> n
</span></span><span class="line"><span class="cl">a_constructor
</span></span><span class="line"><span class="cl"><span class="m">5</span>   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080483c6 &lt;a_constructor+18&gt;:    c9 leave  
</span></span><span class="line"><span class="cl">   0x080483c7 &lt;a_constructor+19&gt;:    c3 ret 
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æœ‰å…³<code>leave</code>æŒ‡ä»¤å®é™…æ“ä½œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> movl %ebp, %esp
</span></span><span class="line"><span class="cl"> popl %ebp
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç»§ç»­æ‰§è¡Œï¼Œæˆ‘ä»¬å°±é€€å‡ºäº†å‡½æ•°ï¼Œå¹¶è¿”å›äº†è°ƒç”¨å‡½æ•°ã€‚è¿™é‡Œæˆ‘åˆä¸å¾—ä¸è¾“å…¥<code>si</code>äº†ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> n
</span></span><span class="line"><span class="cl">0x0804846d in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x0804846d &lt;__do_global_ctors_aux+29&gt;:    8b <span class="m">03</span>  mov    <span class="o">(</span>%ebx<span class="o">)</span>,%eax
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> si
</span></span><span class="line"><span class="cl">0x0804846f in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x0804846f &lt;__do_global_ctors_aux+31&gt;:    <span class="m">83</span> f8 ff   cmp    <span class="nv">$0</span>xffffffff,%eax
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048472 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048472 &lt;__do_global_ctors_aux+34&gt;:    <span class="m">75</span> f4  jne    0x8048468 &lt;__do_global_ctors_aux+24&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> p/x <span class="nv">$eax</span>
</span></span><span class="line"><span class="cl"><span class="nv">$2</span> <span class="o">=</span> 0xffffffff
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æˆ‘æ¯”è¾ƒå¥½å¥‡ï¼Œå¹¶ä¸”å†æ¬¡çœ‹äº†ä¸€ä¸‹ï¼šè¿™æ¬¡ï¼Œæˆ‘ä»¬çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘äº†-1ï¼Œæ‰€ä»¥ï¼Œç¨‹åºé€€å‡ºäº†å¾ªç¯</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> si
</span></span><span class="line"><span class="cl">0x08048474 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048474 &lt;__do_global_ctors_aux+36&gt;:    <span class="m">83</span> c4 <span class="m">04</span>   add    <span class="nv">$0</span>x4,%esp
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048477 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048477 &lt;__do_global_ctors_aux+39&gt;:    5b pop    %ebx
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048478 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048478 &lt;__do_global_ctors_aux+40&gt;:    5d pop    %ebp
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x08048479 in __do_global_ctors_aux <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x08048479 &lt;__do_global_ctors_aux+41&gt;:    c3 ret    
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x080482bc in _init <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080482bc &lt;_init+44&gt;:    <span class="m">58</span> pop    %eax
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æˆ‘ä»¬ç°åœ¨é€€å›åˆ°äº†<code>_init</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x080482bd in _init <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080482bd &lt;_init+45&gt;:    5b pop    %ebx
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x080482be in _init <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080482be &lt;_init+46&gt;:    c9 leave  
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x080482bf in _init <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080482bf &lt;_init+47&gt;:    c3 ret    
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span><span class="line"><span class="cl">0x080483f9 in __libc_csu_init <span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>&gt; 0x080483f9 &lt;__libc_csu_init+25&gt;:  8d bb 1c ff ff ff  lea    -0xe4<span class="o">(</span>%ebx<span class="o">)</span>,%edi
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> q
</span></span><span class="line"><span class="cl">A debugging session is active.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Inferior <span class="m">1</span> <span class="o">[</span>process 17368<span class="o">]</span> will be killed.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Quit anyway? <span class="o">(</span>y or n<span class="o">)</span> y
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å›åˆ°__libc_csu_init__">å›åˆ°<code>__libc_csu_init__</code></h4>
<ul>
<li>æºç </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__libc_csu_init</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_init</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">__init_array_end</span> <span class="o">-</span> <span class="n">__init_array_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="n">__init_array_start</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¿™æ˜¯å¦ä¸€ä¸ªå‡½æ•°çš„å¾ªç¯è°ƒç”¨">è¿™æ˜¯å¦ä¸€ä¸ªå‡½æ•°çš„å¾ªç¯è°ƒç”¨</h5>
<ul>
<li><code>__init__</code>æ•°ç»„é‡Œé¢æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä½ è‚¯å®šä¸ä¼šæƒ³åˆ°ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªé˜¶æ®µè‡ªå®šä¹‰ä»£ç ã€‚è¿™æ—¶åˆšåˆšä»è¿è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„æ„é€ å‡½æ•°çš„<code>_init</code>å‡½æ•°è¿”å›ï¼Œè¿™æ„å‘³ç€ï¼Œåœ¨è¿™ä¸ªæ•°ç»„é‡Œé¢çš„å†…å®¹å°†ä¼šåœ¨æ„é€ å‡½æ•°å®Œæˆä¹‹åè¿è¡Œã€‚ä½ èƒ½é€šè¿‡æŸç§æ–¹å¼å‘Šè¯‰ç¼–è¯‘å™¨ä½ æƒ³åœ¨è¿™ä¸ªé˜¶æ®µè¿è¡ŒæŸä¸ªä½ è‡ªå®šä¹‰çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¹Ÿä¼šæ”¶åˆ°å’Œmainå‡½æ•°ç›¸åŒçš„å‚æ•°</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&#34;.init_array&#34;</span><span class="p">)))</span> <span class="n">typeof</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">*</span><span class="n">__init</span> <span class="o">=</span> <span class="n">init</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç¨‹åºå°†è¿”å›__libc_start_main__">ç¨‹åºå°†è¿”å›<code>__libc_start_main__</code></h4>
<ul>
<li>å®ƒè°ƒç”¨äº†æˆ‘ä»¬çš„mainå‡½æ•°ï¼Œç„¶åæŠŠmainå‡½æ•°çš„è¿”å›å€¼ä¼ é€’ç»™exit()å‡½æ•°</li>
</ul>
<h5 id="exitå‡½æ•°è¿è¡Œäº†æ›´å¤šçš„å¾ªç¯">exit()å‡½æ•°è¿è¡Œäº†æ›´å¤šçš„å¾ªç¯</h5>
<ul>
<li>exit()å‡½æ•°æŒ‰ç…§æ³¨å†Œé¡ºåºä¾æ¬¡è¿è¡Œäº†åœ¨at_exit()ä¸­æ³¨å†Œçš„å‡½æ•°ã€‚ç„¶åä¼šè¿è¡Œå¦å¤–ä¸€ä¸ªå¾ªç¯ï¼Œè¿™æ¬¡çš„å¾ªç¯æ˜¯åœ¨<code>__fini_</code>æ•°ç»„ä¸­å®šä¹‰çš„ã€‚åœ¨è¿è¡Œå®Œè¿™äº›å‡½æ•°ä¹‹åï¼Œå°±ä¼šè°ƒç”¨ææ„å‡½æ•°ã€‚</li>
</ul>
<h3 id="è¿™ä¸ªç¨‹åºæŠŠä¸Šé¢æ‰€æœ‰çš„è¿‡ç¨‹è”ç³»äº†èµ·æ¥">è¿™ä¸ªç¨‹åºï¼ŒæŠŠä¸Šé¢æ‰€æœ‰çš„è¿‡ç¨‹è”ç³»äº†èµ·æ¥</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">preinit</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">fini</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&#34;.init_array&#34;</span><span class="p">)))</span> <span class="n">typeof</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">*</span><span class="n">__init</span> <span class="o">=</span> <span class="n">init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&#34;.preinit_array&#34;</span><span class="p">)))</span> <span class="n">typeof</span><span class="p">(</span><span class="n">preinit</span><span class="p">)</span> <span class="o">*</span><span class="n">__preinit</span> <span class="o">=</span> <span class="n">preinit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&#34;.fini_array&#34;</span><span class="p">)))</span> <span class="n">typeof</span><span class="p">(</span><span class="n">fini</span><span class="p">)</span> <span class="o">*</span><span class="n">__fini</span> <span class="o">=</span> <span class="n">fini</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span>  <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">destructor</span><span class="p">))</span> <span class="n">destructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">my_atexit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">my_atexit2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">atexit</span><span class="p">(</span><span class="n">my_atexit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">atexit</span><span class="p">(</span><span class="n">my_atexit2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¼–è¯‘å¹¶è¿è¡Œè¿™ä¸ªå‡½æ•°ï¼ˆè¿™é‡Œæˆ‘å°†å…¶å‘½åä¸ºhooks.cï¼‰ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./hooks
</span></span><span class="line"><span class="cl">preinit
</span></span><span class="line"><span class="cl">constructor
</span></span><span class="line"><span class="cl">init
</span></span><span class="line"><span class="cl">my_atexit2
</span></span><span class="line"><span class="cl">my_atexit
</span></span><span class="line"><span class="cl">fini
</span></span><span class="line"><span class="cl">destructor
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å›é¡¾">å›é¡¾</h2>
<ul>
<li>è¿˜æ˜¯è¿™å¼ å›¾</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/support2-1.png" title="/img/Operating System/support2-1.png" data-thumbnail="/img/Operating System/support2-1.png" data-sub-html="<h2>æ€»ä½“æµç¨‹å›¾</h2>">
        
    </a><figcaption class="image-caption">æ€»ä½“æµç¨‹å›¾</figcaption>
    </figure>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li>æ±‡ç¼–çœŸTMéš¾åˆ†æ</li>
<li>ç”±äºæ˜¯32ä½çš„è€Linuxï¼Œæ‰€ä»¥æ²¡èƒ½åœ¨è‡ªå·±çš„è™šæ‹Ÿæœºä¸Šé¢å¤ç°</li>
<li>æ¶‰åŠç¼–è¯‘å’Œé“¾æ¥çš„è¿‡ç¨‹ï¼Œåº”è¯¥å»è¡¥<a href="https://luomuxiaoxiao.com/?p=137" target="_blank" rel="noopener noreffer">ã€Šè®¡ç®—æœºåŸç†ç³»åˆ—ä¹‹ä¸‰ â€”â€”â€“ å¦‚ä½•ç¼–è¯‘ç›®æ ‡æ–‡ä»¶ã€‹</a>è¿™ç¯‡æ–‡ç« </li>
</ul>
<h2 id="ç›¸å…³å‚è€ƒèµ„æ–™">ç›¸å…³å‚è€ƒèµ„æ–™</h2>
<ul>
<li>å‚è€ƒæ–‡ç« 
<ul>
<li>
<p><a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html" target="_blank" rel="noopener noreffer">ã€ŠLinux x86 Program Start Up or - How the heck do we get to main()? by Patrick Horganã€‹</a></p>
</li>
<li>
<p><a href="https://luomuxiaoxiao.com/?p=516" target="_blank" rel="noopener noreffer">ã€ŠLinux X86 ç¨‹åºå¯åŠ¨ â€“ mainå‡½æ•°æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Ÿâ€”â€”è½æœ¨è§è§çš„åšå®¢ã€‹</a>ï¼ˆå·²ä¸ä½œè€…æ²Ÿé€šï¼ŒåŒæ„éƒ¨åˆ†è½¬è½½ï¼‰</p>
</li>
<li>
<p><a href="https://www.gnu.org/software/hurd/glibc/startup.html" target="_blank" rel="noopener noreffer">ã€ŠHow libc startup in a process worksã€‹</a></p>
</li>
</ul>
</li>
</ul>
]]></description>
</item>
<item>
    <title>Chapter2-éƒ¨åˆ†äºŒåˆ·-ä¸ªäººç†è§£System call</title>
    <link>https://Jungle430.github.io/posts/operating-system/support1/</link>
    <pubDate>Sun, 26 Feb 2023 21:02:57 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/support1/</guid>
    <description><![CDATA[<h1 id="äºŒåˆ·éƒ¨åˆ†chapter2-longrightarrow-å¦‚ä½•ç†è§£system-call">äºŒåˆ·éƒ¨åˆ†Chapter2 $\Longrightarrow$ å¦‚ä½•ç†è§£<code>System call</code></h1>
<h2 id="é—®é¢˜æ„é€ æœ€å°çš„hello-worldç¨‹åº">é—®é¢˜ï¼šæ„é€ æœ€å°çš„â€Hello worldâ€ç¨‹åº</h2>
<h3 id="åŸºæœ¬ç¨‹åºå’Œé™æ€ç¼–è¯‘">åŸºæœ¬ç¨‹åºå’Œé™æ€ç¼–è¯‘</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -static hello.c -o hello <span class="o">&amp;&amp;</span> ./hello
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘å‡ºæ¥å¾ˆå¤§(Ubuntuä¸Šçº¦900KB)</p>
<ul>
<li>å¦‚æœåªç¼–è¯‘ï¼Œä¸é“¾æ¥ï¼Œçœ‹ä¸€ä¸‹objæ–‡ä»¶çš„åæ±‡ç¼–</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcc -c hello.c <span class="o">&amp;&amp;</span> objdump -d hello.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hello.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Disassembly of section .text:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000000</span> &lt;main&gt;:
</span></span><span class="line"><span class="cl">   0:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">   4:	<span class="m">55</span>                   	push   %rbp
</span></span><span class="line"><span class="cl">   5:	<span class="m">48</span> <span class="m">89</span> e5             	mov    %rsp,%rbp
</span></span><span class="line"><span class="cl">   8:	<span class="m">48</span> 8d <span class="m">05</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 	lea    0x0<span class="o">(</span>%rip<span class="o">)</span>,%rax        <span class="c1"># f &lt;main+0xf&gt;</span>
</span></span><span class="line"><span class="cl">   f:	<span class="m">48</span> <span class="m">89</span> c7             	mov    %rax,%rdi
</span></span><span class="line"><span class="cl">  12:	b8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>       	mov    <span class="nv">$0</span>x0,%eax
</span></span><span class="line"><span class="cl">  17:	e8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>       	call   1c &lt;main+0x1c&gt;
</span></span><span class="line"><span class="cl">  1c:	b8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>       	mov    <span class="nv">$0</span>x0,%eax
</span></span><span class="line"><span class="cl">  21:	5d                   	pop    %rbp
</span></span><span class="line"><span class="cl">  22:	c3                   	ret    
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å°±å’Œæ™®é€šçš„å‡½æ•°å·®ä¸å¤šï¼Œåªæœ‰å‚æ•°å‹æ ˆï¼Œcallå’Œå‚æ•°å‡ºæ ˆçš„è¿‡ç¨‹
<ul>
<li>æ™®é€šå‡½æ•°<code>fun.c</code></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">f</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -c fun.c <span class="o">&amp;&amp;</span> objdump -d fun.o 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">fun.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Disassembly of section .text:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000000</span> &lt;f&gt;:
</span></span><span class="line"><span class="cl">   0:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">   4:	<span class="m">55</span>                   	push   %rbp
</span></span><span class="line"><span class="cl">   5:	<span class="m">48</span> <span class="m">89</span> e5             	mov    %rsp,%rbp
</span></span><span class="line"><span class="cl">   8:	<span class="m">90</span>                   	nop
</span></span><span class="line"><span class="cl">   9:	5d                   	pop    %rbp
</span></span><span class="line"><span class="cl">   a:	c3                   	ret
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>å¯ä»¥çœ‹åˆ°ä¸é“¾æ¥çš„è¯å’Œæ™®é€šçš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹å·®ä¸å¤š</p>
</li>
<li>
<p>é“¾æ¥å¤±è´¥ï¼</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â—‹ â†’ ld hello.o
</span></span><span class="line"><span class="cl">ld: è­¦å‘Š: æ— æ³•æ‰¾åˆ°é¡¹ç›®ç¬¦å· _start<span class="p">;</span> ç¼ºçœä¸º <span class="m">0000000000401000</span>
</span></span><span class="line"><span class="cl">ld: hello.o: in <span class="k">function</span> <span class="sb">`</span>main<span class="s1">&#39;:
</span></span></span><span class="line"><span class="cl"><span class="s1">hello.c:(.text+0x18): undefined reference to `printf&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æœ¬æ¥ä»¥ä¸ºæ‰¾çš„<code>main</code>ï¼Œä½†æ˜¯å®ƒå®é™…ä¸Šåœ¨æ‰¾<code>_start</code>è¿™ä¸ªä¸œè¥¿ï¼Ÿ</li>
</ul>
<h3 id="é‚£æˆ‘ä»¬å°±æŠŠmainæ”¹æˆ_start">é‚£æˆ‘ä»¬å°±æŠŠ<code>main</code>æ”¹æˆ<code>_start</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/support1-1.png" title="/img/Operating System/support1-1.png" data-thumbnail="/img/Operating System/support1-1.png" data-sub-html="<h2>ldä»ç„¶ä¸äºˆé€šè¿‡-&gt; æ‰¾ä¸åˆ°printf?</h2>">
        
    </a><figcaption class="image-caption"><code>ldä»ç„¶ä¸äºˆé€šè¿‡</code>-&gt; æ‰¾ä¸åˆ°printf?</figcaption>
    </figure>
<ul>
<li>é‚£æŠŠprintfä¹Ÿç»™å»äº†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¼–è¯‘ä¸é“¾æ¥å…¨éƒ¨æˆåŠŸï¼</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â—‹ â†’ gcc -c hello.c <span class="o">&amp;&amp;</span> objdump -d hello.o <span class="o">&amp;&amp;</span> ld hello.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hello.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Disassembly of section .text:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000000</span> &lt;_start&gt;:
</span></span><span class="line"><span class="cl">   0:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">   4:	<span class="m">55</span>                   	push   %rbp
</span></span><span class="line"><span class="cl">   5:	<span class="m">48</span> <span class="m">89</span> e5             	mov    %rsp,%rbp
</span></span><span class="line"><span class="cl">   8:	<span class="m">90</span>                   	nop
</span></span><span class="line"><span class="cl">   9:	5d                   	pop    %rbp
</span></span><span class="line"><span class="cl">   a:	c3                   	ret    
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ç¨‹åºå¾ˆå°ï¼Œåªæœ‰99ä¸ªå­—èŠ‚</p>
</li>
<li>
<p>ä½†æ˜¯è¿è¡Œ $\Longrightarrow$ æ®µé”™è¯¯ï¼</p>
</li>
<li>
<p>ä½†æ˜¯é‡Œé¢åŠ å…¥while(1)è¿™ç§æ­»å¾ªç¯å°±æ²¡äº‹äº†</p>
</li>
</ul>
<hr>
<ul>
<li>å¯¹äºæ²¡æœ‰while(1)çš„a.outï¼Œä½¿ç”¨gdbç‹ ç‹ çš„æ‹·æ‰“è°ƒè¯•</li>
</ul>
<a class="lightgallery" href="/img/Operating%20System/support1-2.jpg" title="/img/Operating System/support1-2.jpg" data-thumbnail="/img/Operating System/support1-2.jpg">
        
    </a>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çœ‹åˆ°rspçš„åœ°å€æ˜¯åˆæ³•çš„ï¼Œé‡Œé¢çš„å€¼æ˜¯1ï¼Œå½“æ‰§è¡Œretåï¼Œrspå°†æ ˆé¡¶çš„å€¼1èµ‹ç»™äº†pcï¼Œgdbæ˜¾ç¤ºpcè®¿é—®äº†éæ³•ä½ç½®</p>
<figure><a class="lightgallery" href="/img/Operating%20System/support1-3.png" title="/img/Operating System/support1-3.png" data-thumbnail="/img/Operating System/support1-3.png" data-sub-html="<h2>ğŸ¤¡å‘¦å¼ï¼Œå´©æºƒäº†ï¼</h2>">
        
    </a><figcaption class="image-caption">ğŸ¤¡å‘¦å¼ï¼Œå´©æºƒäº†ï¼</figcaption>
    </figure>
<ul>
<li>CPUåªä¼šæ‰§è¡ŒæŒ‡ä»¤ï¼Œè¯¥æ€ä¹ˆåœä¸‹æ¥ï¼Ÿ(mov,addè¿™äº›æŒ‡ä»¤åœä¸ä¸‹æ¥)</li>
<li>éœ€è¦ä»€ä¹ˆæŒ‡ä»¤è®©å®ƒåœä¸‹æ¥ï¼Ÿ $\Longrightarrow$ <code>System call</code> ä¹Ÿå°±æ˜¯ç®¡æ€</li>
</ul>
<h3 id="æœ€å°çš„hello-worldç¨‹åº">æœ€å°çš„<code>Hello world</code>ç¨‹åº</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">globl</span> <span class="n">_start</span>
</span></span><span class="line"><span class="cl"><span class="nl">_start</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">SYS_write</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span>   <span class="err">#</span> <span class="n">write</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span>         <span class="o">%</span><span class="n">rdi</span>   <span class="err">#</span>   <span class="n">fd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">st</span><span class="p">,</span>        <span class="o">%</span><span class="n">rsi</span>   <span class="err">#</span>   <span class="n">buf</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="p">(</span><span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">),</span> <span class="o">%</span><span class="n">rdx</span>   <span class="err">#</span>   <span class="n">count</span><span class="o">=</span><span class="n">ed</span><span class="o">-</span><span class="n">st</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span>                 <span class="err">#</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">SYS_exit</span><span class="p">,</span>  <span class="o">%</span><span class="n">rax</span>   <span class="err">#</span> <span class="n">exit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span>         <span class="o">%</span><span class="n">rdi</span>   <span class="err">#</span>   <span class="n">status</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span>                 <span class="err">#</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">st</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">ascii</span> <span class="s">&#34;</span><span class="se">\033</span><span class="s">[01;31mHello, OS World</span><span class="se">\033</span><span class="s">[0m</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ed</span><span class="p">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å®ƒåœ¨å¹²ä»€ä¹ˆ
<ul>
<li>ç»™è®¸å¤šå¯„å­˜å™¨èµ‹å€¼ï¼Œç„¶åcalläº†syscall</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/support1-4.png" title="/img/Operating System/support1-4.png" data-thumbnail="/img/Operating System/support1-4.png" data-sub-html="<h2>ç¼–è¯‘åæŸ¥çœ‹åæ±‡ç¼–ä»£ç </h2>">
        
    </a><figcaption class="image-caption">ç¼–è¯‘åæŸ¥çœ‹åæ±‡ç¼–ä»£ç </figcaption>
    </figure>
<ul>
<li>ldé“¾æ¥ï¼Œç¼–è¯‘æˆåŠŸï¼Œè¿è¡ŒæˆåŠŸï¼</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â—‹ â†’ objdump -d a.out <span class="p">|</span> less
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/support1-5.png" title="/img/Operating System/support1-5.png" data-thumbnail="/img/Operating System/support1-5.png" data-sub-html="<h2>æŸ¥çœ‹åæ±‡ç¼–ä»£ç </h2>">
        
    </a><figcaption class="image-caption">æŸ¥çœ‹åæ±‡ç¼–ä»£ç </figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/support1-6.png" title="/img/Operating System/support1-6.png" data-thumbnail="/img/Operating System/support1-6.png" data-sub-html="<h2>man syscallæŸ¥çœ‹syscallçš„æ–‡æ¡£</h2>">
        
    </a><figcaption class="image-caption"><code>man syscall</code>æŸ¥çœ‹syscallçš„æ–‡æ¡£</figcaption>
    </figure>
<p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œsyscallä¼šå‘Šè¯‰æˆ‘ä»¬åœ¨å„ç§æ¶æ„çš„è®¡ç®—æœºä¸­è¯¥å¦‚ä½•é€šè¿‡å¯„å­˜å™¨ä¸ºsyscallä¼ å…¥å‚æ•°,<code>man syscalls</code>ä¼šå‘Šè¯‰æˆ‘ä»¬Linuxæ“ä½œç³»ç»Ÿçš„æ¥å£</p>
<ul>
<li>æ‰€ä»¥ç¨‹åºçš„æ‰§è¡Œæ¨¡å¼</li>
</ul>
<div class="mermaid" id="id-1"></div>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>æ„Ÿè°¢<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="typeit"><div id="id-2" class=""></div></div>
<p>æ„Ÿè°¢jyyäº’åŠ©ç¾¤é‡Œ<b>zweix</b>å¤§ä½¬æä¾›çš„<a href="https://github.com/zweix123/jyyslide-md" target="_blank" rel="noopener noreffer">
jyyslide-md</a></p>
<p>ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°å› ä¸ºWindowså¾ˆçƒ‚çš„ç¼–ç é—®é¢˜å§‹ç»ˆä¼šå‡ºç°gbkè§£ç é”™è¯¯çš„errorï¼Œå’Œ<b>zweix</b>å¤§ä½¬å·®ä¸å¤šæ²Ÿé€šäº†å¤§åŠä¸ªä¸‹åˆï¼Œç”±äºæ‡’å¾—ç»™vscodeé…ç¯å¢ƒç›´æ¥æ”¹æˆæ‰‹åŠ¨printçœ‹æ•°æ®ğŸ¤£ï¼Œæ„Ÿè§‰å°±æ˜¯å‘½ä»¤è¡Œä¼ å‚ç¼–ç çš„é—®é¢˜ï¼Œæœ€åç»ˆäºæ‰¾åˆ°äº†è§£å†³æ–¹æ³•ğŸ˜†ï¼Œåªèƒ½è¯´Windowsè¿™ä¸ªç¼–ç è®¾ç½®ä¹Ÿæ˜¯æ²¡è°äº†ã€‚</p>
</div>
        </div>
    </div>
]]></description>
</item>
<item>
    <title>Operating System Chapter3 å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter3/</link>
    <pubDate>Sun, 01 Jan 2023 19:59:41 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter3/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="å¤šå¤„ç†å™¨ç¼–ç¨‹ä»å…¥é—¨åˆ°æ”¾å¼ƒ">å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</h2>
<h3 id="overview">Overview</h3>
<p>å¤ä¹ </p>
<ul>
<li>ç¨‹åº (æºä»£ç <code>S</code>ã€äºŒè¿›åˆ¶ä»£ç <code>C</code>) = çŠ¶æ€æœº
<ul>
<li>ç¼–è¯‘å™¨ $C = \textrm{compile}(S)\newline$</li>
</ul>
</li>
<li>åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ = syscall æŒ‡ä»¤</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: åœ¨å¤šå¤„ç†å™¨æ—¶ä»£ï¼Œä¸Šé¢çš„ç†è§£åº”è¯¥ä½œå‡ºæ€æ ·çš„å˜åŒ–ï¼Ÿ</li>
</ul>
<hr>
<p>æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul>
<li>å¹¶å‘ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹</li>
<li>çº¿ç¨‹åº“ <code>thread.h</code></li>
<li>å¤šçº¿ç¨‹å¸¦æ¥çš„éº»çƒ¦</li>
</ul>
<h3 id="å…¥é—¨">å…¥é—¨</h3>
<h4 id="three-easy-pieces-å¹¶å‘">Three Easy Pieces: å¹¶å‘</h4>
<blockquote>
<p>Concurrent: existing, happening, or done <em>at the same time</em>.</p>
<p>In computer science, concurrency refers to the ability of different parts or units of a program, algorithm, or problem to be executed out-of-order or in partial order, without affecting the final outcome. (Wikipedia)</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆåœ¨è¿™é—¨è¯¾ (å…ˆ) è®²å¹¶å‘ï¼Ÿ</p>
<ul>
<li>è®²å¹¶å‘
<ul>
<li><strong>æ“ä½œç³»ç»Ÿæ˜¯æœ€æ—©çš„å¹¶å‘ç¨‹åºä¹‹ä¸€</strong></li>
<li>ä»Šå¤©éåœ°éƒ½æ˜¯å¤šå¤„ç†å™¨ç³»ç»Ÿ (ä¸ºä»€ä¹ˆï¼Ÿ)</li>
</ul>
</li>
<li>å…ˆè®²å¹¶å‘
<ul>
<li>å®éªŒæ˜¯ bottom-up çš„ (L1: å¤šå¤„ç†å™¨ä¸Šçš„ <code>malloc</code>/<code>free</code>)</li>
</ul>
</li>
</ul>
<h4 id="å¹¶å‘çš„åŸºæœ¬å•ä½çº¿ç¨‹">å¹¶å‘çš„åŸºæœ¬å•ä½ï¼šçº¿ç¨‹</h4>
<p>å…±äº«å†…å­˜çš„å¤šä¸ªæ‰§è¡Œæµ</p>
<ul>
<li>æ‰§è¡Œæµæ‹¥æœ‰ç‹¬ç«‹çš„å †æ ˆ/å¯„å­˜å™¨</li>
<li>å…±äº«å…¨éƒ¨çš„å†…å­˜ (æŒ‡é’ˆå¯ä»¥äº’ç›¸å¼•ç”¨)</li>
</ul>
<hr>
<p>ç”¨çŠ¶æ€æœºçš„è§†è§’å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-1.jpg" title="/img/Operating System/chapter3-1.jpg" data-thumbnail="/img/Operating System/chapter3-1.jpg" data-sub-html="<h2>æ‰‹å†™(çŠ¶æ€æœº,stack frameä¸å…±äº«å†…å­˜)</h2>">
        
    </a><figcaption class="image-caption">æ‰‹å†™(<code>çŠ¶æ€æœº,stack frameä¸å…±äº«å†…å­˜</code>)</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-2.jpg" title="/img/Operating System/chapter3-2.jpg" data-thumbnail="/img/Operating System/chapter3-2.jpg" data-sub-html="<h2>æ‰‹å†™(çº¿ç¨‹)</h2>">
        
    </a><figcaption class="image-caption">æ‰‹å†™(<code>çº¿ç¨‹</code>)</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-3.jpg" title="/img/Operating System/chapter3-3.jpg" data-thumbnail="/img/Operating System/chapter3-3.jpg" data-sub-html="<h2>æ‰‹å†™(å¹¶å‘ç¼–ç¨‹çš„ä¸ç¡®å®šæ€§)</h2>">
        
    </a><figcaption class="image-caption">æ‰‹å†™(<code>å¹¶å‘ç¼–ç¨‹çš„ä¸ç¡®å®šæ€§</code>)</figcaption>
    </figure>
<h4 id="å…¥é—¨threadh-ç®€åŒ–çš„çº¿ç¨‹-api">å…¥é—¨ï¼š<code>thread.h</code> ç®€åŒ–çš„çº¿ç¨‹ API</h4>
<p>æˆ‘ä»¬ä¸ºå¤§å®¶å°è£…äº†è¶…çº§å¥½ç”¨çš„çº¿ç¨‹ API (<a href="https://jyywiki.cn/pages/OS/2022/demos/thread.h" target="_blank" rel="noopener noreffer"><code>thread.h</code></a>)</p>
<ul>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>åˆ›å»ºä¸€ä¸ªå…¥å£å‡½æ•°æ˜¯<code>fn</code>çš„çº¿ç¨‹ï¼Œå¹¶ç«‹å³å¼€å§‹æ‰§è¡Œï¼ˆçŠ¶æ€æœºç†è§£åˆ›å»º $\rightarrow$ åœ¨çŠ¶æ€æœºé‡ŒåŠ å…¥ä¸€ä¸ªæ–°çš„æ ˆå¸§çš„åˆ—è¡¨ï¼Œå¹¶ä¸”æ¯æ¬¡å¯ä»¥é€‰åˆ°æ¯ä¸€ä¸ªé“¾è¡¨æ¥æ‰§è¡Œï¼‰</p>
<ul>
<li>
<p>void fn(int tid) { &hellip; }</p>
</li>
<li>
<p>å‚æ•° <code>tid</code> ä» 1 å¼€å§‹ç¼–å·</p>
</li>
</ul>
</li>
<li>
<p>è¯­ä¹‰ï¼šåœ¨çŠ¶æ€ä¸­æ–°å¢ stack frame åˆ—è¡¨å¹¶åˆå§‹åŒ–ä¸º <code>fn(tid)</code></p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">join</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç­‰å¾…æ‰€æœ‰è¿è¡Œçº¿ç¨‹çš„ <code>fn</code> è¿”å›</li>
<li>åœ¨ <code>main</code> è¿”å›æ—¶ä¼šè‡ªåŠ¨ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ</li>
<li><strong>è¯­ä¹‰ï¼šåœ¨æœ‰å…¶ä»–çº¿ç¨‹æœªæ‰§è¡Œå®Œæ—¶æ­»å¾ªç¯ï¼Œå¦åˆ™è¿”å›</strong>ï¼ˆç”¨çŠ¶æ€æœºç©ºè½¬çš„è§’åº¦æ¥ç†è§£ï¼‰</li>
</ul>
</li>
<li>
<p>ç¼–è¯‘æ—¶éœ€è¦å¢åŠ  <code>-lpthread</code></p>
</li>
</ul>
<p><code>thread.h</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdatomic.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define NTHREAD 64
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">enum</span> <span class="p">{</span> <span class="n">T_FREE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T_LIVE</span><span class="p">,</span> <span class="n">T_DEAD</span><span class="p">,</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="kr">thread</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="kr">thread</span> <span class="n">tpool</span><span class="p">[</span><span class="n">NTHREAD</span><span class="p">],</span> <span class="o">*</span><span class="n">tptr</span> <span class="o">=</span> <span class="n">tpool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">wrapper</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">tptr</span> <span class="o">-</span> <span class="n">tpool</span> <span class="o">&lt;</span> <span class="n">NTHREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">tptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">tptr</span> <span class="o">-</span> <span class="n">tpool</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">T_LIVE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">entry</span> <span class="o">=</span> <span class="n">fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tptr</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">,</span> <span class="n">tptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">tptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">join</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NTHREAD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">T_LIVE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pthread_join</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">t</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">T_DEAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">destructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">cleanup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å…¥é—¨-contd">å…¥é—¨ (cont&rsquo;d)</h4>
<p>Hello, Multi-threaded World!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Ta</span><span class="p">()</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tb</span><span class="p">()</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Ta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘ï¼ˆæ³¨æ„ä½¿ç”¨<code>-lpthread</code>ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc the.c -lpthread 
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œ $\rightarrow$ äº¤æ›¿è¾“å‡º</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-4.png" title="/img/Operating System/chapter3-4.png" data-thumbnail="/img/Operating System/chapter3-4.png" data-sub-html="<h2>Linux(è¾“å‡ºç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">Linux(<code>è¾“å‡ºç»“æœ</code>)</figcaption>
    </figure>
<p>åˆ©ç”¨ <code>thread.h</code> å°±å¯ä»¥å†™å‡ºåˆ©ç”¨å¤šå¤„ç†å™¨çš„ç¨‹åºï¼</p>
<ul>
<li>æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠçº¿ç¨‹æ”¾ç½®åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Š</li>
<li>åœ¨åå°è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ° CPU ä½¿ç”¨ç‡è¶…è¿‡äº† 100%ï¼ˆ2ä¸ªæ¥è¿‘200ï¼Œ 4ä¸ªæ¥è¿‘400ï¼‰$\rightarrow$ ä½¿ç”¨äº†å¤šä¸ªCPU</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-5.png" title="/img/Operating System/chapter3-5.png" data-thumbnail="/img/Operating System/chapter3-5.png" data-sub-html="<h2>top(æŸ¥çœ‹CPUä½¿ç”¨ç‡)</h2>">
        
    </a><figcaption class="image-caption">top(<code>æŸ¥çœ‹CPUä½¿ç”¨ç‡</code>)</figcaption>
    </figure>
<blockquote>
<p>ä¼šç¼–ç¨‹ï¼Œä½ å°±æ‹¥æœ‰å…¨ä¸–ç•Œï¼</p>
</blockquote>
<p>å¦‚ä½•è¯æ˜çº¿ç¨‹ç¡®å®å…±äº«å†…å­˜ï¼Ÿ</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/shm-test.c" target="_blank" rel="noopener noreffer">shm-test.c</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thello</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">usleep</span><span class="p">(</span><span class="n">id</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello from thread #%c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;123456789ABCDEF&#34;</span><span class="p">[</span><span class="n">x</span><span class="o">++</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Thello</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-6.png" title="/img/Operating System/chapter3-6.png" data-thumbnail="/img/Operating System/chapter3-6.png" data-sub-html="<h2>Linux(shm-test.cè¿è¡Œç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">Linux(<code>shm-test.cè¿è¡Œç»“æœ</code>)</figcaption>
    </figure>
<hr>
<p>å¦‚ä½•è¯æ˜çº¿ç¨‹å…·æœ‰ç‹¬ç«‹å †æ ˆ (ä»¥åŠç¡®å®šå®ƒä»¬çš„èŒƒå›´)ï¼Ÿ</p>
<ul>
<li><a href="https://jyywiki.cn/pages/OS/2022/demos/stack-probe.c" target="_blank" rel="noopener noreffer">stack-probe.c</a> (è¾“å‡ºæœ‰ç‚¹ä¹±ï¼Ÿæˆ‘ä»¬è¿˜æœ‰ <code>sort</code>!)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">__thread</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span> <span class="c1">// thread-local variables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__thread</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objdump to see how thread-local variables are implemented
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span> <span class="kt">void</span> <span class="n">set_cur</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span> <span class="kt">char</span> <span class="o">*</span><span class="n">get_cur</span><span class="p">()</span>         <span class="p">{</span> <span class="k">return</span> <span class="n">cur</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">stackoverflow</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">set_cur</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">1024</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">base</span> <span class="o">-</span> <span class="n">get_cur</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Stack size of T%d &gt;= %d KB</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">sz</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">stackoverflow</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Tprobe</span><span class="p">(</span><span class="kt">int</span> <span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">id</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">stackoverflow</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tprobe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-7.png" title="/img/Operating System/chapter3-7.png" data-thumbnail="/img/Operating System/chapter3-7.png" data-sub-html="<h2>Linux(stack-probe.cè¿è¡Œç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">Linux(<code>stack-probe.cè¿è¡Œç»“æœ</code>)</figcaption>
    </figure>
<p>è¿›è¡Œæ’åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc stack-probe.c -lpthread <span class="o">&amp;&amp;</span> ./a.out <span class="p">|</span> sort -nk <span class="m">6</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•ˆæœï¼š</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-8.png" title="/img/Operating System/chapter3-8.png" data-thumbnail="/img/Operating System/chapter3-8.png" data-sub-html="<h2>stack-probe.c(æ’åºå)</h2>">
        
    </a><figcaption class="image-caption">stack-probe.c(<code>æ’åºå</code>)</figcaption>
    </figure>
<p>$size\ of\ stack=8192KB\newline$</p>
<hr>
<p>æ›´å¤šçš„ä¹ é¢˜</p>
<ul>
<li>åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ</li>
<li>èƒ½ä¸èƒ½ç”¨ gdb è°ƒè¯•ï¼Ÿ</li>
<li>åŸºæœ¬åŸåˆ™ï¼šæœ‰éœ€æ±‚ï¼Œå°±èƒ½åšåˆ° (<a href="https://sourceware.org/gdb/onlinedocs/gdb/Threads.html" target="_blank" rel="noopener noreffer">RTFM</a>)</li>
</ul>
<h4 id="threadh-èƒŒåposix-threads"><code>thread.h</code> èƒŒåï¼šPOSIX Threads</h4>
<p>æƒ³è¿›ä¸€æ­¥é…ç½®çº¿ç¨‹ï¼Ÿ</p>
<ul>
<li>è®¾ç½®æ›´å¤§çš„çº¿ç¨‹æ ˆ</li>
<li>è®¾ç½® detach è¿è¡Œ (ä¸åœ¨è¿›ç¨‹ç»“æŸåè¢«æ€æ­»ï¼Œä¹Ÿä¸èƒ½ join)</li>
<li>â€¦â€¦</li>
</ul>
<hr>
<p>POSIX ä¸ºæˆ‘ä»¬æä¾›äº†çº¿ç¨‹åº“ (pthreads)</p>
<ul>
<li>
<p><code>man 7 pthreads</code></p>
</li>
<li>
<p>ç»ƒä¹ ï¼šæ”¹å†™ thread.hï¼Œä½¿å¾—çº¿ç¨‹æ‹¥æœ‰æ›´å¤§çš„æ ˆ</p>
<ul>
<li>å¯ä»¥ç”¨ <a href="https://jyywiki.cn/pages/OS/2022/demos/stack-probe.c" target="_blank" rel="noopener noreffer">stack-probe.c</a> éªŒè¯</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">__thread</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span> <span class="c1">// thread-local variables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__thread</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objdump to see how thread-local variables are implemented
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span> <span class="kt">void</span> <span class="n">set_cur</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span> <span class="kt">char</span> <span class="o">*</span><span class="n">get_cur</span><span class="p">()</span>         <span class="p">{</span> <span class="k">return</span> <span class="n">cur</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">stackoverflow</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">set_cur</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">1024</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">base</span> <span class="o">-</span> <span class="n">get_cur</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Stack size of T%d &gt;= %d KB</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">sz</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">stackoverflow</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Tprobe</span><span class="p">(</span><span class="kt">int</span> <span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">id</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">stackoverflow</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">Tprobe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶è€Œï¼Œå¯æ€•çš„äº‹æƒ…æ­£åœ¨æ‚„æ‚„é€¼è¿‘â€¦â€¦</p>
<ul>
<li>
<p>å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­çº¿ç¨‹çš„ä»£ç å¯èƒ½åŒæ—¶æ‰§è¡Œ</p>
<ul>
<li>ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ <code>x++</code>ï¼Œç»“æœä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</li>
</ul>
</li>
</ul>
<h3 id="æ”¾å¼ƒ1åŸå­æ€§">æ”¾å¼ƒï¼ˆ1ï¼‰ï¼šåŸå­æ€§</h3>
<h4 id="ä¾‹å­å±±å¯¨å¤šçº¿ç¨‹æ”¯ä»˜å®">ä¾‹å­ï¼šå±±å¯¨å¤šçº¿ç¨‹æ”¯ä»˜å®</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">balance</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">Alipay_withdraw</span><span class="p">(</span><span class="kt">int</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">balance</span> <span class="o">-=</span> <span class="n">amt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FAIL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ”¯ä»˜ Â¥100 ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<a href="https://jyywiki.cn/pages/OS/2022/demos/alipay.c" target="_blank" rel="noopener noreffer">alipay.c</a></p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-10.jpg" title="/img/Operating System/chapter3-10.jpg" data-thumbnail="/img/Operating System/chapter3-10.jpg" data-sub-html="<h2>æ‰‹å†™(å±±å¯¨æ”¯ä»˜å®çŠ¶æ€æœº)</h2>">
        
    </a><figcaption class="image-caption">æ‰‹å†™(<code>å±±å¯¨æ”¯ä»˜å®çŠ¶æ€æœº</code>)</figcaption>
    </figure>
<ul>
<li>è´¦æˆ·é‡Œä¼šå¤šå‡ºç”¨ä¸å®Œçš„é’±ï¼</li>
<li>Bug/æ¼æ´ä¸è·Ÿä½ å¼€ç©ç¬‘ï¼šMt. Gox Hack æŸå¤±650,000
<ul>
<li>ä»Šå¤©ä»·å€¼ $28,000,000,000</li>
</ul>
</li>
</ul>
<p><code>alipay.c</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">balance</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Alipay_withdraw</span><span class="p">(</span><span class="kt">int</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">amt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// unexpected delays
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">balance</span> <span class="o">-=</span> <span class="n">amt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Talipay</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Alipay_withdraw</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Talipay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Talipay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;balance = %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter3-9.png" title="/img/Operating System/chapter3-9.png" data-thumbnail="/img/Operating System/chapter3-9.png" data-sub-html="<h2>Linux(alipay.cè¿è¡Œç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">Linux(<code>alipay.cè¿è¡Œç»“æœ</code>)</figcaption>
    </figure>
<h4 id="ä¾‹å­æ±‚å’Œ">ä¾‹å­ï¼šæ±‚å’Œ</h4>
<p>åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— $1+1+1+\ldots+1+1+1+1+â€¦+1$ (å…±è®¡ 2n ä¸ª 1)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define N 100000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;sum = %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://jyywiki.cn/pages/OS/2022/demos/sum.c" target="_blank" rel="noopener noreffer">sum.c</a> è¿è¡Œç»“æœ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-11.png" title="/img/Operating System/chapter3-11.png" data-thumbnail="/img/Operating System/chapter3-11.png" data-sub-html="<h2>Linux(sum.cè¿è¡Œç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">Linux(<code>sum.cè¿è¡Œç»“æœ</code>)</figcaption>
    </figure>
<ul>
<li>
<p>119790390, 99872322 (ç»“æœå¯ä»¥æ¯” <code>N</code> è¿˜è¦å°), &hellip;</p>
</li>
<li>
<p>Inline assembly ä¹Ÿä¸è¡Œ</p>
</li>
</ul>
<p>ä¿®æ”¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define N 100000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&#34;lock add $1, %0&#34;</span><span class="o">:</span> <span class="s">&#34;+m&#34;</span><span class="p">(</span><span class="n">sum</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;sum = %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-12.png" title="/img/Operating System/chapter3-12.png" data-thumbnail="/img/Operating System/chapter3-12.png" data-sub-html="<h2>Linux(sum.cä¿®æ”¹åè¿è¡Œç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">Linux(<code>sum.cä¿®æ”¹åè¿è¡Œç»“æœ</code>)</figcaption>
    </figure>
<p>ç»“æœæ­£ç¡®ï¼Œä½†æ˜¯è¿è¡Œæ€§èƒ½æ˜¾è‘—ä¸‹é™</p>
<h4 id="åŸå­æ€§çš„ä¸§å¤±">åŸå­æ€§çš„ä¸§å¤±</h4>
<blockquote>
<p>â€œç¨‹åº (ç”šè‡³æ˜¯ä¸€æ¡æŒ‡ä»¤) ç‹¬å å¤„ç†å™¨æ‰§è¡Œâ€ çš„åŸºæœ¬å‡è®¾åœ¨ç°ä»£å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šä¸å†æˆç«‹ã€‚</p>
</blockquote>
<p>åŸå­æ€§ï¼šä¸€æ®µä»£ç æ‰§è¡Œ (ä¾‹å¦‚ <code>pay()</code>) ç‹¬å æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿ</p>
<ul>
<li>å•å¤„ç†å™¨å¤šçº¿ç¨‹
<ul>
<li>çº¿ç¨‹åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</li>
</ul>
</li>
<li>å¤šå¤„ç†å™¨å¤šçº¿ç¨‹
<ul>
<li>çº¿ç¨‹æ ¹æœ¬å°±æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</li>
</ul>
</li>
</ul>
<hr>
<p>(å†å²) 1960sï¼Œå¤§å®¶äº‰å…ˆåœ¨å…±äº«å†…å­˜ä¸Šå®ç°åŸå­æ€§ (äº’æ–¥)</p>
<ul>
<li>ä½†å‡ ä¹æ‰€æœ‰çš„å®ç°éƒ½æ˜¯é”™çš„ï¼Œç›´åˆ° <a href="https://en.wikipedia.org/wiki/Dekker%27s_algorithm" target="_blank" rel="noopener noreffer">Dekker&rsquo;s Algorithm</a>ï¼Œè¿˜åªèƒ½ä¿è¯ä¸¤ä¸ªçº¿ç¨‹çš„äº’æ–¥</li>
</ul>
<h4 id="åŸå­æ€§çš„ä¸§å¤±æœ‰æ²¡æœ‰æ„Ÿåˆ°åæ€•">åŸå­æ€§çš„ä¸§å¤±ï¼šæœ‰æ²¡æœ‰æ„Ÿåˆ°åæ€•ï¼Ÿ</h4>
<p><code>printf</code> è¿˜èƒ½åœ¨å¤šçº¿ç¨‹ç¨‹åºé‡Œè°ƒç”¨å—ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">void thread1() { while (1) { printf(&#34;a&#34;); } }
</span></span><span class="line"><span class="cl">void thread2() { while (1) { printf(&#34;b&#34;); } }
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬éƒ½çŸ¥é“ printf æ˜¯æœ‰ç¼“å†²åŒºçš„ (ä¸ºä»€ä¹ˆï¼Ÿ)</p>
<ul>
<li>å¦‚æœæ‰§è¡Œ <code>buf[pos++] = ch</code> (<code>pos</code> å…±äº«) ä¸å°±ğŸ’¥äº†å—ï¼Ÿ</li>
</ul>
<hr>
<p>RTFM!</p>
<p>å‘½ä»¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ man <span class="m">3</span> <span class="nb">printf</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ATTRIBUTES
</span></span><span class="line"><span class="cl">       For an explanation of the terms used in this section, see attributes<span class="o">(</span>7<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class="line"><span class="cl">       â”‚Interface               â”‚ Attribute     â”‚ Value          â”‚
</span></span><span class="line"><span class="cl">       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span></span><span class="line"><span class="cl">       â”‚printf<span class="o">()</span>, fprintf<span class="o">()</span>,    â”‚ Thread safety â”‚ MT-Safe locale â”‚
</span></span><span class="line"><span class="cl">       â”‚sprintf<span class="o">()</span>, snprintf<span class="o">()</span>,  â”‚               â”‚                â”‚
</span></span><span class="line"><span class="cl">       â”‚vprintf<span class="o">()</span>, vfprintf<span class="o">()</span>,  â”‚               â”‚                â”‚
</span></span><span class="line"><span class="cl">       â”‚vsprintf<span class="o">()</span>, vsnprintf<span class="o">()</span> â”‚               â”‚                â”‚
</span></span><span class="line"><span class="cl">       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è¿›ç¨‹å®‰å…¨ï¼</strong></p>
<h4 id="å®ç°åŸå­æ€§">å®ç°åŸå­æ€§</h4>
<p>äº’æ–¥å’ŒåŸå­æ€§æ˜¯æœ¬å­¦æœŸçš„é‡è¦ä¸»é¢˜</p>
<ul>
<li>
<p><code>lock(&amp;lk)</code></p>
</li>
<li>
<p><code>unlock(&amp;lk)</code></p>
<ul>
<li>å®ç°ä¸´ç•ŒåŒº (critical section) ä¹‹é—´çš„ç»å¯¹ä¸²è¡ŒåŒ–</li>
<li>ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ä¾ç„¶å¯ä»¥å¹¶è¡Œæ‰§è¡Œ</li>
</ul>
</li>
</ul>
<hr>
<p>99% çš„å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ä¸€ä¸ªé˜Ÿåˆ—è§£å†³</p>
<ul>
<li>
<p>æŠŠå¤§ä»»åŠ¡åˆ‡åˆ†æˆå¯ä»¥å¹¶è¡Œçš„å°ä»»åŠ¡</p>
</li>
<li>
<p>worker thread å»é”ä¿æŠ¤çš„é˜Ÿåˆ—é‡Œå–ä»»åŠ¡</p>
</li>
<li>
<p>é™¤å»ä¸å¯å¹¶è¡Œçš„éƒ¨åˆ†ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å¯ä»¥è·å¾—çº¿æ€§çš„åŠ é€Ÿ</p>
<ul>
<li>$Thm.\ T_n&lt;T_{\infty}+\frac {T_1}{n}$(<a href="https://web.mit.edu/dimitrib/www/pdc.html" target="_blank" rel="noopener noreffer">PDC</a>, Chap. 1)</li>
</ul>
</li>
</ul>
<h3 id="æ”¾å¼ƒ2é¡ºåº">æ”¾å¼ƒï¼ˆ2ï¼‰ï¼šé¡ºåº</h3>
<h4 id="ä¾‹å­æ±‚å’Œ-å†æ¬¡å‡ºç°">ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)</h4>
<p>åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— $1+1+1+\ldots+1+1+1+1+â€¦+1$ (å…±è®¡ 2n ä¸ª 1)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define N 100000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Tsum</span><span class="p">()</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">sum</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;sum = %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å¥½åƒå¿˜è®°ç»™ <a href="https://jyywiki.cn/pages/OS/2022/demos/sum.c" target="_blank" rel="noopener noreffer">sum.c</a> æ·»åŠ ç¼–è¯‘ä¼˜åŒ–äº†ï¼Ÿ</p>
<ul>
<li><code>-O1</code>: 100000000 ğŸ˜±ğŸ˜±</li>
<li><code>-O2</code>: 200000000 ğŸ˜±ğŸ˜±ğŸ˜±</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc -O1 sum.c -lpthread <span class="o">&amp;&amp;</span> ./a.out 
</span></span><span class="line"><span class="cl"><span class="nv">sum</span> <span class="o">=</span> <span class="m">100000000</span>
</span></span><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc -O2 sum.c -lpthread <span class="o">&amp;&amp;</span> ./a.out 
</span></span><span class="line"><span class="cl"><span class="nv">sum</span> <span class="o">=</span> <span class="m">200000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é¡ºåºçš„ä¸§å¤±">é¡ºåºçš„ä¸§å¤±</h4>
<blockquote>
<p>ç¼–è¯‘å™¨å¯¹å†…å­˜è®¿é—® â€œeventually consistentâ€ çš„å¤„ç†å¯¼è‡´å…±äº«å†…å­˜ä½œä¸ºçº¿ç¨‹åŒæ­¥å·¥å…·çš„å¤±æ•ˆã€‚</p>
</blockquote>
<p>åˆšæ‰çš„ä¾‹å­</p>
<ul>
<li><code>-O1</code>: <code>R[eax] = sum; R[eax] += N; sum = R[eax]</code></li>
<li><code>-O2</code>: <code>sum += N;</code></li>
<li>(ä½ çš„ç¼–è¯‘å™¨ä¹Ÿè®¸æ˜¯ä¸åŒçš„ç»“æœ)</li>
</ul>
<p>å¦ä¸€ä¸ªä¾‹å­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// would be optimized to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc -c -O1 sum.c <span class="o">&amp;&amp;</span> objdump -d sum.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sum.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Disassembly of section .text:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000000</span> &lt;wrapper&gt;:
</span></span><span class="line"><span class="cl">   0:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">   4:	<span class="m">48</span> <span class="m">83</span> ec <span class="m">08</span>          	sub    <span class="nv">$0</span>x8,%rsp
</span></span><span class="line"><span class="cl">   8:	<span class="m">48</span> <span class="m">89</span> f8             	mov    %rdi,%rax
</span></span><span class="line"><span class="cl">   b:	8b 3f                	mov    <span class="o">(</span>%rdi<span class="o">)</span>,%edi
</span></span><span class="line"><span class="cl">   d:	ff <span class="m">50</span> <span class="m">10</span>             	call   *0x10<span class="o">(</span>%rax<span class="o">)</span>
</span></span><span class="line"><span class="cl">  10:	b8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>       	mov    <span class="nv">$0</span>x0,%eax
</span></span><span class="line"><span class="cl">  15:	<span class="m">48</span> <span class="m">83</span> c4 <span class="m">08</span>          	add    <span class="nv">$0</span>x8,%rsp
</span></span><span class="line"><span class="cl">  19:	c3                   	ret    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">000000000000001a &lt;Tsum&gt;:
</span></span><span class="line"><span class="cl">  1a:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">  1e:	<span class="m">48</span> 8b <span class="m">15</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 	mov    0x0<span class="o">(</span>%rip<span class="o">)</span>,%rdx        <span class="c1"># 25 &lt;Tsum+0xb&gt; -&gt; R[eax] = sum</span>
</span></span><span class="line"><span class="cl">  25:	<span class="m">48</span> 8d <span class="m">42</span> <span class="m">01</span>          	lea    0x1<span class="o">(</span>%rdx<span class="o">)</span>,%rax		 <span class="c1"># -&gt; R[eax] += N, sum = R[eax]</span>
</span></span><span class="line"><span class="cl">  29:	<span class="m">48</span> <span class="m">81</span> c2 <span class="m">01</span> e1 f5 <span class="m">05</span> 	add    <span class="nv">$0</span>x5f5e101,%rdx
</span></span><span class="line"><span class="cl">  30:	<span class="m">48</span> <span class="m">89</span> c1             	mov    %rax,%rcx
</span></span><span class="line"><span class="cl">  33:	<span class="m">48</span> <span class="m">83</span> c0 <span class="m">01</span>          	add    <span class="nv">$0</span>x1,%rax
</span></span><span class="line"><span class="cl">  37:	<span class="m">48</span> <span class="m">39</span> d0             	cmp    %rdx,%rax
</span></span><span class="line"><span class="cl">  3a:	<span class="m">75</span> f4                	jne    <span class="m">30</span> &lt;Tsum+0x16&gt;
</span></span><span class="line"><span class="cl">  3c:	<span class="m">48</span> <span class="m">89</span> 0d <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 	mov    %rcx,0x0<span class="o">(</span>%rip<span class="o">)</span>        <span class="c1"># 43 &lt;Tsum+0x29&gt;</span>
</span></span><span class="line"><span class="cl">  43:	c3                   	ret    
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter3-13.jpg" title="/img/Operating System/chapter3-13.jpg" data-thumbnail="/img/Operating System/chapter3-13.jpg" data-sub-html="<h2>æ‰‹å†™(O1æ¨¡å¼ä¸‹ä¼˜åŒ–)</h2>">
        
    </a><figcaption class="image-caption">æ‰‹å†™(<code>O1æ¨¡å¼ä¸‹ä¼˜åŒ–</code>)</figcaption>
    </figure>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc -c -O2 sum.c <span class="o">&amp;&amp;</span> objdump -d sum.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sum.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Disassembly of section .text:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000000</span> &lt;wrapper&gt;:
</span></span><span class="line"><span class="cl">   0:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">   4:	<span class="m">48</span> <span class="m">83</span> ec <span class="m">08</span>          	sub    <span class="nv">$0</span>x8,%rsp
</span></span><span class="line"><span class="cl">   8:	<span class="m">48</span> <span class="m">89</span> f8             	mov    %rdi,%rax
</span></span><span class="line"><span class="cl">   b:	8b 3f                	mov    <span class="o">(</span>%rdi<span class="o">)</span>,%edi
</span></span><span class="line"><span class="cl">   d:	ff <span class="m">50</span> <span class="m">10</span>             	call   *0x10<span class="o">(</span>%rax<span class="o">)</span>
</span></span><span class="line"><span class="cl">  10:	<span class="m">31</span> c0                	xor    %eax,%eax
</span></span><span class="line"><span class="cl">  12:	<span class="m">48</span> <span class="m">83</span> c4 <span class="m">08</span>          	add    <span class="nv">$0</span>x8,%rsp
</span></span><span class="line"><span class="cl">  16:	c3                   	ret    
</span></span><span class="line"><span class="cl">  17:	<span class="m">66</span> 0f 1f <span class="m">84</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 	nopw   0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</span></span><span class="line"><span class="cl">  1e:	<span class="m">00</span> <span class="m">00</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000020</span> &lt;Tsum&gt;:
</span></span><span class="line"><span class="cl">  20:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl">  24:	<span class="m">48</span> <span class="m">81</span> <span class="m">05</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 	addq   <span class="nv">$0</span>x5f5e100,0x0<span class="o">(</span>%rip<span class="o">)</span>        <span class="c1"># 2f &lt;Tsum+0xf&gt;</span>
</span></span><span class="line"><span class="cl">  2b:	<span class="m">00</span> e1 f5 <span class="m">05</span> 
</span></span><span class="line"><span class="cl">  2f:	c3                   	ret 
</span></span></code></pre></td></tr></table>
</div>
</div><p>O2ä¼˜åŒ–çš„æ¯”è¾ƒå½»åº•ï¼Œåªaddäº†ä¸€æ¬¡ï¼ˆå‡ºé—®é¢˜çš„æ¦‚ç‡æ¯”è¾ƒä½ï¼‰</p>
<h4 id="å®ç°æºä»£ç çš„æŒ‰é¡ºåºç¿»è¯‘">å®ç°æºä»£ç çš„æŒ‰é¡ºåºç¿»è¯‘</h4>
<p>åœ¨ä»£ç ä¸­æ’å…¥ â€œä¼˜åŒ–ä¸èƒ½ç©¿è¶Šâ€ çš„ barrier</p>
<ul>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">asm</span> <span class="nf">volatile</span> <span class="p">(</span><span class="s">&#34;&#34;</span> <span class="o">:::</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Barrier çš„å«ä¹‰æ˜¯ â€œå¯ä»¥è¯»å†™ä»»ä½•å†…å­˜â€</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨<code>volatile</code>å˜é‡</p>
<ul>
<li>ä¿æŒ C è¯­ä¹‰å’Œæ±‡ç¼–è¯­ä¹‰ä¸€è‡´</li>
</ul>
</li>
</ul>
<hr>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="k">volatile</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ”¾å¼ƒ-3å¯è§æ€§">æ”¾å¼ƒ (3)ï¼šå¯è§æ€§</h3>
<h4 id="ä¾‹å­">ä¾‹å­</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">T1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span> <span class="c1">// compiler barrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;y = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">T2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span> <span class="c1">// compiler barrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;x = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é—®é¢˜ï¼šæˆ‘ä»¬æœ€ç»ˆèƒ½çœ‹åˆ°å“ªäº›ç»“æœï¼Ÿ</p>
<p>çŠ¶æ€æœº</p>
<div class="mermaid" id="id-1"></div>
<ul>
<li>mem-ordering.c
<ul>
<li>è¾“å‡ºä¸å¥½è¯»ï¼Ÿ<code>pipe to head -n 1000000 | sort | uniq -c</code></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">atomic_int</span> <span class="n">flag</span><span class="p">;</span> <span class="c1">//å¼€å…³åˆå§‹ä¸º0ï¼ˆå…³ç€ï¼‰ï¼ŒåŸå­å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define FLAG atomic_load(&amp;flag) </span><span class="c1">//åŸå­è¯»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define FLAG_XOR(val) atomic_fetch_xor(&amp;flag, val) </span><span class="c1">//åŸå­å¼‚æˆ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define WAIT_FOR(cond) while (!(cond)) ;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">write_x_read_y</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">y_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;movl $1, %0;&#34;</span> <span class="c1">// x = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;movl %2, %1;&#34;</span> <span class="c1">// y_val = y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">:</span> <span class="s">&#34;=m&#34;</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span> <span class="o">:</span> <span class="s">&#34;m&#34;</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">y_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">write_y_read_x</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">x_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;movl $1, %0;&#34;</span> <span class="c1">// y = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;movl %2, %1;&#34;</span> <span class="c1">// x_val = x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">:</span> <span class="s">&#34;=m&#34;</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span> <span class="o">:</span> <span class="s">&#34;m&#34;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">x_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">T1</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WAIT_FOR</span><span class="p">((</span><span class="n">FLAG</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span> <span class="c1">//ç­‰å¼€å…³1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">write_x_read_y</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLAG_XOR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//å…³æ‰å¼€å…³1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">T2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WAIT_FOR</span><span class="p">((</span><span class="n">FLAG</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">//ç­‰å¼€å…³2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">write_y_read_x</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">    <span class="n">FLAG_XOR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//å…³æ‰å¼€å…³2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Tsync</span><span class="p">()</span> <span class="p">{</span> <span class="c1">//æ§åˆ¶çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//å¸ƒç½®å¥½åˆå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__sync_synchronize</span><span class="p">();</span> <span class="c1">// full barrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>            <span class="c1">// + delay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">FLAG</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//ç¡®å®šå¼€å…³æ˜¯å…³ç€çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FLAG_XOR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">//å¼€å…³çš„ä¸¤ä¸ªbitä»0å˜ä¸º1ï¼ˆå¼€å¯å¼€å…³1ï¼Œ2ï¼‰ï¼ˆåŸå­æ“ä½œï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// T1 and T2 clear 0/1-bit, respectively
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WAIT_FOR</span><span class="p">(</span><span class="n">FLAG</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">T1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">T2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsync</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>-O2æ¨¡å¼ä¸‹ç¼–è¯‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00000000000001a0 &lt;write_x_read_y&gt;:
</span></span><span class="line"><span class="cl"> 1a0:	f3 0f 1e fa          	endbr64 
</span></span><span class="line"><span class="cl"> 1a4:	c7 05 00 00 00 00 01 	movl   $0x1,0x0(%rip)        # 1ae &lt;write_x_read_y+0xe&gt;
</span></span><span class="line"><span class="cl"> 1ab:	00 00 00 
</span></span><span class="line"><span class="cl"> 1ae:	8b 15 00 00 00 00    	mov    0x0(%rip),%edx        # 1b4 &lt;write_x_read_y+0x14&gt;
</span></span><span class="line"><span class="cl"> 1b4:	48 8d 35 00 00 00 00 	lea    0x0(%rip),%rsi        # 1bb &lt;write_x_read_y+0x1b&gt;
</span></span><span class="line"><span class="cl"> 1bb:	bf 01 00 00 00       	mov    $0x1,%edi
</span></span><span class="line"><span class="cl"> 1c0:	31 c0                	xor    %eax,%eax
</span></span><span class="line"><span class="cl"> 1c2:	e9 00 00 00 00       	jmp    1c7 &lt;write_x_read_y+0x27&gt;
</span></span><span class="line"><span class="cl"> 1c7:	66 0f 1f 84 00 00 00 	nopw   0x0(%rax,%rax,1)
</span></span><span class="line"><span class="cl"> 1ce:	00 00 
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ©ç”¨è„šæœ¬æ¥ç»Ÿè®¡ï¼Œä¸çŸ¥é“ä¸ºå•¥è‡ªå·±çš„ä¹Œç­å›¾ğŸ’©ğŸ´è·‘å‡ºæ¥éƒ½æ˜¯01ï¼Œ00ï¼Œ01ï¼Œ10ï¼Œ11éƒ½è·‘å‡ºæ¥äº†ï¼Œå’Œæˆ‘ä»¬çš„çŠ¶æ€æœºæ¨¡å‹ä¸ç¬¦ğŸ¤¡</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-14.png" title="/img/Operating System/chapter3-14.png" data-thumbnail="/img/Operating System/chapter3-14.png" data-sub-html="<h2>From class(è¾“å‡ºç»“æœ)</h2>">
        
    </a><figcaption class="image-caption">From class(<code>è¾“å‡ºç»“æœ</code>)</figcaption>
    </figure>
<h4 id="ç°ä»£å¤„ç†å™¨å¤„ç†å™¨ä¹Ÿæ˜¯-åŠ¨æ€-ç¼–è¯‘å™¨">ç°ä»£å¤„ç†å™¨ï¼šå¤„ç†å™¨ä¹Ÿæ˜¯ (åŠ¨æ€) ç¼–è¯‘å™¨ï¼</h4>
<p>å•ä¸ªå¤„ç†å™¨æŠŠæ±‡ç¼–ä»£ç  (ç”¨ç”µè·¯) â€œç¼–è¯‘â€ æˆæ›´å°çš„ $\mu ops\newline$</p>
<ul>
<li>RF[9] = load(RF[7] + 400)</li>
<li>store(RF[12], RF[13])</li>
<li>RF[3] = RF[4] + RF[5]
<ul>
<li>æ¯ä¸ª $\mu op$ éƒ½æœ‰ Fetch, Issue, Execute, Commit å››ä¸ªé˜¶æ®µ</li>
</ul>
</li>
</ul>
<hr>
<p>åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå¤„ç†å™¨éƒ½ç»´æŠ¤ä¸€ä¸ª $\mu op$ çš„ â€œæ± å­â€</p>
<ul>
<li>
<p>æ¯ä¸€å‘¨æœŸå‘æ± å­è¡¥å……å°½å¯èƒ½å¤šçš„$\mu op\newline$</p>
<ul>
<li>â€œå¤šå‘å°„â€</li>
</ul>
</li>
<li>
<p>æ¯ä¸€å‘¨æœŸ (åœ¨ä¸è¿åç¼–è¯‘æ­£ç¡®æ€§çš„å‰æä¸‹) æ‰§è¡Œå°½å¯èƒ½å¤šçš„$\mu op\newline$</p>
<ul>
<li>â€œä¹±åºæ‰§è¡Œâ€ã€â€œæŒ‰åºæäº¤â€</li>
</ul>
</li>
<li>
<p>è¿™å°±æ˜¯ã€Šè®¡ç®—æœºä½“ç³»ç»“æ„ã€‹ (å‰©ä¸‹å°±æ˜¯æœ¨æ¡¶æ•ˆåº”ï¼Œå“ªé‡ŒçŸ­æ¿è¡¥å“ªé‡Œ)</p>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-15.jpg" title="/img/Operating System/chapter3-15.jpg" data-thumbnail="/img/Operating System/chapter3-15.jpg" data-sub-html="<h2>ç¥ä¹¦(ã€Šè®¡ç®—æœºä½“ç³»ç»“æ„â€”â€”é‡åŒ–ç ”ç©¶æ–¹æ³•ã€‹)</h2>">
        
    </a><figcaption class="image-caption">ç¥ä¹¦(<code>ã€Šè®¡ç®—æœºä½“ç³»ç»“æ„â€”â€”é‡åŒ–ç ”ç©¶æ–¹æ³•ã€‹</code>)</figcaption>
    </figure>
<h4 id="å¤šå¤„ç†å™¨é—´å³æ—¶å¯è§æ€§çš„ä¸§å¤±">å¤šå¤„ç†å™¨é—´å³æ—¶å¯è§æ€§çš„ä¸§å¤±</h4>
<blockquote>
<p>æ»¡è¶³å•å¤„ç†å™¨ eventual memory consistency çš„æ‰§è¡Œï¼Œåœ¨å¤šå¤„ç†å™¨ä¸Šå¯èƒ½æ— æ³•åºåˆ—åŒ–ï¼</p>
</blockquote>
<p>å½“ $x \ne y$ æ—¶ï¼Œå¯¹ $x ,y$ çš„å†…å­˜è¯»å†™å¯ä»¥äº¤æ¢é¡ºåº</p>
<ul>
<li>å®ƒä»¬ç”šè‡³å¯ä»¥åœ¨åŒä¸€ä¸ªå‘¨æœŸé‡Œå®Œæˆ (åªè¦ load/store unit æ”¯æŒ)</li>
<li>å¦‚æœå†™xå‘ç”Ÿ cache missï¼Œå¯ä»¥è®©è¯»yå…ˆæ‰§è¡Œ
<ul>
<li>æ»¡è¶³ â€œå°½å¯èƒ½æ‰§è¡Œ â€œ$\mu op$â€ çš„åŸåˆ™ï¼Œæœ€å¤§åŒ–å¤„ç†å™¨æ€§èƒ½</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">     # &lt;-----------+
</span></span><span class="line"><span class="cl">movl $1, (x)   #   |
</span></span><span class="line"><span class="cl">movl (y), %eax # --+
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åœ¨å¤šå¤„ç†å™¨ä¸Šçš„è¡¨ç°
<ul>
<li>ä¸¤ä¸ªå¤„ç†å™¨åˆ†åˆ«çœ‹åˆ° $y=0 å’Œ x=0\newline$</li>
</ul>
</li>
</ul>
<h4 id="å®½æ¾å†…å­˜æ¨¡å‹-relaxedweak-memory-model">å®½æ¾å†…å­˜æ¨¡å‹ (Relaxed/Weak Memory Model)</h4>
<blockquote>
<p>å®½æ¾å†…å­˜æ¨¡å‹çš„ç›®çš„æ˜¯ä½¿å•å¤„ç†å™¨çš„æ‰§è¡Œæ›´é«˜æ•ˆã€‚</p>
</blockquote>
<p>x86 å·²ç»æ˜¯å¸‚é¢ä¸Šèƒ½ä¹°åˆ°çš„ â€œæœ€å¼ºâ€ çš„å†…å­˜æ¨¡å‹äº† ğŸ˜‚</p>
<ul>
<li>è¿™ä¹Ÿæ˜¯ Intel è‡ªå·±ç»™è‡ªå·±åŠ çš„åŒ…è¢±</li>
<li>çœ‹çœ‹ <a href="https://research.swtch.com/mem-weak@2x.png" target="_blank" rel="noopener noreffer">ARM/RISC-V</a> å§ï¼Œæ ¹æœ¬å°±æ˜¯ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-16.png" title="/img/Operating System/chapter3-16.png" data-thumbnail="/img/Operating System/chapter3-16.png" data-sub-html="<h2>x86(å†…å­˜æ¨¡å‹)</h2>">
        
    </a><figcaption class="image-caption">x86(<code>å†…å­˜æ¨¡å‹</code>)</figcaption>
    </figure>
<p><strong>(x86-TSO in <a href="https://research.swtch.com/hwmm" target="_blank" rel="noopener noreffer">Hardware memory models</a> by Russ Cox)</strong></p>
<hr>
<p><strong>ARM/RISC-V</strong></p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-17.png" title="/img/Operating System/chapter3-17.png" data-thumbnail="/img/Operating System/chapter3-17.png" data-sub-html="<h2>ARM/RISC-V(å†…å­˜æ¨¡å‹)</h2>">
        
    </a><figcaption class="image-caption">ARM/RISC-V(<code>å†…å­˜æ¨¡å‹</code>)</figcaption>
    </figure>
<h4 id="å®ç°é¡ºåºä¸€è‡´æ€§">å®ç°é¡ºåºä¸€è‡´æ€§</h4>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter3-18.png" title="/img/Operating System/chapter3-18.png" data-thumbnail="/img/Operating System/chapter3-18.png" data-sub-html="<h2>æ”¹è‰¯(å†…å­˜æ¨¡å‹)</h2>">
        
    </a><figcaption class="image-caption">æ”¹è‰¯(<code>å†…å­˜æ¨¡å‹</code>)</figcaption>
    </figure>
<hr>
<p>è½¯ä»¶åšä¸åˆ°ï¼Œç¡¬ä»¶æ¥å¸®å¿™</p>
<ul>
<li>
<p>Memory barrier: __sync_synchronize() (RTFM)</p>
<ul>
<li>Compiler barrier + fence æŒ‡ä»¤</li>
<li>æ’å…¥ fence æŒ‡ä»¤åï¼Œå°†é˜»æ­¢ x=y=0</li>
</ul>
</li>
<li>
<p>åŸå­æŒ‡ä»¤ (lock,prefix, lr/sc, &hellip;)</p>
<ul>
<li><code>stdatomic.h</code></li>
</ul>
</li>
</ul>
<p>ä¿®æ”¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">atomic_int</span> <span class="n">flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FLAG atomic_load(&amp;flag)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FLAG_XOR(val) atomic_fetch_xor(&amp;flag, val)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define WAIT_FOR(cond) while (!(cond)) ;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">write_x_read_y</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">y_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;movl $1, %0;&#34;</span> <span class="c1">// x = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;mfence;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;movl %2, %1;&#34;</span> <span class="c1">// y_val = y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">:</span> <span class="s">&#34;=m&#34;</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span> <span class="o">:</span> <span class="s">&#34;m&#34;</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">y_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">write_y_read_x</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">x_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;movl $1, %0;&#34;</span> <span class="c1">// y = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;mfence;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;movl %2, %1;&#34;</span> <span class="c1">// x_val = x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">:</span> <span class="s">&#34;=m&#34;</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span> <span class="o">:</span> <span class="s">&#34;m&#34;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">x_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">T1</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WAIT_FOR</span><span class="p">((</span><span class="n">FLAG</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_x_read_y</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLAG_XOR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">T2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WAIT_FOR</span><span class="p">((</span><span class="n">FLAG</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_y_read_x</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLAG_XOR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Tsync</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__sync_synchronize</span><span class="p">();</span> <span class="c1">// full barrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>            <span class="c1">// + delay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">FLAG</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLAG_XOR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// T1 and T2 clear 0/1-bit, respectively
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WAIT_FOR</span><span class="p">(</span><span class="n">FLAG</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">T1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">T2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">create</span><span class="p">(</span><span class="n">Tsync</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ä¼šå†çœ‹è§00çš„ç»„åˆäº†</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: å¦‚ä½•ç†è§£å¤šå¤„ç†å™¨ç³»ç»Ÿï¼Ÿ</li>
</ul>
<hr>
<p>Take-away message</p>
<ul>
<li>å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šå…¥é—¨
<ul>
<li>å¤šå¤„ç†å™¨ç¨‹åº = çŠ¶æ€æœº (å…±äº«å†…å­˜ï¼›éç¡®å®šé€‰æ‹©çº¿ç¨‹æ‰§è¡Œ)</li>
<li>thread.h = create + join</li>
</ul>
</li>
<li>å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šæ”¾å¼ƒä½ å¯¹ â€œç¨‹åºâ€ çš„æ—§ç†è§£
<ul>
<li>ä¸åŸå­ã€èƒ½ä¹±åºã€ä¸ç«‹å³å¯è§ï¼ˆç°ä»£å¤„ç†å™¨å°±æ˜¯ä¸€ä¸ªåŠ¨æ€çš„æ•°æ®æµåˆ†æå™¨ï¼‰
<ul>
<li>æ¥è‡ªäºç¼–è¯‘ä¼˜åŒ– (å¤„ç†å™¨ä¹Ÿæ˜¯ç¼–è¯‘å™¨)</li>
<li><a href="https://www.usenix.org/events/osdi10/tech/full_papers/Xiong.pdf" target="_blank" rel="noopener noreffer">Ad hoc synchronization considered harmful</a> (OSDI'10)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</strong></p>
]]></description>
</item>
<item>
    <title>Operating System Chapter2 æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº</title>
    <link>https://Jungle430.github.io/posts/operating-system/operating-system-chapter2/</link>
    <pubDate>Sat, 31 Dec 2022 19:30:30 &#43;0800</pubDate><author>1239946358@qq.com (Jungle)</author><guid>https://Jungle430.github.io/posts/operating-system/operating-system-chapter2/</guid>
    <description><![CDATA[<h1 id="operating-system">Operating System</h1>
<p>$Nanjing\ University\rightarrow Yanyan\ Jiang\newline$</p>
<h2 id="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº">æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº</h2>
<h3 id="overview">Overview</h3>
<h4 id="å¤ä¹ ">å¤ä¹ </h4>
<p>ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Ÿ</p>
<ul>
<li>åº”ç”¨è§†è§’ (è®¾è®¡): ä¸€ç»„å¯¹è±¡ (è¿›ç¨‹/æ–‡ä»¶/&hellip;) + API</li>
<li>ç¡¬ä»¶è§†è§’ (å®ç°): ä¸€ä¸ª C ç¨‹åº</li>
</ul>
<h4 id="æœ¬æ¬¡è¯¾ç¨‹ä¸»è¦é—®é¢˜">æœ¬æ¬¡è¯¾ç¨‹ä¸»è¦é—®é¢˜</h4>
<ul>
<li>åˆ°åº•ä»€ä¹ˆæ˜¯â€ç¨‹åºâ€ï¼Ÿ</li>
</ul>
<h4 id="æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹">æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</h4>
<ul>
<li>ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (å’Œç¼–è¯‘å™¨)</li>
<li>æ“ä½œç³»ç»Ÿä¸Šçš„ {æœ€å°/ä¸€èˆ¬/å›¾å½¢} ç¨‹åº</li>
</ul>
<h3 id="çŠ¶æ€æœºä¸æ•°å­—ç”µè·¯">çŠ¶æ€æœºä¸æ•°å­—ç”µè·¯</h3>
<p>æ•°å­—é€»è¾‘ç”µè·¯</p>
<ul>
<li>çŠ¶æ€ = å¯„å­˜å™¨ä¿å­˜çš„å€¼ (flip-flop)</li>
<li>åˆå§‹çŠ¶æ€ = RESET (implementation dependent)</li>
<li>è¿ç§» = ç»„åˆé€»è¾‘ç”µè·¯è®¡ç®—å¯„å­˜å™¨ä¸‹ä¸€å‘¨æœŸçš„å€¼</li>
</ul>
<p>ä¾‹å­ï¼š
$$
\begin{align}
&amp;X^{&rsquo;}= \neg X \wedge Y\newline
&amp;Y^{&rsquo;}= \neg X \wedge \neg Y\newline
\end{align}
$$</p>
<div class="mermaid" id="id-1"></div>
<p>ä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define REGS_FOREACH(_)  _(X) _(Y)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RUN_LOGIC        X1 = !X &amp;&amp; Y; \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         Y1 = !X &amp;&amp; !Y;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DEFINE(X)        static int X, X##1;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define UPDATE(X)        X = X##1;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINT(X)         printf(#X &#34; = %d; &#34;, X);
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">REGS_FOREACH</span><span class="p">(</span><span class="n">DEFINE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// clock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RUN_LOGIC</span>
</span></span><span class="line"><span class="cl">        <span class="n">REGS_FOREACH</span><span class="p">(</span><span class="n">PRINT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">REGS_FOREACH</span><span class="p">(</span><span class="n">UPDATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®å±•å¼€</p>
<p>ä½¿ç”¨mingwå‘½ä»¤(æ³¨æ„å»æ‰å¤´æ–‡ä»¶ï¼Œå¦åˆ™å¤´æ–‡ä»¶ä¹Ÿä¼šä¸€å¹¶å±•å¼€ï¼Œå°±æ²¡æ³•çœ‹äº†ğŸ¤¡)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -E main.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>å±•å¼€å</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">X</span><span class="p">,</span> <span class="n">X1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">X1</span> <span class="o">=</span> <span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="n">Y</span><span class="p">;</span> <span class="n">Y1</span> <span class="o">=</span> <span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;X&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">X</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Y&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">X</span> <span class="o">=</span> <span class="n">X1</span><span class="p">;</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ›´å®Œæ•´çš„å®ç°ï¼šæ•°ç ç®¡æ˜¾ç¤º</p>
<p>ä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define REGS_FOREACH(_)  _(X) _(Y)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define OUTS_FOREACH(_)  _(A) _(B) _(C) _(D) _(E) _(F) _(G)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RUN_LOGIC        X1 = !X &amp;&amp; Y; \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         Y1 = !X &amp;&amp; !Y; \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         A  = (!X &amp;&amp; !Y) || (X &amp;&amp; !Y); \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         B  = 1; \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         C  = (!X &amp;&amp; !Y) || (!X &amp;&amp; Y); \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         D  = (!X &amp;&amp; !Y) || (X &amp;&amp; !Y); \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         E  = (!X &amp;&amp; !Y) || (X &amp;&amp; !Y); \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         F  = (!X &amp;&amp; !Y); \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         G  = (X &amp;&amp; !Y);
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DEFINE(X)   static int X, X##1;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define UPDATE(X)   X = X##1;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINT(X)    printf(#X &#34; = %d; &#34;, X);
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">REGS_FOREACH</span><span class="p">(</span><span class="n">DEFINE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">OUTS_FOREACH</span><span class="p">(</span><span class="n">DEFINE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// clock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RUN_LOGIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">OUTS_FOREACH</span><span class="p">(</span><span class="n">PRINT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">REGS_FOREACH</span><span class="p">(</span><span class="n">UPDATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®å±•å¼€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">X</span><span class="p">,</span> <span class="n">X1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">A</span><span class="p">,</span> <span class="n">A1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">B</span><span class="p">,</span> <span class="n">B1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">C</span><span class="p">,</span> <span class="n">C1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">D</span><span class="p">,</span> <span class="n">D1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">E</span><span class="p">,</span> <span class="n">E1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">F</span><span class="p">,</span> <span class="n">F1</span><span class="p">;</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">G</span><span class="p">,</span> <span class="n">G1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">X1</span> <span class="o">=</span> <span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="n">Y</span><span class="p">;</span> <span class="n">Y1</span> <span class="o">=</span> <span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">;</span> <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">);</span> <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="n">Y</span><span class="p">);</span> <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">);</span> <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">);</span> <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">);</span> <span class="n">G</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Y</span><span class="p">);;</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">A</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">B</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;C&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">C</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;D&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;E&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">E</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;F&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">F</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;G&#34;</span> <span class="s">&#34; = %d; &#34;</span><span class="p">,</span> <span class="n">G</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">X</span> <span class="o">=</span> <span class="n">X1</span><span class="p">;</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>pythonåç«¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fileinput</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="se">\033</span><span class="s1">[2J</span><span class="se">\033</span><span class="s1">[1;1f
</span></span></span><span class="line"><span class="cl"><span class="s1">     AAAAAAAAA
</span></span></span><span class="line"><span class="cl"><span class="s1">    FF       BB
</span></span></span><span class="line"><span class="cl"><span class="s1">    FF       BB
</span></span></span><span class="line"><span class="cl"><span class="s1">    FF       BB
</span></span></span><span class="line"><span class="cl"><span class="s1">    FF       BB
</span></span></span><span class="line"><span class="cl"><span class="s1">    GGGGGGGGGG
</span></span></span><span class="line"><span class="cl"><span class="s1">   EE       CC
</span></span></span><span class="line"><span class="cl"><span class="s1">   EE       CC
</span></span></span><span class="line"><span class="cl"><span class="s1">   EE       CC
</span></span></span><span class="line"><span class="cl"><span class="s1">   EE       CC
</span></span></span><span class="line"><span class="cl"><span class="s1">    DDDDDDDDD
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="n">BLOCK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[37mâ–‘</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">,</span> <span class="c1"># STFW: ANSI Escape Code</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[31mâ–ˆ</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">VARS</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFG&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">VARS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">globals</span><span class="p">()[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">stdin</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">exec</span><span class="p">(</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">pic</span> <span class="o">=</span> <span class="n">TEMPLATE</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">VARS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pic</span> <span class="o">=</span> <span class="n">pic</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">BLOCK</span><span class="p">[</span><span class="nb">globals</span><span class="p">()[</span><span class="n">v</span><span class="p">]])</span> <span class="c1"># &#39;A&#39; -&gt; BLOCK[A], ...</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨æ–¹æ³•</p>
<p>å…ˆé€šè¿‡gccå°†cæ–‡ä»¶ç¼–è¯‘ä¸ºexeæ–‡ä»¶</p>
<p>ç„¶åcmdå‘½ä»¤ç«¯è¾“å…¥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">logisim.exe <span class="p">|</span> python seven-seg.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•ˆæœï¼šå¾ªç¯å‡ºç°å¦‚ä¸‹ç”»é¢</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-1.png" title="/img/Operating System/chapter2-1.png" data-thumbnail="/img/Operating System/chapter2-1.png" data-sub-html="<h2>pythonåç«¯(image 1)</h2>">
        
    </a><figcaption class="image-caption">pythonåç«¯(<code>image 1</code>)</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-2.png" title="/img/Operating System/chapter2-2.png" data-thumbnail="/img/Operating System/chapter2-2.png" data-sub-html="<h2>pythonåç«¯(image 2)</h2>">
        
    </a><figcaption class="image-caption">pythonåç«¯(<code>image 2</code>)</figcaption>
    </figure>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-3.png" title="/img/Operating System/chapter2-3.png" data-thumbnail="/img/Operating System/chapter2-3.png" data-sub-html="<h2>pythonåç«¯(image 3)</h2>">
        
    </a><figcaption class="image-caption">pythonåç«¯(<code>image 3</code>)</figcaption>
    </figure>
<ul>
<li>
<p>ä¼šç¼–ç¨‹ï¼Œä½ å°±æ‹¥æœ‰å…¨ä¸–ç•Œï¼</p>
</li>
<li>
<p>åŒæ ·çš„æ–¹å¼å¯ä»¥æ¨¡æ‹Ÿä»»ä½•æ•°å­—ç³»ç»Ÿ</p>
<ul>
<li>å½“ç„¶ï¼Œä¹ŸåŒ…æ‹¬è®¡ç®—æœºç³»ç»Ÿ</li>
</ul>
</li>
</ul>
<p>UNIX å“²å­¦</p>
<ul>
<li>Make each program do one thing well</li>
<li>Expect the output of every program to become the input to another</li>
</ul>
<h3 id="ä»€ä¹ˆæ˜¯ç¨‹åºæºä»£ç è§†è§’">ä»€ä¹ˆæ˜¯ç¨‹åºï¼ˆæºä»£ç è§†è§’ï¼‰</h3>
<p>ç¨‹åºå°±æ˜¯çŠ¶æ€æœº (ä½ åœ¨ gdb é‡Œçœ‹åˆ°çš„)</p>
<p>ä»£ç ï¼šhanoi-r.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hanoi</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">char</span> <span class="n">from</span><span class="p">,</span> <span class="kt">char</span> <span class="n">to</span><span class="p">,</span> <span class="kt">char</span> <span class="n">via</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%c -&gt; %c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hanoi</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hanoi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>     <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span>  <span class="n">via</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hanoi</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span>  <span class="n">to</span><span class="p">,</span>  <span class="n">from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="c-ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹è§’åº¦ä¸€">C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ï¼ˆè§’åº¦ä¸€ï¼‰</h4>
<p><strong>(è¯­ä¹‰ï¼Œsemantics)</strong></p>
<ul>
<li>çŠ¶æ€ = å † + æ ˆ</li>
<li>åˆå§‹çŠ¶æ€ = <code>main</code> çš„ç¬¬ä¸€æ¡è¯­å¥</li>
<li>è¿ç§» = æ‰§è¡Œä¸€æ¡ç®€å•è¯­å¥
<ul>
<li>ä»»ä½• C ç¨‹åºéƒ½å¯ä»¥æ”¹å†™æˆ â€œéå¤åˆè¯­å¥â€ çš„ C ä»£ç </li>
<li><a href="https://cil-project.github.io/cil/" target="_blank" rel="noopener noreffer">çœŸçš„æœ‰è¿™ç§å·¥å…·</a> (C Intermediate Language) å’Œ<a href="https://gitlab.com/zsaleeba/picoc" target="_blank" rel="noopener noreffer">è§£é‡Šå™¨</a></li>
</ul>
</li>
</ul>
<hr>
<p>(è¿™è¿˜åªæ˜¯ â€œç²—æµ…â€ çš„ç†è§£)</p>
<ul>
<li>Talk is cheap. Show me the code. (Linus Torvalds): ä»»ä½•çœŸæ­£çš„ç†è§£éƒ½åº”è¯¥è½åˆ°å¯ä»¥æ‰§è¡Œçš„ä»£ç </li>
</ul>
<h4 id="c-ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹è§’åº¦äºŒ">C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ï¼ˆè§’åº¦äºŒï¼‰</h4>
<p><strong>(è¯­ä¹‰ï¼Œsemantics)</strong></p>
<ul>
<li>çŠ¶æ€ = stack frame çš„åˆ—è¡¨ (æ¯ä¸ª frame æœ‰ PC <code>program counter</code> ) + å…¨å±€å˜é‡</li>
<li>åˆå§‹çŠ¶æ€ = main(argc, argv), å…¨å±€å˜é‡åˆå§‹åŒ–</li>
<li>è¿ç§» = æ‰§è¡Œ top stack frame PC çš„è¯­å¥; PC++
<ul>
<li>å‡½æ•°è°ƒç”¨ = push frame (frame.PC = å…¥å£)</li>
<li>å‡½æ•°è¿”å› = pop frame</li>
</ul>
</li>
</ul>
<p><strong>åº”ç”¨ï¼šå°†ä»»ä½•é€’å½’ç¨‹åºå°±åœ°è½¬ä¸ºéé€’å½’</strong>ï¼ˆæ¨¡æ‹Ÿ$stack$ï¼‰</p>
<p>$hanoi-nr.c\newline$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">pc</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">via</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Frame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define call(...) ({ *(++top) = (Frame) { .pc = 0, __VA_ARGS__ }; })
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ret()     ({ top--; })
</span></span></span><span class="line"><span class="cl"><span class="cp">#define goto(loc) ({ f-&gt;pc = (loc) - 1; })
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hanoi</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">char</span> <span class="n">from</span><span class="p">,</span> <span class="kt">char</span> <span class="n">to</span><span class="p">,</span> <span class="kt">char</span> <span class="n">via</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Frame</span> <span class="n">stk</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">stk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">call</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">via</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">Frame</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">top</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">stk</span><span class="p">;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">pc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%c -&gt; %c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">);</span> <span class="k">goto</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">via</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">);</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="n">call</span><span class="p">(</span>       <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">,</span>  <span class="n">f</span><span class="o">-&gt;</span><span class="n">via</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">via</span><span class="p">,</span>  <span class="n">f</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">,</span>  <span class="n">f</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="n">ret</span><span class="p">();</span>                                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span> <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>A â†’ B, B â†’ A çš„è¿åˆƒè€Œè§£
<ul>
<li>è¿˜æ˜¯ä¸€æ ·çš„ <code>call()</code>ï¼Œä½†æ”¾å…¥ä¸åŒçš„ <code>Frame</code></li>
</ul>
</li>
</ul>
<h3 id="ä»€ä¹ˆæ˜¯ç¨‹åº-äºŒè¿›åˆ¶ä»£ç è§†è§’">ä»€ä¹ˆæ˜¯ç¨‹åº (äºŒè¿›åˆ¶ä»£ç è§†è§’)</h3>
<p>è¿˜æ˜¯çŠ¶æ€æœº	(æ²¡çœ‹è¿‡å—å¤§çš„è®¡ç®—æœºåŸºç¡€å’Œæ•°å­—é€»è¾‘è¯¾åˆ°è¿™å¤šå°‘æœ‰ç‚¹ğŸ¤¡äº†)</p>
<ul>
<li>çŠ¶æ€ = å†…å­˜ <code>M</code> + å¯„å­˜å™¨ <code>R</code></li>
<li>åˆå§‹çŠ¶æ€ = (ç¨åå›ç­”)</li>
<li>è¿ç§» = æ‰§è¡Œä¸€æ¡æŒ‡ä»¤
<ul>
<li>æˆ‘ä»¬èŠ±äº†ä¸€æ•´ä¸ªã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹è§£é‡Šè¿™ä»¶äº‹</li>
<li>gdb åŒæ ·å¯ä»¥è§‚å¯ŸçŠ¶æ€å’Œæ‰§è¡Œ</li>
</ul>
</li>
</ul>
<hr>
<p>æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº</p>
<ul>
<li>
<p>æ‰€æœ‰çš„æŒ‡ä»¤éƒ½åªèƒ½<code>è®¡ç®—</code></p>
<ul>
<li>deterministic: mov, add, sub, call, &hellip;</li>
<li>non-deterministic: rdrand, &hellip;</li>
<li>ä½†è¿™äº›æŒ‡ä»¤ç”šè‡³éƒ½æ— æ³•ä½¿ç¨‹åºåœä¸‹æ¥ ,ç›´æ¥ğŸ¤¡, å¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´æ²¡æœ‰ä»€ä¹ˆğŸ”ç”¨(NEMU: åŠ æ¡ <code>trap</code> æŒ‡ä»¤)</li>
</ul>
</li>
</ul>
<h4 id="ä¸€æ¡ç‰¹æ®Šçš„æŒ‡ä»¤">ä¸€æ¡ç‰¹æ®Šçš„æŒ‡ä»¤</h4>
<p>è°ƒç”¨æ“ä½œç³»ç»Ÿ <code>syscall</code></p>
<ul>
<li>æŠŠ(<code>M</code>, <code>R</code>)<strong>å®Œå…¨äº¤ç»™æ“ä½œç³»ç»Ÿ</strong>ï¼Œä»»å…¶ä¿®æ”¹
<ul>
<li>ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼šå¦‚æœç¨‹åºä¸æ‰“ç®—å®Œå…¨ä¿¡ä»»æ“ä½œç³»ç»Ÿï¼Ÿ</li>
</ul>
</li>
<li>å®ç°ä¸æ“ä½œç³»ç»Ÿä¸­çš„å…¶ä»–å¯¹è±¡äº¤äº’
<ul>
<li>è¯»å†™æ–‡ä»¶/æ“ä½œç³»ç»ŸçŠ¶æ€ (ä¾‹å¦‚æŠŠæ–‡ä»¶å†…å®¹å†™å…¥ M<em>M</em>)</li>
<li>æ”¹å˜è¿›ç¨‹ (è¿è¡Œä¸­çŠ¶æ€æœº) çš„çŠ¶æ€ï¼Œä¾‹å¦‚åˆ›å»ºè¿›ç¨‹/é”€æ¯è‡ªå·±</li>
</ul>
</li>
</ul>
<hr>
<p><strong>ç¨‹åº = è®¡ç®— + syscall</strong></p>
<div class="mermaid" id="id-2"></div>
<h4 id="é—®é¢˜æ€ä¹ˆæ„é€ ä¸€ä¸ªæœ€å°çš„-hello-world">é—®é¢˜ï¼šæ€ä¹ˆæ„é€ ä¸€ä¸ªæœ€å°çš„ Hello, Worldï¼Ÿ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello, World</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>gcc ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¸æ»¡è¶³ â€œæœ€å°â€</p>
<ul>
<li><code>--verbose</code>å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç¼–è¯‘é€‰é¡¹ (çœŸä¸å°‘)
<ul>
<li><code>printf </code>å˜æˆäº† puts@plt</li>
</ul>
</li>
<li><code>-static</code> ä¼šå¤åˆ¶ libc</li>
</ul>
<p>gccèƒ½ç©çš„è¿™ä¹ˆå¤šï¼Œçœ‹æ¥âœŒï¸ä¹‹å‰å¤©å¤©é ç°æˆ$IDE$å¤šå°‘æ²¾ç‚¹ğŸ¤¡äº†</p>
<p>å®é™…ä½¿ç”¨<code>--verbose</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc --verbose hello.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•ˆæœ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-4.png" title="/img/Operating System/chapter2-4.png" data-thumbnail="/img/Operating System/chapter2-4.png" data-sub-html="<h2>æ•ˆæœ(on windows)</h2>">
        
    </a><figcaption class="image-caption">æ•ˆæœ(<code>on windows</code>)</figcaption>
    </figure>
<p>å®é™…ä½¿ç”¨<code>â€“static</code>(ä¸ä¾èµ–åŠ¨æ€é“¾æ¥åº“)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -static hello.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¼šå¾ˆå¤§ï¼ˆæˆ‘çš„æ˜¯53KBï¼‰</p>
<hr>
<p>ç›´æ¥ç¡¬æ¥ï¼Ÿ</p>
<p>å¼ºè¡Œç¼–è¯‘ + é“¾æ¥ï¼š<code>gcc -c</code> + <code>ld</code></p>
<ul>
<li>
<p>ç›´æ¥ç”¨ ld é“¾æ¥å¤±è´¥</p>
<ul>
<li>ld ä¸çŸ¥é“æ€ä¹ˆé“¾æ¥åº“å‡½æ•°â€¦â€¦</li>
</ul>
</li>
<li>
<p>ç©ºçš„ main å‡½æ•°å€’æ˜¯å¯ä»¥</p>
<ul>
<li>é“¾æ¥æ—¶å¾—åˆ°å¥‡æ€ªçš„è­¦å‘Š (å¯ä»¥å®šä¹‰æˆ <code>_start</code> é¿å…è­¦å‘Š)</li>
<li>ä½† Segmentation Fault äº†â€¦â€¦</li>
</ul>
</li>
</ul>
<p>æ‰¾äº†ä¸€ä¸‹<code>Segmentation Fault</code></p>
<p>$From\ wikipedia\newline$
$\rightarrow$ <a href="https://en.wikipedia.org/wiki/Segmentation_fault" target="_blank" rel="noopener noreffer">address</a></p>
<blockquote>
<p>In <a href="https://en.wikipedia.org/wiki/Computing" target="_blank" rel="noopener noreffer">computing</a>, a <strong>segmentation fault</strong> (often shortened to <strong>segfault</strong>) or <strong>access violation</strong> is a <a href="https://en.wikipedia.org/wiki/Fault_%28computing%29" target="_blank" rel="noopener noreffer">fault</a>, or failure condition, raised by hardware with <a href="https://en.wikipedia.org/wiki/Memory_protection" target="_blank" rel="noopener noreffer">memory protection</a>, notifying an <a href="https://en.wikipedia.org/wiki/Operating_system" target="_blank" rel="noopener noreffer">operating system</a> (OS) the software has attempted to access a restricted area of memory (a memory access violation). On standard <a href="https://en.wikipedia.org/wiki/X86" target="_blank" rel="noopener noreffer">x86</a> computers, this is a form of <a href="https://en.wikipedia.org/wiki/General_protection_fault" target="_blank" rel="noopener noreffer">general protection fault</a>. The <a href="https://en.wikipedia.org/wiki/Operating_system_kernel" target="_blank" rel="noopener noreffer">operating system kernel</a> will, in response, usually perform some corrective action, generally passing the fault on to the offending <a href="https://en.wikipedia.org/wiki/Process_%28computing%29" target="_blank" rel="noopener noreffer">process</a> by sending the process a <a href="https://en.wikipedia.org/wiki/Signal_%28computing%29" target="_blank" rel="noopener noreffer">signal</a>. Processes can in some cases install a custom signal handler, allowing them to recover on their own,[<a href="https://en.wikipedia.org/wiki/Segmentation_fault#cite_note-Peter_Van_der_Linden-1" target="_blank" rel="noopener noreffer">1]</a> but otherwise the OS default signal handler is used, generally causing <a href="https://en.wikipedia.org/wiki/Abnormal_termination" target="_blank" rel="noopener noreffer">abnormal termination</a> of the process (a program <a href="https://en.wikipedia.org/wiki/Crash_%28computing%29" target="_blank" rel="noopener noreffer">crash</a>), and sometimes a <a href="https://en.wikipedia.org/wiki/Core_dump" target="_blank" rel="noopener noreffer">core dump</a>.</p>
<p>Segmentation faults are a common class of error in programs written in languages like <a href="https://en.wikipedia.org/wiki/C_%28programming_language%29" target="_blank" rel="noopener noreffer">C</a> that provide low-level memory access and few to no safety checks. They arise primarily due to errors in use of <a href="https://en.wikipedia.org/wiki/Pointer_%28computer_programming%29" target="_blank" rel="noopener noreffer">pointers</a> for <a href="https://en.wikipedia.org/wiki/Virtual_memory" target="_blank" rel="noopener noreffer">virtual memory</a> addressing, particularly illegal access. Another type of memory access error is a <a href="https://en.wikipedia.org/wiki/Bus_error" target="_blank" rel="noopener noreffer">bus error</a>, which also has various causes, but is today much rarer; these occur primarily due to incorrect <em>physical</em> memory addressing, or due to misaligned memory access â€“ these are memory references that the hardware <em>cannot</em> address, rather than references that a process is not <em>allowed</em> to address.</p>
<p>Many programming languages may employ mechanisms designed to avoid segmentation faults and improve memory safety. For example, <a href="https://en.wikipedia.org/wiki/Rust_%28programming_language%29" target="_blank" rel="noopener noreffer">Rust</a> employs an ownership-based[<a href="https://en.wikipedia.org/wiki/Segmentation_fault#cite_note-2" target="_blank" rel="noopener noreffer">2]</a> model to ensure memory safety.[<a href="https://en.wikipedia.org/wiki/Segmentation_fault#cite_note-3" target="_blank" rel="noopener noreffer">3]</a> Other languages, such as <a href="https://en.wikipedia.org/wiki/Lisp_%28programming_language%29" target="_blank" rel="noopener noreffer">Lisp</a> and <a href="https://en.wikipedia.org/wiki/Java_%28programming_language%29" target="_blank" rel="noopener noreffer">Java</a>, employ <a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29" target="_blank" rel="noopener noreffer">garbage collection</a>,[<a href="https://en.wikipedia.org/wiki/Segmentation_fault#cite_note-4" target="_blank" rel="noopener noreffer">4]</a> which avoids certain classes of memory errors that could lead to segmentation faults.[<a href="https://en.wikipedia.org/wiki/Segmentation_fault#cite_note-5" target="_blank" rel="noopener noreffer">5]</a></p>
</blockquote>
<p>ä¸»è¦å’Œéæ³•è®¿é—®å†…å­˜æœ‰å…³</p>
<p>è§£å†³æ–¹æ³•ï¼šè§‚å¯Ÿç¨‹åºï¼ˆçŠ¶æ€æœºï¼‰æ‰§è¡Œ</p>
<ul>
<li>
<p><code>starti</code>å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»<strong>ç¬¬ä¸€æ¡æŒ‡ä»¤</strong>å¼€å§‹æ‰§è¡Œç¨‹åº</p>
<ul>
<li><code>gdb</code> å¯ä»¥åœ¨ä¸¤ç§çŠ¶æ€æœºè§†è§’ä¹‹é—´åˆ‡æ¢ (<code>layout</code>) <a href="http://sourceware.org/gdb/documentation/" target="_blank" rel="noopener noreffer">GDBå®˜æ–¹æ–‡æ¡£</a></li>
</ul>
</li>
</ul>
<p>å®šä½å‡ºé”™ä½ç½®</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-5.png" title="/img/Operating System/chapter2-5.png" data-thumbnail="/img/Operating System/chapter2-5.png" data-sub-html="<h2>å‡ºé”™ä½ç½®(on linux)</h2>">
        
    </a><figcaption class="image-caption">å‡ºé”™ä½ç½®(<code>on linux</code>)</figcaption>
    </figure>
<p><code>retq</code>:æ ˆç”±<code>rsp</code>ï¼ˆå¯„å­˜å™¨ï¼‰æ§åˆ¶,<code>retq</code>å°±æ˜¯ä»<code>rsp</code>å¯„å­˜å™¨å½“ä¸­å–å‡º8ä¸ªå­—èŠ‚ï¼Œèµ‹å€¼ç»™<code>rip</code>(pc)ï¼Œç„¶å<code>rsp &lt;- rsp + 8</code>ï¼ˆå¾€ä¸ŠæŒªä¸€æ ¼ï¼‰ï¼ˆæ ˆå‘ä¸‹å¢é•¿ï¼‰</p>
<p>åˆå§‹<code>rsp</code>é¡¶éƒ¨ä¸º1</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-6.png" title="/img/Operating System/chapter2-6.png" data-thumbnail="/img/Operating System/chapter2-6.png" data-sub-html="<h2>æŸ¥çœ‹é”™è¯¯(on gdb)</h2>">
        
    </a><figcaption class="image-caption">æŸ¥çœ‹é”™è¯¯(<code>on gdb</code>)</figcaption>
    </figure>
<p>æ ˆ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-7.png" title="/img/Operating System/chapter2-7.png" data-thumbnail="/img/Operating System/chapter2-7.png" data-sub-html="<h2>æŸ¥çœ‹é”™è¯¯(on gdb)</h2>">
        
    </a><figcaption class="image-caption">æŸ¥çœ‹é”™è¯¯(<code>on gdb</code>)</figcaption>
    </figure>
<p>ä½†æ˜¯å½“æ‰§è¡Œå®Œæœ‰é—®é¢˜çš„è¯­å¥ä¹‹å<code>retq</code>ï¼Œ<code>rip</code>å°±å˜æˆäº†8</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-8.png" title="/img/Operating System/chapter2-8.png" data-thumbnail="/img/Operating System/chapter2-8.png" data-sub-html="<h2>å‡ºç°é”™è¯¯(on gdb)</h2>">
        
    </a><figcaption class="image-caption">å‡ºç°é”™è¯¯(<code>on gdb</code>)</figcaption>
    </figure>
<p>éæ³•è®¿é—®ï¼Œè§¦å‘äº†<code>Segmentation Fault</code></p>
<p><strong>æ‰€ä»¥è¯¥ç¨‹åºèƒ½è¢«æ“ä½œç³»ç»Ÿæ­£ç¡®çš„æ‰§è¡Œï¼Œä½†æ²¡æœ‰åŠæ³•è¿”å›ï¼Œé—®é¢˜å‡ºåœ¨åˆå§‹çŠ¶æ€ä¸Šï¼ˆå³é”™è¯¯çš„æŒ‡ä»¤ï¼‰</strong></p>
<h5 id="è§£å†³å¼‚å¸¸é€€å‡º">è§£å†³å¼‚å¸¸é€€å‡º</h5>
<p>æœ‰åŠæ³•è®©çŠ¶æ€æœº â€œåœä¸‹æ¥â€ å—ï¼Ÿ</p>
<ul>
<li>çº¯ â€œè®¡ç®—â€ çš„çŠ¶æ€æœºï¼šä¸è¡Œ</li>
<li>è¦ä¹ˆæ­»å¾ªç¯ï¼Œè¦ä¹ˆ undefined behavior</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š<code>syscall</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_exit</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>linux</code>ç¯å¢ƒä¸‹ä½¿ç”¨<code>gdb</code>è¿›è¡Œè°ƒè¯•</p>
<p>å‘ç°è°ƒç”¨äº†<code>syscall</code></p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-9.png" title="/img/Operating System/chapter2-9.png" data-thumbnail="/img/Operating System/chapter2-9.png" data-sub-html="<h2>gdb(on linux)</h2>">
        
    </a><figcaption class="image-caption">gdb(<code>on linux</code>)</figcaption>
    </figure>
<p>è¿›å…¥<code>syscall</code>ç»§ç»­æŸ¥çœ‹</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-10.png" title="/img/Operating System/chapter2-10.png" data-thumbnail="/img/Operating System/chapter2-10.png" data-sub-html="<h2>gdb(ç»§ç»­æŸ¥çœ‹)</h2>">
        
    </a><figcaption class="image-caption">gdb(<code>ç»§ç»­æŸ¥çœ‹</code>)</figcaption>
    </figure>
<p>å‘ç°è¯¥å‡½æ•°ç»™ä¸€å¤§å †å¯„å­˜å™¨èµ‹äº†å€¼ï¼Œèµ‹å®Œå€¼ä¹‹åä¼šæ‰§è¡Œä¸€ä¸ª<code>syscall</code>æŒ‡ä»¤</p>
<p>å®è´¨ï¼šå‡†å¤‡å¥½ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œç„¶åæŠŠè‡ªå·±å®Œå…¨äº¤ç»™æ“ä½œç³»ç»Ÿ</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-11.png" title="/img/Operating System/chapter2-11.png" data-thumbnail="/img/Operating System/chapter2-11.png" data-sub-html="<h2>gdb(å¯ä»¥çœ‹åˆ°é€€å‡ºç )</h2>">
        
    </a><figcaption class="image-caption">gdb(<code>å¯ä»¥çœ‹åˆ°é€€å‡ºç </code>)</figcaption>
    </figure>
<p>ï¼ˆç»ˆæ­¢ï¼‰</p>
<ul>
<li>è°ƒè¯•ä»£ç ï¼šsyscall çš„å®ç°åœ¨å“ªé‡Œï¼Ÿ
<ul>
<li>åæ¶ˆæ¯ï¼šåœ¨ libc é‡Œï¼Œä¸æ–¹ä¾¿ç›´æ¥é“¾æ¥</li>
<li>å¥½æ¶ˆæ¯ï¼šä»£ç å¾ˆçŸ­ï¼Œè€Œä¸”ä¼¼ä¹çœ‹æ‡‚äº†</li>
</ul>
</li>
</ul>
<h5 id="hello-worldçš„æ±‡ç¼–å®ç°">Hello, Worldçš„æ±‡ç¼–å®ç°</h5>
<p>minmal.S</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">globl</span> <span class="n">_start</span>
</span></span><span class="line"><span class="cl"><span class="nl">_start</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">SYS_write</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span>   <span class="err">#</span> <span class="n">write</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span>         <span class="o">%</span><span class="n">rdi</span>   <span class="err">#</span>   <span class="n">fd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">st</span><span class="p">,</span>        <span class="o">%</span><span class="n">rsi</span>   <span class="err">#</span>   <span class="n">buf</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="p">(</span><span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">),</span> <span class="o">%</span><span class="n">rdx</span>   <span class="err">#</span>   <span class="n">count</span><span class="o">=</span><span class="n">ed</span><span class="o">-</span><span class="n">st</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span>                 <span class="err">#</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">SYS_exit</span><span class="p">,</span>  <span class="o">%</span><span class="n">rax</span>   <span class="err">#</span> <span class="n">exit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span>         <span class="o">%</span><span class="n">rdi</span>   <span class="err">#</span>   <span class="n">status</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span>                 <span class="err">#</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">st</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">ascii</span> <span class="s">&#34;</span><span class="se">\033</span><span class="s">[01;31mHello, OS World</span><span class="se">\033</span><span class="s">[0m</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ed</span><span class="p">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note: gcc æ”¯æŒå¯¹æ±‡ç¼–ä»£ç çš„é¢„ç¼–è¯‘ (è¿˜ä¼šå®šä¹‰ <code>__ASSEMBLER__</code> å®)</p>
<p>è¿è¡ŒæˆåŠŸï¼Œçº¢è‰²çš„hello,worldï¼ˆ<code>linux</code>å¼€å§‹ğŸ’©ğŸ´çŠ¯ç—…ï¼Œç”¨gdbæ‰è°ƒå‡ºæ¥ï¼‰</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-12.png" title="/img/Operating System/chapter2-12.png" data-thumbnail="/img/Operating System/chapter2-12.png" data-sub-html="<h2>è¿è¡Œç¨‹åº(on gdb)</h2>">
        
    </a><figcaption class="image-caption">è¿è¡Œç¨‹åº(<code>on gdb</code>)</figcaption>
    </figure>
<p>å®å±•å¼€ç»“æœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gcc -E minmal.S
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">.</span><span class="n">globl</span> <span class="n">_start</span>
</span></span><span class="line"><span class="cl"><span class="nl">_start</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span> <span class="err">#</span> <span class="n">write</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span> <span class="err">#</span> <span class="n">fd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="n">st</span><span class="p">,</span> <span class="o">%</span><span class="n">rsi</span> <span class="err">#</span> <span class="n">buf</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="p">(</span><span class="n">ed</span> <span class="o">-</span> <span class="n">st</span><span class="p">),</span> <span class="o">%</span><span class="n">rdx</span> <span class="err">#</span> <span class="n">count</span><span class="o">=</span><span class="n">ed</span><span class="o">-</span><span class="n">st</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span> <span class="err">#</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">60</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span> <span class="err">#</span> <span class="n">exit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">movq</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span> <span class="err">#</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall</span> <span class="err">#</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">st</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">ascii</span> <span class="s">&#34;</span><span class="se">\033</span><span class="s">[01;31mHello, OS World</span><span class="se">\033</span><span class="s">[0m</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ed</span><span class="p">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·±ç©¶<code>syscall</code></p>
<p>ä½¿ç”¨å‘½ä»¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">man syscall
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥ç›´æ¥æŸ¥çœ‹æ‰‹å†Œ</p>
<hr>
<p>å›é¡¾ï¼šçŠ¶æ€æœºè§†è§’çš„ç¨‹åº</p>
<ul>
<li>ç¨‹åº = è®¡ç®— â†’ <code>syscall </code>â†’ è®¡ç®— â†’ &hellip;</li>
</ul>
<h6 id="å½©è›‹ansi-escape-code">å½©è›‹ï¼šANSI Escape Code</h6>
<blockquote>
<p>ä¸ºä»€ä¹ˆ Hello World æœ‰é¢œè‰²ï¼Ÿï¼Ÿ</p>
</blockquote>
<p>ç‰¹æ®Šç¼–ç çš„å­—ç¬¦å®ç°ç»ˆç«¯æ§åˆ¶</p>
<ul>
<li>
<p><a href="https://git.busybox.net/busybox/tree/editors/vi.c" target="_blank" rel="noopener noreffer">vi.c</a> from busybox</p>
</li>
<li>
<p><code>telnet towel.blinkenlights.nl</code> (ç”µå½±ï¼›Ctrl-] and q é€€å‡º)</p>
</li>
<li>
<p><code>dialog --msgbox 'Hello, OS World!' 8 32</code></p>
</li>
<li>
<p><code>ssh sshtron.zachlatta.com</code>(ç½‘ç»œæ¸¸æˆ)</p>
<ul>
<li>
<p>æ‰€ä»¥ç¼–ç¨‹å¯ä»¥ä»ä¸€å¼€å§‹å°±ä¸é‚£ä¹ˆæ¯ç‡¥</p>
</li>
<li>
<p>çœ‹ä¼¼å¤æ‚ï¼Œå®é™…ç®€å•æ˜äº†</p>
</li>
</ul>
</li>
</ul>
<h3 id="ç¼–è¯‘å™¨ä¸ç¼–è¯‘ä¼˜åŒ–">ç¼–è¯‘å™¨ä¸ç¼–è¯‘ä¼˜åŒ–</h3>
<p>â€œçŠ¶æ€æœºâ€ é¡ºä¾¿è§£å†³äº†ä¸€ä¸ªéå¸¸é‡è¦çš„åŸºæœ¬é—®é¢˜ï¼š</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯ç¼–è¯‘å™¨ï¼Ÿï¼Ÿï¼Ÿ</p>
</blockquote>
<p>ç¼–è¯‘å™¨ï¼šæºä»£ç  <code>S</code>(çŠ¶æ€æœº) â†’ äºŒè¿›åˆ¶ä»£ç  <code>C</code> (çŠ¶æ€æœº)</p>
<p>$C = \textrm{compile}(S)\newline$</p>
<p>ç¼–è¯‘ (ä¼˜åŒ–) çš„æ­£ç¡®æ€§ (Soundness):</p>
<ul>
<li><em>S</em> ä¸ <em>C</em> çš„å¯è§‚æµ‹è¡Œä¸ºä¸¥æ ¼ä¸€è‡´
<ul>
<li>system calls; volatile variable loads/stores; termination</li>
</ul>
</li>
<li><code>Trivially</code> æ­£ç¡® (ä½†ä½æ•ˆ) çš„å®ç°
<ul>
<li>è§£é‡Šæ‰§è¡Œ/ç›´æ¥ç¿»è¯‘ <code>S</code>çš„è¯­ä¹‰</li>
</ul>
</li>
</ul>
<h4 id="ç°ä»£-ä¸æœªæ¥çš„-ç¼–è¯‘ä¼˜åŒ–">ç°ä»£ (ä¸æœªæ¥çš„) ç¼–è¯‘ä¼˜åŒ–</h4>
<p>åœ¨ä¿è¯è§‚æµ‹ä¸€è‡´æ€§ (sound) çš„å‰æä¸‹æ”¹å†™ä»£ç  (rewriting)</p>
<ul>
<li>
<p>Inline assembly ä¹Ÿå¯ä»¥å‚ä¸ä¼˜åŒ–</p>
<ul>
<li>å…¶ä»–ä¼˜åŒ–å¯èƒ½ä¼šè·¨è¿‡ä¸å¸¦ barrier çš„ <code>asm volatile</code></li>
</ul>
</li>
<li>
<p>Eventual memory consistency</p>
</li>
<li>
<p>Call to external CU = write back visible memory</p>
<ul>
<li>talk is cheap, show me the code!</li>
</ul>
</li>
</ul>
<hr>
<p>è¿™ç»™äº†æˆ‘ä»¬å¾ˆå¤šæƒ³è±¡çš„ç©ºé—´ï¼ˆğŸ®ğŸºçš„ä¸œè¥¿ï¼‰</p>
<ul>
<li>Semantic-based compilation (synthesis)</li>
<li>AI-based rewriting</li>
<li>Fine-grained semantics &amp; system call fusion</li>
</ul>
<p>ä¸å¯ä¼˜åŒ–çš„éƒ¨åˆ†å¯ä»¥è¿›è¡Œåˆå¹¶ï¼Ÿï¼ˆğŸ®ğŸºçš„ä¸œè¥¿ï¼‰</p>
<h4 id="è¿›å…¥-plprogramming-language-çš„é¢†åŸŸ">è¿›å…¥ PL(Programming language) çš„é¢†åŸŸ</h4>
<p>PL é¢†åŸŸ (çš„å¾ˆå¤šäºº) æœ‰ä¸€ç§å€¾å‘ï¼šç”¨æ•°å­¦åŒ–çš„è¯­è¨€å®šä¹‰å’Œç†è§£ä¸€åˆ‡ (all about semantics)</p>
<ul>
<li><del>æ‰€ä»¥ä½ çœ‹ä¸€çœ¼ paper å°±è§‰å¾—è‡ªå·±çäº†</del></li>
<li>ä½†èƒŒåçš„ç›´è§‰ä¾ç„¶æ˜¯ system/software çš„
<ul>
<li>(æˆ‘ä»¬æ˜¯äººï¼Œä¸æ˜¯æ— æƒ…çš„æ•°å­¦æœºå™¨ ğŸ˜‚)</li>
<li>æºœäº†æºœäº†ï¼Œå›åˆ° system çš„ä¸–ç•Œ</li>
</ul>
</li>
</ul>
<hr>
<p>Further readings</p>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/2103621.2103719" target="_blank" rel="noopener noreffer">An executable formal semantics of C with applications</a> (POPL'12)</li>
<li><a href="https://compcert.org/motivations.html" target="_blank" rel="noopener noreffer">CompCert C verified compiler</a> and a <a href="https://xavierleroy.org/publi/compcert-backend.pdf" target="_blank" rel="noopener noreffer">paper</a> (POPL'06, Most Influential Paper Award :gold medalğŸ®)</li>
<li><a href="https://dl.acm.org/doi/10.1145/3485513" target="_blank" rel="noopener noreffer">Copy-and-patch compilation</a> (OOPSLA'21, Distinguished Paper ğŸ®)</li>
</ul>
<h3 id="æ“ä½œç³»ç»Ÿä¸­çš„ç¨‹åº">æ“ä½œç³»ç»Ÿä¸­çš„ç¨‹åº</h3>
<h4 id="æ“ä½œç³»ç»Ÿä¸­çš„ä¸€èˆ¬ç¨‹åº">æ“ä½œç³»ç»Ÿä¸­çš„ä¸€èˆ¬ç¨‹åº</h4>
<blockquote>
<p>å’Œ <a href="https://jyywiki.cn/pages/OS/2022/demos/minimal.S" target="_blank" rel="noopener noreffer">minimal.S</a> æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼šç¨‹åº = è®¡ç®— â†’ syscall â†’ &hellip;</p>
</blockquote>
<p>æ“ä½œç³»ç»Ÿæ”¶ç¼–äº†æ‰€æœ‰çš„ç¡¬ä»¶/è½¯ä»¶èµ„æº</p>
<ul>
<li>åªèƒ½ç”¨æ“ä½œç³»ç»Ÿå…è®¸çš„æ–¹å¼è®¿é—®æ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡
<ul>
<li>ä»è€Œå®ç°æ“ä½œç³»ç»Ÿçš„ â€œéœ¸ä¸»â€ åœ°ä½</li>
<li>ä¾‹å­ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/tryopen.c" target="_blank" rel="noopener noreffer">tryopen.c</a></li>
</ul>
</li>
<li>è¿™æ˜¯ä¸º â€œç®¡ç†å¤šä¸ªçŠ¶æ€æœºâ€ æ‰€å¿…é¡»çš„
<ul>
<li>ä¸èƒ½æ‰“æ¶ï¼Œè°æœ‰æƒé™å°±ç»™ä»–</li>
</ul>
</li>
</ul>
<p>tryopen.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">try_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;open(</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">) returns %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;  FAIL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;  SUCCESS!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">try_open</span><span class="p">(</span><span class="s">&#34;/something/not/exist&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">try_open</span><span class="p">(</span><span class="s">&#34;/dev/sda&#34;</span><span class="p">);</span> <span class="c1">// hard drive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œæ•ˆæœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jungle@jungle-virtual-machine:~$ gcc tryopen.c <span class="o">&amp;&amp;</span> ./a.out
</span></span><span class="line"><span class="cl">open<span class="o">(</span><span class="s2">&#34;/something/not/exist&#34;</span><span class="o">)</span> returns -1
</span></span><span class="line"><span class="cl">  FAIL: No such file or directory
</span></span><span class="line"><span class="cl">open<span class="o">(</span><span class="s2">&#34;/dev/sda&#34;</span><span class="o">)</span> returns -1
</span></span><span class="line"><span class="cl">  FAIL: Permission denied
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="äºŒè¿›åˆ¶-ç¨‹åºä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡">(äºŒè¿›åˆ¶) ç¨‹åºä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡</h4>
<p>å¯æ‰§è¡Œæ–‡ä»¶</p>
<ul>
<li>ä¸å¤§å®¶æ—¥å¸¸ä½¿ç”¨çš„æ–‡ä»¶ (a.c, README.txt) æ²¡æœ‰æœ¬è´¨åŒºåˆ«</li>
<li>æ“ä½œç³»ç»Ÿæä¾› API æ‰“å¼€ã€è¯»å–ã€æ”¹å†™ (éƒ½éœ€è¦ç›¸åº”çš„æƒé™)</li>
</ul>
<hr>
<p>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶</p>
<ul>
<li>
<p><code>vim</code>,<code>cat</code>,<code>xxd</code></p>
<p>éƒ½å¯ä»¥ç›´æ¥æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶</p>
<ul>
<li><code>vim</code> ä¸­äºŒè¿›åˆ¶çš„éƒ¨åˆ†æ— æ³• â€œé˜…è¯»â€ï¼Œä½†å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²å¸¸é‡</li>
<li>ä½¿ç”¨ <code>xxd</code> å¯ä»¥çœ‹åˆ°æ–‡ä»¶ä»¥ <code>&quot;\x7f&quot; &quot;ELF&quot;</code> å¼€å¤´</li>
<li>vscode æœ‰ <code>binary editor</code> æ’ä»¶</li>
</ul>
</li>
</ul>
<h4 id="ç³»ç»Ÿä¸­å¸¸è§çš„åº”ç”¨ç¨‹åº">ç³»ç»Ÿä¸­å¸¸è§çš„åº”ç”¨ç¨‹åº</h4>
<p>Core Utilities (coreutils)</p>
<ul>
<li><em>standard</em> programs for text and file manipulation</li>
<li>ç³»ç»Ÿä¸­å®‰è£…çš„æ˜¯ <a href="https://www.gnu.org/software/coreutils/" target="_blank" rel="noopener noreffer">GNU Coreutils</a>
<ul>
<li>æœ‰è¾ƒå°çš„æ›¿ä»£å“ <a href="https://www.busybox.net/" target="_blank" rel="noopener noreffer">busybox</a></li>
</ul>
</li>
</ul>
<hr>
<p>ç³»ç»Ÿ/å·¥å…·ç¨‹åº</p>
<ul>
<li>
<p>bash,binutils, apt, ip, ssh, vim, tmux, jdk, python, &hellip;</p>
<ul>
<li>
<p>è¿™äº›å·¥å…·çš„åŸç†éƒ½ä¸å¤æ‚ (ä¾‹å¦‚ apt å…¶å®åªæ˜¯ dpkg çš„å£³)</p>
</li>
<li>
<p><a href="https://packages.ubuntu.com/" target="_blank" rel="noopener noreffer">Ubuntu Packages</a> (å’Œ apt-file å·¥å…·) æ”¯æŒæ–‡ä»¶åæ£€ç´¢</p>
<ul>
<li>ä¾‹å­ï¼šæ‰¾ä¸åˆ° <code>SDL2/SDL.h</code> æ—¶&hellip;</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p>å…¶ä»–å„ç§åº”ç”¨ç¨‹åº</p>
<ul>
<li>æµè§ˆå™¨ã€éŸ³ä¹æ’­æ”¾å™¨â€¦â€¦</li>
</ul>
<h4 id="æ“ä½œç³»ç»Ÿä¸­çš„ç¨‹åºdark-side">æ“ä½œç³»ç»Ÿä¸­çš„ç¨‹åºï¼šDark Side</h4>
<blockquote>
<p>æ€äººçš„é¢è¯•é¢˜ (1)ï¼šä¸€ä¸ªæ™®é€šçš„ã€äººç•œæ— å®³çš„ Hello World C ç¨‹åºæ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å“ªé‡Œï¼Ÿ</p>
</blockquote>
<p>ç­‰ä»·é—®æ³•</p>
<ul>
<li>â€œäºŒè¿›åˆ¶ç¨‹åºçŠ¶æ€æœºçš„åˆå§‹çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿâ€
<ul>
<li><code>main</code> çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ âŒ</li>
<li><code>libc</code> çš„ <code>_start</code> âŒ</li>
</ul>
</li>
</ul>
<hr>
<p>é—® gdb å§</p>
<ul>
<li><code>info proc {mappings,...}</code> - æ‰“å°è¿›ç¨‹å†…å­˜</li>
</ul>
<p>ä½¿ç”¨<code>gdb</code></p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-13.png" title="/img/Operating System/chapter2-13.png" data-thumbnail="/img/Operating System/chapter2-13.png" data-sub-html="<h2>gdb(æŸ¥çœ‹å…¥å£)</h2>">
        
    </a><figcaption class="image-caption">gdb(<code>æŸ¥çœ‹å…¥å£</code>)</figcaption>
    </figure>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">0x00007ffff7fe32b0 in _start <span class="o">()</span> from /lib64/ld-linux-x86-64.so.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨<code>info proc mappings</code>å‘½ä»¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> info proc mappings 
</span></span><span class="line"><span class="cl">process <span class="m">48808</span>
</span></span><span class="line"><span class="cl">Mapped address spaces:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          Start Addr           End Addr       Size     Offset  Perms  objfile
</span></span><span class="line"><span class="cl">      0x555555554000     0x555555555000     0x1000        0x0  r--p   /home/jungle/a.out
</span></span><span class="line"><span class="cl">      0x555555555000     0x555555556000     0x1000     0x1000  r-xp   /home/jungle/a.out
</span></span><span class="line"><span class="cl">      0x555555556000     0x555555557000     0x1000     0x2000  r--p   /home/jungle/a.out
</span></span><span class="line"><span class="cl">      0x555555557000     0x555555559000     0x2000     0x2000  rw-p   /home/jungle/a.out
</span></span><span class="line"><span class="cl">      0x7ffff7fbd000     0x7ffff7fc1000     0x4000        0x0  r--p   <span class="o">[</span>vvar<span class="o">]</span>
</span></span><span class="line"><span class="cl">      0x7ffff7fc1000     0x7ffff7fc3000     0x2000        0x0  r-xp   <span class="o">[</span>vdso<span class="o">]</span>
</span></span><span class="line"><span class="cl">      0x7ffff7fc3000     0x7ffff7fc5000     0x2000        0x0  r--p   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">      0x7ffff7fc5000     0x7ffff7fef000    0x2a000     0x2000  r-xp   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">      0x7ffff7fef000     0x7ffff7ffa000     0xb000    0x2c000  r--p   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">      0x7ffff7ffb000     0x7ffff7fff000     0x4000    0x37000  rw-p   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl">      0x7ffffffde000     0x7ffffffff000    0x21000        0x0  rw-p   <span class="o">[</span>stack<span class="o">]</span>
</span></span><span class="line"><span class="cl">  0xffffffffff600000 0xffffffffff601000     0x1000        0x0  --xp   <span class="o">[</span>vsyscall<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="main-ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆ"><code>main()</code> ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h5>
<p><code>ld-linux-x86-64.so</code> åŠ è½½äº† libc</p>
<ul>
<li>ä¹‹å libc å®Œæˆäº†è‡ªå·±çš„åˆå§‹åŒ–
<ul>
<li>RTFM: <a href="https://www.gnu.org/software/hurd/glibc/startup.html" target="_blank" rel="noopener noreffer">libc startup</a> on Hurd</li>
<li><code>main()</code> çš„å¼€å§‹/ç»“æŸå¹¶ä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å¼€å§‹/ç»“æŸ</li>
<li>ä¾‹å­ï¼š<a href="https://jyywiki.cn/pages/OS/2022/demos/hello-goodbye.c" target="_blank" rel="noopener noreffer">hello-goodbye.c</a></li>
</ul>
</li>
</ul>
<hr>
<p>è°è§„å®šæ˜¯ <code>ld-linux-x86-64.so</code>ï¼Œè€Œä¸æ˜¯ <code>rtfm.so</code>ï¼Ÿ</p>
<ul>
<li>readelf å‘Šè¯‰ä½ ç­”æ¡ˆ</li>
<li>(è®¡ç®—æœºç³»ç»Ÿä¸å­˜åœ¨ç„å­¦ï¼›ä¸€åˆ‡éƒ½å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Š)
<ul>
<li>å›é¡¾ <code>gcc --verbose</code></li>
</ul>
</li>
</ul>
<p><code>hello-goodbye.c</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">hello</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello, World</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// See also: atexit(3)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">destructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">goodbye</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Goodbye, Cruel OS World!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="/img/Operating%20System/chapter2-14.png" title="/img/Operating System/chapter2-14.png" data-thumbnail="/img/Operating System/chapter2-14.png" data-sub-html="<h2>vim(æ±‡ç¼–ä»£ç )</h2>">
        
    </a><figcaption class="image-caption">vim(<code>æ±‡ç¼–ä»£ç </code>)</figcaption>
    </figure>
<p>åé¢è€å¸ˆhackeræ”¹äºŒè¿›åˆ¶ä»£ç çš„æ—¶å€™âœŒï¸çš„ğŸ‘€å·²ç»è·Ÿä¸ä¸Šäº†ï¼Œè„‘å­æ›´æ˜¯ç›´æ¥ğŸ’©ğŸ´</p>
<blockquote>
<p>æ€äººçš„é¢è¯•é¢˜ (2)ï¼šmain æ‰§è¡Œä¹‹å‰ã€æ‰§è¡Œä¸­ã€æ‰§è¡Œåï¼Œå‘ç”Ÿäº†å“ªäº›æ“ä½œç³»ç»Ÿ API è°ƒç”¨ï¼Ÿ</p>
</blockquote>
<hr>
<p>å‘ƒâ€¦â€¦</p>
<ul>
<li>(è®¡ç®—æœºç³»ç»Ÿä¸å­˜åœ¨ç„å­¦ï¼›ä¸€åˆ‡éƒ½å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Š)</li>
<li>æ‰€ä»¥ä½ åº”è¯¥æœ‰ä¸€ä¸ªå¼ºçƒˆçš„ä¿¡å¿µï¼šè¿™ä¸ªé—®é¢˜æ˜¯å¯ä»¥å›ç­”çš„</li>
</ul>
<h4 id="æ‰“å¼€ç¨‹åºçš„æ‰§è¡Œtrace-è¸ªè¿¹">æ‰“å¼€ç¨‹åºçš„æ‰§è¡Œï¼šTrace (è¸ªè¿¹)</h4>
<blockquote>
<p>In general, trace refers to the process of following <em>anything</em> from the beginning to the end. For example, the <code>traceroute</code> command follows each of the network hops as your computer connects to another computer.</p>
</blockquote>
<p>è¿™é—¨è¯¾ä¸­å¾ˆé‡è¦çš„å·¥å…·ï¼šstrace</p>
<ul>
<li>system call trace</li>
<li>ç†è§£ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨
<ul>
<li>demo: <code>strace ./hello-goodbye</code></li>
<li>åœ¨è¿™é—¨è¯¾ä¸­ï¼Œä½ èƒ½ç†è§£ strace çš„è¾“å‡ºå¹¶åœ¨ä½ è‡ªå·±çš„æ“ä½œç³»ç»Ÿé‡Œå®ç°ç›¸å½“ä¸€éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨ (mmap, execve, &hellip;)</li>
</ul>
</li>
</ul>
<p>ä½¿ç”¨<code>strace</code></p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-15.png" title="/img/Operating System/chapter2-15.png" data-thumbnail="/img/Operating System/chapter2-15.png" data-sub-html="<h2>linux(ä½¿ç”¨strace)</h2>">
        
    </a><figcaption class="image-caption">linux(<code>ä½¿ç”¨strace</code>)</figcaption>
    </figure>
<h4 id="æœ¬è´¨ä¸Šæ‰€æœ‰çš„ç¨‹åºå’Œ-hello-world-ç±»ä¼¼">æœ¬è´¨ä¸Šï¼Œæ‰€æœ‰çš„ç¨‹åºå’Œ Hello World ç±»ä¼¼</h4>
<p>ç¨‹åº = çŠ¶æ€æœº = è®¡ç®— â†’ syscall â†’ è®¡ç®— â†’</p>
<ul>
<li>
<p>è¢«æ“ä½œç³»ç»ŸåŠ è½½</p>
<ul>
<li>é€šè¿‡å¦ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œ execve è®¾ç½®ä¸ºåˆå§‹çŠ¶æ€</li>
</ul>
</li>
<li>
<p>çŠ¶æ€æœºæ‰§è¡Œ</p>
<ul>
<li>è¿›ç¨‹ç®¡ç†ï¼šfork, execve, exit, &hellip;</li>
<li>æ–‡ä»¶/è®¾å¤‡ç®¡ç†ï¼šopen, close, read, write, &hellip;</li>
<li>å­˜å‚¨ç®¡ç†ï¼šmmap, brk, &hellip;</li>
</ul>
</li>
<li>
<p>ç›´åˆ° _exit (exit_group) é€€å‡º</p>
</li>
</ul>
<hr>
<ul>
<li>è¯´å¥½çš„æµè§ˆå™¨ã€æ¸¸æˆã€æ€æ¯’è½¯ä»¶ã€ç—…æ¯’å‘¢ï¼Ÿéƒ½æ˜¯è¿™äº› API å—ï¼ŸğŸ’¢ğŸ’¢ğŸ’¢(éƒ½æ˜¯) $\rightarrow$ğŸ®ğŸº</li>
</ul>
<h4 id="yes---è¿™äº›-api-å°±æ˜¯æ“ä½œç³»ç»Ÿçš„å…¨éƒ¨">Yes! - è¿™äº› API å°±æ˜¯æ“ä½œç³»ç»Ÿçš„å…¨éƒ¨</h4>
<p>ç¼–è¯‘å™¨ (gcc)ï¼Œä»£è¡¨å…¶ä»–å·¥å…·ç¨‹åº</p>
<ul>
<li>
<p>ä¸»è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼šexecve, read, write</p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">strace -f gcc a.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>(gcc ä¼šå¯åŠ¨å…¶ä»–è¿›ç¨‹)</p>
<ul>
<li>å¯ä»¥ç®¡é“ç»™ç¼–è¾‘å™¨ <code>vim -</code></li>
<li>ç¼–è¾‘å™¨é‡Œè¿˜å¯ä»¥ <code>%!grep</code> (ç»†èŠ‚/æŠ€å·§)</li>
</ul>
</li>
</ul>
<hr>
<p>å›¾å½¢ç•Œé¢ç¨‹åº (xedit)ï¼Œä»£è¡¨å…¶ä»–å›¾å½¢ç•Œé¢ç¨‹åº (ä¾‹å¦‚ vscode)</p>
<ul>
<li>
<p>ä¸»è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼špoll, recvmsg, writev</p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">strace xedit
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å›¾å½¢ç•Œé¢ç¨‹åºå’Œ X-Window æœåŠ¡å™¨æŒ‰ç…§ X11 åè®®é€šä¿¡</li>
<li>è™šæ‹Ÿæœºä¸­çš„ <code>xedit</code> å°† <code>X11</code> å‘½ä»¤é€šè¿‡<code>ssh</code>(X11 forwarding) è½¬å‘åˆ° Host</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-16.png" title="/img/Operating System/chapter2-16.png" data-thumbnail="/img/Operating System/chapter2-16.png" data-sub-html="<h2>strace(xedit)</h2>">
        
    </a><figcaption class="image-caption">strace(<code>xedit</code>)</figcaption>
    </figure>
<h4 id="å„å¼å„æ ·çš„åº”ç”¨ç¨‹åº">å„å¼å„æ ·çš„åº”ç”¨ç¨‹åº</h4>
<p>éƒ½åœ¨æ“ä½œç³»ç»Ÿ API (syscall) å’Œæ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡ä¸Šæ„å»º</p>
<ul>
<li>çª—å£ç®¡ç†å™¨
<ul>
<li>ç®¡ç†è®¾å¤‡å’Œå±å¹• (read/write/mmap)</li>
<li>è¿›ç¨‹é—´é€šä¿¡ (send, recv)</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>ä»»åŠ¡ç®¡ç†å™¨
<ul>
<li>è®¿é—®æ“ä½œç³»ç»Ÿæä¾›çš„è¿›ç¨‹å¯¹è±¡ (readdir/read)</li>
<li>å‚è€ƒ gdb é‡Œçš„ <code>info proc *</code></li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>æ€æ¯’è½¯ä»¶
<ul>
<li>æ–‡ä»¶é™æ€æ‰«æ (read)</li>
<li>ä¸»åŠ¨é˜²å¾¡ (ptrace)</li>
<li>å…¶ä»–æ›´å¤æ‚çš„å®‰å…¨æœºåˆ¶â€¦â€¦</li>
</ul>
</li>
</ul>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul>
<li><strong>Q</strong>: åˆ°åº•ä»€ä¹ˆæ˜¯ â€œç¨‹åºâ€ï¼Ÿ</li>
</ul>
<hr>
<p>$Take-away\ message\newline$</p>
<ul>
<li>ç¨‹åº = çŠ¶æ€æœº
<ul>
<li>æºä»£ç  S: çŠ¶æ€è¿ç§» = æ‰§è¡Œè¯­å¥</li>
<li>äºŒè¿›åˆ¶ä»£ç  C: çŠ¶æ€è¿ç§» = æ‰§è¡ŒæŒ‡ä»¤</li>
<li>ç¼–è¯‘å™¨ $C=compile(S)\newline$</li>
</ul>
</li>
<li>åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ
<ul>
<li>å°±æ˜¯ä¸€æ¡ <code>syscall</code> æŒ‡ä»¤</li>
</ul>
</li>
<li>è®¡ç®—æœºç³»ç»Ÿä¸å­˜åœ¨ç„å­¦ï¼›ä¸€åˆ‡éƒ½å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Š
<ul>
<li>ç†è§£æ“ä½œç³»ç»Ÿçš„é‡è¦å·¥å…·ï¼š<code>gcc</code>, <code>binutils</code>, <code>gdb</code>, <code>strace</code></li>
</ul>
</li>
</ul>
<h3 id="ä¸ªäººçš„ä¸€äº›è¡¥å……">ä¸ªäººçš„ä¸€äº›è¡¥å……</h3>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="typeit"><div id="id-3" class=""></div></div>
</div>
        </div>
    </div>
<p>æ–°å­¦æœŸå¼€è¯¾ï¼Œä¹Ÿä¸Šäº†æ“ä½œç³»ç»Ÿï¼Œå½“ç„¶ï¼Œè€å¸ˆå¿µpptè®²çš„ä¹Ÿç¡®å®æ˜¯ğŸ’©ğŸ´åœ°å¬ä¸æ‡‚ï¼Œä»Šæ™šåšä½œä¸šï¼Œå…¶ä¸­ä¹Ÿæœ‰æœ‰å…³<b>System call</b>çš„ä¸€äº›ç›¸å…³é—®é¢˜ï¼Œäºæ˜¯å†™äº†ä¸€ä¸ªæœ€ç®€å•çš„Cç¨‹åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åç”¨gdbè°ƒè¯•äº†ä¸€ä¸‹</p>
<figure><a class="lightgallery" href="/img/Operating%20System/chapter2-17.png" title="/img/Operating System/chapter2-17.png" data-thumbnail="/img/Operating System/chapter2-17.png" data-sub-html="<h2>gdb $\Longrightarrow$ layout asm</h2>">
        
    </a><figcaption class="image-caption">gdb $\Longrightarrow$ <code>layout asm</code></figcaption>
    </figure>
<p>å¿½ç„¶å¯¹å‰é¢è¿™äº›æŒ‡ä»¤çš„è°ƒç”¨æœ‰äº†äº›å…´è¶£ï¼Œ&lt;_do_global_dtors_aux&gt;æ˜¯ä¸ªå•¥ï¼Ÿ&lt;frame_dummy&gt;åˆæ˜¯ä¸ªå•¥ï¼Œç»“æœç”¨è¿™äº›åå­—æ‰¾åˆ°äº†ä¸€ä¸ªè®²çš„éå¸¸ç»†çš„åšå®¢<a href="https://luomuxiaoxiao.com/?p=516" target="_blank" rel="noopener noreffer">ã€ŠLinux X86 ç¨‹åºå¯åŠ¨ â€“ mainå‡½æ•°æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Ÿâ€”â€”è½æœ¨è§è§çš„åšå®¢ã€‹</a>ï¼Œä¸è¿‡å†…å®¹çœŸçš„æ˜¯å¤ªå¤šäº†ï¼Œå…ˆç«‹ä¸€ä¸ªflagï¼Œè¿™ä¸¤å‘¨ä¸€å®šè¦æ‰¾æ—¶é—´ç»™è¯»ä¸€éï¼Œå®Œä¸æˆå°±å…¨éƒ¨ğŸ’©ğŸ´</p>
<hr>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Update<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><div class="typeit"><div id="id-4" class=""></div></div>
</div>
        </div>
    </div>
<p>çœ‹äº†ä¸€éƒ¨åˆ†è¯¥æ–‡ç« ï¼Œå¤ªé•¿äº†ï¼Œå…ˆçœ‹ä¸€å°åŠï¼Œå› ä¸ºæ˜¯32ä½çš„è€ç‰ˆæœ¬Linuxï¼Œå¾ˆå¤šä¸œè¥¿ä¸èƒ½å®Œå…¨å¤ç°</p>
<p>$\Longrightarrow$ <a href="https://jungle430.github.io/posts/operating-system/support2/" target="_blank" rel="noopener noreffer">ã€ŠLinux x86 Program Start Up or - How the heck do we get to main()?ã€‹</a></p>
<p><b>å£°æ˜ï¼šæœ¬æ–‡ç« å¼•ç”¨èµ„æ–™ä¸å›¾åƒå‡å·²åšæ ‡æ³¨ï¼Œå¦‚æœ‰ä¾µæƒæœ¬äººä¼šé©¬ä¸Šåˆ é™¤</b></p>
]]></description>
</item>
</channel>
</rss>
